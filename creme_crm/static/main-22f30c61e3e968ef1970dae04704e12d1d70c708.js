(function($){"use strict";$.fn.toggleProp=function(name,enabled,value){return this.each(function(){var element=$(this);var state=Boolean(element.prop(name));var next=enabled!==undefined?enabled:!state;if(value===undefined){element.prop(name,next);}else{if(next){element.prop(name,value);}else{element.removeProp(name);}}});};$.fn.toggleAttr=function(name,enabled,value){return this.each(function(){var element=$(this);var state=element.is('['+name+']');var next=enabled!==undefined?enabled:!state;if(next){element.attr(name,value||element.attr(name)||'');}else{element.removeAttr(name);}});};}(jQuery));(function(){"use strict";function pop(object,name,defaults){if(object instanceof Object&&name in object){var value=object[name];delete object[name];return value;}else{return defaults;}}
function append(object,key,value){var entry=object[key];if(entry===undefined){entry=value;}else if(Array.isArray(entry)){entry.push(value);}else{entry=[entry,value];}
object[key]=entry;}
_.mixin({pop:pop,append:append});}());(function(){"use strict";function isJSON(data){var output=null;try{output=_.isString(data)&&data.length>0?JSON.parse(data):null;}catch(e){}
return output!==null;}
function cleanJSON(data,reviver){try{if(_.isString(data)&&data.length>0){return JSON.parse(data,reviver);}}catch(e){}}
function readJSONScriptText(element){if(_.isString(element)&&element.length>0){element=document.querySelector(element);}
if(!_.isElement(element)){console.warn('No such JSON script element');return'';}
var isScript=(element.nodeName.toLowerCase()==='script'&&['text/json','application/json'].indexOf(element.getAttribute('type'))!==-1);if(!isScript){console.warn('This element is not a JSON script',element);return'';}
var startTag='<!--';var endTag='-->';var rawData=(element.text||'').replace(/^[\s\n\r]+|[\s\n\r]+$/g,'');if(rawData.startsWith(startTag)&&rawData.endsWith(endTag)){rawData=rawData.slice(startTag.length,rawData.length-endTag.length);}else{console.warn('Please use html comment <!-- --> within JSON <script> tag to prevent some browsers to interpret it as javascript');}
return rawData.trim().replace(/\\u005c/gi,'\\').replace(/\\u0026/gi,'&').replace(/\\u003c/gi,'<').replace(/\\u003e/gi,'>').replace(/\\u2028/gi,'\u2028').replace(/\\u2029/gi,'\u2029');}
function cleanJSONScript(element,reviver){return _.cleanJSON(_.readJSONScriptText(element),reviver);}
_.mixin({isJSON:isJSON,readJSONScriptText:readJSONScriptText,cleanJSON:cleanJSON,cleanJSONScript:cleanJSONScript});}());(function(){"use strict";function appendStatic(name,method){if(!Object[name]){Object[name]=method;}};appendStatic('property',function(obj,key,value){if(value===undefined){return obj[key];}
obj[key]=value;return obj;});appendStatic('isNone',function(obj){return obj===undefined||obj===null;});appendStatic('isEmpty',function(obj){if(Object.isNone(obj)||obj.length===0){return true;}
if(typeof obj==='number'){return false;}
for(var name in obj){return false;}
return true;});appendStatic('isNotEmpty',function(obj){return!Object.isEmpty(obj);});appendStatic('isType',function(obj,type){return(typeof obj===type);});appendStatic('isNumber',function(obj){return(typeof obj==='number');});appendStatic('isFunc',function(obj){return(typeof obj==='function');});appendStatic('isString',function(obj){if(!Object.isNone(obj)){return(typeof obj==='string')||(obj instanceof String);}else{return false;}});appendStatic('proxy',function(delegate,context,options){if(Object.isNone(delegate)){return;}
options=options||{};context=context||delegate;var proxy={__context__:context};var filter=Object.isFunc(options.filter)?options.filter:function(){return true;};var parameters=Object.isFunc(options.arguments)?function(args){return options.arguments(Array.from(args));}:Array.from;for(var key in delegate){var value=delegate[key];if(!Object.isFunc(value)||filter(key,value)===false){continue;}
(function(proxy,fn,key){proxy[key]=function(){return fn.apply(this.__context__,parameters(arguments));};})(proxy,value,key);}
return proxy;});appendStatic('isSubClassOf',function(object,constructor){if(constructor&&Object.isFunc(constructor.prototype.isPrototypeOf)){return constructor.prototype.isPrototypeOf(object);}
return false;});}());(function(){"use strict";function append(name,method){if(!String.prototype[name]){String.prototype[name]=method;}};append('capitalize',function(){return this.length>0?this.slice(0,1).toUpperCase().concat(this.slice(1,this.length)):this;});append('isDigit',function(){return this.match(/^(\+|\-)?[\.0-9]+/)!==null;});append('isAlpha',function(){return this.match(/^[a-zA-z]+$/)!==null;});append('isSpace',function(){return this.match(/^[\s]+$/)!==null;});append('template',function(data,pattern){if(Object.isNone(data)){return String(this);}
pattern=pattern||/\$\{([^\}]+)\}/g;if(Object.isFunc(data)){return this.replace(pattern,function(match,key){var value=data(key,match);return value!==undefined?value:match;});}else{return this.replace(pattern,function(match,key){var value=data[key];return value!==undefined?value:match;});}});function __decodeEntity(x){if(x.charAt(2)==='x'){return String.fromCharCode(parseInt(x.substr(3,x.length-4),16));}else{return String.fromCharCode(x.substr(2,x.length-3));}};function __decodeUnicode(x){return String.fromCharCode(parseInt(x.substr(2,x.length-2),16));};var __htmlEntityToChar={'&lt;':'<','&gt;':'>','&amp;':'&','&apos;':"'",'&quot;':'"','&nbsp;':'\u00A0'};var __charToHtmlEntity={'<':'&lt;','>':'&gt;','&':'&amp;',"'":'&apos;','"':'&quot;','\u00A0':'&nbsp;'};append('unescapeHTML',function(){return this.replace(/&([a-z]+);/g,function(c){return __htmlEntityToChar[c]||c;});});append('escapeHTML',function(){return this.replace(/[<>&'"\u00A0]/g,function(c){return __charToHtmlEntity[c]||c;});});append('decodeHTMLEntities',function(){return this.unescapeHTML().replace(/\\u[0-9A-F]{4,6}/gi,__decodeUnicode).replace(/&(#([0-9]{2,4})|#x([0-9A-F]{2,6}));/gi,__decodeEntity);});var __diacritics=[['A','\u0041\u24B6\uFF21\u00C0\u00C1\u00C2\u1EA6\u1EA4\u1EAA\u1EA8\u00C3\u0100\u0102\u1EB0\u1EAE\u1EB4\u1EB2\u0226\u01E0\u00C4\u01DE\u1EA2\u00C5\u01FA\u01CD\u0200\u0202\u1EA0\u1EAC\u1EB6\u1E00\u0104\u023A\u2C6F]'],['AA','\uA732]'],['AE','\u00C6\u01FC\u01E2]'],['AO','\uA734]'],['AU','\uA736]'],['AV','\uA738\uA73A]'],['AY','\uA73C]'],['B','\u0042\u24B7\uFF22\u1E02\u1E04\u1E06\u0243\u0182\u0181]'],['C','\u0043\u24B8\uFF23\u0106\u0108\u010A\u010C\u00C7\u1E08\u0187\u023B\uA73E]'],['D','\u0044\u24B9\uFF24\u1E0A\u010E\u1E0C\u1E10\u1E12\u1E0E\u0110\u018B\u018A\u0189\uA779]'],['DZ','\u01F1\u01C4]'],['Dz','\u01F2\u01C5]'],['E','\u0045\u24BA\uFF25\u00C8\u00C9\u00CA\u1EC0\u1EBE\u1EC4\u1EC2\u1EBC\u0112\u1E14\u1E16\u0114\u0116\u00CB\u1EBA\u011A\u0204\u0206\u1EB8\u1EC6\u0228\u1E1C\u0118\u1E18\u1E1A\u0190\u018E]'],['F','\u0046\u24BB\uFF26\u1E1E\u0191\uA77B]'],['G','\u0047\u24BC\uFF27\u01F4\u011C\u1E20\u011E\u0120\u01E6\u0122\u01E4\u0193\uA7A0\uA77D\uA77E]'],['H','\u0048\u24BD\uFF28\u0124\u1E22\u1E26\u021E\u1E24\u1E28\u1E2A\u0126\u2C67\u2C75\uA78D]'],['I','\u0049\u24BE\uFF29\u00CC\u00CD\u00CE\u0128\u012A\u012C\u0130\u00CF\u1E2E\u1EC8\u01CF\u0208\u020A\u1ECA\u012E\u1E2C\u0197]'],['J','\u004A\u24BF\uFF2A\u0134\u0248]'],['K','\u004B\u24C0\uFF2B\u1E30\u01E8\u1E32\u0136\u1E34\u0198\u2C69\uA740\uA742\uA744\uA7A2]'],['L','\u004C\u24C1\uFF2C\u013F\u0139\u013D\u1E36\u1E38\u013B\u1E3C\u1E3A\u0141\u023D\u2C62\u2C60\uA748\uA746\uA780]'],['LJ','\u01C7]'],['Lj','\u01C8]'],['M','\u004D\u24C2\uFF2D\u1E3E\u1E40\u1E42\u2C6E\u019C]'],['N','\u004E\u24C3\uFF2E\u01F8\u0143\u00D1\u1E44\u0147\u1E46\u0145\u1E4A\u1E48\u0220\u019D\uA790\uA7A4]'],['NJ','\u01CA]'],['Nj','\u01CB]'],['O','\u004F\u24C4\uFF2F\u00D2\u00D3\u00D4\u1ED2\u1ED0\u1ED6\u1ED4\u00D5\u1E4C\u022C\u1E4E\u014C\u1E50\u1E52\u014E\u022E\u0230\u00D6\u022A\u1ECE\u0150\u01D1\u020C\u020E\u01A0\u1EDC\u1EDA\u1EE0\u1EDE\u1EE2\u1ECC\u1ED8\u01EA\u01EC\u00D8\u01FE\u0186\u019F\uA74A\uA74C]'],['OI','\u01A2]'],['OO','\uA74E]'],['OU','\u0222]'],['P','\u0050\u24C5\uFF30\u1E54\u1E56\u01A4\u2C63\uA750\uA752\uA754]'],['Q','\u0051\u24C6\uFF31\uA756\uA758\u024A]'],['R','\u0052\u24C7\uFF32\u0154\u1E58\u0158\u0210\u0212\u1E5A\u1E5C\u0156\u1E5E\u024C\u2C64\uA75A\uA7A6\uA782]'],['S','\u0053\u24C8\uFF33\u1E9E\u015A\u1E64\u015C\u1E60\u0160\u1E66\u1E62\u1E68\u0218\u015E\u2C7E\uA7A8\uA784]'],['T','\u0054\u24C9\uFF34\u1E6A\u0164\u1E6C\u021A\u0162\u1E70\u1E6E\u0166\u01AC\u01AE\u023E\uA786]'],['TZ','\uA728]'],['U','\u0055\u24CA\uFF35\u00D9\u00DA\u00DB\u0168\u1E78\u016A\u1E7A\u016C\u00DC\u01DB\u01D7\u01D5\u01D9\u1EE6\u016E\u0170\u01D3\u0214\u0216\u01AF\u1EEA\u1EE8\u1EEE\u1EEC\u1EF0\u1EE4\u1E72\u0172\u1E76\u1E74\u0244]'],['V','\u0056\u24CB\uFF36\u1E7C\u1E7E\u01B2\uA75E\u0245]'],['VY','\uA760]'],['W','\u0057\u24CC\uFF37\u1E80\u1E82\u0174\u1E86\u1E84\u1E88\u2C72]'],['X','\u0058\u24CD\uFF38\u1E8A\u1E8C]'],['Y','\u0059\u24CE\uFF39\u1EF2\u00DD\u0176\u1EF8\u0232\u1E8E\u0178\u1EF6\u1EF4\u01B3\u024E\u1EFE]'],['Z','\u005A\u24CF\uFF3A\u0179\u1E90\u017B\u017D\u1E92\u1E94\u01B5\u0224\u2C7F\u2C6B\uA762]'],['a','\u0061\u24D0\uFF41\u1E9A\u00E0\u00E1\u00E2\u1EA7\u1EA5\u1EAB\u1EA9\u00E3\u0101\u0103\u1EB1\u1EAF\u1EB5\u1EB3\u0227\u01E1\u00E4\u01DF\u1EA3\u00E5\u01FB\u01CE\u0201\u0203\u1EA1\u1EAD\u1EB7\u1E01\u0105\u2C65\u0250]'],['aa','\uA733]'],['ae','\u00E6\u01FD\u01E3]'],['ao','\uA735]'],['au','\uA737]'],['av','\uA739\uA73B]'],['ay','\uA73D]'],['b','\u0062\u24D1\uFF42\u1E03\u1E05\u1E07\u0180\u0183\u0253]'],['c','\u0063\u24D2\uFF43\u0107\u0109\u010B\u010D\u00E7\u1E09\u0188\u023C\uA73F\u2184]'],['d','\u0064\u24D3\uFF44\u1E0B\u010F\u1E0D\u1E11\u1E13\u1E0F\u0111\u018C\u0256\u0257\uA77A]'],['dz','\u01F3\u01C6]'],['e','\u0065\u24D4\uFF45\u00E8\u00E9\u00EA\u1EC1\u1EBF\u1EC5\u1EC3\u1EBD\u0113\u1E15\u1E17\u0115\u0117\u00EB\u1EBB\u011B\u0205\u0207\u1EB9\u1EC7\u0229\u1E1D\u0119\u1E19\u1E1B\u0247\u025B\u01DD]'],['f','\u0066\u24D5\uFF46\u1E1F\u0192\uA77C]'],['g','\u0067\u24D6\uFF47\u01F5\u011D\u1E21\u011F\u0121\u01E7\u0123\u01E5\u0260\uA7A1\u1D79\uA77F]'],['h','\u0068\u24D7\uFF48\u0125\u1E23\u1E27\u021F\u1E25\u1E29\u1E2B\u1E96\u0127\u2C68\u2C76\u0265]'],['hv','\u0195]'],['i','\u0069\u24D8\uFF49\u00EC\u00ED\u00EE\u0129\u012B\u012D\u00EF\u1E2F\u1EC9\u01D0\u0209\u020B\u1ECB\u012F\u1E2D\u0268\u0131]'],['j','\u006A\u24D9\uFF4A\u0135\u01F0\u0249]'],['k','\u006B\u24DA\uFF4B\u1E31\u01E9\u1E33\u0137\u1E35\u0199\u2C6A\uA741\uA743\uA745\uA7A3]'],['l','\u006C\u24DB\uFF4C\u0140\u013A\u013E\u1E37\u1E39\u013C\u1E3D\u1E3B\u017F\u0142\u019A\u026B\u2C61\uA749\uA781\uA747]'],['lj','\u01C9]'],['m','\u006D\u24DC\uFF4D\u1E3F\u1E41\u1E43\u0271\u026F]'],['n','\u006E\u24DD\uFF4E\u01F9\u0144\u00F1\u1E45\u0148\u1E47\u0146\u1E4B\u1E49\u019E\u0272\u0149\uA791\uA7A5]'],['nj','\u01CC]'],['o','\u006F\u24DE\uFF4F\u00F2\u00F3\u00F4\u1ED3\u1ED1\u1ED7\u1ED5\u00F5\u1E4D\u022D\u1E4F\u014D\u1E51\u1E53\u014F\u022F\u0231\u00F6\u022B\u1ECF\u0151\u01D2\u020D\u020F\u01A1\u1EDD\u1EDB\u1EE1\u1EDF\u1EE3\u1ECD\u1ED9\u01EB\u01ED\u00F8\u01FF\u0254\uA74B\uA74D\u0275]'],['oi','\u01A3]'],['ou','\u0223]'],['oo','\uA74F]'],['p','\u0070\u24DF\uFF50\u1E55\u1E57\u01A5\u1D7D\uA751\uA753\uA755]'],['q','\u0071\u24E0\uFF51\u024B\uA757\uA759]'],['r','\u0072\u24E1\uFF52\u0155\u1E59\u0159\u0211\u0213\u1E5B\u1E5D\u0157\u1E5F\u024D\u027D\uA75B\uA7A7\uA783]'],['s','\u0073\u24E2\uFF53\u00DF\u015B\u1E65\u015D\u1E61\u0161\u1E67\u1E63\u1E69\u0219\u015F\u023F\uA7A9\uA785\u1E9B]'],['t','\u0074\u24E3\uFF54\u1E6B\u1E97\u0165\u1E6D\u021B\u0163\u1E71\u1E6F\u0167\u01AD\u0288\u2C66\uA787]'],['tz','\uA729]'],['u','\u0075\u24E4\uFF55\u00F9\u00FA\u00FB\u0169\u1E79\u016B\u1E7B\u016D\u00FC\u01DC\u01D8\u01D6\u01DA\u1EE7\u016F\u0171\u01D4\u0215\u0217\u01B0\u1EEB\u1EE9\u1EEF\u1EED\u1EF1\u1EE5\u1E73\u0173\u1E77\u1E75\u0289]'],['v','\u0076\u24E5\uFF56\u1E7D\u1E7F\u028B\uA75F\u028C]'],['vy','\uA761]'],['w','\u0077\u24E6\uFF57\u1E81\u1E83\u0175\u1E87\u1E85\u1E98\u1E89\u2C73]'],['x','\u0078\u24E7\uFF58\u1E8B\u1E8D]'],['y','\u0079\u24E8\uFF59\u1EF3\u00FD\u0177\u1EF9\u0233\u1E8F\u00FF\u1EF7\u1E99\u1EF5\u01B4\u024F\u1EFF]'],['z','\u007A\u24E9\uFF5A\u017A\u1E91\u017C\u017E\u1E93\u1E95\u01B6\u0225\u0240\u2C6C\uA763]']];var __diacriticsMap={};__diacritics.forEach(function(diacritic){var letters=diacritic[1].split('');letters.forEach(function(letter){__diacriticsMap[letter]=diacritic[0];});});append('removeDiacritics',function(){return this.replace(/[^\u0020-\u007E]/g,function(a){return __diacriticsMap[a]||a;});});append('format',function(){function pad(str,len,chr,leftJustify){var padding=(str.length>=len)?'':Array(1+len-str.length>>>0).join(chr);return leftJustify?str+padding:padding+str;}
function thousand_separate(value){var value_str=String(value);for(var i=10;i>0;i--){if(value_str===(value_str=value_str.replace(/^(\d+)(\d{3})/,"$1"+thousandsSeparator+"$2"))){break;}}
return value_str;}
function justify(value,prefix,leftJustify,minWidth,zeroPad,htmlSpace){var diff=minWidth-value.length;if(diff>0){var spchar=' ';if(htmlSpace){spchar='&nbsp;';}
if(leftJustify||!zeroPad){value=pad(value,minWidth,spchar,leftJustify);}else{value=value.slice(0,prefix.length)+pad('',diff,'0',true)+value.slice(prefix.length);}}
return value;}
function formatBaseX(value,base,prefix,leftJustify,minWidth,precision,zeroPad,htmlSpace){var number=value>>>0;prefix=(prefix&&number&&{'2':'0b','8':'0','16':'0x'}[base])||'';value=prefix+pad(number.toString(base),precision||0,'0',false);return justify(value,prefix,leftJustify,minWidth,zeroPad,htmlSpace);}
function formatString(value,leftJustify,minWidth,precision,zeroPad,htmlSpace){if(precision!=null){value=value.slice(0,precision);}
return justify(value,'',leftJustify,minWidth,zeroPad,htmlSpace);}
var a=arguments,i=0;var thousandsSeparator=',';var decimalMark='.';var regex=/%%|%(\d+\$)?([-+#0&\' ]*)(\*\d+\$|\*|\d+)?(\.(\*\d+\$|\*|\d+))?([nAscboxXuidfegpEGP])/g;if(a.length===1&&Array.isArray(a[0])){a=a[0];}
var fmt=String(this);return fmt.replace(regex,function(substring,valueIndex,flags,minWidth,_,precision,type){if(substring==='%%'){return'%';}
var leftJustify=false,positivePrefix='',zeroPad=false,prefixBaseX=false,htmlSpace=false,thousandSeparation=false;flags=flags||'';for(var j=0;j<flags.length;j++){switch(flags.charAt(j)){case' ':positivePrefix=' ';break;case'+':positivePrefix='+';break;case'-':leftJustify=true;break;case'0':zeroPad=true;break;case'#':prefixBaseX=true;break;case'&':htmlSpace=true;break;case'\'':thousandSeparation=true;break;}}
if(!minWidth){minWidth=0;}else if(minWidth==='*'){minWidth=+a[i++];}else if(minWidth.charAt(0)==='*'){minWidth=+a[minWidth.slice(1,-1)];}else{minWidth=+minWidth;}
if(minWidth<0){minWidth=-minWidth;leftJustify=true;}
if(!isFinite(minWidth)){throw new Error('String.sprintf: (minimum-)width must be finite');}
if(!precision){precision='fFeE'.indexOf(type)>-1?6:(type==='d')?0:void(0);}else if(precision==='*'){precision=+a[i++];}else if(precision.charAt(0)==='*'){precision=+a[precision.slice(1,-1)];}else{precision=+precision;}
var value=valueIndex?a[valueIndex.slice(0,-1)]:a[i++];var number,prefix,number_str,textTransform,method;switch(type){case's':{if(value==null){return'';}
return formatString(String(value),leftJustify,minWidth,precision,zeroPad,htmlSpace);}
case'c':return formatString(String.fromCharCode(+value),leftJustify,minWidth,precision,zeroPad,htmlSpace);case'b':return formatBaseX(value,2,prefixBaseX,leftJustify,minWidth,precision,zeroPad,htmlSpace);case'o':return formatBaseX(value,8,prefixBaseX,leftJustify,minWidth,precision,zeroPad,htmlSpace);case'x':return formatBaseX(value,16,prefixBaseX,leftJustify,minWidth,precision,zeroPad,htmlSpace);case'X':return formatBaseX(value,16,prefixBaseX,leftJustify,minWidth,precision,zeroPad,htmlSpace).toUpperCase();case'u':return formatBaseX(value,10,prefixBaseX,leftJustify,minWidth,precision,zeroPad,htmlSpace);case'i':{number=parseInt(+value,10);if(isNaN(number)){return'';}
prefix=number<0?'-':positivePrefix;number_str=thousandSeparation?thousand_separate(String(Math.abs(number))):String(Math.abs(number));value=prefix+pad(number_str,precision,'0',false);return justify(value,prefix,leftJustify,minWidth,zeroPad,htmlSpace);}
case'd':{number=Math.round(+value);if(isNaN(number)){return'';}
prefix=number<0?'-':positivePrefix;number_str=thousandSeparation?thousand_separate(String(Math.abs(number))):String(Math.abs(number));value=prefix+pad(number_str,precision,'0',false);return justify(value,prefix,leftJustify,minWidth,zeroPad,htmlSpace);}
case'e':case'E':case'f':case'F':case'g':case'G':{number=+value;if(isNaN(number)){return'';}
prefix=number<0?'-':positivePrefix;method=['toExponential','toFixed','toPrecision']['efg'.indexOf(type.toLowerCase())];textTransform=['toString','toUpperCase']['eEfFgG'.indexOf(type)%2];number_str=Math.abs(number)[method](precision);number_str=thousandSeparation?thousand_separate(number_str):number_str;value=prefix+number_str;var justified=justify(value,prefix,leftJustify,minWidth,zeroPad,htmlSpace)[textTransform]();if(decimalMark!=='.'&&decimalMark!==thousandsSeparator){return justified.replace(/\./,decimalMark);}else{return justified;}}
case'p':case'P':{number=+value;if(isNaN(number)){return'';}
prefix=number<0?'-':positivePrefix;var parts=String(Number(Math.abs(number)).toExponential()).split(/e|E/);var sd=(parts[0].indexOf('.')!==-1)?parts[0].length-1:parts[0].length;var zeros=(parts[1]<0)?-parts[1]-1:0;if(Math.abs(number)<1){if(sd+zeros<=precision){value=prefix+Math.abs(number).toPrecision(sd);}else{if(sd<=precision-1){value=prefix+Math.abs(number).toExponential(sd-1);}else{value=prefix+Math.abs(number).toExponential(precision-1);}}}else{var prec=(sd<=precision)?sd:precision;value=prefix+Math.abs(number).toPrecision(prec);}
textTransform=['toString','toUpperCase']['pP'.indexOf(type)%2];return justify(value,prefix,leftJustify,minWidth,zeroPad,htmlSpace)[textTransform]();}
case'n':return'';default:return substring;}});});})();(function(){"use strict";var EPSILON=1e-6;var RADIAN_RATIO=(Math.PI/180);function degToRad(angle){return angle*RADIAN_RATIO;}
function radToDeg(angle){return angle/RADIAN_RATIO;}
function clamp(value,lower,upper){var hasLower=_.isNumber(lower);var hasUpper=_.isNumber(upper);if(hasLower&&hasUpper&&lower>upper){return clamp(value,upper,lower);}
value=hasUpper?(upper>value?value:upper):value;return hasLower?(lower<value?value:lower):value;}
function absRound(value){return(0.5+value)<<0;}
function scaleRound(value,precision){var scale=Math.pow(10,precision||0);return Math.round(value*scale)/scale;}
function scaleTrunc(value,precision){var scale=Math.pow(10,precision||0);return Math.trunc(value*scale)/scale;}
function toNumber(value){return+value;}
_.mixin({EPSILON:EPSILON,absRound:absRound,clamp:clamp,scaleRound:scaleRound,scaleTrunc:scaleTrunc,toRadian:degToRad,toDegree:radToDeg,toNumber:toNumber});}());(function(){"use strict";var __namedColors={black:"#000000",silver:"#c0c0c0",gray:"#808080",white:"#ffffff",maroon:"#800000",red:"#ff0000",purple:"#800080",fuchsia:"#ff00ff",green:"#008000",lime:"#00ff00",olive:"#808000",yellow:"#ffff00",navy:"#000080",blue:"#0000ff",teal:"#008080",aqua:"#00ffff",orange:"#ffa500"};function parseCSSColorName(value,cached){var hex=__namedColors[value];if(hex===undefined){var ctx=document.createElement('canvas').getContext('2d');ctx.fillStyle=value;hex=ctx.fillStyle;if(hex==='#000000'&&value.toLowerCase()!=='black'){throw new Error('"${0}" is not a valid css named color'.template([value]));}
__namedColors[value]=hex;}
return hex;}
window.RGBColor=function(value){if(Object.isString(value)){value=value.toLowerCase();if(value.startsWith('#')){this.hex(value);}else if(value.startsWith('rgb(')){this.rgb(value);}else if(value.match(/[a-z]+$/)){this.hex(parseCSSColorName(value));}else{throw new Error('"${0}" is not a RGB css value'.template([value]));}}else if(isFinite(value)){this.decimal(value);}else if(Array.isArray(value)){this.rgb(value);}else if(value instanceof RGBColor){this.set(value);}else{this.set(Object.assign({r:0,g:0,b:0},value));}};RGBColor.prototype={clone:function(){return new RGBColor(this);},set:function(color){this.r=Math.trunc(color.r||0);this.g=Math.trunc(color.g||0);this.b=Math.trunc(color.b||0);return this;},get:function(){return{r:this.r,g:this.g,b:this.b};},toString:function(){return'#'+this.hex();},rgb:function(value){if(value===undefined){return'rgb('+[this.r,this.g,this.b].join(',')+')';}
if(Object.isString(value)){value=value.toLowerCase();if(value.startsWith('rgb(')){return this.rgb(value.slice(4,value.length-1).split(',').map(parseFloat));}else{throw new Error('"${0}" is not a RGB css value'.template([value]));}}else if(Array.isArray(value)){this.set({r:value[0],g:value[1],b:value[2]});}else{throw new Error('"${0}" is not a RGB css value'.template([value]));}
return this;},hex:function(value){if(value===undefined){var hex=this.decimal().toString(16);hex='000000'.substr(0,6-hex.length)+hex;return hex.toUpperCase();}
if(Object.isString(value)&&value.match(/^(#)?[0-9a-f]{6,6}$/i)){value=parseInt((value.indexOf('#')===0?value.substring(1):value),16);}else{throw new Error('"${0}" is not a RGB hexadecimal value'.template([value]));}
return this.decimal(value);},decimal:function(value){if(value===undefined){return((this.r<<16)+(this.g<<8)+this.b);}
if(isFinite(value)&&value>=0&&value<=0xFFFFFF){this.r=value>>16;this.g=(value&0x00FF00)>>8;this.b=(value&0x0000FF);}else{throw new Error('"${0}" is not a RGB decimal value'.template([value]));}
return this;},hsl:function(){var r=this.r/255;var g=this.g/255;var b=this.b/255;var max=Math.max(r,g,b);var min=Math.min(r,g,b);var lightness=(max+min)/2;var brightness=max;var hue=0;var saturation=0;if(max===min){return{h:0,s:0,l:_.absRound(lightness*100),b:_.absRound(brightness*100)};};var d=max-min;saturation=d/((lightness<=0.5)?(max+min):(2-d));if(max===r){hue=(g-b)/d+(g<b?6:0);}else if(max===g){hue=((b-r)/d+2);}else{hue=((r-g)/d+4);}
hue=hue/6;return{h:_.absRound(hue*360),s:_.absRound(saturation*100),l:_.absRound(lightness*100),b:_.absRound(brightness*100)};},lightness:function(){var r=this.r/255;var g=this.g/255;var b=this.b/255;var max=Math.max(r,g,b);var min=Math.min(r,g,b);var lightness=(max+min)/2;return _.absRound(lightness*100);},intensity:function(gamma){gamma=gamma||2.2;var r=Math.pow(this.r/255,gamma);var g=Math.pow(this.g/255,gamma);var b=Math.pow(this.b/255,gamma);var l=0.212671*r+0.715160*g+0.072169*b;return _.clamp(_.scaleRound(l,3),0,1);},grayscale:function(gamma){var c=_.clamp(this.intensity(gamma)*255,0,255);return new RGBColor({r:c,g:c,b:c});},contrast:function(color,gamma){var l1=this.intensity(gamma);var l2=new RGBColor(color).intensity(gamma);var c=(Math.max(l1,l2)+0.05)/(Math.min(l1,l2)+0.05);return _.clamp(_.scaleRound(c,3),1,21);},isDark:function(gamma){return this.contrast(0,gamma)<10;},foreground:function(gamma){return this.isDark(gamma)?new RGBColor(0xFFFFFF):new RGBColor(0x000000);}};}());(function(){"use strict";var __eval=function(value){return Object.isFunc(value)?value():value;};var __isTypeOf=function(value,expected){if(Object.isString(expected)){return Object.isType(value,expected);}else if(expected===Array){return Array.isArray(value);}else{return(value instanceof expected);}};var __fmtType=function(value){if(Object.isString(value)){return value;}else if(value===String){return'String';}else if(value===Array){return'Array';}else if(Object.isFunc(value)){var name=(String(value).match(/function[\s]*(.*)[\s]*\(/)||['',''])[1];return Object.isEmpty(name)?value:name+'()';}else{return String(value);}};window.Assert={that:function(test,message,context){if(Boolean(__eval(test))===false){throw new Error((message||'assertion failed').template(context||{}));}},not:function(test,message,context){if(Boolean(__eval(test))===true){throw new Error((message||'assertion failed').template(context||{}));}},notThrown:function(test,message,context){try{return test();}catch(e){throw new Error((message||'${error}').template(Object.assign({error:e.message},context||{})));}},in:function(value,data,message,context){message=message||"${value} is not in the collection";context=Object.assign({},context||{},{value:value});if(Array.isArray(data)||Object.isString(data)){Assert.that(data.indexOf(value)!==-1,message,context);}else{Assert.that(value in data,message,context);}
return value;},notIn:function(value,data,message,context){message=message||"${value} should not be in the collection";context=Object.assign({},context||{},{value:value});if(Array.isArray(data)||Object.isString(data)){Assert.that(data.indexOf(value)===-1,message,context);}else{Assert.that((value in data)===false,message,context);}
return value;},is:function(value,expected,message,context){message=message||'${value} is not a ${expected}';context=Object.assign({},context||{},{value:Object.isString(value)?'"'+value+'"':value,expected:__fmtType(expected)});Assert.that(__isTypeOf(value,expected),message,context);return value;},isAnyOf:function(value,expected,message,context){message=message||'${value} is none of [${expected}]';context=Object.assign({},context||{},{value:Object.isString(value)?'"'+value+'"':value,expected:expected.map(__fmtType).join(', ')});Assert.is(expected,Array,'expected type list must be an array');var matches=expected.filter(function(expected){return __isTypeOf(value,expected);});Assert.that(matches.length>0,message,context);return value;}};}());(function(){"use strict";function __import(module,path){var output=module;var pwd=[];var splitPath=Array.isArray(path)?path:path.split('.');splitPath.forEach(function(key){Assert.that(key in output,'"${key}" is not a property of ${pwd}',{key:key,pwd:String(module)+(Object.isEmpty(pwd)?'':'.'+pwd.join('.'))});output=output[key];pwd.push(key);});return output;}
function __export(module,path,value){var splitPath=path.split('.');var target=__import(module,splitPath.slice(0,splitPath.length-1));target[splitPath[splitPath.length-1]]=value;};window.FunctionFaker=function(options){if(Object.isFunc(options)){options={instance:null,method:options};}else{options=options||{};}
var method=options.method||function(){};var origin=null;var property=null;var follow=options.follow||false;if(Object.isFunc(method)){origin=method;}else if(Object.isString(method)){property=method;origin=__import(options.instance||window,method);}else{throw new Error('"${method}" is not a function nor a path'.template({method:method}));}
Assert.that(Object.isFunc(origin),'"${method}" is not a function',{method:method});this._calls=[];this._instance=options.instance;this._origin=origin;this._property=property;this._follow=follow;this.callable=options.callable;this.result=options.result;};FunctionFaker.prototype={reset:function(){this._calls=[];return this;},called:function(){return this._calls.length>0;},calls:function(mapper){if(Object.isFunc(mapper)){return this._calls.map(mapper);}else{return this._calls.slice();}},count:function(){return this._calls.length;},_makeWrapper:function(){var faker=this;return function(){var args=Array.from(arguments);faker._calls.push(args);if(faker._follow){return faker._origin.apply(faker._instance,args);}else if(Object.isFunc(faker.callable)){return faker.callable.apply(faker._instance,args);}else{return faker.result;}};},wrap:function(){if(this._wrapper===undefined){this._wrapper=this._makeWrapper().bind(this._instance);if(this._property){__export(this._instance||window,this._property,this._wrapper);}}
return this._wrapper;},unwrap:function(){if(this._wrapper){if(this._property){__export(this._instance||window,this._property,this._origin);}
delete this._wrapper;}
return this;},'with':function(callable){try{callable(this,this.wrap());}finally{this.unwrap();}
return this;}};window.PropertyFaker=function(options){options=options||{};Assert.not(Object.isNone(options.instance),'Cannot fake property of undefined or null');this._instance=options.instance;this._properties=options.props||{};};PropertyFaker.prototype={'with':function(callable){var origin={};var fakes={};var newKeys=[];var instance=this._instance;for(var key in this._properties){var prop=Object.getOwnPropertyDescriptor(instance,key);var fake={value:this._properties[key],writable:false,enumerable:false,configurable:true};if(prop===undefined){newKeys.push(key);}else{origin[key]=prop;fake.writable=prop.writable;fake.enumerable=prop.enumerable;fake.configurable=prop.configurable;}
fakes[key]=fake;}
try{Object.defineProperties(instance,fakes);callable(this);}finally{Object.defineProperties(instance,origin);newKeys.forEach(function(key){delete instance[key];});}
return this;}};window.DateFaker=function(value){Assert.that(Object.isString(value)||Object.isSubClassOf(value,Date),'The value must be either a string or a Date',{value:value});try{if(Object.isString(value)){this.frozen=new Date(value).toISOString();}else{this.frozen=value.toISOString();}}catch(e){throw new Error('The value "${value}" is not a valid date'.template({value:value}));}};window.DateFaker.prototype={'with':function(callable){var NativeDate=window.Date;var frozen=this.frozen;try{window.Date=function(value){if(arguments.length>1){var D=NativeDate.bind.apply(NativeDate,[null].concat(Array.from(arguments)));return new D();}
return new NativeDate(value||frozen);};window.Date.now=function(){return new NativeDate(frozen);};window.Date.parse=NativeDate.parse;window.Date.UTC=NativeDate.UTC;callable(this);}finally{window.Date=NativeDate;}
return this;}};}());(function(){"use strict";window.BrowserVersion={match:function(pattern,version){var versionParts=(version||'').split('.').map(parseInt);var matches=pattern.match(/^(==|<|>|<=|>=)?([0-9]+)$/);if(!(matches&&matches.length===3)){return false;}
var operator=matches[1]||'==';var value=parseInt(matches[2]);switch(operator){case'==':return versionParts[0]===value;case'<=':return versionParts[0]<=value;case'>=':return versionParts[0]>=value;case'<':return versionParts[0]<value;case'>':return versionParts[0]>value;}},isIE:function(pattern){var parts=(window.navigator.appVersion||'').match(/MSIE ([0-9\.]+)/);if(!(parts&&parts.length===2)){return false;}
return pattern?BrowserVersion.match(pattern,parts[1]):true;},isChrome:function(pattern){var userAgent=window.navigator.userAgent||'';if(!!window.chrome||/HeadlessChrome/.test(userAgent)){var parts=userAgent.match(/Chrom(?:e|ium)\/([0-9\.]+)/);if(!(parts&&parts.length===2)){return false;}
return pattern?BrowserVersion.match(pattern,parts[1]):true;}else{return false;}},isHeadless:function(){var userAgent=window.navigator.userAgent||'';return(/HeadlessChrome/.test(userAgent)||!!window.navigator.webdriver);},isFirefox:function(pattern){var userAgent=window.navigator.userAgent||'';if('MozAppearance'in document.documentElement.style){var parts=userAgent.match(/(?:Firefox)\/([0-9\.]+)/);if(!(parts&&parts.length===2)){return false;}
return pattern?BrowserVersion.match(pattern,parts[1]):true;}else{return false;}}};}());(function(){"use strict";function decodeURLSearchData(search){search=search.replace(/^\?/,'');var searchData={};if(search){var query=search.split('&');query.forEach(function(e){var item=e.split('=');var key=decodeURIComponent(item[0]);var value=decodeURIComponent(item[1]);_.append(searchData,key,value);});}
return searchData;};function decodeURLSearchParams(params){var data={};params.forEach(function(value,key){_.append(data,key,value);});return data;}
function toURLSearchParams(data){if(data instanceof URLSearchParams){return data;}else if(_.isString(data)){return new URLSearchParams(data);}
var params=new URLSearchParams();Object.entries(data||{}).forEach(function(e){var key=e[0],value=e[1];if(Array.isArray(value)){if(value.length>0){value.forEach(function(item){params.append(key,item);});}}else if(value!==null&&value!==undefined){params.append(key,value);}});return params;}
function toFormData(data){if(data instanceof FormData){return data;}else if(data instanceof HTMLFormElement){return new FormData(data);}else{return assignFormData(new FormData(),data);}}
function assignFormData(params,data){Object.entries(data||{}).forEach(function(e){var key=e[0],value=e[1];if(value instanceof Set){value=Array.from(value);}
if(Array.isArray(value)){params.delete(key);if(value.length>0){value.forEach(function(item){params.append(key,item);});}}else if(value!==null&&value!==undefined){params.set(key,value);}});return params;}
window.RelativeURL=function(url){this._link=document.createElement('a');this._link.href=(url instanceof URL)?url.toString():url;};window.RelativeURL.prototype={_property:function(name,value){if(value===undefined){return this._link[name];}
this._link[name]=value;return this;},href:function(href){return this._property('href',href);},fullPath:function(){return this._link.pathname+this._link.search+this._link.hash;},username:function(username){return this._property('username',username);},password:function(password){return this._property('password',password);},protocol:function(protocol){return this._property('protocol',protocol);},host:function(host){return this._property('host',host);},hostname:function(hostname){return this._property('hostname',hostname);},port:function(port){return this._property('port',port);},pathname:function(pathname){return this._property('pathname',pathname);},search:function(search){if(search===undefined){return this._link.search;}
search=(search instanceof URLSearchParams)?search.toString():search;this._link.search=search;return this;},hash:function(hash){return this._property('hash',hash);},properties:function(){var url=this._link;return{href:url.href,username:url.username,password:url.password,protocol:url.protocol,host:url.host,hostname:url.hostname,port:url.port,pathname:url.pathname,search:url.search,searchData:decodeURLSearchData(url.search),hash:url.hash};},searchParams:function(params){if(params===undefined){return new URLSearchParams(this._link.search);}
this._link.search=toURLSearchParams(params).toString();},searchData:function(data){if(data===undefined){return decodeURLSearchData(this._link.search);}
this._link.search=toURLSearchParams(data).toString();return this;},updateSearchData:function(data){var entries=(data instanceof URLSearchParams)?decodeURLSearchParams(data):data;var origin=this.searchData();var params=toURLSearchParams(Object.assign(origin,entries));this._link.search=params.toString();return this;},toString:function(){return this._link.toString();}};_.mixin({toRelativeURL:function(url){return new window.RelativeURL(url);},urlAsDict:function(url){return new window.RelativeURL(url).properties();},toURLSearchParams:toURLSearchParams,decodeURLSearchData:decodeURLSearchData,decodeURLSearchParams:decodeURLSearchParams,encodeURLSearch:function(data){return _.toURLSearchParams(data).toString();},toFormData:toFormData,assignFormData:assignFormData});}());creme=window.creme||{};(function($){"use strict";creme.utils=creme.utils||{};creme.utils.openWindow=function(url,name,params){window[name]=window.open(url,name,params||'menubar=no, status=no, scrollbars=yes, menubar=no, width=800, height=600');};creme.utils.reload=function(){window.location.replace(window.location.href);};creme.utils.redirect=function(url){window.location.assign(url);};creme.utils.locationRelativeUrl=function(){return _.toRelativeURL(window.location.href).fullPath();};creme.utils.goTo=function(url,data){if(Object.isEmpty(data)){creme.utils.redirect(url);}else{var urlinfo=_.toRelativeURL(url);if(Object.isString(data)){data=_.decodeURLSearchData(data);}
urlinfo.searchData($.extend({},urlinfo.searchData(),data));creme.utils.redirect(urlinfo.href());}};creme.utils.scrollTo=function(element){if(Object.isNone(element)===false){var outer_height=$('.header-menu').outerHeight();var position=$.extend({left:0,top:0},$(element).position());window.scrollTo(position.left,position.top-outer_height);}};creme.utils.scrollBack=function(position,speed){if(Object.isNone(position)){return document.body.scrollTop||document.documentElement.scrollTop;}
speed=speed||0;if(speed!==0){$(document.body).animate({scrollTop:position},speed);$(document.documentElement).animate({scrollTop:position},speed);}else{document.body.scrollTop=position;document.documentElement.scrollTop=position;}};creme.utils.showErrorNReload=function(delay){delay=Object.isNone(delay)?3000:delay;var dialog=creme.dialogs.warning('<p><b>'+gettext("Error!")+'</b></p><p>'+gettext("The page will be reloaded!")+'</p>').onClose(function(){clearTimeout(timeout);creme.utils.reload();});var timeout=setTimeout(function(){dialog.close();});dialog.open();};creme.utils.ajaxQuery=function(url,options,data){options=$.extend({action:'get',warnOnFail:true},options||{});var action=new creme.component.Action(function(){var self=this;var query=creme.ajax.query(url,options,data);var _fail=function(data,error){self.fail(data,error);if(options.reloadOnFail){creme.utils.reload();}};var _success=function(result){self.done(result);if(options.reloadOnSuccess){creme.utils.reload();}};query.onFail(function(event,data,error){if(options.warnOnFail){var message=Object.isString(data)?data:(error.message||gettext("Error"));creme.dialogs.error(message,{title:options.warnOnFailTitle},error).onClose(function(){_fail(data,error);}).open();}else{_fail(data,error);}}).onDone(function(event,result){if(options.messageOnSuccess){creme.dialogs.html('<p>%s</p>'.format(options.messageOnSuccess)).onClose(function(){_success(result);}).open();}else{_success(result);}});if(options.confirm){var confirmMessage=Object.isString(options.confirm)?options.confirm:gettext("Are you sure?");creme.dialogs.confirm('<h4>%s</h4>'.format(confirmMessage)).onOk(function(){query.start();}).onClose(function(){self.cancel();}).open({width:250,height:150});}else{query.start();}},options);return action;};creme.utils.isHTMLDataType=function(dataType){return Object.isString(dataType)&&['html','text/html'].indexOf(dataType.toLowerCase())!==-1;};creme.utils.clickOnce=function(element,func){element=$(element);if(element.is(':not(.clickonce')&&Object.isFunc(func)){element.addClass('clickonce');return func.apply(this,Array.from(arguments).slice(2));}else{return false;}};creme.utils.jQueryToMomentDateFormat=function(format){return format.replace(/y+/g,function(match){return match.length>1?'YYYY':'YY';}).replace(/d+/g,function(match){return match.length>1?'DD':'D';}).replace(/m+/g,function(match){return match.length>1?'MM':'M';});};}(jQuery));(function($){"use strict";creme.forms={};creme.forms.TimePicker={};creme.forms.TimePicker.init=function(self){var time=creme.forms.TimePicker.timeval(self);var disabled=$('input[type="hidden"]',self).is('[disabled]');$('li.hour input[type="number"]',self).val(time.hour);$('li.minute input[type="number"]',self).val(time.minute);if(disabled){$('li input[type="number"]',self).prop('disabled',true);$('li button',self).prop('disabled',true);}else{$('li input[type="number"]',self).on('change',function(){creme.forms.TimePicker.update(self);});$('li button',self).on('click',function(){var now=new Date();creme.forms.TimePicker.set(self,now.getHours(),now.getMinutes());});}};creme.forms.TimePicker.parseTime=function(value){var values=(value!==undefined)?value.split(':'):[];var hour=(values.length>1)?values[0]:'';var minute=(values.length>1)?values[1]:'';return{hour:hour,minute:minute};};creme.forms.TimePicker.val=function(self){return $('input[type="hidden"]',self).val();};creme.forms.TimePicker.timeval=function(self){return creme.forms.TimePicker.parseTime($('input[type="hidden"]',self).val());};creme.forms.TimePicker.update=function(self){var hour=$('li.hour input[type="number"]',self).val();var minute=$('li.minute input[type="number"]',self).val();$('input[type="hidden"]',self).val(hour+':'+minute);};creme.forms.TimePicker.clear=function(self){$('li.hour input[type="number"]',self).val('');$('li.minute input[type="number"]',self).val('');$('input[type="hidden"]',self).val('');};creme.forms.TimePicker.set=function(self,hour,minute){$('li.hour input[type="number"]',self).val(hour);$('li.minute input[type="number"]',self).val(minute);$('input[type="hidden"]',self).val(hour+':'+minute);};creme.forms.DateTimePicker={};creme.forms.DateTimePicker.init=function(self,format){format=format||'yy-mm-dd';var datetime=creme.forms.DateTimePicker.datetimeval(self);$('li.date input[type="text"]',self).val(datetime.date);$('li.hour input[type="number"]',self).val(datetime.hour);$('li.minute input[type="number"]',self).val(datetime.minute);$('li input:not([type="hidden"])',self).on('change propertychange keyup input paste',function(){creme.forms.DateTimePicker.update(self);});$('li.now button',self).on('click',function(e){e.preventDefault();creme.forms.DateTimePicker.setDate(self,new Date());});$('li.clear button',self).on('click',function(e){e.preventDefault();creme.forms.DateTimePicker.clear(self);});$('li.date input[type="text"]',self).datepicker({dateFormat:format,showOn:"button",buttonText:gettext("Calendar"),buttonImage:creme_media_url("images/icon_calendar.gif"),buttonImageOnly:true});};creme.forms.DateTimePicker.val=function(self){return $('input[type="hidden"]',self).val();};creme.forms.DateTimePicker.datetimeval=function(self){return creme.forms.DateTimePicker.parseDateTime($('input[type="hidden"]',self).val());};creme.forms.DateTimePicker.parseDateTime=function(value){var values=(value!==undefined)?value.split(' '):[];var date=(values.length>1)?values[0]:'';var time=creme.forms.TimePicker.parseTime((values.length>1)?values[1]:'');return $.extend({date:date},time);};creme.forms.DateTimePicker.update=function(self){var date=$('li.date input[type="text"]',self).val();var hour=$('li.hour input[type="number"]',self).val();var minute=$('li.minute input[type="number"]',self).val();$('input[type="hidden"]',self).val(date+' '+hour+':'+minute);};creme.forms.DateTimePicker.clear=function(self){$('li.date input[type="text"]',self).val('');$('li.hour input[type="number"]',self).val('');$('li.minute input[type="number"]',self).val('');$('input[type="hidden"]',self).val('');};creme.forms.DateTimePicker.setDate=function(self,date){var hour=date.getHours();var minute=date.getMinutes();$('li.date input[type="text"]',self).datepicker('setDate',date);$('li.hour input[type="number"]',self).val(hour);$('li.minute input[type="number"]',self).val(minute);creme.forms.DateTimePicker.update(self);};creme.forms.DateTimePicker.set=function(self,year,month,day,hour,minute){creme.forms.DateTimePicker.setDate(self,new Date(year,month,day,hour,minute));};function __validateHTML5(element){var errors={};$('*:invalid',element).each(function(index,item){errors[$(this).prop('name')]=item.validationMessage;});return errors;}
creme.forms.initialize=function(form){if(form.is(':not(.is-form-active)')){form.addClass('is-form-active');$('input,select,textarea',form).on('invalid',function(e){this.scrollIntoView(false);$(e.target).addClass('is-field-invalid');});form.on('click','[type="submit"]',function(e){var button=$(this);if(button.is('[data-no-validate]')){form.attr('novalidate','novalidate');}
var isHtml5Valid=Object.isEmpty(__validateHTML5(form));if(isHtml5Valid===true){if(button.is(':not(.is-form-submit)')){button.addClass('is-form-submit');}else{e.preventDefault();}}}).on('submit',function(){form.find('[type="submit"]').addClass('is-form-submit');});creme.utils.scrollTo($('.errorlist:first, .non_field_errors',form));}};creme.forms.validateHtml5Field=function(field,options){options=options||{};var errors={};if(options.noValidate||field.is('[novalidate]')){return errors;}
if(field.is(':invalid')){var message=field.get(0).validationMessage||'';errors[$(field).prop('name')]=message;field.addClass('is-field-invalid');field.trigger('html5-invalid',[true,message]);}else{field.removeClass('is-field-invalid');field.trigger('html5-invalid',[false]);}
return errors;};creme.forms.validateHtml5Form=function(form,options){options=options||{};var errors={};var fieldOptions={noValidate:options.noValidate||form.is('[novalidate]')};var inputs=$('input, select, textarea, datalist, output',form);inputs.filter(':not([type="submit"])').trigger('html5-pre-validate',[options]);inputs.each(function(){$.extend(errors,creme.forms.validateHtml5Field($(this),fieldOptions));});return errors;};}(jQuery));(function($){"use strict";creme.object={invoke:function(){if(arguments.length===0){return;}
var cb=arguments[0];if(Object.isFunc(cb)){return cb.apply(this,Array.from(arguments).slice(1));}},delegate:function(){if(arguments.length<2){return;}
var delegate=arguments[0];var cb=arguments[1];if(Object.isEmpty(delegate)||typeof delegate!=='object'){return;}
if(Object.isString(cb)){cb=delegate[cb];}
if(Object.isFunc(cb)){return cb.apply(delegate,Array.from(arguments).slice(2));}},isFalse:function(value){return Object.isNone(value)||value===false;},isTrue:function(value){return!Object.isNone(value)&&value!==false;}};creme.widget={};creme.widget.Widget=function(){return{options:{},arguments:{},_create:function(element,options,cb,sync){},_destroy:function(element){},destroy:function(element){creme.widget.destroy(element);},isActive:function(element){return creme.widget.is_valid(element);},cleanedval:function(element){if(!this.isActive(element)){return null;}
var value=element.creme().widget().val();return creme.widget.cleanval(value,value);}};};$.extend(creme.widget,{_widgets:{},ready:function(root){var self=creme.widget;$('.ui-creme-widget.widget-auto',root).each(function(){self.create($(this));});},shutdown:function(root){var self=creme.widget;$('.ui-creme-widget.widget-ready',root).each(function(){self.destroy($(this));});},register:function(name,widget){creme.widget._widgets[name]=widget;},unregister:function(name){if(creme.widget._widgets[name]!==undefined){delete creme.widget._widgets[name];}},find:function(name){return creme.widget._widgets[name];},proxy:function(element,delegate){if(Object.isNone(delegate)){return;}
var widget={element:element,delegate:delegate,options:function(){return this.delegate.options;},arguments:function(){return this.delegate.arguments;}};(function(widget){$.each(widget.delegate,function(key,value){if(typeof value!=='function'||key.match('^_.*')!==null){return;}
widget[key]=function(){return value.apply(widget.delegate,[widget.element].concat(Array.from(arguments)));};});})(widget);return widget;},create:function(element,options,cb,sync){if(element.data('CremeWidget')!==undefined){return;}
var name=element.attr('widget');var widget=creme.widget.find(name);if(typeof widget!=='object'){console.warn('Widget "${name}" is not registered'.template({name:name||''}));return;}
var delegate=$.extend({},widget);delegate.options=creme.widget.parseopt(element,widget.options,options);delegate.arguments=creme.widget.parseattr(element,$.extend({'widget':'','class':''},delegate.options));var proxy=creme.widget.proxy(element,delegate);element.data('CremeWidget',proxy);element.addClass('widget-active');delegate._create(element,delegate.options,cb,sync,delegate.arguments);return proxy;},destroy:function(element){if(!creme.widget.is_valid(element)){return element;}
element.data('CremeWidget').delegate._destroy(element);element.removeData('CremeWidget');element.removeClass('widget-ready widget-active');return element;},declare:function(name,object,parent){var widget=$.extend(new creme.widget.Widget(),parent,object);creme.widget.register(name,widget);return widget;},parseattr:function(element,excludes){var attributes={};var index;if(element.length===0){return attributes;}
for(index=0;index<element[0].attributes.length;++index){var attr=element[0].attributes[index];attributes[attr.name]=attr.value;}
excludes=excludes||[];if(Array.isArray(excludes)){for(index in excludes){if(attributes[excludes[index]]!==undefined){delete attributes[excludes[index]];}}}else{for(var exclude in excludes){if(attributes[exclude]!==undefined){delete attributes[exclude];}}}
return attributes;},parseopt:function(element,defaults,options){var opts={};Object.keys(defaults||{}).forEach(function(name){var value=element.attr(name);if(value!==undefined){opts[name]=element.attr(name);}});opts=$.extend({},defaults,opts,options);return opts;},parseval:function(value,parser){if(Object.isString(value)&&Object.isFunc(parser)){try{return parser(value);}catch(e){return null;}}
return value;},cleanval:function(value,defaultval,parser){var cleanparser=(parser!==undefined)?parser:JSON.parse;var result=(typeof value==='object')?value:creme.widget.parseval(value,cleanparser);return(result!==null&&result!==undefined)?result:defaultval;},val:function(element,value){var widget=$(element).creme().widget()||$(element);if(value===undefined){return widget.val();}
return widget.val(value);},values_list:function(elements,data,parser){var values;if(data===undefined){values=[];elements.each(function(){values.push(creme.widget.val($(this)));});return values;}
values=creme.widget.parseval(data,parser);values=(values===null)?'':values;values=(!Array.isArray(values))?[values]:values;elements.each(function(index,element){var value=(index<values.length)?values[index]:'';creme.widget.val(element,value);});},input:function(element){var query='input.ui-creme-input.'+$(element).attr('widget');var inputs=$('input.ui-creme-input.'+$(element).attr('widget'),element);if($(element).is(query)){inputs.push(element);}
return inputs;},is_valid:function(element){if(Object.isEmpty(element)){return false;}
return Object.isFunc(element.data)&&!Object.isNone(element.data('CremeWidget'));}});$.fn.creme=function(){var self=$(this);return{widget:function(){return self.data('CremeWidget');},create:function(options,cb,sync){creme.widget.create(self,options,cb,sync);},destroy:function(){creme.widget.destroy(self);},isActive:function(){return creme.widget.is_valid(self);}};};$(document).ready(function(){creme.widget.ready();});}(jQuery));(function($){"use strict";var __frozenStatics=['prototype','__super__','sub','create'];creme.component={};creme.component.extend=function(Parent,content){Parent=Parent||Object;content=content||{};var prop;var NewClass=function(){if(this._init_){this._init_.apply(this,arguments);}else if(Parent.prototype._init_){Parent.prototype._init_.apply(this,arguments);}};NewClass.prototype=Object.create(Parent.prototype);NewClass.prototype.constructor=NewClass;NewClass.__super__=Parent.prototype;NewClass.sub=function(content){return creme.component.extend(NewClass,content);};for(prop in Parent){if(Parent.hasOwnProperty(prop)&&__frozenStatics.indexOf(prop)===-1){NewClass[prop]=Parent[prop];}}
for(prop in content){NewClass.prototype[prop]=content[prop];}
return NewClass;};creme.component.Component=creme.component.extend(Object,{_init_:function(){},_super_:function(constructor,method){if(method!==undefined){return constructor.prototype[method].apply(this,Array.from(arguments).slice(2));}
return Object.proxy(constructor.prototype,this);},is:function(constructor){return Object.isSubClassOf(this,constructor);}});}(jQuery));(function($){"use strict";creme.component=creme.component||{};creme.component.FactoryRegistry=creme.component.Component.sub({_init_:function(options){options=$.extend({strict:false,fallback:'_build_',builders:{}},options||{});this._strict=options.strict||false;this._builders={};this.fallback(options.fallback);this.registerAll(options.builders);},fallback:function(fallback){if(fallback===undefined){return this._fallback;}
if(Object.isFunc(fallback)){this._fallbackPrefix=null;this._fallback=fallback.bind(this);}else if(Object.isString(fallback)&&Object.isEmpty(fallback)===false){this._fallbackPrefix=fallback;this._fallback=function(key){key=key.replace(/\-/g,'_').toLowerCase();return this[fallback+key];}.bind(this);}else if(fallback===null){this._fallbackPrefix=null;this._fallback=null;}else{throw new Error("invalid fallback builder",fallback);}
return this;},registerAll:function(builders){builders=builders||{};var registered=[];if(Object.isString(builders)||Array.isArray(builders)){throw new Error("builders data must be a dict",builders);}
for(var key in builders){try{this.register(key,builders[key]);registered.push(key);}catch(e){registered.forEach(function(key){delete this._builders[key];}.bind(this));throw e;}}
return this;},register:function(key,builder){if(this._builders[key]!==undefined){throw new Error('builder "%s" is already registered'.format(key));}
if(!Object.isFunc(builder)){throw new Error('builder "%s" is not a function'.format(key));}
this._builders[key]=builder;return this;},unregister:function(key){if(this._builders[key]===undefined){throw new Error('builder "%s" is not registered'.format(key));}
delete this._builders[key];return this;},builders:function(){return Object.keys(this._builders);},fallbackBuilders:function(){var prefix=this._fallbackPrefix;if(Object.isEmpty(prefix)===false){return Object.entries(this).filter(function(e){return e[0].startsWith(prefix)&&Object.isFunc(e[1]);}).map(function(e){return e[0].slice(prefix.length);});}else{return[];}},has:function(key){return Object.isFunc(this.get(key,false));},get:function(key,strict){strict=(strict===undefined)?this._strict:strict;var builder=this._builders[key];if(!Object.isFunc(builder)&&Object.isFunc(this._fallback)){builder=this._fallback(key);}
if(Object.isFunc(builder)){return builder.bind(this);}else if(strict){throw new Error('no such builder "'+key+'"');}}});}(jQuery));(function($){"use strict";var _noop=function(){};creme.component.EventHandler=creme.component.Component.sub({_init_:function(){this._listeners={};this._error=_noop;},on:function(key,listener,decorator){return this.bind(key,listener,decorator);},off:function(key,listener){return this.unbind(key,listener);},one:function(key,listener,decorator){var self=this;if(Object.isFunc(decorator)){return this.bind(key,listener,function(key,listener,args){self.unbind(key,listener);return decorator.apply(this,[key,listener,args]);});}
return this.bind(key,listener,function(key,listener,args){self.unbind(key,listener);return listener.apply(this,args);});},bind:function(key,listener,decorator){var self=this;if(Array.isArray(key)){key.forEach(function(key){self.bind(key,listener,decorator);});return this;}
if(typeof key==='object'){for(var k in key){this.bind(k,key[k],decorator);}
return this;}
if(typeof key==='string'&&key.indexOf(' ')!==-1){return this.bind(key.split(' '),listener,decorator);}
if(Array.isArray(listener)){listener.forEach(function(listener){self.bind(key,listener,decorator);});return this;}
if(Object.isFunc(listener)===false){throw new Error('unable to bind event "'+key+'", listener is not a function');}
var listeners=this.listeners(key);listener.__eventuuid__=listener.__eventuuid__||_.uniqueId();if(Object.isFunc(decorator)){var proxy=(function(key,listener,decorator){return function(){return decorator.apply(this,[key,listener,Array.from(arguments)]);};})(key,listener,decorator);proxy.__eventuuid__=listener.__eventuuid__;listeners.push(proxy);}else{listeners.push(listener);}
this._listeners[key]=listeners;return this;},unbind:function(key,listener){var self=this;if(Array.isArray(key)){key.forEach(function(key){self.unbind(key,listener);});return this;}
if(typeof key==='object'){for(var k in key){this.unbind(k,key[k]);}
return this;}
if(typeof key==='string'&&key.indexOf(' ')!==-1){return this.unbind(key.split(' '),listener);}
var listeners=this.listeners(key);if(listener===undefined){listeners.splice(0,listeners.length);return this;}
if(Array.isArray(listener)){listener.forEach(function(l){self._remove(listeners,l);});}else{this._remove(listeners,listener);}
return this;},_remove:function(listeners,listener){var index=0;while(index<listeners.length){var item=listeners[index];if(item&&item.__eventuuid__!==undefined&&(item.__eventuuid__===listener.__eventuuid__)){listeners.splice(index,1);}else{++index;}}},error:function(error){if(error===undefined){return this._error;}
if(error===null){this._error=_noop;return this;}
if(Object.isFunc(error)===false){throw new Error('event error handler is not a function');}
this._error=error;return this;},listeners:function(key){return this._listeners[key]||[];},trigger:function(key,data,source){source=source||this;data=Array.isArray(data)?data:(data!==undefined?[data]:[]);var args=[key].concat(data);var error=this._error.bind(source);Array.from(this.listeners(key)).forEach(function(listener){try{listener.apply(source,args);}catch(e){console.error(key,data,listener,e,source);error(e,key,data,listener);}});}});}(jQuery));(function($){"use strict";var _ActionStatus={DONE:'done',RUNNING:'run',FAIL:'fail',CANCEL:'cancel'};creme.component.ActionStatus=$.extend({},_ActionStatus);creme.component.Action=creme.component.Component.sub({_init_:function(action,options){this._events=new creme.component.EventHandler();this._options=options||{};this._status=_ActionStatus.DONE;this._action=Object.isFunc(action)?action:this.done;},start:function(){if(this.isRunning()===true){return this;}
try{this._events.trigger('start',Array.from(arguments),this);this._status=_ActionStatus.RUNNING;this._action.apply(this,Array.from(arguments));}catch(e){console.error(e);this.fail(e);}
return this;},done:function(){if(this.isRunning()===false){return this;}
this._status=_ActionStatus.DONE;this._events.trigger('done',Array.from(arguments),this);return this;},fail:function(){if(this.isRunning()===false){return this;}
this._status=_ActionStatus.FAIL;this._events.trigger('fail',Array.from(arguments),this);return this;},cancel:function(){if(this.isRunning()===false){return this;}
this._status=_ActionStatus.CANCEL;this._events.trigger('cancel',Array.from(arguments),this);return this;},trigger:function(event){this._events.trigger(event,Array.from(arguments).slice(1),this);return this;},action:function(data){var self=this;var action=(data===undefined||Object.isFunc(data))?data:function(){self.done(data);};return Object.property(this,'_action',action);},one:function(key,listener,decorator){this._events.one(key,listener,decorator);return this;},on:function(key,listener,decorator){return this.bind(key,listener,decorator);},off:function(key,listener){return this.unbind(key,listener);},bind:function(key,listener,decorator){this._events.bind(key,listener,decorator);return this;},unbind:function(key,listener){this._events.unbind(key,listener);return this;},onStart:function(start){return this.bind('start',start);},onComplete:function(complete){return this.bind('done fail cancel',complete);},onDone:function(success){return this.bind('done',success);},onCancel:function(canceled){return this.bind('cancel',canceled);},onFail:function(error){return this.bind('fail',error);},isRunning:function(){return this._status===_ActionStatus.RUNNING;},isStatusDone:function(){return this._status===_ActionStatus.DONE;},isStatusFail:function(){return this._status===_ActionStatus.FAIL;},isStatusCancel:function(){return this._status===_ActionStatus.CANCEL;},status:function(){return this._status;},options:function(options){return Object.property(this,'_options',options);},listen:function(source,options){return this.after(source,options);},stack:function(){var stack=[];var source=this._source;while(Object.isNone(source)===false){stack.push(source);source=source._source;}
return stack;},after:function(source,options){options=$.extend({passArgs:false},options||{});if(Object.isSubClassOf(source,creme.component.Action)===false){throw new Error('This is not an action instance',source);}
if(Object.isNone(this._source)===false){throw new Error('Action is already after',this._source);}
this._source=source;var self=this;source.onDone(function(){self.start.apply(self,options.passArgs?Array.from(arguments).slice(1):[]);});source.onFail(function(event){self._status=_ActionStatus.FAIL;self._events.trigger('fail',Array.from(arguments).slice(1),self);});source.onCancel(function(event){self._status=_ActionStatus.CANCEL;self._events.trigger('cancel',Array.from(arguments).slice(1),self);});return this;},before:function(target,options){target.after(this,options);return this;},delegate:function(delegate){var self=this;delegate.onDone(function(){self._status=_ActionStatus.DONE;self._events.trigger('done',Array.from(arguments).slice(1),self);});delegate.onFail(function(){self._status=_ActionStatus.FAIL;self._events.trigger('fail',Array.from(arguments).slice(1),self);});delegate.onCancel(function(){self._status=_ActionStatus.CANCEL;self._events.trigger('cancel',Array.from(arguments).slice(1),self);});return this;}});creme.component.TimeoutAction=creme.component.Action.sub({_init_:function(options){this._super_(creme.component.Action,'_init_',this._startTimeout,options);},_startTimeout:function(options){options=$.extend({},this.options(),options);var self=this;var delay=options.delay||0;if(delay>0){window.setTimeout(function(){if(self.isRunning()){self.done(options);}},delay);}else{self.done(options);}}});}(jQuery));(function($){"use strict";creme.action=creme.action||{};creme.action.DefaultActionBuilderRegistry=creme.component.FactoryRegistry.sub({_redirectAction:function(url,options,data){return new creme.component.Action(function(){options=options||{};var locationUrl=creme.utils.locationRelativeUrl();var resolvedUrl=url.template($.extend({location:locationUrl},data||{}));if(options.comeback){resolvedUrl=_.toRelativeURL(resolvedUrl).updateSearchData({callback_url:locationUrl}).toString();}
creme.utils.goTo(resolvedUrl);this.done();});},_warningAction:function(message){return new creme.component.Action(function(){var self=this;creme.dialogs.warning(message).onClose(function(){self.fail();}).open();});},_postQueryAction:function(url,options,data){options=$.extend({action:'post'},options||{});return creme.utils.ajaxQuery(url,options,data);},_reloadAction:function(url,options,data){return new creme.component.Action(function(){creme.utils.reload();this.done();});},_build_redirect:function(url,options,data){return this._redirectAction(url,options,data);}});}(jQuery));(function($){"use strict";creme.action=creme.action||{};creme.action.ActionLink=creme.component.Component.sub({_init_:function(options){this._options=$.extend({strict:false,debounce:0},options||{});this._running=false;this._events=new creme.component.EventHandler();this._registry=new creme.component.FactoryRegistry();},on:function(event,listener,decorator){this._events.on(event,listener,decorator);return this;},off:function(event,listener){this._events.off(event,listener);return this;},one:function(event,listener){this._events.one(event,listener);},onComplete:function(listener,decorator){this.on('action-link-done action-link-cancel action-link-fail',listener,decorator);},builders:function(builders){if(builders instanceof creme.component.FactoryRegistry){this._registry=builders;}else if(Object.isFunc(builders)){this._registry=new creme.component.FactoryRegistry({fallback:builders});}else if(builders instanceof Object){this._registry=new creme.component.FactoryRegistry({builders:builders});}else{throw Error('action builder "%s" is not valid'.format(builders));}
return this;},trigger:function(event){this._events.trigger(event,Array.from(arguments).slice(1),this);return this;},isRunning:function(){return this._running===true;},isBound:function(){return Object.isNone(this._button)===false;},isDisabled:function(){return this.isBound()&&this._button.is('.is-disabled');},options:function(){return this._options;},_debounce:function(handler,delay){if(delay>0){return _.debounce(handler,delay);}else{return handler;}},_optActionBuilder:function(button,actiontype){return this._registry.get(actiontype,this.options().strict);},_optActionData:function(button){var script=$('script[type$="/json"]',button);try{if(!Object.isEmpty(script)){var data=_.readJSONScriptText(script.get(0));return Object.isEmpty(data)?{}:JSON.parse(data);}}catch(e){console.warn(e);}
return{};},_optDebounceDelay:function(button){var delay=parseInt(button.attr('data-debounce')||'');return isNaN(delay)?this._options.debounce:delay;},bind:function(button){if(this.isBound()){throw Error('action link is already bound');}
var url=button.attr('href')||button.attr('data-action-url');var actiontype=button.attr('data-action')||'';var isRunning=this.isRunning.bind(this);var isDisabled=this.isDisabled.bind(this);var trigger=this.trigger.bind(this);var setRunning=function(state){this._running=state;button.toggleClass('is-loading',state);}.bind(this);var debounceDelay=this._optDebounceDelay(button);var actiondata=this._optActionData(button);var builder=this._optActionBuilder(button,actiontype);var isvalid=Object.isFunc(builder);if(isvalid){var actionHandler=this._debounce(function(e){if(!isRunning()){var action=builder(url,actiondata.options,actiondata.data,e);if(Object.isSubClassOf(action,creme.component.Action)){trigger('action-link-start',url,actiondata.options||{},actiondata.data||{},e);setRunning(true);action.one('done fail cancel',function(){setRunning(false);}).one({done:function(){trigger('action-link-done',Array.from(arguments).slice(1),this);},cancel:function(){trigger('action-link-cancel',Array.from(arguments).slice(1),this);},fail:function(){trigger('action-link-fail',Array.from(arguments).slice(1),this);}}).start();}else{console.warn('action link builder for "'+actiontype+'" have not returned an action instance : ',action);}}},debounceDelay);this._onButtonClick=function(e){e.preventDefault();e.stopPropagation();if(!isDisabled()){actionHandler(e);}};}else{button.addClass('is-disabled');console.warn('action link builder for "'+actiontype+'" does not exist.',button);this._onButtonClick=function(e){e.preventDefault();e.stopPropagation();return false;};}
button.on('click',this._onButtonClick);this._button=button;return this;},unbind:function(){if(this.isBound()===false){throw Error('action link is not bound');}
this._button.off('click',this._onButtonClick);this._button=undefined;this._onButtonClick=undefined;}});}(jQuery));(function($){"use strict";creme.utils=creme.utils||{};creme.utils.TemplateRenderer=creme.component.Component.sub({tags:function(template){return[];},render:function(template,values){return template;}});creme.utils.TemplateDefaultRenderer=creme.utils.TemplateRenderer.sub({_entrypattern:/\$\{([\w\d\\.^\\s]+)\}/g,_attributeGetter:function(data,key){var keys=Array.isArray(key)?key:((typeof key==='string')?key.split('.'):[key]);var value=data;for(var i in keys){if(!Object.isNone(value)&&typeof value==='object'){value=value[keys[i]];}else{value=undefined;break;}
value=Object.isFunc(value)?value(key):value;}
return value;},tags:function(template){var matches=template.match(this._entrypattern);var tags={};if(Object.isEmpty(matches)===false){matches.forEach(function(match){tags[match.slice(2,-1).split('.')[0]]=0;return 0;});}
return Object.keys(tags);},render:function(template,values){if(Object.isEmpty(values)){return template;}
var getter=this._attributeGetter.bind(this);return template.replace(this._entrypattern,function(match,key){var value=getter(values,key);return value!==undefined?value:match;});}});creme.utils.Template=creme.component.Component.sub({_init_:function(pattern,parameters,renderer){this.renderer(renderer||new creme.utils.TemplateDefaultRenderer());this.pattern(pattern);this.parameters(parameters);},_resolve:function(extra){extra=extra||{};var data=this._parameters||{};var resolved={};if(Object.isFunc(data)){this.tags().forEach(function(key){resolved[key]=data(key);});}else{resolved=$.extend(resolved,data);}
if(Object.isFunc(extra)){this.tags().forEach(function(key){resolved[key]=extra(key);});}else{resolved=$.extend(resolved,extra);}
return resolved;},render:function(extra){var renderer=this._renderer;var pattern=this._pattern;if(Object.isNone(renderer)||Object.isNone(pattern)){return null;}
return renderer.render(pattern,this._resolve(extra));},tags:function(){return this._tags;},_updateTags:function(){var renderer=this._renderer;var pattern=this._pattern;this._tags=(Object.isNone(renderer)||Object.isEmpty(pattern))?[]:renderer.tags(pattern);},iscomplete:function(){var tags=this._tags;var parameters=this._resolve();for(var i=0;i<tags.length;++i){if(Object.isNone(parameters[tags[i]])){return false;}}
return true;},renderer:function(renderer){if(renderer===undefined){return this._renderer;}
this._renderer=renderer;this._updateTags();return this;},pattern:function(pattern){if(pattern===undefined){return this._pattern;}
this._pattern=pattern;this._updateTags();return this;},parameters:function(parameters){return Object.property(this,'_parameters',parameters);},update:function(data){if(Array.isArray(data)){this.pattern(data[0]);this.parameters(data[1]);}else if(typeof data==='object'){this.parameters($.extend({},this.parameters()||{},data));}else if(typeof data==='string'){this.pattern(data);}
return this;}});creme.utils.templatize=function(value,context){var template;if(Object.isNone(value)){template=new creme.utils.Template();}
if(Object.isType(value,'string')){template=new creme.utils.Template(value);}
if(value!==null&&Object.isType(value,'object')&&Object.isFunc(value.is)&&value.is(creme.utils.Template)){template=value;}
return Object.isNone(context)?template:template.parameters(context);};}(jQuery));(function($){"use strict";creme.utils=creme.utils||{};creme.utils.Lambda=creme.component.Component.sub({_init_:function(callable,parameters){this.lambda(callable,parameters);},isValid:function(){return!Object.isNone(this._lambda);},apply:function(context,parameters){if(this._lambda){return this._lambda.apply(context,parameters);}},call:function(){if(this._lambda){var args=Array.from(arguments);return this._lambda.apply(args[0],args.slice(1));}},invoke:function(){return this._lambda?this._lambda.apply(this._context||{},arguments):undefined;},constant:function(value){this._lambda=function(){return value;};return this;},lambda:function(callable,parameters){if(callable===undefined){return this._lambda;}
if(Object.isFunc(callable)){this._lambda=callable;return this;}
if(!Object.isType(callable,'string')){return this.constant(callable);}
if(Object.isEmpty(callable)){throw Error('empty lambda script');}
parameters=Array.isArray(parameters)?parameters.join(','):(parameters||'');var body=callable.indexOf('return')!==-1?callable:'return '+callable+';';this._lambda=new Function(parameters,body);return this;},callable:function(){if(this._lambda){return this._context?this._lambda.bind(this._context):this._lambda;}},bind:function(context){this._context=context;return this;}});creme.utils.lambda=function(callable,parameters,defaults){try{return new creme.utils.Lambda(callable,parameters).callable();}catch(e){if(defaults!==undefined){return defaults;}else{throw e;}}};}(jQuery));(function($){"use strict";creme.utils=creme.utils||{};var __key=function(from,to){return[String(from),String(to)].join('-');};var __ident=function(value){return value;};creme.utils.ConverterRegistry=creme.component.Component.sub({_init_:function(){this._converters={};},convert:function(data,options){options=options||{};if(options.defaults!==undefined){try{this.convert(data,{from:options.from,to:options.to});}catch(e){return options.defaults;}}
return this.converter(options.from,options.to)(data);},available:function(from,to){return(from===to)||this._converters[__key(from,to)]!==undefined;},converter:function(from,to){if(from===to){return __ident;}
var key=__key(from,to);var conv=this._converters[key];Assert.that(Object.isFunc(conv),'"${key}" is not registered',{key:key});return conv;},register:function(from,to,converter){if(arguments.length===2){for(var k in to){this.register(from,k,to[k]);}
return this;}
if(Array.isArray(from)){var args=Array.from(arguments).slice(1);from.forEach(function(f){this.register.apply(this,[f].concat(args));}.bind(this));}
var key=__key(from,to);Assert.that(Object.isFunc(converter),'"${key}" converter must be a function',{key:key});Assert.not(Object.isFunc(this._converters[key]),'"${key}" is already registered',{key:key});this._converters[key]=converter;return this;},unregister:function(from,to){var key=__key(from,to);Assert.that(Object.isFunc(this._converters[key]),'"${key}" is not registered',{key:key});delete this._converters[key];return this;}});var __registry=new creme.utils.ConverterRegistry();creme.utils.converters=function(){return __registry;};creme.utils.convert=function(data,options){return __registry.convert(data,options);};var __toInt=function(value){var res=Object.isString(value)?parseInt(value):value;Assert.not(isNaN(res),'"${value}" is not an integer',{value:value});return res;};var __toFloat=function(value){var res=Object.isString(value)?parseFloat(value):value;Assert.not(isNaN(res),'"${value}" is not a number',{value:value});return res;};var __fromJSON=function(value){return JSON.parse(value);};var __toJSON=function(value){return JSON.stringify(value);};var __toString=function(value){return String(value);};var __toIso8601=function(value){Assert.isAnyOf(value,[moment,Date],'${value} is not a date nor datetime',{value:value});return moment(value).format();};var __toIso8601Date=function(value){Assert.isAnyOf(value,[moment,Date],'${value} is not a date nor datetime',{value:value});return moment(value).format('YYYY-MM-DD');};var __fromIso8601=function(value){var res=Assert.notThrown(function(){return value instanceof moment?value:moment(value);},'"${value}" is not an iso8601 datetime',{value:value});Assert.that(res.isValid(),'"${value}" is not an iso8601 datetime',{value:value});return res;};var __fromIso8601Date=function(value){var res=Assert.notThrown(function(){return value instanceof moment?value:moment(value,moment.HTML5_FMT.DATE);},'"${value}" is not an iso8601 datetime',{value:value});Assert.that(res.isValid(),'"${value}" is not an iso8601 date',{value:value});return res;};__registry.register(['string','text'],{int:__toInt,integer:__toInt,float:__toFloat,number:__toFloat,json:__fromJSON,date:__fromIso8601Date,datetime:__fromIso8601});__registry.register(['number','int','integer','float'],{string:__toString,text:__toString,json:__toJSON});__registry.register('date',{string:__toIso8601Date,text:__toIso8601Date,json:function(value){return __toJSON(__toIso8601Date(value));}});__registry.register('datetime',{string:__toIso8601,text:__toIso8601,json:function(value){return __toJSON(__toIso8601Date(value));}});__registry.register('json',{string:__toJSON,text:__toJSON});}(jQuery));(function($){"use strict";creme.utils=creme.utils||{};creme.utils.comparator=function(){if(arguments.length===0){return creme.utils.compareTo;}
var attributes=Array.from(arguments);return function(a,b){for(var i=0;i<attributes.length;++i){var key=attributes[i];var a_attr=a[key],b_attr=b[key];if(a_attr===b_attr){continue;}
return a_attr<b_attr?-1:1;}
return 0;};};creme.utils.compareTo=function(a,b){return a<b?-1:(a>b?1:0);};}(jQuery));(function($){"use strict";creme.history=creme.history||{};window.addEventListener("popstate",function(e){if(e.state){window.location.assign(e.state.url);}});creme.history.push=function(url,title){title=title||document.title;window.history.pushState({title:title,url:url},title,url);};creme.history.replace=function(url,title){title=title||document.title;window.history.replaceState({title:title,url:url},title,url);};}(jQuery));(function($){"use strict";creme.utils=creme.utils||{};var _noop=function(){};var _getter=function(instance,key){var prop=instance[key];return Object.isFunc(prop)?prop.apply(instance):prop;};var _setter=function(instance,key,value){var prop=instance[key];if(Object.isFunc(prop)){prop.apply(instance,[value]);}else{instance[key]=value;}
return instance;};creme.utils.newJQueryPlugin=function(options){options=options||{};var methods=options.methods||[];var properties=options.properties||[];var name=options.name;var constructor=options.create;var destructor=options.destroy||_noop;Assert.not(Object.isEmpty(name),'Missing JQuery plugin name.');Assert.that(Object.isFunc(constructor),'JQuery plugin "${name}" constructor is not a function.',{name:name});Assert.that(Object.isFunc(destructor),'JQuery plugin "${name}" destructor is not a function.',{name:name});Assert.that(Object.isNone($.fn[name]),'JQuery plugin "${name}" already exist.',{name:name});['prop','props','destroy','instance'].forEach(function(builtin){Assert.notIn(builtin,methods,'Method "${value}" is a builtin of JQuery plugin "${name}".',{name:name});});$.fn[name]=function(methodname,key,value){var args=Array.from(arguments);var resultList=this.get().map(function(element){var instanceKey='-'+name;var instance=$.data(element,instanceKey);if(Object.isString(methodname)===false){if(Object.isNone(instance)){instance=constructor.apply(element,args);Assert.not(Object.isNone(instance),'Jquery plugin "${name}" constructor has returned nothing.',{name:name});$.data(element,instanceKey,instance);}else{Assert.not(args.length>0,'Jquery plugin "${name}" is already initialized.',{name:name});}
return instance;}
var result;if(Object.isNone(instance)){return;}
if(methodname==='prop'){Assert.in(key,properties,'No such property "${value}" in jQuery plugin "${name}"',{name:name});if(args.length>2){result=_setter(instance,key,value);}else{result=_getter(instance,key);}}else if(methodname==='props'){result={};properties.forEach(function(prop){result[prop]=_getter(instance,prop);});}else if(methodname==='destroy'){destructor.apply(element,[instance]);$(element).removeData(instanceKey);}else if(methodname==='instance'){return instance;}else{Assert.in(methodname,methods,'No such method "${value}" in jQuery plugin "${name}"',{name:name});var method=instance[methodname];Assert.that(Object.isFunc(method),'Attribute "${method}" is not a function in jQuery plugin "${name}"',{method:methodname,name:name});result=method.apply(instance,args.slice(1));}
return result;}).filter(function(item){return item!==undefined;});if(this.length>1){return resultList;}else{return resultList.length===1?resultList[0]:undefined;}};};}(jQuery));(function($){"use strict";$(document).ajaxSend(function(event,xhr,settings){if(!(/^http:.*/.test(settings.url)||/^https:.*/.test(settings.url))){xhr.setRequestHeader("X-CSRFToken",creme.ajax.cookieCSRF());}});creme.ajax=creme.ajax||{};creme.ajax.Backend=function(options){this.options=$.extend({dataType:'html',sync:false,debug:false,traditional:true},options||{});};creme.ajax.Backend.prototype={get:function(url,data,successCb,errorCb,options){var opts=$.extend(true,{},this.options,options);var debug=_.pop(opts,'debug',false);if(debug){console.log('creme.ajax.Backend > GET',url,' > data:',data,', options:',opts);}
return creme.ajax.jqueryAjaxSend(Object.assign({url:url,method:'GET',body:data},opts),{done:successCb,fail:errorCb});},post:function(url,data,successCb,errorCb,options){var opts=$.extend(true,{},this.options,options);var debug=_.pop(opts,'debug',false);if(debug){console.log('creme.ajax.Backend > POST',url,' > data:',data,', options:',opts);}
return creme.ajax.jqueryAjaxSend(Object.assign({url:url,method:'POST',body:data,csrf:creme.ajax.cookieCSRF()},opts),{done:successCb,fail:errorCb});},submit:function(form,successCb,errorCb,options){var opts=$.extend(true,{},this.options,options);var formEl=form.get(0);var debug=_.pop(opts,'debug',false);if(debug){console.log('creme.ajax.Backend > SUBMIT',form.attr('action'),'> options:',opts);}
var url=_.pop(opts,'url',_.pop(opts,'action',form.attr('action')))||'';var data=new FormData(formEl);var extraData=_.pop(opts,'data',opts.extraData||{});var csrf=data.get('csrfmiddlewaretoken')||creme.ajax.cookieCSRF();return creme.ajax.jqueryAjaxSend(Object.assign({url:url,method:'POST',body:data,extraData:extraData,csrf:csrf},opts),{done:successCb,fail:errorCb});},query:function(options){return new creme.ajax.Query(options,this);}};creme.ajax.LOCALIZED_ERROR_MESSAGES={0:gettext('Connection Refused'),400:gettext('Bad Request'),401:gettext('Unauthorized'),403:gettext('Forbidden Access'),404:gettext('Not Found'),406:gettext('Not Acceptable'),409:gettext('Conflict'),500:gettext('Internal Error')};creme.ajax.localizedErrorMessage=function(status){status=isNaN(status)?parseInt(_.isString(status)?status:(status||{}).status):status;var message=status>=0?creme.ajax.LOCALIZED_ERROR_MESSAGES[status]:gettext('Error');return message||(gettext('Error')+(status>0?' ('+status+')':''));};creme.ajax.XHR=function(options){$.extend(this,{aborted:0,responseText:'',responseXML:null,status:200,statusText:'n/a',getAllResponseHeaders:function(){},getResponseHeader:function(){},setRequestHeader:function(){},abort:function(status){}},options||{});};creme.ajax.AjaxResponse=function(status,data,xhr){this.type="request";this.status=status;this.message=data;this.request=xhr||new creme.ajax.XHR({responseText:data,status:status});};creme.ajax.cookieAttr=function(name){if(Object.isEmpty(name)||Object.isEmpty(document.cookie)){return null;}
var cookies=document.cookie.split(';');for(var i=0;i<cookies.length;i++){var item=cookies[i].trim().split('=');if(item.length>1&&item[0]===name){return decodeURIComponent(item[1]);}}
return null;};creme.ajax.cookieCSRF=function(){return creme.ajax.cookieAttr('csrftoken');};creme.ajax.serializeFormAsDict=function(form,extraData){extraData=extraData||{};var data={};var addEntry=function(data,key,value){if(!Object.isEmpty(key)&&!Object.isNone(value)){if(data[key]===undefined){data[key]=Array.isArray(value)?value:[value];}else if(Array.isArray(value)){data[key].extend(value);}else{data[key].push(value);}}};$(form).serializeArray().forEach(function(e){addEntry(data,e.name,e.value);});for(var key in extraData){addEntry(data,key,extraData[key]);}
return data;};function xhrEventLoadedPercent(event){var position=event.loaded||event.position;var total=event.total;return(event.lengthComputable>0||event.lengthComputable===true)?Math.ceil(position/total*100):0;}
function progressXHR(listeners){listeners=listeners||{};var xhr=$.ajaxSettings.xhr();if(listeners.uploadProgress&&xhr.upload){xhr.upload.addEventListener('progress',function(event){event.loadedPercent=xhrEventLoadedPercent(event);listeners.uploadProgress(event);},false);}
if(listeners.progress){xhr.addEventListener('progress',function(event){event.loadedPercent=xhrEventLoadedPercent(event);listeners.progress(event);},false);}
return xhr;}
function xhrErrorMessage(xhr,textStatus,errorThrown){if(textStatus==='parseerror'){return"JSON parse error";}else{return"HTTP ${status} - ${statusText}".template({status:xhr.status||0,statusText:xhr.statusText||errorThrown||gettext('Error')});}};creme.ajax.jqueryAjaxSend=function(options,listeners){options=options||{};listeners=Object.assign({done:_.pop(options,'success'),fail:_.pop(options,'error'),progress:_.pop(options,'progress'),uploadProgress:_.pop(options,'uploadProgress')},listeners||{});var csrf=options.csrf===true?creme.ajax.cookieCSRF():options.csrf;var headers=Object.assign({},options.headers||{},Object.isEmpty(csrf)?{}:{'X-CSRFToken':csrf});var method=(options.method||options.type||'GET').toUpperCase();var body=(options.data||options.body);var extraData=_.pop(options,'extraData',{});function _onSuccess(data,textStatus,xhr){if(Object.isFunc(listeners.done)){listeners.done(data,textStatus,xhr);}};function _onError(xhr,textStatus,errorThrown){if(Object.isFunc(listeners.fail)){listeners.fail(xhr.responseText,{type:"request",status:xhr.status,request:xhr,message:xhrErrorMessage(xhr,textStatus,errorThrown)});}};var ajaxOptions=$.extend(true,{async:!_.pop(options,'sync'),type:method,url:options.url,data:body,dataType:options.dataType||'json',headers:headers,success:_onSuccess,error:_onError},options);if(listeners.uploadProgress||listeners.progress){ajaxOptions.xhr=function(){return progressXHR(listeners);};}
if(body instanceof FormData){ajaxOptions.processData=false;ajaxOptions.contentType=false;_.assignFormData(body,extraData);}else if(!Object.isEmpty(extraData)){ajaxOptions.data=Object.assign(body||{},extraData);}
return $.ajax(ajaxOptions);};var __defaultBackend=new creme.ajax.Backend();creme.ajax.defaultBackend=function(backend){if(backend===undefined){return __defaultBackend;}
if(creme.ajax.Backend.prototype.isPrototypeOf(backend)===false){throw new Error('Default ajax backend must be a creme.ajax.Backend instance');}
__defaultBackend=backend;};}(jQuery));(function($){"use strict";creme.ajax=creme.ajax||{};creme.ajax.MockAjaxBackend=function(options){this.options=$.extend({delay:500,enableUriSearch:false},options||{});this.GET={};this.POST={};this.counts={GET:0,POST:0,SUBMIT:0};this.parser=document.createElement('a');this.progressSteps=[];};creme.ajax.MockAjaxBackend.prototype=new creme.ajax.Backend();creme.ajax.MockAjaxBackend.prototype.constructor=creme.ajax.Backend;$.extend(creme.ajax.MockAjaxBackend.prototype,{send:function(url,data,method,on_success,on_error,options){var self=this;var method_urls=this[method]||{};options=$.extend({},this.options,options||{});if(options.sync!==true){options.sync=true;var delay=isNaN(options.delay)?500:options.delay;if(delay>0){window.setTimeout(function(){self.send(url,data,method,on_success,on_error,options);},delay);return;}}
if(options.enableUriSearch){var urlInfo=_.toRelativeURL(url);var searchData=urlInfo.searchData();if(Object.isEmpty(searchData)===false){if(method==='GET'){data=$.extend({},searchData,data||{});}else{data=$.extend({'URI-SEARCH':searchData},data||{});}}
url=urlInfo.pathname().replace(window.location.pathname,'').replace(/^\//,'');}
var response=method_urls[url];if(response===undefined){console.warn('MockAjaxBackend (404) : '+method+' '+url);response=this.response(404,'');}
if(Object.isFunc(response)){try{response=creme.object.invoke(response,url,data,options);}catch(e){console.error(e);response=this.response(500,''+e);}}
if(options.debug){console.log('mockajax > send > url:',url,'options:',options,'response:',response);}
var responseData=response.responseText;if(options.uploadProgress||options.progress){(this.progressSteps||[]).forEach(function(step){var progressEvent=new ProgressEvent('progress',{total:1000,loaded:_.clamp(step,0,100)*10,lengthComputable:true});progressEvent.loadedPercent=step;if(options.uploadProgress){options.uploadProgress(progressEvent);}
if(options.progress){options.progress(progressEvent);}});}
try{if(response.status===200&&options.dataType==='json'){responseData=JSON.parse(responseData);}}catch(e){console.error(e);response=this.response(500,''+e);}
if(response.status!==200){return creme.object.invoke(on_error,response.responseText,new creme.ajax.AjaxResponse(response.status,response.responseText,response.xhr));}
return creme.object.invoke(on_success,responseData,response.statusText,response);},get:function(url,data,on_success,on_error,options){this.counts.GET+=1;return this.send(url,data,'GET',on_success,on_error,options);},post:function(url,data,on_success,on_error,options){this.counts.POST+=1;return this.send(url,data,'POST',on_success,on_error,options);},submit:function(form,on_success,on_error,options){options=options||{};var url=options.action||form.attr('action');var data=creme.ajax.serializeFormAsDict(form,options.data);this.counts.SUBMIT+=1;return this.send(url,data,'POST',on_success,on_error,options);},response:function(status,data,header){header=$.extend({'content-type':'text/html'},header||{});var normalizedHeader={};for(var key in header){normalizedHeader[key.toLowerCase()]=header[key];}
var getResponseHeader=function(name){return normalizedHeader[name.toLowerCase()];};return new creme.ajax.XHR({responseText:data,status:status,statusText:status!==200?creme.ajax.LOCALIZED_ERROR_MESSAGES[status]:'ok',getResponseHeader:getResponseHeader});},responseJSON:function(status,data,header){return this.response(status,Object.isString(data)?data:JSON.stringify(data),{'content-type':'text/json'});},resetMockCounts:function(){this.counts={GET:0,POST:0,SUBMIT:0};}});}(jQuery));(function($){"use strict";creme.ajax=creme.ajax||{};creme.ajax.CacheBackendEntry=function(key,url,data,dataType,response){this.key=key;this.url=url;this.data=data;this.dataType=dataType;this.response=response;this.state=undefined;this.waiting=false;this.events=new creme.component.EventHandler();this.registry=undefined;};creme.ajax.CacheBackendCondition=function(cb){this._expired_cb=Object.isFunc(cb)?cb:function(){return false;};};creme.ajax.CacheBackendCondition.prototype={expired:function(entry,options){if(entry.state===undefined){return true;}
return creme.object.invoke(this._expired_cb,entry,options);},reset:function(entry){entry.state={};}};creme.ajax.CacheBackendTimeout=function(max){this.maxdelay=(max||0);};creme.ajax.CacheBackendTimeout.prototype=new creme.ajax.CacheBackendCondition();creme.ajax.CacheBackendTimeout.prototype.constructor=creme.ajax.CacheBackendCondition;$.extend(creme.ajax.CacheBackendTimeout.prototype,{expired:function(entry,options){if(entry.state===undefined){return true;}
var expirationTime=entry.state.time+this.maxdelay;return expirationTime-new Date().getTime()<=0;},reset:function(entry){entry.state={time:new Date().getTime()};}});creme.ajax.CacheBackend=function(backend,options){this.options=options||{};this.delegate=backend||creme.ajax.defaultBackend();this.condition=this.options.condition||new creme.ajax.CacheBackendCondition();this.entries={};};creme.ajax.CacheBackend.prototype=new creme.ajax.Backend();creme.ajax.CacheBackend.prototype.constructor=creme.ajax.Backend;$.extend(creme.ajax.CacheBackend.prototype,{get:function(url,data,on_success,on_error,options){options=$.extend({},this.options,options);var entry=this._getEntry(url,data,options.dataType);this._fetchEntry(entry,on_success,on_error,options);},reset:function(){this.entries={};},_getEntry:function(url,data,dataType){var key=JSON.stringify([url,dataType,data]);return this.entries[key]||new creme.ajax.CacheBackendEntry(key,url,data,dataType);},_updateEntry:function(entry,response,textStatus){entry.response={data:response,textStatus:textStatus};this.condition.reset(entry);},_registerEntry:function(entry){this.entries[entry.key]=entry;this.condition.reset(entry);entry.registry=this;},_removeEntry:function(entry){entry.registry=undefined;delete this.entries[entry.key];},_fetchEntry:function(entry,on_success,on_error,options){var self=this;var isCacheExpired=this.condition.expired(entry,options);if(options.debug){console.log('cacheajax > cache > url:',entry.url,'expired:',isCacheExpired,'waiting:',entry.waiting);}
if(!options.forcecache&&!entry.waiting&&!isCacheExpired){return creme.object.invoke(on_success,entry.response.data,entry.response.textStatus);}
if(entry.registry===undefined){this._registerEntry(entry);}
entry.events.one('complete',function(event,is_success,data,status){creme.object.invoke(is_success?on_success:on_error,data,status);});if(!entry.waiting){entry.waiting=true;if(options.debug){console.log('cacheajax > miss > url:',entry.url,'data:',entry.data,'options:',options);}
this.delegate.get(entry.url,entry.data,function(data,textStatus){entry.waiting=false;self._updateEntry(entry,data,textStatus);entry.events.trigger('complete',[true,data,textStatus]);},function(data,status){self._removeEntry(entry);entry.waiting=false;entry.events.trigger('complete',[false,data,status]);},options);}}});var __defaultBackend=new creme.ajax.CacheBackend(creme.ajax.defaultBackend(),{condition:new creme.ajax.CacheBackendTimeout(120*1000)});creme.ajax.defaultCacheBackend=function(backend){if(backend===undefined){return __defaultBackend;}
if(creme.ajax.Backend.prototype.isPrototypeOf(backend)===false){throw new Error('Default ajax cache backend must be a creme.ajax.Backend instance');}
__defaultBackend=backend;};}(jQuery));(function($){"use strict";creme.ajax=creme.ajax||{};creme.ajax.Query=creme.component.Action.sub({_init_:function(options,backend){this._super_(creme.component.Action,'_init_',this._send,options);this._backend=backend||creme.ajax.defaultBackend();this._converter=function(data){return data;};this._data={};this._cancellable=false;this._successCb=this._onBackendSuccess.bind(this);this._errorCb=this._onBackendError.bind(this);},_onBackendSuccess:function(data,textStatus){if(this.isRunning()){try{this.done(this._converter(data));}catch(e){this.fail(data,e);}}},_onBackendError:function(data,error){this.fail(data,error);},converter:function(converter){if(converter===undefined){return this._converter;}
if(!Object.isFunc(converter)){throw Error('converter is not a function');}
this._converter=converter;return this;},isCancelable:function(){return this.isRunning()&&this._cancelable;},cancel:function(){if(this.isCancelable()===false){throw new Error('unable to cancel this query');}
return this._super_(creme.component.Action,'cancel');},backend:function(backend){return Object.property(this,'_backend',backend);},url:function(url){if(url===undefined){return Object.isFunc(this._url)?this._url():this._url;}
this._url=url;return this;},data:function(data){if(data===undefined){return Object.isFunc(this._data)?this._data():this._data;}
this._data=data;return this;},onProgress:function(progress){return this.on('progress',progress);},onUploadProgress:function(progress){return this.on('upload-progress',progress);},_send:function(options){options=$.extend(true,{},this.options(),options||{});var self=this;var data=$.extend({},this.data()||{},options.data||{});var action=(options.action||'get').toLowerCase();var backendOptions=options.backend||{};var url=this.url()||'';var progressCb=_.pop(options,'progress',backendOptions.progress);var uploadProgressCb=_.pop(options,'uploadProgress',backendOptions.uploadProgress);if(Object.isFunc(progressCb)||this._events.listeners('progress').length>0){backendOptions.progress=function(e){self.trigger('progress',e);(progressCb||_.noop)(e);};}
if(Object.isFunc(uploadProgressCb)||this._events.listeners('upload-progress').length>0){backendOptions.uploadProgress=function(e){self.trigger('upload-progress',e);(uploadProgressCb||_.noop)(e);};}
try{if(Object.isNone(this._backend)){throw new Error('Missing ajax backend');}
if(!Object.isFunc(this._backend[action])){throw new Error('Missing ajax backend action "%s"'.format(action));}
if(Object.isEmpty(url)){throw new Error('Unable to send request with empty url');}
this._cancelable=(action==='get');this._backend[action](url,data,this._successCb,this._errorCb,backendOptions);}catch(e){var message=e.message||String(e);this.fail(e,new creme.ajax.AjaxResponse(400,message));}
return this;},get:function(data,options){return this.start({action:'get',data:data,backend:options||{}});},post:function(data,options){return this.start({action:'post',data:data,backend:options||{}});}});creme.ajax.query=function(url,options,data,backend){options=options||{};return new creme.ajax.Query(options,backend).url(url||'').data(data||{});};}(jQuery));(function($){"use strict";creme.layout=creme.layout||{};creme.layout.preferredSize=function(element,depth){depth=depth||1;var height=0;var width=0;$('> *',element).filter(':visible').each(function(){var position=$(this).position();if(depth>1){var size=creme.layout.preferredSize($(this),depth-1);width=Math.max(width,size[0]);height=Math.max(height,size[1]);}
width=Math.max(width,position.left+$(this).outerWidth(true));height=Math.max(height,position.top+$(this).outerHeight(true));});return[Math.round(width),Math.round(height)];};}(jQuery));(function($){"use strict";creme.layout=creme.layout||{};creme.layout.TextAreaAutoSize=creme.component.Component.sub({_init_:function(options){options=$.extend({min:2},options||{});this._min=options.min;this._max=options.max;this._listeners=this._onResize.bind(this);},_onResize:function(e){var element=this._delegate;var text=element.val();var previous=this._count!==undefined?this._count:this._initial;var lines=(text!==null)?text.split('\n'):[];var count=lines.length;if(e.keyCode===13){++count;}
if(lines){var width=element.width();if(width){var ghostSpan=$('<span></span>');ghostSpan.css({'font-family':element.css('font-family'),'font-size':element.css('font-size'),position:'absolute',top:-1000,left:-1000});ghostSpan.appendTo('body');for(var i in lines){ghostSpan.text(lines[i]);count+=Math.floor(ghostSpan.width()/width);}
ghostSpan.remove();}}
count=Math.max(this._min,count);count=!isNaN(this._max)?Math.min(this._max,count):count;this._count=count;if(previous!==count){element.get().scrollTop=0;element.attr('rows',count);}},bind:function(element){if(this._delegate!==undefined){throw new Error('already bound');}
this._delegate=element;element.css({'overflow-y':'hidden','resize':'none'});this._initial=parseInt(element.attr('rows'))||1;this._onResize(element);element.on('input',this._listeners);return this;},unbind:function(){if(this._delegate===undefined){throw new Error('not bound');}
this._delegate.off('input',this._listeners);this._delegate=undefined;return this;}});}(jQuery));(function($){"use strict";creme.model=creme.model||{};creme.model.Collection=creme.component.Component.sub({_init_:function(){this._events=new creme.component.EventHandler();},bind:function(event,listener,decorator){this._events.bind(event,listener,decorator);return this;},unbind:function(event,listener){this._events.unbind(event,listener);return this;},one:function(event,listener){this._events.one(event,listener);},_fireAdd:function(data,start,end,action){this._events.trigger('add',[data,start,end,action],this);},_fireRemove:function(data,start,end,action){this._events.trigger('remove',[data,start,end,action],this);},_fireUpdate:function(data,start,end,previous,action){this._events.trigger('update',[data,start,end,previous,action],this);},length:function(){return this.all().length;},get:function(index){return this.all()[index];},each:function(cb){return this.all().forEach(cb);},map:function(cb){return this.all().map(cb);},where:function(cb){return this.all().filter(cb);},slice:function(start,end){return this.all().slice(start,end);},first:function(){return this.length()>0?this.get(0):undefined;},last:function(){return this.length()>0?this.get(this.length()-1):undefined;},all:function(){return[];}});creme.model.Delegate=creme.model.Collection.sub({_init_:function(delegate,listeners){this._super_(creme.model.Collection,'_init_');this._delegateListener=$.extend({update:this._onUpdate.bind(this),add:this._onAdd.bind(this),remove:this._onRemove.bind(this)},listeners||{});this.delegate(delegate);},delegate:function(delegate){if(delegate===undefined){return this._delegate;}
var previous=this._delegate;if(previous!==undefined){previous.unbind(this._delegateListener);}
if(!Object.isNone(delegate)){delegate.bind(this._delegateListener);}
this._delegate=delegate;return this;},all:function(){return this._delegate?this._delegate.all():[];},_onUpdate:function(event,data,start,end,previous,action){this._fireUpdate(data,start,end,previous,action);},_onAdd:function(event,data,start,end,action){this._fireAdd(data,start,end,action);},_onRemove:function(event,data,start,end,action){this._fireRemove(data,start,end,action);}});creme.model.Filter=creme.model.Delegate.sub({_init_:function(delegate,filter){var listeners={reset:this._onReset.bind(this)};this._setFilter(filter);this._super_(creme.model.Delegate,'_init_',delegate,listeners);},all:function(){return this._data;},fetch:function(start,end){var data=this._filterData();this._super_(creme.model.Array,'reset',data);return this;},_filterData:function(){var delegate=this._delegate;var filter=this._filter;if(!delegate){return[];}
return Object.isFunc(filter)?delegate.where(filter):delegate.all().slice();},_setFilter:function(filter){if(Object.isNone(filter)){this._filter=null;}else if(Object.isFunc(filter)){this._filter=filter;}else if(Object.isFunc(filter.callable)){this._filter=filter.callable();}else if(Object.isType(filter,'string')){this._filter=creme.utils.lambda(filter,'item',null);}},filter:function(filter){if(filter===undefined){return this._filter;}
this._setFilter(filter);this.fetch();return this;},delegate:function(delegate){var previous=this._delegate;var ret=this._super_(creme.model.Delegate,'delegate',delegate);if(previous!==this._delegate){this.fetch();}
return ret;},_onUpdate:function(event,data,start,end,previous,action){if(action!=='reset'){this.fetch();}},_onAdd:function(event,data,start,end,previous,action){if(action!=='reset'){this.fetch();}},_onRemove:function(event,data,start,end,previous,action){if(action!=='reset'){this.fetch();}},_onReset:function(event){this.fetch();}});}(jQuery));(function($){"use strict";creme.model=creme.model||{};creme.model.Array=creme.model.Collection.sub({_init_:function(data,comparator){this._super_(creme.model.Collection,'_init_');this._data=!Object.isEmpty(data)?(Array.isArray(data)?data:[data]):[];this.comparator(comparator);},length:function(){return this._data.length;},get:function(index){return this._data[index];},set:function(data,index,action){if(index<0||index>this._data.length){throw new Error('index out of bound');}
var previous=this._data[index];this._data[index]=data;this._fireUpdate([data],index,index,[previous],action||'set');return this;},reset:function(data){var previous=this._data;var previous_length=previous?previous.length:0;this._data=!Object.isEmpty(data)?(Array.isArray(data)?data:[data]):[];var next_length=this._data.length;if(previous_length>0){if(next_length>0){var update_start=0;var update_end=Math.max(0,Math.min(previous.length-1,this._data.length-1));this._fireUpdate(this._data.slice(update_start,update_end+1),update_start,update_end,previous.slice(update_start,update_end+1),'reset');}
if(previous_length>next_length){var remove_start=next_length;var remove_end=previous_length-1;this._fireRemove(previous.slice(remove_start,remove_end+1),remove_start,remove_end,'reset');}}
if(next_length>0&&next_length>previous_length){var add_start=previous_length;var add_end=next_length-1;this._fireAdd(this._data.slice(add_start,add_end+1),add_start,add_end,'reset');}
this._events.trigger('reset',[],this);return this;},insert:function(data,index){data=Array.isArray(data)?data:[data];index=index||0;var start=index;var end=start+(data.length-1);if(data.length===0){return this;}
if(index<0||index>this._data.length){throw new Error('index out of bound');}
if(index===this._data.length){this._data=this._data.concat(data);}else if(index===0){this._data=data.concat(this._data);}else{this._data=this._data.slice(0,index).concat(data,this._data.slice(index));}
this._fireAdd(data,start,end,'insert');return this;},append:function(data){return this.insert(data,this._data.length);},prepend:function(data){return this.insert(data);},pop:function(){if(this._data.length===0){return;}
var index=this._data.length-1;var item=this._data.pop();this._fireRemove([item],index,index,'remove');return item;},removeAt:function(index){if(index<0||index>this._data.length){throw new Error('index out of bound');}
var item=this._data.splice(index,1);this._fireRemove(item,index,index,'remove');return item[0];},remove:function(value){value=Array.isArray(value)?value:[value];var self=this;var removed=[];value.forEach(function(item){var index=self.indexOf(item);if(index!==-1){removed.push(self.removeAt(index));}});return removed;},indexOf:function(value,comparator){comparator=comparator||this._comparator;var data=this._data;if(Object.isFunc(comparator)===false){return data.indexOf(value);}
for(var index=0;index<data.length;++index){if(comparator(data[index],value)===0){return index;}}
return-1;},indicesOf:function(values,comparator){comparator=comparator||this._comparator;values=Array.isArray(values)?values.slice():[values];var data=this._data;var result=[];if(Object.isFunc(comparator)===false){data.forEach(function(item,index){var i=values.indexOf(item);if(i!==-1){result.push(index);values.slice(i,1);}});}else{data.forEach(function(item,index){for(var i=0;i<values.length;++i){if(comparator(item,values[i])===0){result.push(index);values.slice(i,1);}}});}
return result;},clear:function(){var data=this._data;this._data=[];this._fireRemove(data,0,data.length-1,'clear');return data;},first:function(){return this._data?this._data[0]:undefined;},last:function(){return this._data?this._data[this._data.length-1]:undefined;},each:function(cb){this._data.forEach(cb);return this;},map:function(cb){return this._data.map(cb);},where:function(cb){return this._data.filter(cb);},slice:function(start,end){return this._data.slice(start,end);},all:function(){return this._data;},comparator:function(comparator){return Object.property(this,'_comparator',comparator);},sort:function(comparator){var data=this._data;var previous=Array.from(data);comparator=comparator||this._comparator;data.sort(comparator);this._fireUpdate(data,0,data.length-1,previous,'sort');this._events.trigger('sort',[],this);return this;},reverse:function(){var data=this._data;var previous=Array.from(data);data.reverse();this._fireUpdate(data,0,data.length-1,previous,'reverse');this._events.trigger('reverse',[],this);return this;},patch:function(data){if(Array.isArray(data)){return this.reset(data);}
data=data||{};var self=this;var added=data.add||[];var removed=data.remove||[];var updated=data.update||[];this.append(added);this.remove(removed);updated.forEach(function(item,index){self.set(item[0],item[1]);});return this;}});}(jQuery));(function($){"use strict";creme.model=creme.model||{};creme.model.Renderer=creme.component.Component.sub({_init_:function(target,model,listeners){this._modelListener=$.extend({update:this._onUpdate.bind(this),add:this._onAdd.bind(this),remove:this._onRemove.bind(this)},listeners||{});this.target(target);this.model(model);},target:function(target){return Object.property(this,'_target',target);},model:function(model){if(model===undefined){return this._model;}
model=Array.isArray(model)?new creme.model.Array(model):model;var previous=this._model;if(!Object.isNone(previous)){previous.unbind(this._modelListener);}
if(!Object.isNone(model)){model.bind(this._modelListener);}
this._model=model;return this;},redraw:function(){return this;}});creme.model.ListRenderer=creme.model.Renderer.sub({items:function(target){return target?$('li',target):$([]);},createItem:function(target,before,data,index){var item=$('<li>');this.updateItem(target,item,data,undefined,index);return item;},insertItem:function(target,before,data,index){var item=this.createItem(target,before,data,index);if(before&&before.length){before.before(item);}else{target.append(item);}},updateItem:function(target,item,data,previous,index){item.html(''+data);return item;},removeItem:function(target,item,data,index){item.remove();},redraw:function(){var target=this._target;var self=this;var model=this.model();this.items(target).each(function(index){self.removeItem(target,$(this),model!==undefined?model.get(index):undefined,index);});if(model===undefined){return this;}
model.all().forEach(function(data,index){self.insertItem(target,$([]),data,index);});return this;},_onUpdate:function(event,data,start,end,previous,action){var self=this;var target=this._target;this.items(target).slice(start,end+1).each(function(index){self.updateItem(target,$(this),data[index],previous[index],start+index,action);});},_onAdd:function(event,data,start,end,action){var target=this._target;var self=this;var before=this.items(target).slice(start,start+1);data.forEach(function(entry,index){self.insertItem(target,before,entry,start+index);});},_onRemove:function(event,data,start,end,action){var target=this._target;var self=this;this.items(target).slice(start,end+1).each(function(index){self.removeItem(target,$(this),data[index],start+index);});}});}(jQuery));(function($){"use strict";creme.model=creme.model||{};creme.model.AjaxArray=creme.model.Array.sub({_init_:function(backend,initial){this.backend(backend);this.initial(initial||[]);this._super_(creme.model.Array,'_init_',this.initial());this._queryListeners={done:this._onQueryDone.bind(this),fail:this._onQueryError.bind(this),cancel:this._onQueryCancel.bind(this)};},_onQueryDone:function(event,data,textStatus){this._events.trigger('fetch-done',[data],this);this.patch(data);},_onQueryCancel:function(){this._events.trigger('fetch-cancel',[],this);},_onQueryError:function(event,data,error){this._events.trigger('fetch-error',[data,error],this);this.patch(this.initial());},initial:function(initial){if(initial===undefined){return Object.isFunc(this._initial)?this._initial():this._initial;}
this._initial=initial;return this;},converter:function(converter){return Object.property(this,'_converter',converter);},backend:function(backend){return Object.property(this,'_backend',backend);},url:function(url){return Object.property(this,'_url',url);},cancelFetch:function(){if(this._running){if(this._running.isRunning()){this._running.cancel();}
delete this._running;}},fetch:function(data,options,listeners){var url=this.url();var query;if(Object.isNone(url)){query=new creme.component.Action(function(){this.cancel();});}else{query=this.backend().query({action:'get'}).data(data||{}).url(url);if(this._converter){query.converter(this._converter);}}
this.cancelFetch();this._running=query;query.one(this._queryListeners).one(listeners||{}).start(options);return this;}});}(jQuery));(function($){"use strict";creme.model=creme.model||{};creme.model.CollectionController=creme.component.Component.sub({target:function(element){if(element===undefined){return this._target;}
this._target=element!==null?element:undefined;if(this.renderer()){this.renderer().target(element);}
return this;},redraw:function(){var renderer=this.renderer();var target=this.target();if(renderer&&target){renderer.redraw();}},_rendererModel:function(){return this._model;},renderer:function(renderer){if(renderer===undefined){return this._renderer;}
this._renderer=renderer;if(this._renderer){this._renderer.model(this._rendererModel());this._renderer.target(this.target());}
return this;},model:function(model){if(model===undefined){return this._model;}
this._model=model;if(this._renderer){this._renderer.model(this._rendererModel());}
return this;},fetch:function(){this.model().fetch();return this;}});creme.model.SelectionController=creme.component.Component.sub({_init_:function(){var events=this._events=new creme.component.EventHandler();this.selectionFilter(null);this._modelListeners={'add remove':function(event,data){events.trigger('change',[],this);},'update':function(event,data,start,end,previous,action){if(action!=='select'){events.trigger('change',[],this);}}};},on:function(event,listener,decorator){this._events.on(event,listener,decorator);return this;},off:function(event,listener){this._events.off(event,listener);return this;},one:function(event,listener){this._events.one(event,listener);},model:function(model){if(model===undefined){return this._model;}
var previous=this._model;if(!Object.isNone(previous)){previous.unbind(this._modelListeners);}
if(!Object.isNone(model)){model.bind(this._modelListeners);this._model=model;}else{this._model=undefined;}
return this;},selectionFilter:function(filter){if(filter===undefined){return this._filter;}
this._filter=Object.isFunc(filter)?filter:null;return this;},selected:function(){var model=this.model();return model?model.where(function(item){return item.selected;}):[];},selectables:function(){var model=this.model();var selectable=this._filter;if(model!==undefined){return Object.isFunc(selectable)?model.where(selectable):model.all();}
return[];},_inRange:function(indices,index){if(indices.length===0){return false;}
for(var i=0;i<indices.length;++i){var range=indices[i];if(index>=range[0]&&index<=range[1]){return true;}}
return false;},_cleanRange:function(range,min,max){var start,end,swp;if(Array.isArray(range)){start=parseInt(range[0])||0;end=parseInt(range[1])||0;}else{start=parseInt(range)||0;end=start;}
if(start>end){swp=start;start=end;end=swp;}
return[Math.min(Math.max(min,start),max),Math.max(min,Math.min(max,end))];},_compareRange:function(a,b){return a[0]<b[0]?-1:(a[0]>b[0]?1:0);},_cleanIndices:function(indices,min,max){if(Object.isFunc(indices)){return this._cleanIndices(indices(this));}
indices=Array.isArray(indices)?indices:[indices];min=min||0;max=max||this.model().length();var cleanRange=this._cleanRange;var cleaned=indices.map(function(range){return cleanRange(range,min,max);}).sort(this._compareRange);return cleaned;},_optimizeRanges:function(ranges){var result=[];var current;ranges.sort(this._compareRange).forEach(function(range){var start=range[0],end=range[1];if(current===undefined){result.push(range);current=range;}
var isStartIn=start>=current[0]&&start<=current[1]+1;if(isStartIn){current[1]=Math.max(end,current[1]);}else{result.push(range);current=range;}});return result;},_updateSelection:function(indices,instate,outstate){var model=this.model();var filter=this.selectionFilter();var inrange=this._inRange;var items=this.model().all();indices=this._cleanIndices(indices);var hasUpdates=false,outIndices=[];var next,previous,item,isInRange;for(var index=0;index<items.length;++index){item=items[index];if(Object.isFunc(filter)&&!filter(item,index)){continue;}
previous=(item.selected===true);isInRange=inrange(indices,index);if(isInRange){next=instate(item,index);}else{next=outstate?outstate(item,index):previous;}
if(next!==undefined&&next!==previous){item.selected=next;hasUpdates=true;if(!isInRange){outIndices.push([index,index]);}}}
if(hasUpdates){var updatedIndices=indices.concat(outIndices);updatedIndices.forEach(function(range){var update_start=range[0];var update_end=range[1];model._fireUpdate(items.slice(update_start,update_end+1),update_start,update_end,items.slice(update_start,update_end+1),'select');});this._events.trigger('change',[],this);}
return this;},toggle:function(indices,state){return this._updateSelection(indices,function(item,index){return state!==undefined?(state===true):!item.selected;});},select:function(indices,inclusive){return this._updateSelection(indices,function(item,index){return true;},inclusive?undefined:function(item,index){return false;});},unselect:function(indices){return this._updateSelection(indices,function(item,index){return false;});},toggleAll:function(state){return this.toggle([[0,this.model().length()-1]],state);},selectAll:function(){return this.toggleAll(true);},unselectAll:function(){return this.toggleAll(false);}});}(jQuery));(function($){"use strict";var _cleanItemValue=function(value){value=Object.isNone(value)?'':value;if(typeof value==='object'){value=JSON.stringify(value);}
return value;};creme.model=creme.model||{};creme.model.ChoiceRenderer=creme.model.ListRenderer.sub({createItem:function(target,before,data,index){var item=$('<option>');this.updateItem(target,item,data,undefined,index);return item;},updateItem:function(target,item,data,previous,index,action){if(action==='select'){return this.selectItem(target,item,data,previous,index);}
var value=_cleanItemValue(data.value);item.attr('value',value).toggleProp('disabled',data.disabled===true).prop('selected',data.selected===true).toggleAttr('tags',data.tags,(data.tags||[]).join(' ')).html(data.label);},selectItem:function(target,item,data,previous,index){item.prop('selected',data.selected===true);},items:function(target){return $('option',target);}});creme.model.ChoiceRenderer.parse=function(element,converter){var values=element.val();values=element.is('[multiple]')?(values||[]):[values];return $('option',element).map(function(){var option=$(this);var option_value=option.attr('value');return{label:option.html(),value:Object.isFunc(converter)?converter(option_value):option_value,disabled:option.is('[disabled]'),readonly:option.is('[readonly]'),selected:values.indexOf(option_value)!==-1,visible:true,help:option.attr('help'),tags:option.is('[tags]')&&option.attr('tags')?option.attr('tags').split(' '):[]};}).get();};creme.model.ChoiceRenderer.choicesFromTuples=function(data){data=data||[];var istuple=data?Array.isArray(data[0]):false;if(istuple){return data.map(function(entry){return{value:entry[0],label:entry[1],help:undefined,visible:true,disabled:false,selected:false};});}else{return data.map(function(entry){var value=null,label='null',help;if(!Object.isNone(entry)){value=entry.value!==undefined?entry.value:entry;label=entry.label!==undefined?entry.label:String(value);help=entry.help;}
return{value:value,label:label,help:help,visible:true,disabled:false,selected:false};});}};creme.model.ChoiceGroupRenderer=creme.model.ChoiceRenderer.sub({insertGroup:function(target,before,groupname){var group=$('optgroup[label="'+groupname+'"]',target);if(group&&group.length){return group;}
group=$('<optgroup label="'+groupname+'">');if(before&&before.length){before.parent().before(group);}else{target.append(group);}
return group;},insertItem:function(target,before,data,index){var group=target;var previous_groupname=before&&before.length?before.parent().attr('label'):undefined;var next_groupname=data.group;if(next_groupname){group=this.insertGroup(target,before,next_groupname);}
if(before&&before.length){if(next_groupname&&previous_groupname!==next_groupname){before=$('option:first',group);}
before.before(this.createItem(target,before,data,index));}else{group.append(this.createItem(target,before,data,index));}},removeItem:function(target,item,data,index){var group=data.group?item.parent():undefined;item.remove();if(group&&$('option',group).length<1){group.remove();}},updateItem:function(target,item,data,previous,index,action){if(action==='select'){return this.selectItem(target,item,data,previous,index);}
var group=target;var prev_group=item.parent();var previous_groupname=previous?previous.group:undefined;var next_groupname=data.group;if(next_groupname){group=this.insertGroup(target,item.next(),next_groupname);}
if(previous_groupname!==next_groupname){item.remove();group.append(item);if(prev_group&&($('option',prev_group).length)<1){prev_group.remove();}}
var value=_cleanItemValue(data.value);item.attr('value',value).toggleProp('disabled',data.disabled===true).prop('selected',data.selected===true).toggleAttr('tags',data.tags,(data.tags||[]).join(' ')).html(data.label);}});creme.model.ChoiceGroupRenderer.parse=function(element,converter){var values=element.val();values=element.is('[multiple]')?(values||[]):[values];return $('option',element).map(function(){var option=$(this);var option_value=option.attr('value');var option_group=option.parent();return{group:(option_group&&option_group.is('optgroup'))?option_group.attr('label'):undefined,label:option.html(),value:Object.isFunc(converter)?converter(option_value):option_value,disabled:option.is('[disabled]'),readonly:option.is('[readonly]'),selected:values.indexOf(option_value)!==-1,visible:true,help:option.attr('help'),tags:option.is('[tags]')&&option.attr('tags')?option.attr('tags').split(' '):[]};}).get();};creme.model.ChoiceGroupRenderer.choicesFromTuples=function(data){data=data||[];var istuple=data?Array.isArray(data[0]):false;if(istuple){return data.map(function(entry){if(entry.length>2){return{value:entry[0],label:entry[1],group:entry[2],help:undefined,visible:true,disabled:false,selected:false};}else{return{value:entry[0],label:entry[1],group:undefined,help:undefined,visible:true,disabled:false,selected:false};}});}else{return data.map(function(entry){var value=null,label='null',group,help;if(!Object.isNone(entry)){value=entry.value!==undefined?entry.value:entry;label=entry.label!==undefined?entry.label:String(value);help=entry.help;group=entry.group;}
return{value:value,label:label,group:group,help:help,visible:true,disabled:false,selected:false};});}};creme.model.CheckListRenderer=creme.model.ListRenderer.sub({_init_:function(options,listeners){options=$.extend({itemtag:'li',disabled:false},options||{});this._super_(creme.model.ListRenderer,'_init_',options.target,options.model,listeners);this._itemtag=options.itemtag;this._disabled=options.disabled;},disabled:function(disabled){return Object.property(this,'_disabled',disabled);},itemTag:function(tag){return Object.property(this,'_itemtag',tag);},createItem:function(target,before,data,index){var disabled=data.disabled||this._disabled;var value=_cleanItemValue(data.value);var context={tag:this._itemtag,disabled:disabled||data.readonly?'disabled':'',value:String(value).escapeHTML(),index:index,checked:data.selected?'checked':'',label:data.label||'',help:data.help||'',hidden:!data.visible?'hidden':'',readonly:data.readonly?'readonly':'',tags:(data.tags||[]).join(' ')};var item=$(('<${tag} class="checkbox-field ${hidden}" checklist-index="${index}" tags="${tags}" ${disabled} ${readonly}>'+'<input type="checkbox" value="${value}" checklist-index="${index}" ${disabled} ${checked}/>'+'<div class="checkbox-label">'+'<span class="checkbox-label-text" ${disabled}>${label}</span>'+'<span class="checkbox-label-help" ${disabled}>${help}</span>'+'</div>'+'</${tag}>').template(context));var checkbox=$('input[type="checkbox"]',item);checkbox.data('checklist-item',{data:data,index:index});return item;},updateItem:function(target,item,data,previous,index,action){if(action==='select'){return this.selectItem(target,item,data,previous,index);}
var value=_cleanItemValue(data.value);var checkbox=$('input[type="checkbox"]',item);var disabled=(data.disabled||data.readonly)||this._disabled;var readonly=data.readonly||false;checkbox.toggleProp('disabled',data.disabled||disabled).attr('value',value).attr('checklist-index',index).data('checklist-item',{data:data,index:index});checkbox.prop('checked',data.selected);$('.checkbox-label-text',item).toggleProp('disabled',disabled).html(data.label);$('.checkbox-label-help',item).toggleProp('disabled',disabled).html(data.help);item.toggleAttr('tags',data.tags,(data.tags||[]).join(' ')).toggleClass('hidden',!data.visible).toggleProp('disabled',disabled).toggleAttr('readonly',readonly).attr('checklist-index',index);},selectItem:function(target,item,data,previous,index){$('input[type="checkbox"]',item).prop('checked',data.selected);},items:function(target){return $('.checkbox-field',target).sort(function(a,b){return parseInt($(a).attr('checklist-index'))-parseInt($(b).attr('checklist-index'));});},converter:function(converter){return Object.property(this,'_converter',converter);},parseItem:function(target,item,index){var converter=this._converter;var input=$('input[type="checkbox"]',item);var label=$('.checkbox-label-text',item);var help=$('.checkbox-label-help',item);var value=input.attr('value');return{label:label.html(),value:Object.isFunc(converter)?converter(value):value,disabled:input.is('[disabled]')||target.is('[disabled]'),readonly:item.is('[readonly]'),selected:input.is(':checked'),help:help.html(),tags:item.is('[tags]')&&item.attr('tags')?item.attr('tags').split(' '):[],visible:true};},parse:function(target){var self=this;this._itemtag=this.items(target).first().prop('tagName')||this._itemtag;return this.items(target).map(function(index){return self.parseItem(target,$(this),index);}).get();}});creme.model.CheckGroupListRenderer=creme.model.CheckListRenderer.sub({_init_:function(options,listeners){options=$.extend({grouptag:'ul'},options||{});this._super_(creme.model.CheckListRenderer,'_init_',options);this._grouptag=options.grouptag;},groupTag:function(tag){return Object.property(this,'_grouptag',tag);},insertGroup:function(target,before,groupname){var group=$('.checkbox-group[label="'+groupname+'"]',target);if(group&&group.length){return group;}
group=$(('<${tag} class="checkbox-group" label="${name}">'+'<li class="checkbox-group-header">${name}</li>'+'</${tag}>').template({tag:this._grouptag,name:groupname}));if(before&&before.length){before.parent().before(group);}else{target.append(group);}
return group;},insertItem:function(target,before,data,index){var group=target;var previous_groupname=before&&before.length?before.parent().attr('label'):undefined;var next_groupname=data.group;if(next_groupname){group=this.insertGroup(target,before,next_groupname);}
if(before&&before.length){if(next_groupname&&previous_groupname!==next_groupname){before=$('.checkbox-field:first',group);}
before.before(this.createItem(target,before,data,index));}else{group.append(this.createItem(target,before,data,index));}},removeItem:function(target,item,data,index){var group=data.group?item.parent():undefined;item.remove();if(group&&this.items(group).length<1){group.remove();}},updateItem:function(target,item,data,previous,index,action){if(action==='select'){return this._super_(creme.model.CheckListRenderer,'updateItem',target,item,data,previous,index,action);}
var group=target;var prev_group=item.parent();var previous_groupname=previous?previous.group:undefined;var next_groupname=data.group;if(next_groupname){group=this.insertGroup(target,item.next(),next_groupname);}
if(previous_groupname!==next_groupname){item.remove();group.append(item);if(prev_group&&(this.items(prev_group).length)<1){prev_group.remove();}}
return this._super_(creme.model.CheckListRenderer,'updateItem',target,item,data,previous,index,action);},parseItem:function(target,item,index){var data=this._super_(creme.model.CheckListRenderer,'parseItem',target,item,index);var checkbox_group=item.parent();data.group=(checkbox_group&&checkbox_group.is('.checkbox-group'))?checkbox_group.attr('label'):undefined;return data;}});}(jQuery));(function($){"use strict";creme.dialog=creme.dialog||{};var _DIALOG_SCROLLTYPES=['frame','background'];creme.dialog.Dialog=creme.component.Component.sub({_init_:function(options){this._events=new creme.component.EventHandler();this._isClosing=false;this._deferFrameActivation=false;var within=$('.ui-dialog-within-container');var maxHeight=within.length>0?within.innerHeight():null;options=this.options=$.extend({url:undefined,data:undefined,backend:undefined,resizable:true,draggable:true,width:640,height:Math.min(350,maxHeight),maxHeight:maxHeight,scroll:'frame',within:within,fitFrame:true,shrink:true,propagateEvent:false,useFrameTitleBar:true,useFrameActions:true,fillFrameOnError:false,closeOnEscape:true,scrollbackOnClose:true,id:undefined},options||{});this._initFrame(options);},_initFrame:function(options){var frame=this._frame=new creme.dialog.Frame({backend:options.backend,autoActivate:false,fillOnError:options.fillFrameOnError});frame.onCleanup(this._onFrameCleanup.bind(this)).onUpdate(this._onFrameUpdate.bind(this));frame.on('fetch-fail submit-fail',this._onFrameFail.bind(this));frame.bind($('<div>').data('creme-dialog',this).addClass('ui-creme-dialog-frame'));},_onFrameFail:function(){this.trigger('frame-fail',this.frame());if(this.options.fitFrame){this.fitToFrameSize();this.position(this.position());}},_onFrameCleanup:function(){this.trigger('frame-cleanup',this.frame());},_onFrameUpdate:function(){this.trigger('frame-update',this.frame());if(this.isOpened()){this._activateFrameContent();}else{this._deferFrameActivation=true;}},_activateFrameContent:function(){if(this._isClosing===true){return;}
if(this.options.useFrameTitleBar){var dialogHeader=this._dialog.parents('.ui-dialog').first().find('.ui-dialog-titlebar .ui-dialog-title');var header=$('.ui-creme-dialog-titlebar',this.frame().delegate()).first();if(header.length>0){header.appendTo(dialogHeader.empty());};}
if(this.options.useFrameActions){this.replaceButtons(this._orderedFrameActionButtons(this.options));}
this.frame().activateContent();if(this.options.fitFrame){this.fitToFrameSize();}
this.trigger('frame-activated',this.frame());if(this.options.closeOnEscape){this.resetFocus();}},_dialogBackground:function(){return this._dialog?$('body > :not(.ui-dialog)'):$([]);},_destroyDialog:function(){if(this._dialog){this._dialogBackground().toggleClass('ui-dialog-scrollbackground',false);this._dialog.dialog('destroy');this._dialog.remove();this._dialog=undefined;creme.utils.scrollBack(this._scrollbackPosition,'slow');this._scrollbackPosition=null;}},_onClose:function(dialog,frame,options){try{this._isClosing=true;frame.clear();}finally{this._isClosing=false;}
this.trigger('before-destroy',options);this._destroyDialog();this.trigger('close',options);},_onOpen:function(dialog,frame,options){this._dialog=dialog;if(options.scroll==='background'){this._dialog.css('overflow-y','hidden');this._dialogBackground().toggleClass('ui-dialog-scrollbackground',true);}
if(!Object.isEmpty(options.url)){this.fetch(options.url);}else if(!Object.isEmpty(options.html)){this.fill(options.html);}
if(this._deferFrameActivation){this._activateFrameContent();this._deferFrameActivation=false;}
if(options.closeOnEscape&&!options.autoFocus){this.resetFocus();}
if(options.scrollbackOnClose){this._scrollbackPosition=creme.utils.scrollBack();}
this.trigger('open',options);},_onResize:function(dialog,frame){var container=this._dialogContainer();var body=$('> .ui-dialog-content',container);var delegate=frame.delegate();delegate.width(body.width()-(delegate.position().left+(body.outerWidth()-body.width())));this.trigger('resize',delegate.width(),delegate.height());},_frameFetchData:function(data){var options=this.options;var fetchData=Object.isFunc(options.data)?options.data.bind(this)(options,data):options.data||{};return $.extend({},fetchData,data);},_frameActionLinkButtons:function(options){var self=this;var buttons={};var index=1;$('a.ui-creme-dialog-action',this.content()).each(function(){var name=$(this).attr('name');if(Object.isEmpty(name)){name="link-"+index;++index;}
var label=$(this).text()||gettext("Action");var url=$(this).attr('href');self._appendButton(buttons,name,label,function(){this.fetch(url);});});return buttons;},_frameActionButtons:function(options){var buttons=this._defaultButtons({},options);return $.extend(buttons,this._frameActionLinkButtons(options));},_orderedFrameActionButtons:function(options){var buttons=this._frameActionButtons(options);return Object.values(buttons).sort(function(a,b){return(a.order||0)-(b.order||0);});},_appendButton:function(buttons,name,label,action,options){var self=this;var labels=this.options.defaultButtonLabels||{};options=options||{};var button=$.extend({'name':name,'text':labels[name]||label,'click':function(e){action.apply(self,[$(this),e,options]);return false;}},options);buttons[name]=button;return button;},_defaultButtons:function(buttons,options){this._appendButton(buttons,'close',gettext('Close'),function(button,e,options){this.close();});return buttons;},_removeButton:function(name){this.button(name).detach();},_updateButtonState:function(name,enabled,focus){var button=this.button(name);button.removeClass('ui-state-focus ui-state-hover ui-state-active');button.toggleClass('ui-state-disabled',!enabled);button.toggleProp('disabled',!enabled);if((!this.options.autoFocus&&focus==='auto')||focus===true){button.trigger('focus');}},_updateButtonLabel:function(name,label){this.button(name).html(label);},_dialogContainer:function(){return $(this._dialog).parent('.ui-dialog').first();},_dialogOption:function(name,value){if(value===undefined){return this._dialog.dialog('option',name);}else{this._dialog.dialog('option',name,value);}},_resizeDialog:function(width,height){if(!this.isOpened()){return;}
var maxSize=this.maxSize();var minSize=this.minSize();width=_.clamp(width,minSize.width,maxSize.width);height=_.clamp(height,minSize.height,maxSize.height);this._dialogOption('width',width);this._dialogOption('height',height);if(this.options.shrink){this._frame.delegate().css({'min-height':minSize.height,'width':'auto'});}else{var framePreferredHeight=_.clamp(this._frame.preferredSize()[1],minSize.height);this._frame.delegate().css({'min-height':framePreferredHeight,'width':'auto'});}
this._frame.overlay().resize();return{width:width,height:height};},fitToFrameSize:function(){if(!this.isOpened()){return this;}
var container=this._dialogContainer();var body=$('> .ui-dialog-content',container);body.css({height:'auto',width:'auto'});var size=this._resizeDialog(container.width(),container.height());this.position(this.position());body.css({"max-height":size.height+30,"height":'auto'});},center:function(constraint){if(this.isOpened()){constraint=constraint||{};var position=this.cssPosition();if(constraint.top>0&&position.top<constraint.top){this.position({my:'center top',at:'center top+'+(constraint.top)});}else{this.position({my:"center center",at:"center center"});}}
return this;},cssPosition:function(){if(this.isOpened()){return this._dialogContainer().position();}},position:function(position){if(position===undefined){return this._dialog?this._dialog.dialog('option','position'):undefined;}
if(Object.isEmpty(this.options.within)===false){position=$.extend({},position,{collision:'fit',within:this.options.within});}
this._dialogOption('position',position);return this;},frame:function(){return this._frame;},content:function(){return this._frame.delegate();},buttons:function(){return $('.ui-dialog-buttonset',this._dialogContainer());},button:function(name){return $('button[name="'+name+'"]',this.buttons());},replaceButtons:function(buttons){this._dialogOption('buttons',buttons);},resize:function(width,height){this._resizeDialog(width,height);},resizeToDefault:function(){return this.resize(this.options.width,this.options.height);},size:function(){if(this.isOpened()){return{width:this._dialogOption('width'),height:this._dialogOption('height')};}},minSize:function(size){if(size===undefined){if(this.isOpened()){return{width:this._dialogOption('minWidth'),height:this._dialogOption('minHeight')};}}else{if(this.isOpened()){this._dialogOption('minWidth',size.width);this._dialogOption('minHeight',size.height);}
return this;}},maxSize:function(size){if(size===undefined){if(this.isOpened()){return{width:this._dialogOption('maxWidth'),height:this._dialogOption('maxHeight')};}}else{if(this.isOpened()){this._dialogOption('maxWidth',size.width);this._dialogOption('maxHeight',size.height);}
return this;}},fetch:function(url,options,data,listeners){this._frame.fetch(url,options,this._frameFetchData(data),listeners);return this;},fill:function(data){this._frame.fill(data);return this;},clear:function(){this._frame.clear();return this;},dialog:function(){return this._dialog;},resetFocus:function(){if(this.isOpened()){var instance=this._dialog.dialog("instance");instance._focusedElement=null;instance._focusTabbable();}
return this;},focus:function(){if(this.isOpened()){var instance=this._dialog.dialog("instance");instance._focusTabbable();}
return this;},title:function(title){if(title===undefined){return this._dialogOption('title');}
this._dialogOption('title',String(title).decodeHTMLEntities());return this;},onClose:function(closed){this._events.bind('close',closed);return this;},onOpen:function(opened){this._events.bind('open',opened);return this;},id:function(){return this.options.id;},trigger:function(event){var data=Array.from(arguments).slice(1);if(this.options.propagateEvent){if(this.isOpened()){$(this._dialog).trigger('dialog-'+event,[this].concat(data||[]));}else{$(document).trigger('dialog-'+event,[this].concat(data||[]));}}
this._events.trigger(event,data,this);return this;},one:function(event,listener,decorator){this._events.one(event,listener,decorator);return this;},on:function(event,listener,decorator){this._events.bind(event,listener,decorator);return this;},off:function(event,listener){this._events.unbind(event,listener);return this;},_onDragStop:function(dialog){this.position(this.position());},_onResizeStop:function(dialog){this.position(this.position());},open:function(options){if(this._dialog!==undefined){throw Error('dialog already opened !');}
options=$.extend(this.options,options||{});var self=this;var frame=this._frame;var container=frame.delegate();var dialogId=Object.isFunc(options.id)?options.id():options.id||'';var buttons=$.extend(this._defaultButtons({},options),options.buttons||{});var content=$('<div/>').append(container);var scroll=Assert.in(options.scroll,_DIALOG_SCROLLTYPES,'scroll type "${value}" is invalid');var isFramescroll=(scroll==='frame');var position={};content.data('uiCremeDialog',this);if(!Object.isEmpty(dialogId)){content.attr('id',dialogId);}
if(Object.isEmpty(options.within)){position={my:"center center",at:"center center"};}else{position={my:"center center+"+options.within.position().top,at:"center center",collision:'fit',within:options.within};}
var resizable=isFramescroll?options.resizable:false;var draggable=isFramescroll?options.draggable:false;var width=_.clamp(options.width,options.minWidth,options.maxWidth);var height=_.clamp(options.height,options.minHeight,options.maxHeight);var title=options.title?String(options.title).decodeHTMLEntities():options.title;var dialogOptions={dialogClass:'ui-creme-dialog',buttons:Object.values(buttons),title:title,modal:true,resizable:resizable,draggable:draggable,width:width,height:height,maxHeight:options.maxHeight,maxWidth:options.maxWidth,minHeight:options.minHeight,minWidth:options.minWidth,position:position,closeOnEscape:options.closeOnEscape,open:function(){self._onOpen($(this),frame,options);},resize:function(){self._onResize($(this),frame);},close:function(){self._onClose($(this),frame,options);},dragStop:function(){self._onDragStop($(this));},resizeStop:function(){self._onResizeStop($(this));}};this._dialog=content.dialog(dialogOptions);return this;},close:function(){this._onClose(this._dialog,this._frame,this.options);return this;},isOpened:function(){return this._dialog!==undefined;}});creme.dialog.DialogAction=creme.component.Action.sub({_init_:function(options,listeners){this._super_(creme.component.Action,'_init_',this._openPopup,options);this._listeners=listeners||{};},dialog:function(){return this._dialog;},_onClose:function(){delete this._dialog;this._dialog=undefined;this.done();},_buildPopup:function(options){var self=this;options=$.extend(this.options(),options||{});this._dialog=new creme.dialog.Dialog(options).onClose(function(){self._onClose();}).on(this._listeners);return this._dialog;},_openPopup:function(options){this._buildPopup(options).open();}});creme.dialogs=creme.dialogs||{};creme.dialogs=$.extend(creme.dialogs,{image:function(source,options){return new creme.dialog.ImagePopover(options).fillImage(source);},url:function(url,options,data){options=options||{};var dialog=new creme.dialog.Dialog(options).fetch(url,{},data);if(options.reloadOnClose){dialog.onClose(function(){creme.utils.reload();});}
return dialog;},form:function(url,options,data){options=$.extend({validator:'innerpopup'},options||{});var dialog=new creme.dialog.FormDialog(options);dialog.fetch(url,{},data);if(options.reloadOnSuccess){dialog.onFormSuccess(function(){creme.utils.reload();});}else if(options.redirectOnSuccess){dialog.onFormSuccess(function(event,response,dataType){var url;if(options.redirectOnSuccess===true){if(response.isHTMLOrElement()){url=response.data().attr('redirect');}else if(response.isPlainText()){url=response.content;}}else{url=options.redirectOnSuccess;}
if(!Object.isEmpty(url)){creme.utils.goTo(url);}});}
return dialog;},html:function(html,options){options=options||{};var dialog=new creme.dialog.Dialog($.extend({},options,{html:html}));if(options.reloadOnClose){dialog.onClose(function(){creme.utils.reload();});}
return dialog;},confirm:function(message,options){return new creme.dialog.ConfirmDialog(message,options);},choice:function(message,options){options=$.extend({required:false},options||{});var data=options.choices||[];var selected=options.selected||(data?data[0]:null);var selector=new creme.model.ChoiceGroupRenderer($("<select style='width:100%;'>"),data).redraw().target();var content=$('<div>');selector.toggleAttr('required',options.required);if(Object.isEmpty(selected.value)===false){selector.val(selected.value);}else if(options.required){selector.val($('option',selector).first().attr('value'));}
if(message){content.append($('<div>').html(message));}
content.append($('<p>').append(selector));return new creme.dialog.SelectionDialog(options).fill(content).validator(function(value){return Object.isEmpty(creme.forms.validateHtml5Field(selector));}).selector(function(frame){return selector.val();});},alert:function(message,options){options=$.extend({title:gettext('Alert'),header:''},options||{});var header=options.header||'';var content=$('<p class="ui-creme-dialog-warn">').append($('<span class="ui-icon ui-icon-alert">'));if(header){content.append($('<span class="header">').html(header)).append($('<p class="message">').html(message));}else{content.append($('<span class="message">').html(message));}
return this.html(content,options);},warning:function(message,options){options=$.extend({title:gettext('Warning')},options||{});return this.alert(message,options);},error:function(message,options,xhr){var header=creme.ajax.localizedErrorMessage(xhr);options=$.extend({title:gettext('Error'),header:header},options||{});return this.alert(message||'',options);}});$.widget("ui.dialog",$.ui.dialog,{_allowInteraction:function(event){if(event!==undefined){if($(event.target).closest('.select2-dropdown').length){return true;}}
return this._super(event);},fitToFrameSize:function(){var dialog=this.cremeInstance();if(!Object.isNone(dialog)){dialog.fitToFrameSize();}},resize:function(width,height){var dialog=this.cremeInstance();if(!Object.isNone(dialog)){dialog.resize(width,height);}},cremeInstance:function(){return this.element.data('uiCremeDialog');}});}(jQuery));(function($){"use strict";creme.dialog=creme.dialog||{};creme.dialog.Overlay=creme.component.Component.sub({_init_:function(options){var self=this;options=options||{};this._content=$('<div/>').addClass('overlay-content');this._overlay=$('<div/>').addClass('ui-creme-overlay').append(this._content);this._timeout=new creme.component.TimeoutAction();this._timeout.onDone(function(event,options){self.update(options.visible,options.status);});},update:function(visible,status,delay){this._timeout.cancel();if(delay>0){this._timeout.start({delay:delay,visible:visible,status:status});return this;}
this.visible(visible||false);if(status===undefined){this._overlay.removeAttr('status');}else{this._overlay.attr('status',status);}
return this;},addClass:function(){this._overlay.addClass.apply(this._overlay,arguments);return this;},removeClass:function(){this._overlay.removeClass.apply(this._overlay,arguments);return this;},toggleClass:function(){this._overlay.toggleClass.apply(this._overlay,arguments);return this;},content:function(content){if(content===undefined){return this._content;}
this._content.html(content);return this;},visible:function(visible){if(visible===undefined){return this._overlay.hasClass('overlay-active');}
visible=visible||false;if(!this.isBound()||this.visible()===visible){return this;}
this._overlay.toggleClass('overlay-active',visible);if(visible){this._targetOverflowX=this._target.css('overflow-x');this._targetOverflowY=this._target.css('overflow-y');this._targetPosition=this._target.css('position');this._target.css({'overflow-x':'hidden','overflow-y':'hidden','position':'relative'});this.resize();this._target.append(this._overlay);}else{this._overlay.remove();this._target.css({'overflow-x':this._targetOverflowX,'overflow-y':this._targetOverflowY,'position':this._targetPosition});}
return this;},resize:function(){if(!this.isBound()||!this.visible()){return this;}
var padding=BrowserVersion.isFirefox()?1:0;this._overlay.css('width',this._target.outerWidth()+padding).css('height',this._target.height());return this;},bind:function(element){var self=this;if(this.isBound()){throw new Error('Overlay is already bound.');}
this._target=element;this._target.on('resize',function(){self.resize();});return this;},unbind:function(){if(this.isBound()===false){throw new Error('Overlay is not bound.');}
this.visible(false);this._overlay.detach();this._target=undefined;return this;},target:function(){return this._target;},isBound:function(){return Object.isNone(this._target)===false;},state:function(){return this._overlay.attr('status');}});}(jQuery));(function($){"use strict";creme.dialog=creme.dialog||{};creme.dialog.FrameContentData=creme.component.Component.sub({_init_:function(content,dataType){var cleaned={};if(Object.isNone(content)){cleaned={content:'',type:'text/plain'};}else if(creme.dialog.FrameContentData.prototype.isPrototypeOf(content)){cleaned={content:content.content,type:content.type,data:content._cleanedData};}else if(Object.isString(content)){switch(dataType){case'text/plain':cleaned={content:String(content),type:dataType};break;case'html':case'text/html':cleaned=this._cleanPRE(content);if(cleaned.type==='text/plain'){try{cleaned=this._cleanJSON(cleaned.content,dataType);}catch(e){}}else{cleaned=this._cleanHTML(content,dataType);}
break;case'text/json':case'text/javascript':case'application/json':case'application/javascript':cleaned=this._cleanPRE(content,'text/plain');try{cleaned=this._cleanJSON(cleaned.content,dataType);}catch(e){}
break;default:cleaned=this._cleanPRE(content);try{cleaned=this._cleanJSON(cleaned.content);}catch(e){if(!cleaned.type){cleaned=this._cleanHTML(cleaned.content);}}
console.warn('[frame] unrecognized content-type "%s"... guessed as "%s"'.format(dataType,cleaned.type));}}else if(Object.getPrototypeOf(content).jquery){cleaned={content:content,type:'object/jquery'};}else if(Object.isType(content,'object')){cleaned={content:content,type:'object'};}else{cleaned={content:Object.isNone(content)?'':String(content),data:content,type:'text/plain'};}
this.content=cleaned.content;this.type=cleaned.type;this._cleanedData=cleaned.data;},_cleanPRE:function(content,dataType){var matches=content.match(new RegExp('^[\\s]*<pre[^>]*>([^<]*)</pre>.*$'));if(matches!==null&&matches.length===2){return{content:matches[1],type:'text/plain'};}
return{content:content,type:dataType};},_cleanJSON:function(content,dataType){try{return{content:content,data:JSON.parse(content),type:'text/json'};}catch(e){if(dataType){console.warn('[frame] received invalid JSON data with content-type "%s"'.format(dataType),e);}
throw e;}},_cleanWrappedJSON:function(content,dataType){var matches=content.match(new RegExp('^[\\s]*<json>(.*)</json>[\\s]*$','i'));if(matches!==null&&matches.length===2){try{return this._cleanJSON(matches[1]);}catch(e){}}
return{content:content,type:dataType};},_cleanHTML:function(content,dataType){var cleaned=this._cleanWrappedJSON(content,dataType);if(cleaned.type==='text/json'){return cleaned;}
try{return{content:content,data:$(content.trim()),type:'text/html'};}catch(e){if(dataType){console.warn('[frame] received invalid HTML with content-type "%s": '.format(dataType),e);}
return{content:content,type:'text/plain'};}},data:function(){return this._cleanedData||this.content;},isEmpty:function(){return Object.isEmpty(this.data());},isPlainText:function(){return this.type==='text/plain';},isJSONOrObject:function(){return['application/json','text/json','object'].indexOf(this.type)!==-1;},isHTMLOrElement:function(){return creme.utils.isHTMLDataType(this.type)||(this.type==='object/jquery');},isHTML:function(){return creme.utils.isHTMLDataType(this.type);}});creme.dialog.Frame=creme.component.Component.sub({_init_:function(options){options=$.extend({autoActivate:true,overlayDelay:200,fillOnError:false},options||{});this._overlay=new creme.dialog.Overlay();this._overlayDelay=options.overlayDelay;this._contentReady=false;this._fillOnError=options.fillOnError;this._backend=options.backend||creme.ajax.defaultBackend();this._events=new creme.component.EventHandler();this._autoActivate=options.autoActivate;},on:function(event,listener){this._events.on(event,listener);return this;},onUpdate:function(listener){return this.on('update',listener);},onCleanup:function(listener){return this.on('cleanup',listener);},onFetchDone:function(listener){return this.on('fetch-done',listener);},onFetchFail:function(listener){return this.on('fetch-fail',listener);},onSubmitDone:function(listener){return this.on('submit-done',listener);},onSubmitFail:function(listener){return this.on('submit-fail',listener);},_cleanResponse:function(response,dataType){return new creme.dialog.FrameContentData(response,dataType);},deactivateContent:function(){if(this._contentReady){creme.widget.shutdown(this._delegate);this._contentReady=false;}},activateContent:function(){if(!this._contentReady){creme.widget.ready(this._delegate);this._contentReady=true;}},isContentReady:function(){return this._contentReady;},fill:function(data,action){data=this._cleanResponse(data,'text/html');var delegate=this._delegate;var overlay=this._overlay;if(!data.isHTMLOrElement()){return this;}
try{overlay.unbind(delegate).update(false);this._events.trigger('cleanup',[delegate,action],this);this.deactivateContent();delegate.empty();overlay.bind(delegate);var content=data.data();if(content.length>0){delegate.append(content);if(this._autoActivate){this.activateContent();}}}catch(e){console.error(e);}
this._events.trigger('update',[data.content,data.type,action],this);return this;},lastFetchUrl:function(){return this._lastFetchUrl;},clear:function(){return this.fill('');},resize:function(args){this._delegate.trigger('resize',args);},_cleanErrorResponse:function(url,response,error){var status=error?error.status:404;var cleaned=this._cleanResponse(response,"text/html");if(cleaned.isHTMLOrElement()&&!cleaned.isEmpty()){return cleaned;}else{return this._cleanResponse(('<h2>${statusMessage}&nbsp;(${status})<div class="subtitle">${url}</div></h2>'+'<p class="message">${message}</p>'+'<a class="redirect" onclick="creme.utils.reload();">'+
gettext('Reload the page or click here. If the problem persists, please contact your administrator.')+'</a>').template({statusMessage:creme.ajax.localizedErrorMessage(error),status:status,url:url,message:response||''}),"text/html");}},fetch:function(url,options,data,listeners){var self=this;listeners=listeners||{};url=url||this.lastFetchUrl();var query=this._backend.query();var overlay=this._overlay;var events=this._events;events.trigger('before-fetch',[url,options],this);overlay.content('').update(true,'wait',this._overlayDelay);query.onDone(function(event,response){self._lastFetchUrl=url;self.fill(response,'fetch');events.trigger('fetch-done',[response],this);}).on('cancel fail',function(event,response,error){var errorStatus=error?error.status:404;var errorContent=self._cleanErrorResponse(url,response,error);if(self._fillOnError){self.fill(errorContent,'fetch');}else{overlay.update(true,errorStatus,0).content(errorContent.data());}
events.trigger('fetch-fail',[response,error],this);});query.one(listeners).url(url||'').get(data,options);return this;},submit:function(url,options,form,listeners){var self=this;url=(form?(url||form.attr('action')):url)||this.lastFetchUrl();options=$.extend({action:url},options||{});listeners=listeners||{};var overlay=this._overlay;var events=this._events;this._events.one(listeners);this._events.trigger('before-submit',[form,options],this);if(Object.isEmpty(options.action)){overlay.update(true,404,0);events.trigger('submit-fail',['',new creme.ajax.XHR({responseText:'',status:404})],this);return this;}
this._overlay.content('').update(true,'wait',this._overlayDelay);this._backend.submit(form,function(response,statusText,xhr){var dataType=xhr.getResponseHeader('Content-Type').split(';')[0];var cleaned=self._cleanResponse(response,dataType);if(cleaned.isHTMLOrElement()){self.fill(cleaned,'submit');}
events.trigger('submit-done',[cleaned,cleaned.type],this);},function(response,error){var errorStatus=error?error.status:500;var errorContent=self._cleanErrorResponse(url,response,error);if(self._fillOnError){self.fill(errorContent,'submit');}else{overlay.update(true,errorStatus,0).content(errorContent.data());}
events.trigger('submit-fail',[response,error],this);},options);return this;},isBound:function(){return Object.isNone(this._delegate)===false;},bind:function(delegate){if(this.isBound()){throw new Error('frame component is already bound');}
this._delegate=delegate;this._overlay.bind(delegate);return this;},unbind:function(){if(this.isBound()===false){throw new Error('frame component is not bound');}
this._overlay.unbind(this._delegate);this._delegate=undefined;return this;},backend:function(backend){return Object.property(this,'_backend',backend);},delegate:function(){return this._delegate;},autoActivate:function(auto){return Object.property(this,'_autoActivate',auto);},overlay:function(){return this._overlay;},overlayDelay:function(delay){return Object.property(this,'_overlayDelay',delay);},preferredSize:function(){return this._delegate?creme.layout.preferredSize(this._delegate,2):{width:0,height:0};}});}(jQuery));(function($){"use strict";creme.dialog=creme.dialog||{};creme.dialog.ConfirmDialog=creme.dialog.Dialog.sub({_init_:function(message,options){options=$.extend({title:gettext('Confirm'),fitFrame:true,height:200},options||{});this._super_(creme.dialog.Dialog,'_init_',options);this.message(message);},ok:function(){this._destroyDialog();this._events.trigger('ok',[],this);return this;},message:function(message){this.options.html='<p>'+message+'</p>';return this.isOpened()?this.fill(this.options.html):this;},_defaultButtons:function(buttons,options){this._appendButton(buttons,'ok',gettext('Ok'),function(button,e,options){this.ok();});this._appendButton(buttons,'cancel',gettext('Cancel'),function(button,e,options){this.close();});return buttons;},onOk:function(cb){this._events.bind('ok',cb);return this;}});}(jQuery));(function($){"use strict";creme.dialog=creme.dialog||{};var _defaultValidator=function(response,dataType){return!response.isHTML()||response.content.match(/<form[^>]*>/)===null;};var _innerPopupValidator=function(response,dataType){console.warn('"innerpopup" validator of creme.dialog.FormDialog is now deprecated; should use "default" instead');var content=response.content;if(Object.isEmpty(content)||!response.isHTML()){return true;}
if(content.match(/^<div[^>]+class="in-popup"[^>]*>/)){if(content.match(/^<div[^>]+closing="true"[^>]*>/)){return true;}
return(content.match(/<form[^>]*>/)===null);}
return false;};var _FORM_VALIDATORS={'default':_defaultValidator,'innerpopup':_innerPopupValidator};creme.dialog.FormDialog=creme.dialog.Dialog.sub({_init_:function(options){options=$.extend({autoFocus:true,submitOnKey:13,submitData:{},noValidate:false,validator:'default',closeOnFormSuccess:true},options||{});this._super_(creme.dialog.Dialog,'_init_',options);this.validator(options.validator);this.frame().on('before-submit before-fetch',this._onBeforeFrameUpdate.bind(this));this._submitListeners={'submit-done':this._onSubmitDone.bind(this),'submit-fail':this._onSubmitFail.bind(this)};this._submitKeyCb=this._onSubmitKey.bind(this);this._submitKey=options.submitOnKey?options.submitOnKey:false;},validator:function(validator){if(validator===undefined){return this._validator;}
var cleaned=Object.isString(validator)?_FORM_VALIDATORS[validator]:validator;if(!Object.isFunc(cleaned)){if(Object.isString(validator)){throw new Error('FormDialog validator "${validator}" is unknown'.template({validator:validator}));}else{throw new Error('FormDialog validator "${validator}" is not a function'.template({validator:validator}));}}
this._validator=cleaned.bind(this);return this;},_validate:function(data,dataType){var validator=this.validator();return!Object.isFunc(validator)||validator(data,dataType);},_frameSubmitData:function(data){var options=this.options;var submitData=Object.isFunc(options.submitData)?options.submitData.bind(this)(options,data):options.submitData||{};return $.extend({},submitData,data);},form:function(){return $('form:first',this.content());},submit:function(options,data,listeners){options=options||{};var form=this.form();var errors=creme.forms.validateHtml5Form(form,{noValidate:options.noValidate||this.options.noValidate});if(Object.isEmpty(errors)===false){return this;}
data=Object.isFunc(data)?data.bind(this)(options):data;var submitData=this._frameSubmitData(data);this.frame().submit('',$.extend({},options,{data:submitData}),form,this._submitListeners);return this;},_onBeforeFrameUpdate:function(){this._updateButtonState("send",false);this._updateButtonState("cancel",true,false);},_onFrameCleanup:function(){this._super_(creme.dialog.Dialog,'_onFrameCleanup');this.frame().delegate().off('keypress',this._submitKeyCb);},_onFrameUpdate:function(event,data,dataType,action){if(action!=='submit'){this._super_(creme.dialog.Dialog,'_onFrameUpdate',event,data,dataType,action);}
var content=this.frame().delegate();if(this.options.autoFocus){var autofocus=$('[autofocus]:tabbable:first',content);if(autofocus.length>0){autofocus.trigger('focus');}else{$(':tabbable:first',content).trigger('focus');}}else{$(':tabbable',content).trigger('blur');}
content.on('keypress',this._submitKeyCb);},_onSubmitDone:function(event,response,dataType){if(this._validate(response,dataType)){this.trigger('form-success',response,dataType);if(this.options.closeOnFormSuccess){this._frame.clear();this._destroyDialog();}else{this._removeButton('send');this._updateButtonLabel('cancel',gettext('Close'));}}else{this._super_(creme.dialog.Dialog,'_onFrameUpdate',event,response.content,dataType,'submit');this._updateButtonState("send",true,'auto');this._updateButtonState("cancel",true);this.trigger('form-error',response.content,dataType);}},_onSubmitFail:function(event,data,statusText){this._updateButtonState("send",false);this._updateButtonState("cancel",true,true);},_onSubmitKey:function(e){if(e.keyCode===this._submitKey&&$(e.target).is(':not(textarea)')){e.preventDefault();this.button('send').trigger('click');}},_onOpen:function(dialog,frame,options){var self=this;frame.onFetchFail(function(data,status){self._updateButtonState("send",false);self._updateButtonState("cancel",true,true);}).onFetchDone(function(data,status){self._updateButtonState("send",true,'auto');self._updateButtonState("cancel",true);});this._super_(creme.dialog.Dialog,'_onOpen',dialog,frame,options);},_frameActionFormSubmitButtons:function(options){var self=this;var buttons={};var buttonIds={};var submitCb=function(button,e,options){options=$.extend({noValidate:button.is('[novalidate]')},options||{});this.submit(options,options.data);};var buildUniqueButtonId=function(id){var suffix=buttonIds[id]||0;buttonIds[id]=suffix+1;return(suffix>0)?id+'-'+suffix:id;};$('.ui-creme-dialog-action[type="submit"]',this.content()).each(function(){var item=$(this);var data={};var name=item.attr('name');var label=item.text();var order=parseInt(item.attr('data-dialog-action-order')||0);var value=item.val();var id=buildUniqueButtonId(name||'send');var noValidate=item.is('[data-no-validate]');if(item.is('input')){label=value||gettext('Save');}else{label=label||gettext('Save');if(!Object.isEmpty(name)&&!Object.isNone(value)){data[name]=value;}}
self._appendButton(buttons,id,label,submitCb,{data:data,order:order,noValidate:noValidate});}).toggleProp('disabled',true);if(Object.isEmpty(buttons)){this._appendButton(buttons,'send',gettext('Save'),submitCb);}
return buttons;},_frameActionButtons:function(options){var buttons=this._super_(creme.dialog.Dialog,'_frameActionButtons',options);$.extend(buttons,this._frameActionFormSubmitButtons(options));return buttons;},_defaultButtons:function(buttons,options){this._appendButton(buttons,'cancel',gettext('Cancel'),function(button,e,options){this.close();});return buttons;},onFormSuccess:function(listeners){this._events.bind('form-success',listeners);return this;},onFormError:function(listeners){this._events.bind('form-error',listeners);return this;},submitKey:function(value){return Object.property(this,'_submitKey',value);}});creme.dialog.FormDialogAction=creme.component.Action.sub({_init_:function(options,listeners){this._super_(creme.component.Action,'_init_',this._openPopup,options);this._listeners=listeners||{};},_onSubmit:function(event,response,dataType){this.done(response,dataType);},_buildPopup:function(options){var self=this;options=$.extend({},this.options(),options||{});var form=new creme.dialog.FormDialog(options).onFormSuccess(this._onSubmit.bind(this)).onClose(function(){self.cancel();}).on(this._listeners);return form;},_openPopup:function(options){this._buildPopup(options).open();}});}(jQuery));(function($){"use strict";creme.dialog.SelectionDialog=creme.dialog.Dialog.sub({_init_:function(options){options=$.extend({title:gettext('Selection'),fitFrame:false,height:200},options||{});this._super_(creme.dialog.Dialog,'_init_',options);},validator:function(validator){return Object.property(this,'_validator',validator);},selector:function(selector){return Object.property(this,'_selector',selector);},selected:function(){var selector=this._selector;return Object.isFunc(selector)?selector.apply(this,[this.content()]):[];},ok:function(){var validator=this._validator;var selected=this.selected();if(Object.isFunc(validator)&&validator(selected)===false){return this;}
this._destroyDialog();this._events.trigger('ok',[selected],this);return this;},_defaultButtons:function(buttons,options){this._appendButton(buttons,'ok',gettext('Ok'),function(button,e,options){this.ok();});this._appendButton(buttons,'cancel',gettext('Cancel'),function(button,e,options){this.close();});return buttons;},onOk:function(cb){this._events.bind('ok',cb);return this;}});}(jQuery));(function($){"use strict";creme.dialog=creme.dialog||{};creme.dialog.GlassPane=creme.component.Component.sub({_init_:function(options){options=$.extend({debug:false,modal:false},options||{});this._events=new creme.component.EventHandler();this._options=options;this._opened=false;this._initFrame(options);},_initFrame:function(options){var pane=this._pane=$('<div class="glasspane">');if(options.debug){pane.attr('data-debug','');}},pane:function(){return this._pane;},addClass:function(){this._pane.addClass.apply(this._pane,arguments);return this;},removeClass:function(){this._pane.removeClass.apply(this._pane,arguments);return this;},toggleClass:function(){this._pane.toggleClass.apply(this._pane,arguments);return this;},on:function(event,listener,decorator){this._events.on(event,listener,decorator);return this;},off:function(event,listener){this._events.off(event,listener);return this;},open:function(anchor){if(this.isOpened()){throw Error('glasspane is already opened');}
var pane=this._pane;if(anchor){var zindex=anchor.css('z-index')-1;if(zindex>0){pane.css('z-index',zindex);}}
$('body').append(pane);this._opened=true;this._pane.trigger('glasspane-opened',this);this._events.trigger('opened',[],this);return this;},isOpened:function(){return this._opened;},close:function(){if(this.isOpened()===false){return this;}
this._pane.detach();this._opened=false;this._pane.trigger('glasspane-closed',this);this._events.trigger('closed',[],this);return this;},toggle:function(anchor){if(this.isOpened()){return this.close();}else{return this.open(anchor);}}});}(jQuery));(function($){"use strict";var _DIRECTIONS=['top','left','right','bottom','bottom-left','bottom-right','center','center-window'];creme.dialog=creme.dialog||{};creme.dialog.Popover=creme.component.Component.sub({_init_:function(options){options=$.extend({title:false,closeIfOut:true,direction:'bottom',modal:true,scrollbackOnClose:false},options||{});this._events=new creme.component.EventHandler();this._options=options;this._initFrame(options);},_initFrame:function(options){var content=$('<div class="popover-content"/>');var dialog=this._dialog=$('<div class="popover"><div class="arrow"></div>');dialog.append($('<div class="popover-title hidden"/>'));dialog.append(content);this._glasspane=new creme.dialog.GlassPane().addClass('popover-glasspane');this.title(options.title);this.direction(options.direction);},open:function(anchor,options){if(this.isOpened()){throw Error('popover is already opened');}
if(this._options.modal){$('.popover').trigger('modal-close');}
options=this._options=$.extend({},this._options,options||{});anchor=$(anchor);if(anchor.length===0){anchor=$('.ui-dialog-within-container');}
var dialog=this._dialog;var close=this.close.bind(this);dialog.css('visibility','hidden');this._anchor=anchor;$('body').append(dialog);this._glasspane.open(dialog);this._onclose=function(){close();};this.direction(options.direction||'bottom');dialog.css('visibility','visible');dialog.on('modal-close',this._onclose);if(options.closeIfOut){this._glasspane.pane().on('mousedown',this._onclose);}
if(options.scrollbackOnClose){this._scrollbackPosition=creme.utils.scrollBack();}
this._events.trigger('opened',[],this);return this;},isOpened:function(){return Object.isNone(this._anchor)===false;},_updateDialogPosition:function(dialog,anchor,direction){var position=$.extend({top:0,left:0},anchor.offset());var anchorWidth=anchor.outerWidth()||0;var anchorHeight=anchor.outerHeight()||0;var width=dialog.outerWidth()||0;var height=dialog.outerHeight()||0;switch(direction){case'bottom':position.top+=anchorHeight;position.left+=(anchorWidth-width)/2;break;case'bottom-left':position.top+=anchorHeight;position.left-=(width-anchorWidth-18);break;case'bottom-right':position.top+=anchorHeight;position.left-=(anchorWidth/2);break;case'top':position.top-=height;position.left+=(anchorWidth-width)/2;break;case'right':position.top+=(anchorHeight/2)-18;position.left+=anchorWidth;break;case'left':position.top+=(anchorHeight/2)-18;position.left-=width;break;case'center':position.top+=(anchorHeight/2)-18;position.left+=(anchorWidth-width)/2;break;case'center-window':position.top+=(($(window).height()-height)/2)-18;position.left+=($(window).width()-width)/2;break;};position.top=Math.max(position.top,0);position.left=Math.max(position.left,0);dialog.removeClass(_DIRECTIONS.join(' '));dialog.addClass(direction);dialog.css(position);},close:function(){if(this.isOpened()===false){return this;}
this._dialog.off('modal-close',this._onclose);this._dialog.detach();this._anchor=null;this._glasspane.pane().off('mousedown',this._onclose);this._glasspane.close();creme.utils.scrollBack(this._scrollbackPosition,'slow');this._scrollbackPosition=null;this._events.trigger('closed',Array.from(arguments),this);return this;},options:function(){return this._options;},direction:function(direction){if(direction===undefined){return this._options.direction;}
Assert.in(direction,_DIRECTIONS,'invalid popover direction ${value}');this._options.direction=direction;if(this.isOpened()){this._updateDialogPosition(this._dialog,this._anchor,direction);}
return this;},title:function(title){if(title===undefined){return $('.popover-title',this._dialog);}
$('.popover-title',this._dialog).toggleClass('hidden',title===false);if(Object.isString(title)){$('.popover-title',this._dialog).text(title.decodeHTMLEntities());}else{$('.popover-title',this._dialog).empty().append(title);}
return this;},addClass:function(classname){this._dialog.addClass(classname);return this;},removeClass:function(classname){this._dialog.removeClass(classname);return this;},toggleClass:function(classname,state){this._dialog.toggleClass(classname,state);return this;},content:function(){return $('.popover-content',this._dialog);},fill:function(content){var rendered=Object.isFunc(content)?content.bind(this)(this._options):content;if(Object.isString(rendered)){$('.popover-content',this._dialog).html(rendered);}else{$('.popover-content',this._dialog).empty().append(rendered);}
if(this.isOpened()){this._updateDialogPosition(this._dialog,this._anchor,this.direction());}
this._events.trigger('popover-update',[this.content()],this);return this;},toggle:function(anchor,options){if(this.isOpened()){return this.close();}else{return this.open(anchor,options);}},anchor:function(){return this._anchor;},on:function(event,listener,decorator){this._events.on(event,listener,decorator);return this;},off:function(event,listener){this._events.off(event,listener);return this;},one:function(event,listener){this._events.one(event,listener);return this;}});creme.dialog.ImagePopover=creme.dialog.Popover.sub({_init_:function(options){options=$.extend({direction:'center-window',title:false,closeOnClick:true},options||{});this._super_(creme.dialog.Popover,'_init_',options);this.addClass('popover-picture');this._glasspane.addClass('popover-glasspane-picture');if(options.closeOnClick){this.content().on('click',this.close.bind(this));}},fill:function(content){this._super_(creme.dialog.Popover,'fill',content);this.content().find('img').toggleClass('no-title',this.options().title===false);return this;},fillImage:function(content){if(Object.isString(content)){var image=document.createElement("img");var fill=this.fill.bind(this);fill($('<div class="picture-wait">&nbsp;</div>'));image.onload=function(){fill($(image));};image.src=content;return this;}
return this.fill($(content));}});creme.dialog.PopoverAction=creme.component.Action.sub({_init_:function(options,listeners){this._super_(creme.component.Action,'_init_',this._open,options);this._listeners=listeners||{};},_build:function(options){var self=this;var popover=new creme.dialog.Popover(options);popover.on('closed',function(){self.done();}).fill(options.content||'').on(self._listeners);return popover;},_open:function(options){options=$.extend(this.options(),options||{});this._build(options).open(options.target);}});creme.dialog.PopoverAction.fromTarget=function(target,options){target=$(target);var contentHref=target.data('contentHref');var content=contentHref?$(contentHref).text():target.find('script[type$="html"]').text();var title=target.data('title')||target.find('summary').text();if(Object.isEmpty(content)){content=target.find('details').html();}
options=Object.assign({content:content,title:title},options||{},{target:target});return new creme.dialog.PopoverAction(options);};}(jQuery));(function($){"use strict";creme.list=creme.list||{};creme.list.Pager=creme.component.Component.sub({_init_:function(options){this._options=$.extend({debounceDelay:50},options||{});this._events=new creme.component.EventHandler();this._element=null;},on:function(event,listener,decorator){this._events.on(event,listener,decorator);return this;},off:function(event,listener){this._events.off(event,listener);return this;},one:function(event,listener){this._events.one(event,listener);return this;},canvas2d:function(){if(Object.isNone(this._canvas2d)){this._canvas2d=document.createElement('canvas').getContext('2d');}
return this._canvas2d;},_cleanPageInput:function(input){var page=parseInt(input.val());var max=parseInt(input.attr('max'));if(isNaN(page)||page<1||(!isNaN(max)&&page>max)){page=null;}
input.toggleClass('invalid-page',Object.isNone(page));return page;},_goToChosenPage:function(input){this.refresh(this._cleanPageInput(input));},_resizeChooseInput:function(input){var canvas2d=this.canvas2d();var value=Object.isNone(input.val())?'':input.val();canvas2d.font=input.css('font-size')+' '+input.css('font-family');var width=canvas2d.measureText(value).width;input.css('width',width+25);return input;},_initializeChooseLink:function(choose){var self=this;var input=$('input',choose).first();var debounce=function(cb){if(self._options.debounceDelay>0){return _.debounce(cb,self._options.debounceDelay);}else{return cb;}};choose.on('click',function(e){e.stopPropagation();choose.addClass('active');input.val(input.attr('data-initial-value'));self._cleanPageInput(input);self._resizeChooseInput(input);input.select().trigger('focus');});input.on('propertychange input change paste',debounce(function(){self._cleanPageInput(input);})).on('propertychange input change paste keydown',debounce(function(){self._resizeChooseInput(input);})).on('keyup',function(e){if(e.keyCode===13){e.preventDefault();self._goToChosenPage(input);}else if(e.keyCode===27){e.preventDefault();input.trigger('focusout');}}).on('blur focusout',function(){choose.removeClass('active');});},refresh:function(page){if(!Object.isEmpty(page)){this._events.trigger('refresh',page);}},bind:function(element){if(this.isBound()){throw new Error('Pager is already bound');}
var self=this;$('a.pager-link',element).on('click',function(e){e.preventDefault();if($(this).is('.is-disabled')===false){self.refresh($(this).attr('data-page'));}});$('.pager-link-choose',element).each(function(){self._initializeChooseLink($(this));});this._element=element;return this;},isBound:function(){return Object.isNone(this._element)===false;}});}(jQuery));(function($){"use strict";creme.form=creme.form||{};var S2=$.fn.select2.amd;function djangoLocalisation(options){return{errorLoading:function(){return options.errorLoadingMsg||gettext('The results could not be loaded.');},inputTooLong:function(args){var overChars=args.input.length-args.maximum;if(options.inputTooLongMsg){return options.inputTooLongMsg(args);}else{return ngettext('Please delete %d character','Please delete %d characters',overChars).format(overChars);}},inputTooShort:function(args){var remainingChars=args.minimum-args.input.length;if(options.inputTooShortMsg){return options.inputTooShortMsg(args);}else{return ngettext('Please enter %d or more character','Please enter %d or more characters',remainingChars).format(remainingChars);}},loadingMore:function(){return options.loadingMoreMsg||gettext('Loading more results');},labelPlaceholder:function(){return options.labelPlaceholderMsg||gettext('Loading');},enumInvalidLabel:function(){return options.labelPlaceholderMsg||gettext('');},enumTooManyResults:function(){return options.tooManyResults||gettext('Show more results');},maximumSelected:function(args){if(options.maximumSelectedMsg){return options.maximumSelectedMsg(args);}else{return ngettext('You can only select %d item','You can only select %d items',args.maximum).format(args.maximum);}},noResults:function(){return options.noResultsMsg||gettext('No result');},searching:function(){return options.searchingMsg||gettext('Searching');},removeAllItems:function(){return options.removeAllItemsMsg||gettext('Remove all items');},removeItem:function(){return options.removeItemMsg||gettext('Remove item');},createItem:function(args){if(options.createItemMsg){return options.createItemMsg(args);}else{return gettext('Create new item %s').format(args.label);}},search:function(){return options.searchMsg||gettext('Search');}};}
function normalizeSelect2Item(item){if(Array.isArray(item)){return{id:item[0],text:item[1],disabled:false,selected:false};}else{var output={id:item.value||item.id,text:item.label||item.text,disabled:item.disabled||false,selected:item.selected||false};if(item.group){output['group']=item.group;}
return output;}};function convertToSelect2Data(data){data=data||[];var optgroups={};var options=[];data.filter(function(item){return item.visible!==false;}).forEach(function(item){var option=normalizeSelect2Item(item);if(option.group){var optgroup=optgroups[option.group]=(optgroups[option.group]||{text:option.group,children:[]});optgroup.children.push(option);}else{options.push(option);}});if(!_.isEmpty(optgroups)){options=options.concat(_.values(optgroups));}
return options;}
function renderSelect2Result(state){if(state.pinned){return $('<span class="select2-results__pin">${text}</span>'.template(state));}else{return state.text;}}
function selectionRenderer(options){function renderer(state,container){if(container){var status=state.enumLabelStatus||{};container.toggleClass('select2-selection__loading',status.loading===true);container.toggleClass('select2-selection__invalid',status.invalid===true);}
if(options.selectionShowGroup){var group=$(state.element).parent('optgroup').get();return group.length?group[0].label+'  '+state.text:state.text;}else{return state.text;}}
renderer.options=options;return renderer;}
function clearSelect2Data(items){S2.require(['select2/utils'],function(Utils){items.each(function(){Utils.RemoveData(this);});},undefined,true);}
function getSelect2Data(items,key){var res;S2.require(['select2/utils'],function(Utils){res=items.map(function(){return Utils.GetData(this,key);});},undefined,true);return res.length===1?res[0]:res;}
S2.define('select2/data/enum',['select2/data/array','select2/utils'],function(ArrayAdapter,Utils){function Adapter(element,options){var enumOptions=this.enumOptions=$.extend({limit:50,debounce:100,cache:false},options.get('enum'));if(enumOptions.cache){this._queryBackend=creme.ajax.defaultCacheBackend();}else{this._queryBackend=creme.ajax.defaultBackend();}
Adapter.__super__.constructor.apply(this,arguments);};Utils.Extend(Adapter,ArrayAdapter);Adapter.prototype.pinItem=function($options){var data=this.item($options);data.pinned=true;return data;};Adapter.prototype.enumFetchOptions=function(selectedIds){var self=this;var existingIds=this.$element.children().map(function(){return self.item($(this)).id;}).get();var missingIds=_.difference(selectedIds,existingIds).filter(Object.isNotEmpty);if(missingIds.length>0){var labelPlaceholder=this.options.get('translations').get('labelPlaceholder');var $options=this.convertToOptions(missingIds.map(function(value){return{id:value,text:labelPlaceholder(),selected:true,enumLabelStatus:{loading:true}};}));this.addOptions($options);}
if(missingIds.length>0){this.enumFetchLabels(missingIds);}};Adapter.prototype.enumFetchLabels=function(missingIds){var self=this;var query=this._queryBackend.query({backend:{dataType:'json'}});var enumInvalidLabel=this.options.get('translations').get('enumInvalidLabel');query.url(this.enumOptions.url).onDone(function(event,data){var labels={};var updated=[];data.forEach(function(d){labels[d.value]=d.label;});self.$element.find('option').each(function(){var item=self.item($(this));if((item.enumLabelStatus||{}).loading){var label=labels[item.id];if(label){item.text=label;delete item.enumLabelStatus;}else{item.text=enumInvalidLabel();item.enumLabelStatus={invalid:true};}
$(this).replaceWith(self.option(item));updated.push(item);};});self.trigger('enum:selection:render',{data:updated});}).onFail(function(event,data){var updated=[];self.$element.find('option').each(function(){var item=self.item($(this));if((item.enumLabelStatus||{}).loading){item.text=enumInvalidLabel();item.enumLabelStatus={invalid:true};updated.push(item);}});self.trigger('enum:selection:render',{data:updated});});query.get({only:missingIds.join(',')});};Adapter.prototype.bind=function(container,$container){Adapter.__super__.bind.call(this,container,$container);var self=this;this._pinItems=this.$element.find('option[data-pinned]').map(function(){return self.pinItem($(this));}).get();container.on('enum:more',function(params){params=$.extend({},this._lastEnumParams);params.limit+=this.enumOptions.limit;this.trigger('query',params);}.bind(this));container.on('enum:add',function(params){if(this._queryBackend instanceof creme.ajax.CacheBackend){this._queryBackend.reset();}}.bind(this));container.on('close',function(){if(this._lastEnumParams){this._lastEnumParams.limit=this.enumOptions.limit;}}.bind(this));};Adapter.prototype.processResults=function(data,params){var items=(this._pinItems||[]).concat(convertToSelect2Data(data));return{results:items.slice(0,params.limit),more:data.length>params.limit};};Adapter.prototype.enumQuery=function(params,callback){var self=this;var options=this.enumOptions;params.limit=(params.limit||this.enumOptions.limit);if(this._query&&this._query.isCancelable()){this._query.cancel();}
var query=this._query=this._queryBackend.query({backend:{dataType:'json'}});query.url(options.url).onDone(function(event,data){self._lastEnumParams=params;callback(self.processResults(data,params));}).onFail(function(){self.trigger('results:message',{message:'errorLoading'});});return query.get({term:params.term,limit:params.limit+1});};Adapter.prototype.query=function(params,callback){if(this._debounce){clearTimeout(this._debounce);}
if(this.enumOptions.debounce>0){this._debounce=setTimeout(function(){this._debounce=null;this.enumQuery(params,callback);}.bind(this),this.enumOptions.debounce);}else{this.enumQuery(params,callback);}};return Adapter;});S2.define('select2/dropdown/enum',[],function(){function EnumMessage(decorated,$element,options,dataAdapter){decorated.call(this,$element,options,dataAdapter);this.$message=this.createMessage();}
EnumMessage.prototype.bind=function(decorated,container,$container){decorated.call(this,container,$container);var self=this;this.$results.parent().on('click','.select2-results__more',function(e){e.stopPropagation();self.moreLoading=true;self.trigger('enum:more');});container.on('query',function(){self.$message.remove();});};EnumMessage.prototype.append=function(decorated,data){decorated.call(this,data);this.moreLoading=false;if(data.more){this.$results.parent().append(this.$message);}else{this.$message.remove();}};EnumMessage.prototype.createMessage=function(){var message=this.options.get('translations').get('enumTooManyResults');var element=$('<div class="select2-results__more" role="option" aria-disabled="true"></div>');element.html(message({}));return element;};return EnumMessage;});S2.define('select2/dropdown/creator',[],function(){function CreatorButton(decorated,$element,options,dataAdapter){decorated.call(this,$element,options,dataAdapter);this.$button=this.createButton();this._dataAdapter=dataAdapter;}
CreatorButton.prototype.bind=function(decorated,container,$container){decorated.call(this,container,$container);var self=this;this.$results.parent().on('click','.select2-results__create',function(e){e.stopPropagation();var text=self._lastCreatorText;var form=new creme.dialog.FormDialog({url:self.options.get('createURL')});form.one('frame-update',function(event,frame){frame.delegate().find('input[type="text"]:first').val(text);});form.onFormSuccess(function(event,response,dataType){var items=((response.data()||{}).added||[]);self.addItems(convertToSelect2Data(items||[]),container);});self.trigger('close');form.open();});function extractTerms(items){var terms=[];items.forEach(function(item){if(item.children){terms.push.apply(terms,extractTerms(item.children));}else{terms.push(item.text);}});return terms;}
container.on('results:all',function(params){var term=params.query.term;var texts=extractTerms(params.data.results);if(term&&texts.indexOf(term)===-1){var message=this.options.get('translations').get('createItem');this.$button.find('.select2-results__create-title').html(message({label:term}));this.$results.parent().append(self.$button);this._lastCreatorText=term;}else{this.$button.remove();this._lastCreatorText=null;}}.bind(this));container.on('close',function(){this.$button.remove();this._lastCreatorText=null;}.bind(this));};CreatorButton.prototype.allItems=function(decorated){var dataAdapter=this._dataAdapter;return this.$element.children().map(function(){return dataAdapter.item($(this));}).get();};CreatorButton.prototype.addItems=function(decorated,items,container){var options=[];var dataAdapter=this._dataAdapter;var existingItems=this.allItems();if(items.length){if(items[0].children){items[0].children[0].selected=true;}else{items[0].selected=true;}}
items.forEach(function(item){var $option;if(item.children){var existingGroup=existingItems.find(function(existing){return existing.children&&item.text===existing.text;});if(existingGroup){item=$.extend(true,{},existingGroup,item,{children:existingGroup.children.concat(item.children)});$option=dataAdapter.option(item);$(existingGroup.element).replaceWith($option);}else{$option=dataAdapter.option(item);}
$option.append(item.children.map(function(item){return dataAdapter.option(item);}));}else{var existingItem=existingItems.find(function(existing){return item.id===existing.id;});if(existingItem){$option=dataAdapter.option($.extend(true,{},existingItem,item));$(existingItem.element).replaceWith();}else{$option=dataAdapter.option(item);}}
options.push($option);});dataAdapter.addOptions(options);this.$element.trigger('change.select2');container.trigger('enum:add',{data:items});};CreatorButton.prototype.createButton=function(label){return $('<div class="select2-results__create">'+'<span class="select2-results__create-icon">+</span>'+'<span class="select2-results__create-title"></span>'+'</div>');};return CreatorButton;});S2.define('select2/selection/enum',['select2/utils'],function(Utils){function EnumSelection(decorated,$element,options){decorated.call(this,$element,options);}
EnumSelection.prototype.bind=function(decorated,container,$container){var self=this;decorated.call(this,container,$container);container.on('enum:selection:render',function(params){var $selection=self.$selection;this.$selection.find('select2-selection__choice').each(function(){var item=Utils.GetData(this,'data');var formatted=self.display(item,$selection);$(this).replaceWith(formatted);});});};return EnumSelection;});creme.form.Select2=creme.component.Component.sub({_init_:function(element,options){Assert.not(element.is('.select2-hidden-accessible'),'Select2 instance is already active');options=this._options=$.extend(true,{multiple:element.prop('multiple'),sortable:element.is('[sortable]'),allowClear:element.data('allowClear'),selectionShowGroup:element.data('selectionShowGroup'),placeholder:element.data('placeholder'),placeholderMultiple:element.data('placeholderMultiple'),labelPlaceholder:element.data('labelPlaceholder'),createURL:element.data('createUrl'),enumURL:element.data('enumUrl'),enumLimit:element.data('enumLimit'),enumDebounce:element.data('enumDebounce'),enumCache:element.data('enumCache'),noEmpty:element.data('noEmpty')},options||{});var placeholder=options.multiple?options.placeholderMultiple:options.placeholder;var select2Options={allowClear:options.allowClear,placeholder:placeholder,debug:true,theme:'creme',language:this.localisation(),templateSelection:selectionRenderer(options)};S2.require(['select2/utils','select2/options','select2/selection/enum','select2/results','select2/data/enum','select2/dropdown/enum','select2/dropdown/creator','select2/dropdown/hidePlaceholder'],function(Utils,Options,EnumSelection,ResultsAdapter,EnumAdapter,EnumMessage,CreatorButton,HidePlaceholder){var defaults=new Options({},element);var resultsAdapter=ResultsAdapter;var selectionAdapter=defaults.options.selectionAdapter;if(placeholder){resultsAdapter=Utils.Decorate(resultsAdapter,HidePlaceholder);}
if(options.createURL){resultsAdapter=Utils.Decorate(resultsAdapter,CreatorButton);}
if(options.enumURL){resultsAdapter=Utils.Decorate(resultsAdapter,EnumMessage);selectionAdapter=Utils.Decorate(selectionAdapter,EnumSelection);$.extend(select2Options,{'enum':{url:options.enumURL,debounce:options.enumDebounce,limit:options.enumLimit,cache:options.enumCache},dataAdapter:EnumAdapter});}
$.extend(select2Options,{createURL:options.createURL,templateResult:renderSelect2Result,resultsAdapter:resultsAdapter,selectionAdapter:selectionAdapter});},undefined,true);if(options.allowClear&&Object.isEmpty(element.find('option[value=""]'))){element.append($('<option value="">${placeholder}</option>'.template({placeholder:placeholder||''})));}
element.attr('data-select2-id',_.uniqueId('select2-'));element.select2(select2Options);if(options.multiple&&options.sortable){this._activateSort(element);}
this._instance=getSelect2Data(element,'select2');Assert.not(Object.isNone(this._instance),'Select2 instance is not availabe');this.element=element;return this;},options:function(){return $.extend(true,{},this._options);},noEmpty:function(value){if(value===undefined){return this._instance.options.get('noEmpty');}
this._instance.options.set('noEmpty',value);this._options['noEmpty']=value;return this;},select2:function(){return this._instance;},localisation:function(options){return djangoLocalisation($.extend({},this._options,options));},destroy:function(){if(!Object.isNone(this.element)){if(this._sortable&&this._sortable.length>0){this._sortable.sortable('destroy');this._sortable=null;}
clearSelect2Data(this.element);this.element.select2('destroy');this._instance=null;this.element=null;}
return this;},_cleanSelectData:function(selected,options){var $options=this.element.find('option:not(:disabled)');if(options.multiple||!options.noEmpty){return selected;}
if(selected.length>0){var available=new Set($options.map(function(){return $(this).attr('value');}));selected=selected.filter(function(value){return available.has(value);});}
if(selected.length===0){var first=$options.first();selected=first?[first.attr('value')]:[];}
return options.multiple?selected:(selected[0]||null);},select:function(data,params){Assert.that(Array.isArray(data));var append=(params||{}).append===true;var options=this.options();var adapter=this._instance.dataAdapter;if(options.enumURL){adapter.enumFetchOptions(data);}
var selectedIds=this._cleanSelectData(data,options);if(append&&options.multiple){var items=this.element.find('option').map(function(){return adapter.item($(this));}).get();selectedIds=new Set(selectedIds);var selected=items.filter(function(item){return selectedIds.has(item.id);}).map(function(item){item.selected=true;return item;});adapter.trigger('selection:update',{data:selected});}else{this.element.val(selectedIds).trigger('input').trigger('change');}
return this;},isEnum:function(){return Object.isEmpty(this.options().enumURL)===false;},refresh:function(){if(this.isEnum()){return this;}
clearSelect2Data(this.element.find('option, optgroup'));this.element.trigger('change');return this;},_activateSort:function(element){var choices=element.next('.select2-container').parent();this._sortable=choices.sortable({items:'.select2-selection__choice',opacity:0.5,revert:200,delay:200,stop:function(){S2.require(['select2/utils'],function(Utils){var sorted=$(choices).find('.select2-selection__choice').map(function(){return Utils.GetData(this,'data');}).get().map(function(d){return d.id;});element.val(sorted);});}});}});}(jQuery));(function($){"use strict";creme.form=creme.form||{};creme.form.DropDown=creme.component.Component.sub({_init_:function(element,options){options=$.extend({mode:element.data('dropdownMode')||'auto',title:element.data('dropdownAlt')||''},options||{});this._element=element;this._element.addClass('ui-dropdown-hidden');this._element.on('change',this._onChange.bind(this));this.mode(options.mode);this._selection=$('<a class="ui-dropdown-selection" title="${title}">${label}</a>'.template({title:options.title,label:this._optionLabel(this._element.val())})).insertAfter(element);this._selection.on('click',function(e){e.preventDefault();this.select();}.bind(this));},destroy:function(){this._element.off('change',this._onChange.bind(this));this._element.removeClass('ui-dropdown-hidden');delete this._popover;},_onOpen:function(){this._popover.content().on('click','.popover-list-item',function(e){e.preventDefault();this.val($(e.target).data('value'));this._popover.close();}.bind(this));},_onClose:function(){this._popover.content().off('click','.popover-list-item');},_onChange:function(){var label=this._optionLabel(this._element.val());this._selection.text(label);},_popoverHtml:function(){var choices=creme.model.ChoiceGroupRenderer.parse(this._element);return choices.filter(function(choice){return!choice.selected;}).map(function(choice){return'<a class="popover-list-item" title="${label}" alt="${label}" data-value="${value}">${label}</a>'.template(choice);}).join('');},_openPopover:function(){if(Object.isNone(this._popover)){this._popover=new creme.dialog.Popover();this._popover.on({closed:this._onClose.bind(this),opened:this._onOpen.bind(this)});}
this._popover.fill(this._popoverHtml());this._popover.open(this._selection);},_optionLabel:function(value){return this._element.find('option').filter(function(){return $(this).attr('value')===value;}).map(function(){return $(this).text();}).get(0);},_optionValueAfter:function(value){var next=this._element.find('option').filter(function(){return $(this).attr('value')===value;}).next();return next.length>0?next.attr('value'):this._element.find('option:first').attr('value');},element:function(){return this._element;},mode:function(mode){return Object.property(this,'_mode',mode);},val:function(value){if(value===undefined){return this._element.val();}
this._element.val(value).trigger('change');},next:function(){this.val(this._optionValueAfter(this.val()));},select:function(){switch(this.mode()){case'popover':this._openPopover();break;case'toggle':this.next();break;default:if(this._element.find('option').length>2){this._openPopover();}else{this.next();}}}});creme.utils.newJQueryPlugin({name:'dropdown',create:function(options){return new creme.form.DropDown($(this),options);},destroy:function(instance){instance.destroy();},methods:['select','next'],properties:['mode']});}(jQuery));(function($){"use strict";creme.widget.Frame=creme.widget.declare('ui-creme-frame',{options:{backend:undefined,url:undefined,overlay_delay:100},_create:function(element,options,cb,sync){this._overlay=new creme.dialog.Overlay();this._overlay.bind(element).addClass('frame-loading');var frame=this._frame=new creme.dialog.Frame({backend:options.backend||creme.ajax.defaultBackend()});frame.onUpdate(function(event,data,type){element.trigger('update',[data,type]);}).onFetchFail(function(event,data,error){element.trigger('reloadError',[data,error]);}).onSubmitFail(function(event,data,error){element.trigger('submitError',[data,error]);}).bind(element).overlayDelay(options.overlay_delay).overlay().addClass('frame-loading');element.addClass('widget-ready');this.reload(element,undefined,cb);},url:function(element){return this._lasturl||this.options.url;},preferredSize:function(element){return creme.layout.preferredSize(element);},resize:function(element,args){element.trigger('resize',args);},fill:function(element,data,cb){this._frame.fill(data);creme.object.invoke(cb,data);},reset:function(element,cb){this._frame.clear();this._lasturl=undefined;creme.object.invoke(cb);},reload:function(element,url,data,listeners){listeners=listeners||{};url=url||this.url();this._lasturl=url;if(Object.isEmpty(url)===false){this._frame.fetch(url,{},data,listeners);}},submit:function(element,form,listeners){listeners=listeners||{};this._frame.submit(this.url(),{},form,listeners);}});}(jQuery));(function($){"use strict";creme.widget.Toggle=creme.widget.declare('ui-creme-toggle',{_create:function(element,options,cb,sync,attributes){options=Object.assign({debounceDelay:200},options||{});var self=this;var handler=this._onToggle.bind(this);var triggers=this.triggers(element);if(options.debounceDelay>0){handler=_.debounce(handler,options.debounceDelay,false);}
this._element=element;this._handler=handler;triggers.each(function(){self._toggleTargets($(this),$(this).hasClass('toggle-collapsed'));});element.on('click','[data-toggle]',handler);if(element.is('[data-toggle]')){element.on('click',handler);}
element.addClass('widget-ready');},_destroy:function(element){element.off('click',this._handler);element.off('click','[data-toggle]',this._handler);},_toggleTargets:function(trigger,state){var targetRef=trigger.data('toggle')||'';var targets=[];if(targetRef.length>0){targets=this._element.find(targetRef);targets=targets.length>0?targets:$(targetRef);}
trigger.toggleClass('toggle-collapsed',state);state=trigger.hasClass('toggle-collapsed');if(targets.length>0){targets.toggleClass('toggle-collapsed',state);}
return targets;},_onToggle:function(e){var targets=this._toggleTargets($(e.target).closest('[data-toggle]'));if(targets.length>0){e.preventDefault();}},expandAll:function(element){var self=this;this.triggers(element).each(function(){self._toggleTargets($(this),false);});},collapseAll:function(element){var self=this;this.triggers(element).each(function(){self._toggleTargets($(this),true);});},triggers:function(element){var triggers=element.find('[data-toggle]').filter(function(){return $(this).parents('.ui-creme-toggle').first().is(element);});return element.is('[data-toggle]')?triggers.add(element):triggers;}});}(jQuery));(function($){"use strict";creme.widget.PluginLauncher=creme.widget.declare('ui-creme-jqueryplugin',{options:{plugin:'',plugin_options:{}},_create:function(element,options,cb,sync,attributes){var plugin_name=options.plugin||'';var plugin_options=this._pluginOptions=(_.isString(options.plugin_options)?_.cleanJSON(options.plugin_options)||{}:options.plugin_options);var plugin=this._plugin=plugin_name!==''?element[plugin_name]:undefined;if(Object.isFunc(plugin)){plugin.apply(element,[plugin_options]);}
element.addClass('widget-ready');},_destroy:function(element){this._plugin.apply(element,'destroy');},plugin:function(element){return this._plugin;}});}(jQuery));(function($){"use strict";creme.widget.DynamicInput=creme.widget.declare('ui-creme-dinput',{options:{datatype:'string'},_create:function(element,options,cb,sync){this._enabled=creme.object.isFalse(options.disabled)&&element.is(':not([disabled])');if(!this._enabled){$(element).attr('disabled','');}
this.reload(element,{},cb,cb);element.addClass('widget-ready');},_updateDisabledState:function(element){element.toggleProp('disabled',!this._enabled);},dependencies:function(element){return[];},reload:function(element,data,cb,error_cb,sync){creme.object.invoke(cb,element);},reset:function(element){this.val(element,null);},val:function(element,value){if(value===undefined){return element.val();}
if(!Object.isNone(value)&&!Object.isString(value)){value=JSON.stringify(value);}
element.val(value);element.prop('disabled',false);element.trigger('change');this._updateDisabledState(element);},cleanedval:function(element){var value=this.val(element);if(this.options.datatype==='string'){return value;}
return creme.widget.cleanval(value,value);}});}(jQuery));(function($){"use strict";creme.widget.AutoSizedTextArea=creme.widget.declare('ui-creme-autosizedarea',{options:{'min-rows':undefined,'max-rows':undefined},_create:function(element,options){var rows=element.attr('rows');var minRows=parseInt(options['min-rows']||rows);var maxRows=parseInt(options['max-rows']);this._layout=new creme.layout.TextAreaAutoSize({min:!isNaN(minRows)?minRows:undefined,max:!isNaN(maxRows)?maxRows:undefined}).bind(element);element.addClass('widget-ready');},layout:function(element){return this._layout;}});}(jQuery));(function($){"use strict";creme.widget.SelectOrInputWidget=creme.widget.declare('ui-creme-selectorinput',{_create:function(element,options){var select=element.find('select');var input=element.find('input[type="text"]');var inputBackup=input.val();select.on('change',function(e){if(select.val()==='0'){input.val(inputBackup);}else{inputBackup=input.val();input.val('');}});input.on('input keyup paste',function(e){select.val(0);});element.addClass('widget-ready');},val:function(element,value){if(value===undefined){value=element.find('select').val();return(value==='0')?element.find('input[type="text"]').val():value;}
if(!Object.isNone(value)&&!Object.isString(value)){value=JSON.stringify(value);}
element.find('select').val(value).trigger('change');}});}(jQuery));(function($){"use strict";creme.widget=creme.widget||{};function datatypeConverter(datatype){if(datatype==='json'){return function(data){return creme.widget.cleanval(data,null);};}}
creme.widget.DynamicSelect=creme.widget.declare('ui-creme-dselect',{options:{backend:undefined,datatype:'string',url:'',filter:'',dependencies:'',multiple:false,sortable:false,autocomplete:false},_create:function(element,options,cb,sync){this._context={};this._backend=options.backend||creme.ajax.defaultCacheBackend();this._enabled=creme.object.isFalse(options.disabled)&&!element.prop('disabled');this._readonly=creme.object.isTrue(options.readonly)||element.is('.is-readonly');this._multiple=creme.object.isTrue(options.multiple)&&element.is('[multiple]');this._autocomplete=creme.object.isTrue(options.autocomplete)||element.is('[autocomplete]');this._url=new creme.utils.Template(options.url);this._filter=new creme.utils.Template(options.filter);this._dependencies=Array.isArray(options.dependencies)?options.dependencies:(options.dependencies?options.dependencies.split(' '):[]);this.cacheMode(element,options.cache||element.data("cache")||'full');this.noEmpty(element,options.noEmpty||element.data('noEmpty'));this._initModel(element,options);this._initAutocomplete(element,options);this._updateDisabledState(element);this.reload(element,{},cb,cb,sync);element.addClass('widget-ready');},_destroy:function(element){if(this._select2){this._select2.destroy();}},_initModel:function(element,options){var self=this;var converter=this._converter=datatypeConverter(options.datatype);var initial=creme.model.ChoiceGroupRenderer.parse(element,converter);this._model=new creme.model.AjaxArray(this._backend,initial);this._model.url(function(){return self.url();}).converter(this._modelConverter).comparator(this._modelComparator);this._filtered=new creme.model.Filter(this._model);this._filtered.bind('remove clear reset add',function(){self._onModelChange(element);}).bind('clear reset',function(){self._onModelReset(element);});this._renderer=new creme.model.ChoiceGroupRenderer(element,this._filtered);},_initAutocomplete:function(element,options){if(this._autocomplete){this._select2=new creme.form.Select2(element,{multiple:Boolean(this._multiple),sortable:element.is('[data-sortable]'),noResultsMsg:element.data('noResults'),placeholder:element.data('placeholder'),placeholderMultiple:element.data('placeholderMultiple'),noEmpty:this.noEmpty(element)});}},_updateAutocomplete:function(element){if(this._select2){this._select2.refresh();}},_updateDisabledState:function(element){var active_option_count=$('option:not(:disabled)',element).length;var is_empty=active_option_count<1;var is_single=active_option_count<2;var disabled=!this._enabled||is_empty;var readonly=(is_single&&!this._multiple)||this._readonly;element.prop('disabled',disabled);element.toggleClass('is-readonly',readonly);},_onModelChange:function(element){this._updateDisabledState(element);},_onModelReset:function(element){this._updateAutocomplete(element);},_modelConverter:function(rawdata){var data=creme.model.ChoiceGroupRenderer.choicesFromTuples(rawdata);return data.map(function(entry){var label=entry.label;if(entry.help||entry.group){label='<span>${label}</span>'.template(entry);if(entry.help){label+='<span class="group-help">${help}</span>'.template(entry);}
if(entry.group){label+='<span class="hidden">${group}</span>'.template(entry);}}
entry.label=label;return entry;});},_modelComparator:function(a,b){return a.value<b.value?-1:(a.value>b.value?1:0);},_updateModel:function(element,cb,error_cb,sync){var self=this;var url=this.url();if(url===null){this._model.reset([]);return;}
if(!url){this._onModelChange(element);creme.object.invoke(error_cb,element,new creme.ajax.AjaxResponse('404',''));return;}
var selected=this.val(element);this._model.fetch({fields:['id','unicode'],sort:'unicode'},{backend:{dataType:'json',sync:sync,forcecache:this._forceCache}},{done:function(event,data){self._forceCache=(self.cacheMode()==='ignore');self.val(element,selected);creme.object.invoke(cb,element,data);},fail:function(event,data,error){self.val(element,selected);creme.object.invoke(error_cb,element,error);},cancel:function(event,data){}});},_updateFilter:function(element){var self=this;var filter=this.filter(element);if(this._previousFilter===filter){this._filtered.fetch();return;}
this._previousFilter=filter;var lambda=creme.utils.lambda(filter,'item, context',null);this._filtered.filter(lambda!==null?function(item){return lambda(item,self._context);}:null);},filter:function(element,filter){if(filter===undefined){return this._filter&&this._filter.iscomplete()?this._filter.render():'';}
this._filter=new creme.utils.Template(filter);this._filter.update(this._context||{});this._updateFilter(element);return this;},url:function(element,url){if(url===undefined){return this._url&&this._url.iscomplete()?this._url.render():null;}
this._url=new creme.utils.Template(url);this._url.update(this._context||{});this._updateModel(element);return this;},dependencies:function(element){return this._dependencies.concat(this._url.tags()||[]).concat(this._filter.tags()||[]);},reload:function(element,data,cb,error_cb,sync){data=data||{};this._context=$.extend({},this._context||{},data);this._url.update(data);this._filter.update(data);this._updateFilter(element);this._updateModel(element,cb,error_cb,sync);return this;},update:function(element,data){data=creme.widget.cleanval(data,{});var model=this._model;var notInModel=function(item){return model.indexOf(item)===-1;};model.patch({add:this._modelConverter(data.added).filter(notInModel),remove:this._modelConverter(data.removed)});this.val(element,data.value);return this;},model:function(element){return this._model;},cacheMode:function(element,mode){if(mode===undefined){return this._cacheMode;}
Assert.in(mode,['ignore','force','full']);this._forceCache=(mode!=='full');this._cacheMode=mode;return this;},noEmpty:function(element,value){if(value===undefined){return this._noEmpty;}
this._noEmpty=creme.object.isTrue(value);if(this._select2){this._select2.noEmpty(this._noEmpty);}
return this;},_onSelectionChange:function(element,previous){element.prop('disabled',false);element.trigger('change');this._updateDisabledState(element);},_select:function(element,value){var selected=[];var isMultiple=this.options.multiple;var isJSON=this.options.datatype==='json';var previous=element.val();if(isMultiple){if(Object.isString(value)){var values=value.split(',');selected=isJSON?_.cleanJSON(value)||values:values;}else{selected=value;}
selected=Array.isArray(selected)?selected:[selected];}else{selected=[value];}
if(isJSON){selected=_.reject(selected,Object.isNone).map(function(item){return!Object.isString(item)?JSON.stringify(item):item;});}else{selected=_.reject(selected,Object.isNone).map(function(item){return String(item);});}
if(this._select2){this._select2.select(selected);this._onSelectionChange(element,previous);}else{if(!isMultiple&&this.noEmpty(element)){if(selected.length>0){var available=new Set(element.find('option:not(:disabled)').map(function(){return $(this).attr('value');}));selected=selected.filter(function(value){return available.has(value);});}
if(selected.length===0){var first=$('option:not(:disabled)',element).first().attr('value');selected=Object.isNone(first)?[]:[first];}}
element.val(isMultiple?selected:(selected[0]||null));this._onSelectionChange(element,previous);}},val:function(element,value){if(value===undefined){return element.val();}
this._select(element,value);},cleanedval:function(element){var value=this.val(element);if(this.options.datatype==='string'){return value;}
if(this.options.multiple){return this._converter?value.map(this._converter):value;}
return this._converter?this._converter(value):value;},reset:function(element){this.selectfirst(element);},selectfirst:function(element){var value=$('option:not(:disabled)',element).first().attr('value');this._select(element,value);},firstchoice:function(element){var choices=$('option:not(:disabled)',element).first();return choices.length?[choices.attr('value'),choices.text()]:null;},_querychoices:function(element,key,strict){if(Object.isString(key)===false){key=JSON.stringify(key);}
var choices=$('option'+(key?':not(:disabled)':''),element).filter(function(){return $(this).parents('select').first().is(element);});if(Object.isEmpty(key)&&!strict){return choices;}
return choices.filter(function(){return $(this).attr('value')===key;});},_querygroups:function(element,key,strict){if(Object.isString(key)===false){key=JSON.stringify(key);}
var groups=$('optgroup'+(key?':not(:disabled)':''),element).filter(function(){return $(this).parents('select').first().is(element);});if(Object.isEmpty(key)&&!strict){return groups;}
return groups.filter(function(){return $(this).attr('label')===key;});},choice:function(element,key){if(Object.isNone(key)===true){return;}
var choices=this._querychoices(element,key,true);return choices.length>0?[key,choices.first().text()]:undefined;},choices:function(element){return this._querychoices(element).get().map(function(item){return[$(item).attr('value'),$(item).text()];});},groups:function(element){return this._querygroups(element).get().map(function(item){return $(item).attr('label');});},selected:function(element){return this.choice(element,this.val(element));}});}(jQuery));(function($){"use strict";creme.widget=creme.widget||{};function __fromJSON(data){return _.cleanJSON(data)||{};}
creme.widget.CheckListSelect=creme.widget.declare('ui-creme-checklistselect',{options:{datatype:'string',less:0,selectall:3},_create:function(element,options,cb,sync){var self=this;this._converter=options.datatype==='json'?__fromJSON:null;this.less(element,options.less||element.is('[less]'));this.minShowSelectAll(element,options.selectall);this.disabled(element,creme.object.isTrue(options.disabled)||this._delegate(element).is('[disabled]'));this._initializeController(element,options);$('.checklist-create:not(.is-disabled)',element).on('click',function(e){e.preventDefault();self._createItem(element,$(this));});$(element).on('click','.checklist-check-all:not(.is-disabled)',function(){self.selectAll(element);});$(element).on('click','.checklist-check-none:not(.is-disabled)',function(){self.unselectAll(element);});$('.checklist-filter',element).on('propertychange keyup input paste',function(){self._updateViewFilter(element,$(this).val().toLowerCase());});$('.checklist-toggle-less',element).on('click',function(){self.toggleShowLess(element);});$(element).on('change','.checkbox-field:not(.hidden):not([disabled]) input[type="checkbox"]',function(e){var checkbox=$(this);self._selections.toggle(parseInt(checkbox.attr('checklist-index')),checkbox.prop('checked'));});$(element).on('click','.checkbox-field:not(.hidden):not([disabled]) .checkbox-label',function(e){e.stopPropagation();var checkbox=$(this).parent().find('input[type="checkbox"]');self._selections.toggle(parseInt(checkbox.attr('checklist-index')),!checkbox.prop('checked'));});element.addClass('widget-ready');},_getItemFilter:function(term){term=term.removeDiacritics().toLowerCase();return function(item){var label=(item.label||'').removeDiacritics().toLowerCase();var help=(item.help||'').removeDiacritics().toLowerCase();return(label.indexOf(term)!==-1||help.indexOf(term)!==-1);};},_updateViewFilter:function(element,term){var isfiltered=!Object.isEmpty(term);var content=this.content(element);var hide=content.is('.filter');var filter=this._getItemFilter(term);content.toggleClass('filtered',isfiltered);if(hide){this._model.each(function(item){item.visible=filter(item);});}else{this._model.each(function(item){item.disabled=!filter(item);});}
this._controller.redraw();this._updateViewCounter(element);this._updateViewLess(element);},_updateViewSelection:function(element){var comparator=function(a,b){return creme.utils.compareTo(a.value,b);};var indices=this._model.indicesOf(this.val(element)||[],comparator);this._selections.select(indices);},_updateViewCounter:function(element){var counter=$('.checklist-counter',element);var selection_count=this._selections.selected().length;var hilighted_count=$('.checkbox-field:not(.hidden)',this.content(element)).length;var model_count=this._model.length();var messages=[];if(selection_count>0){messages.push(ngettext('%d selection','%d selections',selection_count).format(selection_count));}
if(hilighted_count!==model_count){messages.push(ngettext('%d result of %d','%d results of %d',hilighted_count).format(hilighted_count,model_count));}
counter.toggleClass('visible',messages.length>0).html(messages.join('&nbsp;&nbsp;')+'&nbsp;');this._updateViewSelectAll(element);this._updateViewLessCounter(element);this._updateViewErrorState(element);},_updateDelegate:function(element){this._delegate(element).val(this.selected(element));element.trigger('change');},_updateViewLessCounter:function(element){var iscollapsed=this._lessCollapsed;var content=this.content(element);var moreItems=$('.checkbox-field:not(.hidden).more input[type="checkbox"]',content);var moreCount=moreItems.length;var messages=[];if(iscollapsed){var moreSelectedCount=moreItems.filter(':checked').length;if(moreCount>0){messages.push(ngettext('%d hidden item','%d hidden items',moreCount).format(moreCount));}
if(moreSelectedCount>0){messages.push(ngettext('(with %d selection)','(with %d selections)',moreSelectedCount).format(moreSelectedCount));}}else if(moreCount>0){messages.push(ngettext('Collapse %d item','Collapse %d items',moreCount).format(moreCount));}
$('.checklist-toggle-less',element).html(messages.join(' '));},_updateViewLess:function(element){var limit=this._lessCount;var iscollapsed=this._lessCollapsed;var content=this.content(element);var isfiltered=content.is('.filtered:not(.search)');var items=isfiltered?$('.checkbox-field:not(.hidden)',content):$('.checkbox-field',content);var isactive=items.length>limit;content.toggleClass('less',iscollapsed);$('.checklist-toggle-less',element).toggleClass('is-active',isactive);if(isactive){items.each(function(index){$(this).toggleClass('more',index>=limit);});}else{items.removeClass('more');}
this._updateViewLessCounter(element);},_updateViewErrorState:function(element){var delegate=this._delegate(element);var isinvalid=delegate.length>0&&delegate.is('.is-field-invalid:invalid');element.toggleClass('is-field-invalid',isinvalid);},_updateViewSelectAll:function(element){var notVisible=(this._model&&this._model.length()<this.minShowSelectAll(element));$('.checklist-check-all, .checklist-check-none',element).toggleClass('hidden',notVisible);},_delegate:function(element){return $('select.ui-creme-input',element);},_initializeController:function(element,options){var self=this;var disabled=this.disabled(element);var input=this._delegate(element);var content=this.content(element);var renderer=new creme.model.CheckGroupListRenderer();var controller=this._controller=new creme.model.CollectionController();var selections=this._selections=new creme.model.SelectionController();var input_renderer=new creme.model.ChoiceGroupRenderer();var choices=creme.model.ChoiceGroupRenderer.parse(input);var model=this._model=new creme.model.Array(choices);selections.model(model).selectionFilter(function(item,index){return!item.disabled&&item.visible&&!item.readonly;}).on('change',function(){self._updateDelegate(element);self._updateViewCounter(element);});renderer.converter(this._converter).disabled(disabled);controller.renderer(renderer).target(content).model(model).redraw();input_renderer.target(input).model(model);input.on('change',function(){self._updateViewSelection(element);}).on('invalid html5-invalid',function(){self._updateViewErrorState(element);});model.bind('add remove',function(){self._updateViewCounter(element);self._updateViewLess(element);input_renderer.redraw();});this._updateViewCounter(element);this._updateViewLess(element);},toggleShowLess:function(element,state){if(this._less){this._lessCollapsed=Object.isNone(state)?!this._lessCollapsed:state;this._updateViewLess(element);}
return this;},isLessCollapsed:function(element){return this._less&&this._lessCollapsed;},lessCount:function(element){return this._lessCount;},less:function(element,less){if(less===undefined){return this._less;}
var isLess=less>0||Boolean(less);this._lessCount=less>1?less:10;this._less=isLess;this.toggleShowLess(element,this._less);return this;},minShowSelectAll:function(element,limit){if(limit===undefined){return this._minShowSelectAll;}
this._minShowSelectAll=limit;this._updateViewSelectAll(element);return this;},disabled:function(element,disabled){if(disabled===undefined){return this._disabled;}
element.toggleClass('is-disabled',disabled);this._disabled=disabled;element.find('.checklist-filter').toggleAttr('disabled',disabled);if(this._controller){this._controller.renderer().disabled(disabled);this._controller.redraw();}
return this;},content:function(element){var content=$('.checklist-content',element);return content.length===0?element:content;},dependencies:function(element){return[];},reload:function(element,data,cb,error_cb,sync){return this;},update:function(element,data){},model:function(element){return this._controller.model();},val:function(element,value){var input=this._delegate(element);if(value===undefined){return input.val();}
var previous=this.val(element);var selections=_.isString(value)?_.cleanJSON(value)||[]:value;value=selections.map(function(item){return Object.isString(item)?item:JSON.stringify(item);});if(previous===value){return this;}
if(input){input.val(value).trigger('change');}
element.trigger('change');return this;},cleanedval:function(element){var to=this.options.datatype.toLowerCase();return this.val(element).map(function(value){return creme.utils.convert(value,{from:'string',to:to,defaults:value});});},_createItem:function(element,link){var url=link.attr('href');if(this.disabled(element)||!url){return this;}
var action=new creme.dialog.FormDialogAction();var model=this._model;action.onDone(function(event,data){var choices=creme.model.ChoiceGroupRenderer.choicesFromTuples(data.data().added||[]);model.patch({add:choices});}).start({url:url,title:link.attr('title')});},reset:function(element){return this.unselectAll(element);},selected:function(element){return this._selections.selected().map(function(item){return item.value;});},selectAll:function(element){if(!this.disabled(element)){this._selections.selectAll();}
return this;},unselectAll:function(element){if(!this.disabled(element)){this._selections.unselectAll();}
return this;}});}(jQuery));(function($){"use strict";creme.widget.OrderedListSelect=creme.widget.declare('ui-creme-ordered',{_create:function(element,options){options=options||{};this._dataIdAttr=options.dataIdAttr||'data-choice-id';this._notDraggableClass=options.notDraggableClass||'not-draggable';this._targetInput=element.find('input.ordered-widget-value');this._choicesContainer=element.find('.ordered-widget-available-choices');this._selectionContainer=element.find('.ordered-widget-enabled-choices');this._setupItems(element);this._setupDragNDrop(element);element.on('dblclick','.ordered-widget-choice',function(e){e.preventDefault();this._moveItem($(e.target).closest('.ordered-widget-choice'));}.bind(this));element.on('click','.ordered-widget-enabled-choices .deselect-choice',function(e){e.preventDefault();this._moveItem($(e.target).closest('.ordered-widget-choice'));}.bind(this));element.addClass('widget-ready');},_setupItems:function(element){var choices=this.choices(element).slice();var selected=this.selected(element);var availableItems=[];var selectedItems=[];selected.forEach(function(value){var index=choices.findIndex(function(choice){return choice.value===value;});if(index!==-1){selectedItems.push(this._itemHtml(choices[index]));choices.splice(index,1);}}.bind(this));choices.forEach(function(choice){availableItems.push(this._itemHtml(choice));}.bind(this));this._choicesContainer.html(availableItems.join(''));this._selectionContainer.html(selectedItems.join(''));},_setupDragNDrop:function(element){var groupName=element.attr('id');this._choicesSortable=new Sortable(this._choicesContainer.get(0),{group:{name:groupName,put:false},dataIdAttr:this._dataIdAttr,filter:'.'+this._notDraggableClass,sort:false});this._selectionSortable=new Sortable(this._selectionContainer.get(0),{group:groupName,dataIdAttr:this._dataIdAttr,filter:'.'+this._notDraggableClass,onSort:this._updateInput.bind(this)});},_updateInput:function(e){this._targetInput.val(JSON.stringify(this._selectionSortable.toArray()));},selected:function(element){var data=JSON.parse(this._targetInput.val());return Array.isArray(data)?data:[];},choices:function(element){if(Object.isNone(this._choices)){var script=element.find('script[type$="/json"]');var choices=[];try{if(!Object.isEmpty(script)){var data=_.readJSONScriptText(script.get(0));choices=Object.isEmpty(data)?[]:JSON.parse(data);}}catch(e){console.warn(e);}
this._choices=choices.map(function(choice,index){choice.initialOrder=index;return choice;});}
return this._choices;},_itemHtml:function(choice){return('<div class="ordered-widget-choice ${notDraggable}" ${idAttr}="${value}" data-order="${order}" ${help}>'+'<span>${label}</span>'+'<button type="button" class="deselect-choice" ${buttonDisabled}>${buttonLabel}</button>'+'</div>').template({idAttr:this._dataIdAttr,value:choice.value,order:choice.initialOrder,help:choice.help?'title="${help}"'.template(choice):'',label:choice.label,notDraggable:choice.disabled?this._notDraggableClass:'',buttonDisabled:choice.disabled?'disabled':'',buttonLabel:gettext('Deselect')});},_moveItem:function(item){var container=item.parent('.ordered-widget-choices');var selected=container.hasClass('ordered-widget-enabled-choices');if(selected){var order=parseInt(item.data('order'));var target=this._choicesContainer.find('.ordered-widget-choice').filter(function(){return(order<parseInt($(this).data('order')));}).first().get(0);if(Object.isNone(target)){this._choicesContainer.append(item);}else{$(target).before(item);}}else{this._selectionContainer.append(item);}
this._updateInput();}});}(jQuery));(function($){"use strict";creme.widget.YearPicker=creme.widget.declare('ui-creme-yearpicker',{options:{readonly:false,disabled:false},_create:function(element,options,cb,sync){this._input=element;this._disabled=creme.object.isTrue(options.disabled)&&element.prop('disabled');this._readonly=creme.object.isTrue(options.readonly)&&element.prop('readonly');element.prop('disabled',this._disabled);element.prop('readonly',this._readonly);var parent=element.parent();var list=$('<ul/>').addClass('ui-layout hbox').append($('<li/>').append(element));parent.append(list);this._buttons=this._initHelperButtons();this._buttons.forEach(function(button){list.append($('<li/>').append(button));});this._updateDisabledState(element,this._disabled);element.addClass('widget-ready');},_updateDisabledState:function(element,disabled){var state=disabled||this._readonly;this._buttons.forEach(function(button){button.prop('disabled',state);});},_initHelperButtons:function(){var input=this._input;var button=$('<button>').attr('name','current-year').attr('type','button').html(gettext('Current year'));button.on('click',function(e){e.preventDefault();input.val(new Date().getFullYear());});return[button];},val:function(element,value){if(value===undefined){return element.val();}
element.val(value);return this;}});creme.widget.DatePicker=creme.widget.declare('ui-creme-datepicker',{options:{format:'dd-mm-yy',readonly:false,disabled:false},_create:function(element,options,cb,sync){this._disabled=creme.object.isTrue(options.disabled)&&element.prop('disabled');this._readonly=creme.object.isTrue(options.readonly)&&element.prop('readonly');element.prop('disabled',this._disabled);element.prop('readonly',this._readonly);var parent=element.parent();var list=$('<ul/>').addClass('ui-layout hbox').append($('<li/>').append(element));parent.append(list);this._datepicker=element.datepicker({dateFormat:options.format,showOn:"button",buttonText:gettext('Calendar'),buttonImage:creme_media_url('images/icon_calendar.gif'),buttonImageOnly:true});list.append($('<li/>').append($('<span/>').addClass('ui-creme-datepicker-trigger').append($('img.ui-datepicker-trigger',parent))));this._buttons=this._initHelperButtons();this._buttons.forEach(function(button){list.append($('<li/>').append(button));});this._updateDisabledState(element,this._disabled);element.addClass('widget-ready');},_updateDisabledState:function(element,disabled){var state=disabled||this._readonly;this._datepicker.datepicker('option','disabled',state);this._buttons.forEach(function(button){button.prop('disabled',state);});},_appendHelperButton:function(buttons,name,label,getter){var datepicker=this._datepicker;var button=$('<button>').attr('name',name).attr('type','button').html(gettext(label));button.on('click',function(e){e.preventDefault();datepicker.datepicker('setDate',getter(datepicker.datepicker('getDate')));});buttons.push(button);return button;},_initHelperButtons:function(){var buttons=[];this._appendHelperButton(buttons,'today','Today',function(current){return new Date();});return buttons;},val:function(element,value){if(value===undefined){return element.val();}
element.val(value);return this;}});creme.widget.DateTimePicker=creme.widget.declare('ui-creme-datetimepicker',{options:{format:'dd-mm-yy',readonly:false,disabled:false},_create:function(element,options,cb,sync){var input=$('input[type="hidden"]',element);this._disabled=creme.object.isTrue(options.disabled)||input.prop('disabled');this._readonly=creme.object.isTrue(options.readonly)||input.prop('readonly');element.toggleClass('is-readonly',this._readonly);input.prop('disabled',this._disabled);input.prop('readonly',this._readonly);creme.forms.DateTimePicker.init(element,options.format);input.on('change',function(){var datetime=creme.forms.DateTimePicker.parseDateTime($(this).val());$('li.date input[type="text"]',element).val(datetime.date);$('li.hour input[type="number"]',element).val(datetime.hour);$('li.minute input[type="number"]',element).val(datetime.minute);});this._datepicker=$('li.date input[type="text"]',element).datepicker();this._buttons=$('button[type="button"]',element);this._updateDisabledState(element,this._disabled);element.addClass('widget-ready');},_updateDisabledState:function(element,disabled){var state=disabled||this._readonly;this._datepicker.datepicker('option','disabled',state);this._buttons.prop('disabled',state);$('li input[type="text"],li input[type="number"]',element).prop('disabled',state);},val:function(element,value){if(value===undefined){return creme.forms.DateTimePicker.val(element);}
$('input[type="hidden"]',element).val(value).trigger('change');return this;}});}(jQuery));(function($){"use strict";creme.widget.DateRange=creme.widget.declare('ui-creme-daterange',{options:{},_create:function(element,options,cb,sync){var self=this;var datetype=this.dateType(element);datetype.on('change',function(){self._onTypeChange(element,$(this).val());});this._onTypeChange(element,datetype.val());element.addClass('widget-ready');},_onTypeChange:function(element,value){var isCustomRange=Object.isEmpty(value);element.find('[data-daterange-field]').each(function(){$(this).parents('.daterange-field').first().toggleClass('not-visible',!isCustomRange);});if(!isCustomRange){element.find('[data-daterange-field]').val('');}},reset:function(element){this.endDate(element).val('');this.startDate(element).val('');this.dateType(element).val('').trigger('change');},endDate:function(element){return $('[data-daterange-field="end"]',element);},startDate:function(element){return $('[data-daterange-field="start"]',element);},dateType:function(element){return $('[data-daterange-type]',element);}});}(jQuery));(function($){"use strict";creme.widget.DateRangeSelector=creme.widget.declare('ui-creme-daterange-selector',{options:{cloneDatePickers:true},_create:function(element,options,cb,sync){options=Object.assign({format:element.data('format')||'dd-mm-yy'},options||{});var self=this;var rangeType=this.rangeType(element);var value=this.val(element);if(options.cloneDatePickers){this._clearDatePickers(element);}
element.find('.date-end, .date-start').datepicker({dateFormat:options.format,showOn:"button",buttonText:gettext("Calendar"),buttonImage:creme_media_url("images/icon_calendar.gif"),buttonImageOnly:true});rangeType.on('change',function(e){self._onTypeChange(element,$(this).val());});this.startDate(element).on('change',function(){self._updateInput(element);});this.endDate(element).on('change',function(){self._updateInput(element);});if(Object.isEmpty(value)){this._updateInput(element);value=this.val(element);}
this._updateRangeFields(element,value);element.addClass('widget-ready');},endDate:function(element){return element.find('.date-end');},startDate:function(element){return element.find('.date-start');},rangeType:function(element){return element.find('.range-type');},_onTypeChange:function(element,value){var isCustomRange=Object.isEmpty(value);element.find('.daterange-inputs').toggleClass('hidden',!isCustomRange);if(!isCustomRange){this.endDate(element).val('');this.startDate(element).val('');}
this._updateInput(element);},_clearDatePickers:function(element){element.find('.daterange-input.hasDatepicker').removeAttr('id').removeClass('hasDatepicker');element.find('img.ui-datepicker-trigger').remove();},dependencies:function(element){return[];},reload:function(element,url,cb,error_cb,sync){if(cb!==undefined){cb(element);}},_updateInput:function(element){var input=creme.widget.input(element);var data=JSON.stringify({type:this.rangeType(element).val(),start:this.startDate(element).val(),end:this.endDate(element).val()});if(data!==input.val()){input.val(data).trigger('change');}},_updateRangeFields:function(element,data){var defaultData={type:'',start:null,end:null};try{data=Object.isString(data)?JSON.parse(data):data||defaultData;}catch(e){data=defaultData;}
this.endDate(element).val(data.end||'');this.startDate(element).val(data.start||'');this.rangeType(element).val(data.type||'').trigger('change');},val:function(element,value){if(value===undefined){return creme.widget.input(element).val();}
creme.widget.input(element).val(value);this._updateRangeFields(element,value);}});}(jQuery));(function($){"use strict";creme.widget.ChainedSelect=creme.widget.declare('ui-creme-chainedselect',{options:{backend:undefined,json:true},_create:function(element,options,cb,sync){var self=this;this._backend=options.backend||creme.ajax.defaultCacheBackend();this._enabled=creme.object.isFalse(options.disabled)&&element.is(':not([disabled])');this._context={};this.selectors(element).each(function(){$(this).creme().create({backend:self._backend,disabled:!self._enabled},undefined,true);});this._dependency_change=function(e){var selector_name=$(this).parent().attr('chained-name');var previous=self._context[selector_name];var next=$(this).creme().widget().cleanedval();if(previous!==next){self._reloadDependencies(element,selector_name,next);self._update(element);}};this._dependency_change_multiple=function(e,data){e.stopPropagation();var name=$(this).parent().attr('chained-name');var value=self._selectorValues(element);data=Array.isArray(data)?data:[data];var chained_data=data.map(function(item){value[name]=item;return Object.assign({},value);});element.trigger('change-multiple',[chained_data]);};$('img.reset',element).on('click',function(){if(self._enabled){self.reset(element);}});var data=this.cleanedval(element);var values=this._selectorValues(element);this._reloadSelectors(element,values);this.selectors(element).on('change',self._dependency_change);this.selectors(element).on('change-multiple',self._dependency_change_multiple);if(Object.isEmpty(data)){this.val(element,values);}else{this._updateSelectors(element,data);this._update(element);}
element.addClass('widget-ready');creme.object.invoke(cb,element);},_destroy:function(element){this.selectors(element).each(function(){$(this).creme().destroy();});},_selectorValues:function(element){var data={};this.selectors(element).each(function(){var selector=$(this);var value=selector.creme().widget().cleanedval();var name=selector.parent().attr('chained-name');data[name]=value;});return data;},_update:function(element){this._context=this._selectorValues(element);creme.widget.input(element).val(JSON.stringify(this._context));},_updateSelector:function(selector,data){var name=selector.element.parent().attr('chained-name');var value=typeof data==='object'?data[name]:undefined;selector.val(value);},_updateSelectors:function(element,data){var self=this;this.selectors(element).each(function(){self._updateSelector($(this).creme().widget(),data);});},_reloadSelector:function(target,name,data){var ready=target.is('.widget-ready');var widget=target.creme().widget();if(ready&&(widget.dependencies()||[]).indexOf(name)!==-1){widget.reload(data,undefined,undefined,true);}},_reloadSelectors:function(element,data){for(var name in data){this._reloadDependencies(element,name,data[name]);}},_reloadDependencies:function(element,name,value){var self=this;var data=this._context;data[name]=value;this.selectors(element).each(function(){self._reloadSelector($(this),name,data);});},selector:function(element,name){return $('[chained-name="'+name+'"].ui-creme-chainedselect-item:last > .ui-creme-widget',element).filter(function(){return $(this).parents('.ui-creme-chainedselect').first().is(element);});},selectors:function(element){return $('.ui-creme-chainedselect-item > .ui-creme-widget',element).filter(function(){return $(this).parents('.ui-creme-chainedselect').first().is(element);});},reset:function(element){this.selectors(element).each(function(){$(this).creme().widget().reset();});},update:function(element,data){data=creme.widget.cleanval(data,{});var added=data.added||[];var removed=data.removed||[];var notempty=function(item){return Object.isEmpty(item)===false;};this.selectors(element).each(function(){var selector=$(this);var name=selector.parent().attr('chained-name');var widget=selector.creme().widget();if(Object.isFunc(widget.update)){var getter=function(item){return item[name];};var selector_added=added.map(getter).filter(notempty);var selector_removed=removed.map(getter).filter(notempty);widget.update({added:selector_added,removed:selector_removed});}});return this.val(element,data.value);},context:function(element){return Object.assign({},this._context);},val:function(element,value){if(value===undefined){return creme.widget.input(element).val();}
this._updateSelectors(element,creme.widget.cleanval(value,{}));this._update(element);element.trigger('change');}});}(jQuery));(function($){"use strict";creme.widget.SelectorList=creme.widget.declare('ui-creme-selectorlist',{options:{cloneLast:undefined},_create:function(element,options,cb,sync){var self=this;this._isCloneLast=creme.object.isTrue(options.cloneLast);this._enabled=creme.object.isFalse(options.disabled)&&element.is(':not([disabled])');if(!this._enabled){element.attr('disabled','');}
$('.selectorlist-add',element).on('click',function(){if(self._enabled){self.appendLastSelector(element);}});$('.selectorlist-create',element).on('click',function(){if(self._enabled){self.createSelector(element);}});var value=this.val(element);if(Object.isEmpty(value)){this._update(element);value=this.val(element);}else{this._updateSelectors(element,value);this._update(element);}
element.addClass('widget-ready');creme.object.invoke(cb,element);},lastSelector:function(element){return $('ul.selectors > li.selector:last > ul > li > .ui-creme-widget',element);},selectorModel:function(element){return $('.inner-selector-model > .ui-creme-widget',element);},selectors:function(element){return $('ul.selectors > li.selector > ul > li > .ui-creme-widget',element);},selector:function(element,index){return $('ul.selectors > li.selector:nth('+(index||0)+') > ul > li > .ui-creme-widget',element);},removeSelectorAt:function(element,index){return this.removeSelector(element,this.selector(element,index));},removeSelector:function(element,selector){if(Object.isEmpty(selector)){return;}
selector.creme().destroy();selector.parents('li.selector').first().remove();this._update(element);return selector;},appendLastSelector:function(element){var last=this.lastSelector(element);var value=this._isCloneLast&&last.creme().isActive()?last.creme().widget().val():undefined;return this.appendSelector(element,value);},appendSelector:function(element,value,action){action=action||'select';var self=this;return this._buildSelector(element,value,{done:function(event,selector,value){if(value===undefined){selector.triggerHandler('action',[action,{cancel:function(){self.removeSelector(element,selector);}}]);}else{selector.creme().widget().val(value);}}});},appendSelectors:function(element,values,action){var self=this;return values.map(function(value){return self.appendSelector(element,value,action);});},createSelector:function(element,value){return this.appendSelector(element,value,'create');},_buildSelector:function(element,value,listeners){var self=this;var selector_model=this.selectorModel(element).clone();if(Object.isEmpty(selector_model)){creme.object.invoke(listeners.fail,'fail');return;}
var selector_item=$('<li>').addClass('selector');var selector_layout=$('<ul>').addClass('ui-layout hbox').css('display','block').appendTo(selector_item);var img_title=gettext('Delete');var delete_button=$('<img/>').attr('src',creme_media_url('images/delete_22.png')).attr('alt',img_title).attr('title',img_title).attr('style','vertical-align:middle;').addClass('delete').on('click',function(){if(self._enabled){self.removeSelector(element,$('> ul > li > .ui-creme-widget',selector_item));}});selector_layout.append($('<li>').append(selector_model));selector_layout.append($('<li>').append(delete_button));$('ul.selectors',element).append(selector_item);selector_model.on('change',function(){self._update(element);});var selector=creme.widget.create(selector_model,{disabled:!this._enabled},function(){selector_model.on('change-multiple',function(e,data){self.appendSelectors(element,data.slice(1));});creme.object.invoke(listeners.done,'done',selector_model,value);},true);if(selector===undefined){selector_item.remove();creme.object.invoke(listeners.fail,'fail');}
return selector;},_update:function(element){var values=creme.widget.values_list(this.selectors(element));creme.widget.input(element).val('['+values.join(',')+']');},_updateSelectors:function(element,data){var self=this;var values=creme.widget.cleanval(data,[]);if(typeof values!=='object'){return;}
$('ul.selectors',element).empty();values.forEach(function(value){self.appendSelector(element,value);});},val:function(element,value){if(value===undefined){return creme.widget.input(element).val();}
this._updateSelectors(element,value);this._update(element);}});}(jQuery));(function($){"use strict";creme.widget.EntitySelectorMode={MULTIPLE:'multiple',SINGLE:'single'};creme.widget.EntitySelector=creme.widget.declare('ui-creme-entityselector',{options:{popupURL:'',popupSelection:creme.widget.EntitySelectorMode.SINGLE,labelURL:'',label:gettext('Select'),qfilter:'',backend:undefined},_create:function(element,options,cb,sync){var self=this;this._backend=options.backend||creme.ajax.defaultCacheBackend();this._enabled=creme.object.isFalse(options.disabled)&&element.is(':not([disabled])');if(!this._enabled){$(element).attr('disabled','');$('button',element).attr('disabled','');}
$(element).on('click',function(){if(self._enabled){self._select(element);}});$(element).on('action',function(e,action,listeners){if(action==='select'){self._select(element,listeners);}});creme.widget.input(element).on('invalid html5-invalid',function(){$('button',element).toggleClass('is-field-invalid',$(this).is(':invalid'));});this._popupURL=new creme.utils.Template(options.popupURL,{qfilter:options.qfilter,selection:options.popupSelection});this._reloadLabel(element,cb,undefined,sync);element.addClass('widget-ready');},dependencies:function(element){return this._popupURL.tags();},reload:function(element,data,cb,error_cb,sync){this._popupURL.update(data);this.val(element,null);creme.object.invoke(cb,element);},update:function(element,data){data=_.isString(data)?_.cleanJSON(data):data;if(!Object.isNone(data)){this.val(element,data['value']);}},_select:function(element,listeners){listeners=listeners||{};var self=this;var multiple=this.isMultiple(element);var url=this.popupURL(element);var selector=new creme.lv_widget.ListViewDialog({url:url,selectionMode:multiple?'multiple':'single',closeOnEscape:true});selector.onValidate(function(event,data){self.val(element,data[0]);if(data.length>1){$(element).trigger('change-multiple',[data]);}
creme.object.invoke(listeners.done,'done',element,data);}).onClose(function(){creme.object.invoke(listeners.cancel,'cancel');}).open();},_reloadLabel:function(element,on_success,on_error,sync){var options=this.options;var button=$('button',element);var value=creme.widget.input(element).val();if(Object.isEmpty(value)===true){button.text(options.label);creme.object.invoke(on_success,element);return;}
var url=(options.labelURL||'').template({id:value});var default_label=gettext('Entity #%s (not viewable)').format(value);this._backend.get(url,{fields:['summary']},function(data,status){try{button.html(data[0][0]||default_label);}catch(e){button.html(default_label);}
creme.object.invoke(on_success,element,data);},function(data,error){button.html(default_label);creme.object.invoke(on_error,element,error);},{dataType:'json',sync:sync});},isMultiple:function(element,value){if(value===undefined){return this._popupURL.parameters().selection===creme.widget.EntitySelectorMode.MULTIPLE;}
value=value?creme.widget.EntitySelectorMode.MULTIPLE:creme.widget.EntitySelectorMode.SINGLE;this._popupURL.update({selection:value});},parentSelectorList:function(element){return element.parents('.ui-creme-selectorlist').first();},qfilter:function(element,value){this._popupURL.update({qfilter:value});},popupURL:function(element){return this._popupURL.render()||'';},reset:function(element){this.val(element,null);},val:function(element,value){if(value===undefined){return creme.widget.input(element).val();}
creme.widget.input(element).val(value);this._reloadLabel(element);element.trigger('change');},cleanedval:function(element){var value=this.val(element);return Object.isEmpty(value)?null:value;}});}(jQuery));(function($){"use strict";creme.widget.PolymorphicSelect=creme.widget.declare('ui-creme-polymorphicselect',{options:{key:null,dependencies:''},_create:function(element,options,cb,sync){var self=this;this._context={};this._dependencies=Array.isArray(options.dependencies)?options.dependencies:(options.dependencies?options.dependencies.split(' '):[]);this._selectorKey=creme.utils.templatize(options.key,function(key){return self._context[key];});this._enabled=creme.object.isFalse(options.disabled)&&element.is(':not([disabled])');this._selector_onchange_cb=function(){element.trigger('change');};this._init_models(element);this.reload(element,{},cb,cb);element.addClass('widget-ready');},_destroy:function(element){this._removeSelector(element);},_init_models:function(element){var models=this._models=[];$('> script[selector-key]',element).each(function(){var pattern=new RegExp($(this).attr('selector-key').replace('.','\.').replace('*','.*'));var content=new creme.utils.Template($(this).html());models.push({pattern:pattern,content:content});});},_updateSelector:function(element,selector,value,cb,sync){if(Object.isNone(selector)){creme.object.invoke(cb,element);}else{selector.val(value);}},_removeSelector:function(element){if(this._selector!==undefined){var selector=this._selector;var selectorElement=selector.element;selectorElement.off('change paste',this._selector_onchange_cb);selector.destroy();selectorElement.remove();this._selector=undefined;this._selectorModel=undefined;}
if(this._target){this._target.remove();this._target=undefined;}},_createSelector:function(element,model,value,cb,error_cb,sync){var self=this;this._target=$('<span>').addClass('delegate').html(model).appendTo(element);var selector=$('> .delegate > .ui-creme-widget',element).first();if(selector.length===1){creme.widget.create(selector,{},function(delegate){creme.object.invoke(cb,element);delegate.on('change paste',self._selector_onchange_cb);element.trigger('change');},sync);this._selector=selector.creme().widget();this._selectorModel=model;}},toggleSelector:function(element,previous_key,cb,error_cb,sync){var value=this.val(element);var previous=this._selector;var previousModel=this._selectorModel;var key=this.selectorKey(element);var model=this.selectorModel(element,key);if(Object.isNone(model)){this._removeSelector(element);}else if(previousModel===model){return this._updateSelector(element,previous,value,cb,sync);}else{this._removeSelector(element);this._createSelector(element,model,null,cb,error_cb,sync);}},selectorKey:function(element){return(this._selectorKey&&this._selectorKey.iscomplete())?this._selectorKey.render()||'':'';},selectorValue:function(element){var selector=this.selector(element);return selector!==undefined?selector.val():null;},selector:function(element){return this._selector;},selectorModel:function(element,key){var models=this.selectorModels(element);for(var i in models){var model=models[i];if(typeof key==='string'&&key.match(model.pattern)!==null){return model.content.render(this._context);}}},selectorModels:function(element){return this._models||[];},dependencies:function(element){return(this._selectorKey?this._selectorKey.tags():[]).concat(this._dependencies);},reload:function(element,data,cb,error_cb,sync){var previous_key=this.selectorKey(element);this._context=$.extend({},this._context||{},data||{});this._selectorKey.parameters(this._context);this.toggleSelector(element,previous_key,cb,error_cb,sync);},reset:function(element){if(this._selector){this._selector.reset();}},val:function(element,value){if(value===undefined){return this._selector?this._selector.val():null;}
if(this._selector){this._selector.val(value);}}});}(jQuery));(function($){"use strict";creme.widget.SelectorAction=creme.component.Action.sub({_init_:function(delegate,button,options){this._super_(creme.component.Action,'_init_',this._run,options);this._delegate=delegate;this._button=button;this.onDone(this._updateDelegate.bind(this));},_updateDelegate:function(event,data){var delegate=this._delegate;if(Object.isEmpty(delegate)){return;}
data=_.isString(data)?_.cleanJSON(data)||null:data;if(data!==null){delegate.update(data);}else{delegate.reload();}},context:function(context){return Object.property(this,'_context',context);},dependencies:function(){return[];}});creme.widget.ResetSelectorAction=creme.widget.SelectorAction.sub({_init_:function(delegate,button,options){this._super_(creme.widget.SelectorAction,'_init_',delegate,button,options);},_run:function(options){var buttonOptions=creme.widget.parseopt(this._button,{value:''});this.done({value:buttonOptions.value},'success');}});creme.widget.CreateSelectorAction=creme.widget.SelectorAction.sub({_init_:function(delegate,button,options){this._super_(creme.widget.SelectorAction,'_init_',delegate,button,options);},_dialogOptions:function(){var options=creme.widget.parseopt(this._button,{popupResizable:true,popupDraggable:true,popupWidth:window.screen.width/2,popupHeight:356,popupUrl:'',popupTitle:''});var delegate=this._delegate;var context=Object.isFunc(delegate.context)?{_delegate_:delegate.context()}:{};context=$.extend(context,this._context);options.url=new creme.utils.Template(options.popupUrl).render(context);options.title=new creme.utils.Template(options.popupTitle).render(context);return options;},updateButtonState:function(){var dialogOptions=this._dialogOptions();var label=dialogOptions.title||gettext('Add');this._button.toggleProp('disabled',Object.isEmpty(dialogOptions.url)).find('span').text(label);},_run:function(options){var self=this;var dialogOptions=this._dialogOptions();if(Object.isEmpty(dialogOptions.url)){self.cancel();return;}
var action=new creme.dialog.FormDialogAction();action.onDone(function(event,data){self.done(data.data());}).on('cancel fail',function(event){self.cancel();}).start(dialogOptions);}});creme.widget.SelectorActionBuilderRegistry=creme.action.DefaultActionBuilderRegistry.sub({_init_:function(selector){this._selector=selector;this._super_(creme.action.DefaultActionBuilderRegistry,'_init_');},_build_popup:function(url,options,data){return new creme.widget.CreateSelectorAction(this._selector,options.button).context(data||{});},_build_reset:function(url,options,data){return new creme.widget.ResetSelectorAction(this._selector,options.button).context(data||{});}});creme.widget.ActionButtonList=creme.widget.declare('ui-creme-actionbuttonlist',{options:{backend:undefined,debug:true},_create:function(element,options,cb,sync){var self=this;this._enabled=creme.object.isFalse(options.disabled)&&element.is(':not([disabled])');this._selector=creme.widget.create(self.selector(element),{disabled:!self._enabled,backend:options.backend});this._dependencies=Array.isArray(options.dependencies)?options.dependencies:(options.dependencies?options.dependencies.split(' '):[]);this._context={};this._actionBuilders=new creme.widget.SelectorActionBuilderRegistry(this._selector);if(!this._enabled){element.attr('disabled','');self.actionButtons(element).attr('disabled','');}
self.actionButtons(element).on('click',function(e){e.preventDefault();self._onButtonActionClick(element,$(this));});$(element).on('action',function(e,name,listeners){self.doAction(element,name,listeners);});creme.object.invoke(cb,element);element.addClass('widget-ready');},actionButtons:function(element){return $('> li > button.ui-creme-actionbutton',element);},actionButton:function(element,name){return $('> li > button.ui-creme-actionbutton[name="'+name+'"]',element);},doAction:function(element,name,listeners){listeners=listeners||{};var button=this.actionButton(element,name);if(button.length===1){this._doAction(element,button,listeners);}else{this._selector.element.triggerHandler('action',[name,listeners]);}},isDisabled:function(element){return!this._enabled;},selector:function(element){return $('> li.delegate > .ui-creme-widget',element);},dependencies:function(element){return creme.object.delegate(this._selector,'dependencies')||[];},url:function(element,url){if(url===undefined){return creme.object.delegate(this._selector,'url');}
creme.object.delegate(this._selector,'url',url);return this;},filter:function(element,filter){if(filter===undefined){return creme.object.delegate(this._selector,'filter');}
creme.object.delegate(this._selector,'filter',filter);return this;},reload:function(element,data,cb,error_cb,sync){creme.object.delegate(this._selector,'reload',data,cb,error_cb,sync);this._context=$.extend({},this._context||{},data);this._updateActionButtons(element);return this;},val:function(element,value){if(value===undefined){return creme.object.delegate(this._selector,'val')||'';}
creme.object.delegate(this._selector,'val',value);return this;},reset:function(element,value){creme.object.delegate(this._selector,'reset');return this;},cleanedval:function(element){return creme.object.delegate(this._selector,'cleanedval')||null;},update:function(element,data){creme.object.delegate(this._selector,'update');return this;},_updateActionButtons:function(element){var self=this;this.actionButtons(element).each(function(){var action=self._buildAction(element,$(this));if(Object.isFunc(action.updateButtonState)){action.updateButtonState();}});},_buildAction:function(element,button){var actiontype=creme.widget.parseopt(button,{action:'popup'}).action;var builder=this._actionBuilders.get(actiontype);if(Object.isFunc(builder)){return builder('',{button:button},this._context);}else{return new creme.component.Action(function(){this.cancel();});}},_doAction:function(element,button,listeners){listeners=listeners||{};var action=this._buildAction(element,button);action.onDone(function(event,data){element.trigger('actionListSuccess',data);}).on('cancel fail',function(event){element.trigger('actionListCanceled',Array.from(arguments).slice(1));}).one(listeners).start();return action;},_onButtonActionClick:function(element,button){if(this.isDisabled()||button.is('[disabled]')){return;}
this._doAction(element,button);}});}(jQuery));(function($){"use strict";function setUpTinymce(url){var base;if(!url.match(/^(http|https):\/\//)){base='${protocol}//${host}/'.template(_.urlAsDict(window.location.href));url=base+url;}else{base='${protocol}//${host}/'.template(_.urlAsDict(url));}
tinymce.documentBaseURL=url;tinymce.baseURL=tinymce.documentBaseURL;tinymce.baseURI=new tinymce.util.URI(tinymce.documentBaseURL,{base_uri:base});}
creme.widget.Editor=creme.widget.declare('ui-creme-editor',{options:{datatype:'string',basepath:'/tiny_mce'},_create:function(element,options,cb,sync){this._enabled=creme.object.isFalse(options.disabled)&&element.is(':not([disabled])');if(!this._enabled){$(element).attr('disabled','');}
var id=element.attr('id')||_.uniqueId('tinymce-');element.attr('id',id);setUpTinymce(options.basepath);var editor=this._editor=new tinymce.Editor(id,{mode:'textareas',theme:'advanced',height:300,language:'en',document_base_url:'tiny_mce/',plugins:['spellchecker','pagebreak','style','layer','table','save','advhr','advimage','advlink','emotions','iespell','inlinepopups','insertdatetime','preview','media','searchreplace','print','contextmenu','paste','directionality','fullscreen','noneditable','visualchars','nonbreaking','xhtmlxtras','template','fullpage'].join(','),theme_advanced_buttons1:['save','newdocument','|','bold','italic','underline','strikethrough','|','justifyleft','justifycenter','justifyright','justifyfull','|','styleselect','formatselect','fontselect','fontsizeselect'].join(','),theme_advanced_buttons2:['cut','copy','paste','pastetext','pasteword','|','search','replace','|','bullist','numlist','|','outdent','indent','blockquote','|','undo','redo','|','link','unlink','anchor','image','cleanup','code','|','insertdate','inserttime','preview','|','forecolor','backcolor'].join(','),theme_advanced_buttons3:['tablecontrols','|','hr','removeformat','visualaid','|','sub','sup','|','charmap','emotions','iespell','media','advhr','|','print','|','ltr','rtl','|','fullscreen'].join(','),theme_advanced_buttons4:['insertlayer','moveforward','movebackward','absolute','|','styleprops','spellchecker','|','cite','abbr','acronym','del','ins','attribs','|','visualchars','nonbreaking','blockquote','pagebreak','|','insertfile','insertimage'].join(','),theme_advanced_toolbar_location:'top',theme_advanced_toolbar_align:'left',theme_advanced_path_location:'bottom',theme_advanced_resizing:true});editor.render();this._onPreValidate=function(){if(this._editor){this._editor.save();}}.bind(this);element.on('html5-pre-validate',this._onPreValidate);creme.object.invoke(cb,element);element.addClass('widget-ready');},_destroy:function(element){if(this._editor){this._editor.remove();}
element.off('html5-pre-validate',this._onPreValidate);},editor:function(element){return this._editor;}});}(jQuery));(function($){"use strict";creme.menu={};creme.menu.MenuController=creme.component.Component.sub({isBound:function(){return Object.isNone(this._element)===false;},bind:function(element){if(this.isBound()){throw new Error('MenuController is already bound');}
this._element=element;this._initMenuItems(element);this._initQuickFormItems(element);this._initAnyFormItems(element);return this;},closeMenu:function(){$('.ui-creme-navigation-activated',this._element).removeClass('ui-creme-navigation-activated');return this;},_initMenuItems:function(element){var menu=element.find('.ui-creme-navigation');var items=menu.children('li');items.on('mouseenter',function(e){$(this).addClass('ui-creme-navigation-activated');}).on('mouseleave',function(e){$(this).removeClass('ui-creme-navigation-activated');});items.on('click',function(e){if(e.target!==this){return;}
var currentActivatedItem=menu.children('li.ui-creme-navigation-activated');var itemToActivate=$(e.currentTarget);var isOtherItemActive=currentActivatedItem.index()!==itemToActivate.index();if(isOtherItemActive){currentActivatedItem.removeClass('ui-creme-navigation-activated');itemToActivate.addClass('ui-creme-navigation-activated');}});},_initQuickFormItems:function(element){var openQuickFormDialog=this._openQuickFormDialog.bind(this);$('.quickform-menu-link',element).on('click',function(e){e.preventDefault();openQuickFormDialog($(this));});},_initAnyFormItems:function(element){var openCreateAnyDialog=this._openCreateAnyDialog.bind(this);$('.anyform-menu-link',element).on('click',function(e){e.preventDefault();openCreateAnyDialog($(this));});},_openPopup:function(dialog){if(this._activePopup){this._activePopup.close();this._activePopup=undefined;}
this._activePopup=dialog.open();},_openQuickFormDialog:function(item){this.closeMenu();this._openPopup(creme.dialogs.form(item.attr('data-href'),{reloadOnSuccess:true}));},_openCreateAnyDialog:function(item){this.closeMenu();var groupedLinks=JSON.parse(item.attr('data-grouped-links'));var maxColumnCount=1;groupedLinks.forEach(function(item){maxColumnCount=Math.max(maxColumnCount,item.length);});var renderLinkGroupRow=function(item){return('<div class="create-group-container create-group-container-${count}-columned">'+'${groups}'+'</div>').template({count:item.length,groups:item.map(renderLinkGroup).join('')});};var renderLinkGroup=function(item){return('<div class="create-group">'+'<div class="create-group-title">${title}</div>'+'${links}'+'</div>').template({title:item.label,links:item.links.map(renderLink).join('')});};var renderLink=function(link){if(link.url){return'<a href="${url}" class="create-group-entry">${label}</a>'.template(link);}else{return'<span class="create-group-entry forbidden">${label}</span>'.template(link);}};var html='<div class="create-all-form">${rows}</div>'.template({rows:groupedLinks.map(renderLinkGroupRow).join('')});this._openPopup(creme.dialogs.html(html,{title:gettext('Chose the type of entity to create'),width:Math.max(550,maxColumnCount*200)}));}});}(jQuery));(function($){"use strict";creme.notification={};creme.notification.NotificationBox=creme.component.Component.sub({_init_:function(element,options){options=Object.assign({refreshDelay:300000,deltaRefreshDelay:60000,refreshUrl:'',discardUrl:''},options||{});Assert.not(Object.isEmpty(options.refreshUrl),'refreshUrl is required');Assert.not(Object.isEmpty(options.discardUrl),'discardUrl is required');Assert.not(element.is('.is-active'),'NotificationBox is already active');this._element=element;this._refreshDelay=options.refreshDelay;this._deltaRefreshDelay=options.deltaRefreshDelay;this._initialDataSelector=options.initialDataSelector;this._refreshUrl=options.refreshUrl;this._discardUrl=options.discardUrl;this.setup(element,options);},isFetchActive:function(){return Boolean(this._fetchJob);},isPaused:function(){return document.hidden;},initialData:function(){var script=this._element.find('script[type$="/json"].notification-box-data:first');var data=_.readJSONScriptText(script.get(0));return Object.assign({count:0,notifications:[]},Object.isEmpty(data)?{}:JSON.parse(data));},setup:function(element,options){var self=this;this._count=0;this._overlay=new creme.dialog.Overlay();this._updateBox(this.initialData());this._overlay.bind($('.notification-items',element)).addClass('notification-loading').content('<h2><img src="${src}"><span>${label}</span></h2>'.template({src:creme_media_url('images/wait.gif'),label:gettext('Loading')}));element.on('click','.discard-notification',function(e){e.preventDefault();self._onDiscardItem($(this).parents('.notification-item:first'));});this.startFetch();element.addClass('is-active');return this;},startFetch:function(){if(!this.isFetchActive()){this._fetchJob=setInterval(this._fetchItems.bind(this),this._refreshDelay);this._timeDeltaJob=setInterval(this._updateDeltas.bind(this),this._deltaRefreshDelay);}
return this;},stopFetch:function(){if(!Object.isNone(this._fetchJob)){clearInterval(this._fetchJob);this._fetchJob=null;}
if(!Object.isNone(this._timeDeltaJob)){clearInterval(this._timeDeltaJob);this._timeDeltaJob=null;}
return this;},_onDiscardItem:function(item){var self=this;var id=item.data('id');if(!Object.isEmpty(id)){creme.utils.ajaxQuery(this._discardUrl,{action:'post',warnOnFail:true},{id:id}).onDone(function(){item.remove();self._updateCounter(self._count-1);}).start();}},_humanizedTimeDelta:function(secondsTimedelta){var minutesTimeDelta=Math.floor(secondsTimedelta/60);if(minutesTimeDelta<1){return gettext('A few moments ago');}else if(minutesTimeDelta<60){return ngettext('%d minute ago','%d minutes ago',minutesTimeDelta).format(minutesTimeDelta);}
var hoursTimeDelta=Math.floor(minutesTimeDelta/60);if(hoursTimeDelta<24){return ngettext('More than %d hour ago','More than %d hours ago',hoursTimeDelta).format(hoursTimeDelta);}
var daysDelta=Math.floor(hoursTimeDelta/24);return ngettext('More than %d day ago','More than %d days ago',daysDelta).format(daysDelta);},_updateCounter:function(count){this._count=count;var countWidget=this._element.find('.notification-box-count');countWidget.text(count);countWidget.toggleClass('is-empty',!count);},_updateDeltas:function(){if(this.isPaused()){return;}
var self=this;var now=Date.now();$('.notification-item').each(function(){var item=$(this);var created=parseInt(item.data('created'));var label=self._humanizedTimeDelta(Math.round((now-created)/1000));item.find('.notification-created').text(label);});},_updateItems:function(notifications){var element=this._element;var items=element.find('.notification-items');var now=Date.now();var html=notifications.map(function(itemData){var created=Date.parse(itemData.created);var createdLabel=new Date(created).toLocaleString();return('<li class="notification-item notification-item-level${level}" data-id="${id}" data-created="${created}">'+'<span class="notification-channel">${channel}</span>'+'<span class="notification-subject">${subject}</span>'+'<span class="notification-created" title="${createdLabel}">${timeDeltaLabel}</span>'+'<div class="notification-body">${body}</div>'+'<button type="button" class="discard-notification">${discardLabel}</button>'+'</li>').template({id:itemData.id,level:itemData.level,channel:itemData.channel,created:created,createdLabel:createdLabel,timeDeltaLabel:this._humanizedTimeDelta(Math.round((now-created)/1000)),subject:itemData.subject,body:itemData.body,discardLabel:gettext('Validate')});}.bind(this)).join('');items.html(html);},_updateBox:function(data){this._updateCounter(data.count);this._updateItems(data.notifications);},_updateErrorMessage:function(message){var container=this._element.find('.notification-error');container.toggleClass('is-empty',message===undefined||message==='');container.find('span').text(message||'');},_fetchItems:function(){if(this.isPaused()){return;}
var self=this;var overlay=this._overlay;overlay.visible(true);this._fetchQuery=creme.ajax.query(this._refreshUrl,{backend:{sync:false,dataType:'json'}}).onDone(function(event,data){self._updateBox(data);self._updateErrorMessage('');}).onFail(function(event,data,error){self._updateErrorMessage(gettext('An error happened when retrieving notifications (%s)').format(error.message));}).onComplete(function(){overlay.visible(false);}).start();}});creme.setupNotificationBox=function(element,options){return new creme.notification.NotificationBox($(element),options);};}(jQuery));(function($){"use strict";creme.search=creme.search||{};var KeyCodes={UP:38,DOWN:40,ENTER:13,ESCAPE:27};creme.search.SearchBox=creme.component.Component.sub({_init_:function(options){options=$.extend({minSearchLength:3,debounceDelay:200,focusDebounceDelay:100},options||{});this._glasspane=new creme.dialog.GlassPane();this._glasspane.pane().on('click',this._onHide.bind(this));if(Object.isEmpty(options.searchUrl)){throw new Error('searchUrl is required');}
if(Object.isEmpty(options.advancedSearchUrl)){throw new Error('advancedSearchUrl is required');}
this._state='default';this._timestamp=null;this.debounceDelay=options.debounceDelay;this.focusDebounceDelay=options.focusDebounceDelay;this.minSearchLength=options.minSearchLength;this.searchUrl=options.searchUrl;this.advancedSearchUrl=options.advancedSearchUrl;},isBound:function(){return Object.isNone(this._element)===false;},isLoading:function(){return this._state==='loading';},bind:function(element){if(this.isBound()){throw Error('SearchBox is already bound');}
this._element=element;var _onInput=this._onInput.bind(this);var _onShow=this._onShow.bind(this);this._input=element.find('input');this._input.on('focus',this.focusDebounceDelay?_.debounce(_onShow,this.focusDebounceDelay,false):_onShow).on('input paste',this.debounceDelay?_.debounce(_onInput,this.debounceDelay,false):_onInput).on('keydown',this._onKeyDown.bind(this));this._resultsRoot=element.find('.inline-search-results');this._icon=element.find('.search-box-icon');this._allResultsGroup=element.find('.all-search-results');this._allResultsLink=this._allResultsGroup.find('a');return this;},isOpened:function(){return this._glasspane.isOpened();},_onShow:function(e){if(this.isOpened()){return;}
this._glasspane.open($('.header-menu'));this._resultsRoot.addClass('showing');},_onHide:function(e){this._cancelSearch();this._input.trigger('blur');this._resultsRoot.removeClass('showing');this._glasspane.close();},_onKeyDown:function(e){if(this.isLoading()){return;}
switch(e.keyCode){case KeyCodes.ESCAPE:this._onHide();break;case KeyCodes.ENTER:this._goToSelection();break;case KeyCodes.UP:this._setSelectedResult((this.selected-1)%this.linksCount);break;case KeyCodes.DOWN:this._setSelectedResult((this.selected+1)%this.linksCount);break;default:return;}
e.preventDefault();},_onInput:function(e){var query=(this._input.val()||'').trim();var isValidQuery=query.length>=this.minSearchLength;if(isValidQuery===false){this._cancelSearch();}else{this._startSearch(query);}},_updateResultState:function(results){results=results||{};this._allResultsGroup.siblings().remove();if(results.count>0){this._allResultsGroup.after(results.items);var url=_.toRelativeURL(this.advancedSearchUrl).searchData({search:results.query});this._allResultsLink.attr('href',url);this._allResultsLink.text(gettext('All results (%s)').format(results.count));this._setSelectedResult(1);}else{this._allResultsLink.attr('href','');this._allResultsLink.text(gettext('No result'));}
this.linksCount=this._resultsRoot.find('.search-result').length;this.resultCount=results.count;},_updateState:function(isLoading,results){this._icon.toggleClass('default',!isLoading).toggleClass('loading',isLoading);this._state=isLoading?'loading':'default';if(isLoading){this._allResultsLink.text(gettext('Loading'));this._resetSelection();}else if(Object.isNone(results)){this._allResultsLink.text(gettext('Advanced search'));this._allResultsLink.attr('href',this.advancedSearchUrl);this._resetSelection();}else{this._updateResultState(results);}},_cancelSearch:function(){this._timestamp=null;this._updateState(false);},_startSearch:function(query){var self=this;var timestamp=new Date().getTime();var queryOptions={backend:{sync:false}};creme.ajax.query(this.searchUrl,queryOptions,{value:query}).onStart(function(){self._updateState(true);self._timestamp=timestamp;}).onFail(function(){self._updateState(false);}).onDone(function(event,responseData){try{var data=self._renderResults(JSON.parse(responseData),query);if(self._timestamp!==null&&timestamp>=self._timestamp){self._updateState(false,data);}}catch(e){console.error(e);self._updateState(false);}}).get();},_renderResults:function(data,query){var results=[];var idx=-1;var resultCount=0;for(idx in data.results){resultCount+=data.results[idx].count;}
if(resultCount>0){if(resultCount>1){var best=data.best;var bestResult=("<div class='search-results-group best-results-group'>"+"<span class='search-results-group-title'>${title}</span>"+"<ul class='search-results'>"+"<li class='search-result'><a href='${url}'${attrs}>${label}</a></li>"+"</ul>"+"</div>").template({title:gettext('Best result'),url:best.url,attrs:best.deleted?" class='is_deleted'":'',label:$('<div>').text(best.label).html()});results.push(bestResult);}
var searchUrl=_.toRelativeURL(this.advancedSearchUrl);for(idx in data.results){var ct=data.results[idx];var ctResultsUrl=searchUrl.searchData({ct_id:ct.id,search:query}).toString();var ctResults=ct.results.map(function(ctResult){return"<li class='search-result'><a href='${url}'${attrs}>${label}</a></li>".template({url:ctResult.url,attrs:ctResult.deleted?" class='is_deleted'":'',label:$('<div>').text(ctResult.label).html()});});var ctGroupTitle=ct.label;var ctGroup=("<div class='search-results-group'>"+"<span class='search-results-group-title'><a href='${url}'>${title}</a></span>"+"<ul class='search-results'>${results}</ul>"+"</div>").template({url:ctResultsUrl,title:ctGroupTitle,results:ctResults.join('\n')});results.push(ctGroup);}}
return{query:query,count:resultCount,items:results};},_resetSelection:function(){this._resultsRoot.find('.search-result-selected').removeClass('search-result-selected');},_setSelectedResult:function(selected){this._resetSelection();this.selected=selected;this._selected=this._resultsRoot.find('.search-result').eq(selected).addClass('search-result-selected');if(this._selected.length>0){this._selected[0].scrollIntoView();}},_goToSelection:function(){if(this.resultCount>0){var result=this._selected.find('a');creme.utils.goTo(result.attr('href'));}}});}(jQuery));(function($){"use strict";creme.bricks=creme.bricks||{};creme.bricks.dialogCenterPosition=function(dialog){var outer_height=$('.header-menu').outerHeight();if(dialog.dialog().parents('.ui-dialog').first().position().top<outer_height){dialog.position({my:'center top',at:'center top+'+(2*outer_height),of:window});}};creme.bricks.dialogActionButtons=function(dialog){var buttons=$('a.brick-dialog-action',dialog.content()).map(function(index){var link=$(this);var label=link.contents().map(function(){return this.nodeType===3?this.data:'';}).get().join('');return{'text':label,'click':function(e){e.preventDefault();creme.utils.goTo(link.attr('href'));}};}).get();if(Object.isEmpty(buttons)===false){buttons=buttons.concat(dialog.dialog().dialog('option','buttons'));dialog.replaceButtons(buttons);if(dialog.options.fitFrame){dialog.fitToFrameSize();}}};creme.bricks.defaultDialogOptions=function(url,title){var width=$(window).innerWidth();return{resizable:true,draggable:true,width:width*0.8,maxWidth:width,url:url,title:title,validator:'innerpopup'};};creme.bricks.BrickMenu=creme.component.Component.sub({_init_:function(brick,options){this._options=$.extend({direction:'right'},options||{});this._brick=brick;this._disabled=true;},bind:function(element){if(this.isBound()){throw new Error('BrickMenu is already bound');}
var toggle=this.toggle.bind(this);var content=this._menuContent(element);var is_disabled=this._disabled=$('a',content).length<1;this._element=element;this._dialog=new creme.dialog.Popover(this._options).fill(content);$('.brick-header-menu',element).toggleClass('is-disabled',is_disabled).on('click',function(e){toggle(e.target);});},unbind:function(){if(!this.isBound()){throw new Error('BrickMenu is not bound');}
this.close();this._dialog=null;this._element=null;this._disabled=true;},_menuContent:function(element){return $('.brick-menu-buttons',element);},isBound:function(){return Object.isNone(this._element)===false;},isDisabled:function(){return!this.isBound()||this._disabled;},isOpened:function(){return this.isBound()&&this._dialog.isOpened();},toggle:function(anchor){if(!this.isDisabled()&&!this._brick.isLoading()){this._dialog.toggle(anchor);}},close:function(){if(this.isBound()){this._dialog.close();}},open:function(anchor){if(!this.isDisabled()&&!this._brick.isLoading()){this._dialog.open(anchor);}}});creme.bricks.BrickSelectionController=creme.component.Component.sub({_init_:function(options){this._options=$.extend({rows:'tr',renderer:this._defaultItemStateRenderer,parser:this._defaultItemStateParser},options||{});var model=this._model=new creme.model.Array();model.bind('update',this._onItemUpdate.bind(this));this._selections=new creme.model.SelectionController().model(model);},_defaultItemStateRenderer:function(item){item.ui.toggleClass('is-selected',item.selected);},_defaultItemStateParser:function(item,index){return item.is('.is-selected');},_onItemUpdate:function(event,next,start,end,previous,action){next.forEach(this._options.renderer);},bind:function(element){var options=this._options;var parser=options.parser;this._model.reset($(options.rows,element).map(function(index){var item=$(this);item.attr('data-row-index',index);return{selected:parser(item,index),ui:item};}).get());return this;},state:function(){return this._selections;}});if($.ui.sortable.prototype._nativeMouseStart===undefined){var _nativeMouseStart=$.ui.sortable.prototype._mouseStart;$.ui.sortable.prototype._nativeMouseStart=_nativeMouseStart;$.ui.sortable.prototype._mouseStart=function(event,overrideHandle,noActivation){this._trigger('beforeStart',event,this._uiHash());_nativeMouseStart.apply(this,[event,overrideHandle,noActivation]);};}
creme.bricks.BrickTable=creme.component.Component.sub({_init_:function(brick,options){this._options=options||{};this._brick=brick;this._selections=new creme.bricks.BrickSelectionController({rows:'tr',renderer:function(item){item.ui.toggleClass('is-selected',item.selected);$('input[type="checkbox"]',item.ui).prop('checked',item.selected);}});this._events=new creme.component.EventHandler();},on:function(event,listener,decorator){this._events.on(event,listener,decorator);return this;},off:function(event,listener){this._events.off(event,listener);return this;},one:function(event,listener){this._events.one(event,listener);return this;},selections:function(){return this._selections.state();},isBound:function(){return Object.isNone(this._element)===false;},_updateSelectionState:function(){var state=this._selections.state();var count=state.selected().length;var total=state.selectables().length;$('th[data-selectable-selector-column] input[type="checkbox"]',this._element).prop('checked',count===total);this._brick.setSelectionState(count,total);},toggleSelection:function(index,state){if(!this._brick.isLoading()){this._selections.state().toggle(index,state);}},toggleSelectionAll:function(state){if(!this._brick.isLoading()){this._selections.state().toggleAll(state);}},toggleSort:function(field,ascending){if(!this._brick.isLoading()){var params={};var order=ascending?'':'-';params[this._brick.type_id()+'_order']=order+field;this._brick.refresh(params);}},bind:function(element){if(this.isBound()){throw new Error('BrickTable is already bound');}
var self=this;var brick=this._brick;var events=this._events;var selections=this._selections.bind($('tbody',element));this._element=element;element.on('change','.row-selector-all',function(e){self.toggleSelectionAll($(this).prop('checked'));});element.on('click','td[data-selectable-selector-column]',function(e){var row=$(this).parents('tr').first();var index=parseInt(row.attr('data-row-index'));self.toggleSelection(index,!row.is('.is-selected'));});selections.state().on('change',function(){self._updateSelectionState();});element.on('click','.brick-table-sortable',function(e){var link=$(this);self.toggleSort(link.attr('data-sort-field'),link.attr('data-sort-order')==='desc');});$('table[-table-floating-header]',element).each(function(){var table=$(this);table.floatThead({scrollContainer:function(table){return table.closest('.brick-scrollable-container');}});});$('.brick-reorderable-items',element).sortable({placeholder:'brick-reorderable-placeholder',handle:'[data-reorderable-handle-column]',beforeStart:function(e,ui){var widths=ui.item.find('td').map(function(){return this.offsetWidth;}).get();var height=ui.item.height();ui.item.data('creme-layout-state',{height:height,widths:widths});},start:function(e,ui){ui.item.appendTo(this).addClass('is-dragging');var state=ui.item.data('creme-layout-state');ui.item.find('td').each(function(index){$(this).css('width',state.widths[index]);});ui.placeholder.find('td').each(function(index,element){$(this).css('width',state.widths[index]);});ui.placeholder.height(state.height);events.trigger('row-drag-start',[e,ui.item]);},stop:function(e,ui){ui.item.removeClass('is-dragging');ui.item.find('td').removeAttr('style');events.trigger('row-drag-stop',[ui.item],this);}});events.on('row-drag-stop',function(event,item){var url=item.attr('data-reorderable-item-url');var next=item.index()+1;var prev=parseInt(item.attr('data-reorderable-item-order'));if(next!==prev){brick.action('update',url,{},{target:next}).on({done:function(){item.attr('data-reorderable-item-order',next);},fail:function(){brick.refresh();}}).start();}});return this;},unbind:function(){if(this.isBound()===false){throw new Error('BrickTable is not bound');}
$('table[-table-floating-header]',this._element).each(function(){$(this).floatThead('destroy');});$('.brick-reorderable-items',this._element).sortable('destroy');this._element=null;return this;}});creme.bricks.Dependencies=function(deps){this._wildcard=false;this._deps={};this.add(deps);};creme.bricks.Dependencies.prototype={intersect:function(other){if(this._wildcard||other._wildcard){return true;}
var this_deps=this._deps;var other_deps=other.keys();for(var i=0;i<other_deps.length;i++){if(this_deps[other_deps[i]]){return true;}}
return false;},add:function(deps){deps=deps||[];if(this._wildcard){return this;}
if(creme.bricks.Dependencies.prototype.isPrototypeOf(deps)){this._wildcard=deps._wildcard;if(deps._wildcard){this._deps={};}else{this._deps=$.extend(this._deps,deps._deps);}}else if(Array.isArray(deps)){for(var i=0;i<deps.length;i++){var key=deps[i];if(key==='*'){this._wildcard=true;this._deps={};break;}
this._deps[key]=true;}}else if(Object.isString(deps)){return this.add([deps]);}else{throw new Error('Unable to add invalid dependency data',deps);}
return this;},keys:function(){return Object.keys(this._deps);},isWildcard:function(){return this._wildcard;},isEmpty:function(){return!this._wildcard&&(Object.keys(this._deps).length===0);}};creme.bricks.Brick=creme.component.Component.sub({_init_:function(options){var self=this;options=$.extend({overlayDelay:200,deferredStateSaveDelay:1000},options||{});this._options=options;this._events=new creme.component.EventHandler();this._state={};this._dependencies=new creme.bricks.Dependencies();this._actionLinks=[];this._actionBuilders=new creme.bricks.BrickActionBuilders(this);if(options.deferredStateSaveDelay>0){this._deferredStateSave=_.debounce(this.saveState.bind(this),options.deferredStateSaveDelay);}else{this._deferredStateSave=this.saveState.bind(this);}
this._overlay=new creme.dialog.Overlay();this._pager=new creme.list.Pager().on('refresh',function(event,page){var data={};data[self.type_id()+'_page']=page;self.refresh(data);});this._table=new creme.bricks.BrickTable(this);this._menu=new creme.bricks.BrickMenu(this);},on:function(event,listener,decorator){this._events.on(event,listener,decorator);return this;},off:function(event,listener){this._events.off(event,listener);return this;},one:function(event,listener){this._events.one(event,listener);return this;},trigger:function(event,data){if(this.isBound()){this._element.trigger('brick-'+event,[this].concat(data||[]));}
this._events.trigger(event,data,this);},isBound:function(){return Object.isNone(this._element)===false;},element:function(){return this._element;},_bindStateSaveURL:function(){var url=this._stateSaveURL=$('body').attr('data-brick-state-url')||'';if(!url){console.warn('It seems there is no brick state URL in this page (see <body data-brick-state-url="..." > attribute)');}
return url;},_bindDependencies:function(element){var data=_.cleanJSON(element.attr('data-brick-deps'))||[];var deps=this._dependencies=new creme.bricks.Dependencies(data);return deps;},_bindActionLinks:function(element){var self=this;this.trigger('setup-actions',[this._actionBuilders]);var links=this._actionLinks=$('[data-action]',element).map(function(){return self._initializeActionButton($(this));});return links;},bind:function(element){if(this.isBound()){throw Error('brick component is already bound');}
this.trigger('before-bind',[element]);element.trigger('brick-before-bind',[this,element]);this._id=element.attr('id');this._element=element;this._defaultLoadingMessage=element.find('.brick-loading-indicator-title').html();this._state={collapsed:element.is('.is-collapsed'),reduced:element.is('.is-content-reduced')};this._bindStateSaveURL();this._bindDependencies(element);this._bindActionLinks(element);this._table.bind(element);this._pager.bind(element);this._overlay.bind($('.brick-content',element));this._menu.bind(element);this.trigger('bind',[element]);return this;},unbind:function(){if(this.isBound()===false){throw Error('brick component is not bound');}
var element=this._element;this.trigger('before-unbind',[element]);this._table.unbind();this._overlay.unbind().update(false);this._menu.unbind();this.closeMenu();this._element=undefined;this._state={};this._actionLinks=[];this._defaultLoadingMessage='';this._stateSaveURL='';this.trigger('unbind',[element]);element.trigger('brick-unbind',[this,element]);return this;},id:function(){return this._id;},type_id:function(){return this._element.attr('data-brick-id');},title:function(){return $('.brick-header .brick-title',this._element).attr('title');},toggleMenu:function(){this._menu.toggle();return this;},closeMenu:function(){this._menu.close();return this;},menu:function(){return this._menu;},table:function(){return this._table;},setSelectionState:function(count,total){count=Math.max(0,count||0);total=Math.max(0,total||0);if(this.isBound()){var indicator=$('.brick-selection-indicator',this._element);var title=indicator.find('.brick-selection-title');var message=title.attr('data-title-format')||'';var plural=title.attr('data-plural-format');var has_selection=count>0;if(pluralidx(count)){message=plural||message;}
indicator.toggleClass('has-selection',has_selection);title.text(has_selection&&Object.isString(message)?message.format(count,total):'');}
return this;},state:function(){return $.extend({},this._state);},setState:function(state){this._state=$.extend(this._state,state||{});this._renderState();this.trigger('state-update',[this._state]);this._deferredStateSave();return this;},toggleState:function(key){var state=this.state();state[key]=!state[key];return this.setState(state);},saveState:function(){if(this.isBound()){var state=this._state;if(!Object.isEmpty(this._stateSaveURL)){creme.ajax.query(this._stateSaveURL,{action:'post'},{brick_id:this.type_id(),is_open:state.collapsed?0:1,show_empty_fields:state.reduced?0:1}).start();}}
return this;},_renderState:function(){var element=this._element;var state=this._state;element.toggleClass('is-collapsed',state.collapsed).toggleClass('is-content-reduced',state.reduced);},_initializeActionButton:function(button){var link=new creme.bricks.BrickActionLink(this).bind(button);if(button.is('.is-async-action')){var setLoadingState=this.setLoadingState.bind(this);link.on('action-link-start',function(event,url,options,data){setLoadingState(true,options.loading);}).onComplete(function(){setLoadingState(false);});}
return link;},_getActionBuilder:function(actiontype){return this._actionBuilders.get(actiontype);},_buildAction:function(actiontype,url,options,data,event){options=options||{};data=data||{};var builder=this._getActionBuilder(actiontype);if(Object.isFunc(builder)){return builder(url,options,data,event);}},action:function(actiontype,url,options,data){var self=this;if(!this.isBound()){return new creme.component.Action(function(){this.cancel('brick is not bound',self);});}
if(this.isLoading()){return new creme.component.Action(function(){this.cancel('brick is in loading state',self);});}
var action=this._buildAction(actiontype,url,options,data);if(Object.isNone(action)){action=new creme.component.Action(function(){this.fail('no such action "'+actiontype+'"',self);});}
return action;},getActionBuilders:function(){return this._actionBuilders;},_defaultDialogOptions:function(url,title){return creme.bricks.defaultDialogOptions(url,title);},dependencies:function(){return this._dependencies;},isLoading:function(){return this.isBound()&&this._element.is('.is-loading');},readOnly:function(){return this.isBound()&&(this._element.attr('data-brick-readonly')==='true');},reloadingInfo:function(){if(!this.isBound()){return{};}
var data=this._element.attr('data-brick-reloading-info')||'';if(data){try{return JSON.parse(data);}catch(e){console.warn('Invalid "data-brick-reloading-info" attribute:',e);}}
return{};},setLoadingState:function(state,message){if(this.isBound()&&state!==this.isLoading()){message=message||this._defaultLoadingMessage;var element=this._element;element.toggleClass('is-loading',state).find('.brick-loading-indicator-title').html(message);element.trigger(state?'brick-loading-start':'brick-loading-complete');}
return this;},setDownloadStatus:function(percent){if(this.isBound()){var element=this._element;$('.brick-header',element).attr('data-loading-progress',percent);this.trigger('brick-loading-progress',[percent]);}
return this;},refresh:function(uri_extra_params,listeners){if(this.isBound()){var reloader=new creme.bricks.BricksReloader(uri_extra_params);var action=reloader.sourceBrick(this).action();action.on(listeners||{}).start();}
return this;},redirect:function(url,option,data){this._buildAction('redirect',url,option,data).start();return this;}});creme.bricks.replaceContent=function(block,content){creme.widget.destroy(block);block.replaceWith(content);creme.widget.create(content);};creme.bricks.BricksReloader=function(uri_extra_params){this._bricksContainer=null;this._url=null;this._brickFilter=null;this.uri_extra_params=uri_extra_params;};creme.bricks.BricksReloader.prototype={containerFromNode:function(node){var container;if(node===undefined){container=$('[data-bricks-reload-url]').first();}else{container=node.parents('[data-bricks-reload-url]').first();}
if(container.length===1){var url=container.attr('data-bricks-reload-url');if(url){this._bricksContainer=container;this._url=url;}else{console.warn('It seems that the brick reload URL is empty (see <body data-bricks-reload-url="..." > attribute)!');}}else{console.warn('It seems there is no brick reload URL in this page (see <body data-bricks-reload-url="..." > attribute)!');}
return this;},dependencies:function(deps){var deps_obj=new creme.bricks.Dependencies(deps);this._brickFilter=function(brick){return deps_obj.intersect(brick.dependencies());};return this;},sourceBrick:function(brick){this.containerFromNode(brick._element);var src_deps=brick.dependencies();var source_id=brick.id();if(Object.isEmpty(source_id)){console.warn('It seems there the brick to reload has no "id".');this._brickFilter=null;return this;}
if(Object.isEmpty(brick.type_id())){console.warn('It seems there the brick to reload has no "data-brick-id".');this._brickFilter=null;return this;}
if(brick.readOnly()||src_deps.isEmpty()){this._brickFilter=function(other_brick){return other_brick.id()===source_id;};}else{this._brickFilter=function(other_brick){return other_brick.id()===source_id||src_deps.intersect(other_brick.dependencies());};}
return this;},action:function(){var failAction=function(message){return new creme.component.Action(function(){this.fail(message);});};var cancelAction=function(message){return new creme.component.Action(function(){this.cancel(message);});};if(!this._bricksContainer){this.containerFromNode();}
if(this._brickFilter===null){return failAction('Missing or invalid source brick');}
var bricks=[];var extra_data={};var brickFilter=this._brickFilter;$('.brick.widget-ready',this._bricksContainer).each(function(){var brick=$(this).creme().widget().brick();if(brickFilter(brick)&&!Object.isEmpty(brick.id())&&!Object.isEmpty(brick.type_id())){bricks.push(brick);var brick_extra_data=brick.reloadingInfo();if(!Object.isEmpty(brick_extra_data)){extra_data[brick.type_id()]=brick_extra_data;}}});if(bricks.length===0){console.debug('No brick collected; so we avoid the reloading query');return cancelAction('No active brick collected. Avoid the reloading query.');}
var data=$.extend({brick_id:bricks.map(function(brick){return brick.type_id();}),extra_data:JSON.stringify(extra_data)},this.uri_extra_params||false);var queryOptions={backend:{sync:false,dataType:'json'},progress:function(evt){var percent=_.clamp(evt.loadedPercent||100,20,100);bricks.forEach(function(brick){brick.setDownloadStatus(percent);});}};return creme.ajax.query(this._url,queryOptions,data).onStart(function(){bricks.forEach(function(brick){brick.setLoadingState(true);brick.setDownloadStatus(20);});}).onComplete(function(){bricks.forEach(function(brick){brick.setLoadingState(false);brick._overlay.update(false);});}).onDone(function(event,data){data.forEach(function(entry){creme.bricks.replaceContent($('[id="brick-'+entry[0]+'"]'),$((entry[1]||'').trim()));});});}};creme.bricks.BrickLauncher=creme.widget.declare('brick',{_create:function(element,options,cb,sync,args){var brick=this._brick=new creme.bricks.Brick();brick.bind(element);element.addClass('widget-ready');brick.trigger('ready',[options]);},_destroy:function(element){this._brick.unbind(element);creme.widget.shutdown(element);},brick:function(element){return this._brick;}});}(jQuery));(function($){"use strict";creme.bricks=creme.bricks||{};creme.bricks.DialogAction=creme.dialog.DialogAction.sub({_init_:function(options,listeners){this._super_(creme.dialog.DialogAction,'_init_',options,listeners);},_buildPopup:function(options){var popup=this._super_(creme.dialog.DialogAction,'_buildPopup',options);return popup.on('frame-activated',function(){creme.bricks.dialogActionButtons(this);creme.bricks.dialogCenterPosition(this);});}});creme.bricks.FormDialogAction=creme.dialog.FormDialogAction.sub({_init_:function(options,listeners){this._super_(creme.dialog.FormDialogAction,'_init_',options,listeners);},_buildPopup:function(options){options=$.extend({redirectOnSuccess:true},this.options(),options||{});if(options.comeback){options.data=$.extend({callback_url:creme.utils.locationRelativeUrl()},options.data||{});}
var popup=this._super_(creme.dialog.FormDialogAction,'_buildPopup',options);if(options.redirectOnSuccess){popup.onFormSuccess(function(event,response){if(response.isPlainText()&&!Object.isEmpty(response.content)){creme.utils.goTo(response.content);}});}
return popup.on('frame-update',function(){creme.bricks.dialogCenterPosition(this);});}});creme.bricks.BrickActionLink=creme.action.ActionLink.sub({_init_:function(brick,options){this._super_(creme.action.ActionLink,'_init_',options);this._brick=brick;this.builders(this._brickActionBuilder.bind(this));},_brickActionBuilder:function(actiontype){var brick=this._brick;var builder=brick._getActionBuilder(actiontype);if(Object.isFunc(builder)){return function(url,options,data,e){if(!brick.isLoading()){brick.closeMenu();return builder(url,options||{},data||{},e);}};}}});creme.bricks.BrickActionBuilders=creme.action.DefaultActionBuilderRegistry.sub({_init_:function(brick){this._brick=brick;this._super_(creme.action.DefaultActionBuilderRegistry,'_init_');},_toggleStateAction:function(key,event,active_label,inactive_label){var toggle=this._brick.toggleState.bind(this._brick,key);return new creme.component.Action(function(){var state=toggle().state()[key];if(!Object.isNone(event)){var link=$(event.target).parents('[data-action]').first();link.find('.brick-action-title').text(state?inactive_label:active_label);}
this.done();});},_refreshBrickAction:function(url,options,data){var reloader=new creme.bricks.BricksReloader(data);return reloader.sourceBrick(this._brick).action();},_selectedRowValues:function(getter){var selected=this._brick.table().selections().selected();getter=getter||function(item){return item.ui.find('input').val();};return selected.map(getter);},_refreshBrick:function(){return this._brick.refresh();},_build_view:function(url,options,data){options=$.extend({title:data.title},this._brick._defaultDialogOptions(url),options||{});return new creme.bricks.DialogAction(options);},_build_collapse:function(url,options,data,event){return this._toggleStateAction('collapsed',event,data.inlabel,data.outlabel);},_build_reduce_content:function(url,options,data,event){return this._toggleStateAction('reduced',event,data.inlabel,data.outlabel);},_build_form:function(url,options,data){options=$.extend({},this._brick._defaultDialogOptions(url,data.title),options||{});return new creme.bricks.FormDialogAction(options);},_build_form_refresh:function(url,options,data){return this._build_form(url,options,data).onDone(this._refreshBrick.bind(this));},_build_add:function(url,options,data){return this._build_form_refresh(url,options,data);},_build_edit:function(url,options,data){return this._build_form_refresh(url,options,data);},_build_link:function(url,options,data){return this._build_form_refresh(url,options,data);},_build_popover:function(url,options,data,e){var link=$(e.target).closest('[data-action]');return creme.dialog.PopoverAction.fromTarget(link,options);},_build_delete:function(url,options,data){options=$.extend({confirm:true},options||{});return this._postQueryAction(url,options,data).onDone(this._refreshBrick.bind(this));},_build_update:function(url,options,data){return this._postQueryAction(url,options,data).onDone(this._refreshBrick.bind(this));},_build_refresh:function(url,options,data){return this._refreshBrickAction(url,options,data);},_build_update_redirect:function(url,options,data){return this._postQueryAction(url,options,data).onDone(function(event,data,xhr){creme.utils.goTo(data);});},_build_add_relationships:function(url,options,data){var action=new creme.relations.AddRelationToAction({subject_id:data.subject_id,rtype_id:data.rtype_id,ctype_id:data.ctype_id,addto_url:url,selector_url:data.selector_url,multiple:data.multiple,q_filter:data.q_filter,list_title:data.list_title||'',reloadOnSuccess:data.reloadOnSuccess});return action;}});}(jQuery));(function($){"use strict";var ListViewColumnFilterBuilders=creme.component.FactoryRegistry.sub({_build_select:function(element,options,list){var select2=new creme.form.Select2(element);element.on('lvsearch:destroy',function(){select2.destroy();});this._element=element.on('change',function(e){e.stopPropagation();list.submitState(creme.ajax.serializeFormAsDict($(this)));});return element;},_build_daterange:function(element,options,list){element.on('lvsearch:destroy',function(){$(this).datepicker('destroy');});$(element).find('input').each(function(){var input=$(this);input.datepicker({showOn:'button',dateFormat:input.data('format'),buttonImage:creme_media_url('images/icon_calendar.gif'),buttonImageOnly:true,onSelect:function(){if(validate(input)){list.submitState(creme.ajax.serializeFormAsDict());}}});});function validate(input){var text=input.val();var isValid=(text.length===0)||moment(text,creme.utils.jQueryToMomentDateFormat(input.data('format')),true).isValid();input.toggleClass('invalid',!isValid);return isValid;}
$(element).on('input paste keydown','input',function(e){var isValid=validate($(e.target));if(e.keyCode===list.submitOnKey()&&isValid){e.preventDefault();list.submitState();}});return element;},_build_text:function(element,options,list){$(element).on('keydown',function(e){if(e.keyCode===list.submitOnKey()){e.preventDefault();list.submitState(creme.ajax.serializeFormAsDict($(e.target)));}});return element;},_build_auto:function(element,options,list){creme.widget.create($(element),options);$(element).on('change',function(e){var input=creme.widget.input(element);list.submitState(creme.ajax.serializeFormAsDict($(input)));});return element;},_optWidgetBuilder:function(element){return this.get(element.attr('data-lv-search-widget'));},_optWidgetData:function(element){var script=$('script[type$="/json"]',element);try{if(!Object.isEmpty(script)){var data=_.readJSONScriptText(script.get(0));return Object.isEmpty(data)?{}:JSON.parse(data);}}catch(e){console.warn(e);}
return{};},create:function(element,list){var data=this._optWidgetData(element);var builder=this._optWidgetBuilder(element);if(Object.isFunc(builder)){return builder(element,data,list);}}});var ListViewActionMenu=creme.component.Component.sub({_init_:function(link,options){options=this._options=$.extend({direction:'bottom-right'},options||{});var self=this;var content=link.find('.listview-actions-container');this._listview=options.listview;this._dialog=new creme.dialog.Popover(options).fill(content);this._dialog.addClass(options.classes||'').on('opened',function(){self._updateState();});link.on('click',function(e){e.stopPropagation();self.toggle(options.anchor||e.target);});},_updateState:function(){var count=(this._listview.selectedRows()||[]).length;this._dialog.content().find('a[data-row-min], a[data-row-max]').each(function(){var min=parseInt($(this).attr('data-row-min'));var max=parseInt($(this).attr('data-row-max'));var message='';if(!isNaN(min)&&min===max&&count!==min){message=ngettext('Select %d row','Select %d rows',min).format(min);}else if(!isNaN(min)&&count<min){message=ngettext('Select at least %d row','Select at least %d rows',min).format(min);}else if(!isNaN(max)&&count>max){message=ngettext('Select no more than %d row','Select no more than %d rows',max).format(max);}
var disabled=message.length>0;var help=$(this).attr('data-helptext')||'';var title=help;if(disabled){title=help?'%s  %s'.format(help,message):message;}
$(this).toggleClass('is-disabled',disabled);$(this).attr('title',title);});},isOpened:function(){return this._dialog.isOpened();},toggle:function(anchor){this._dialog.toggle(anchor);return this;},close:function(){this._dialog.close();return this;},open:function(anchor){this._dialog.open(anchor);return this;}});var ListViewSelectionController=creme.component.Component.sub({_init_:function(listview,options){options=$.extend({selectionMode:creme.lv_widget.ListViewSelectionMode.SINGLE},options||{});this._listview=listview;this.selectionMode(options.selectionMode);},isBound:function(){return Object.isNone(this._element)===false;},bind:function(element){if(this.isBound()){throw new Error('ListViewSelectionController is already bound');}
var self=this;element.on('click','tr.selectable',function(e){var target=$(e.target);var isClickFromLink=target.is('a')||target.parents('a').first().length===1;if(!isClickFromLink){self.toggle($(this));}});element.on('click','[name="select_all"]',function(e){self.toggleAll($(this).prop('checked'));});this._element=element;return this;},store:function(){return this._element.find('.lv-state-field[name="selected_rows"]');},_updateStore:function(){var data=this.selectables().filter('.selected').find('[name="entity_id"]').map(function(){return this.value;}).get().join(',');this.store().val(data);},selectionMode:function(mode){if(mode===undefined){return this._selectionMode;}
this._selectionMode=creme.lv_widget.checkSelectionMode(mode);return this;},isMultiple:function(){return this.selectionMode()===creme.lv_widget.ListViewSelectionMode.MULTIPLE;},isSingle:function(){return this.selectionMode()===creme.lv_widget.ListViewSelectionMode.SINGLE;},isEnabled:function(){return this.selectionMode()!==creme.lv_widget.ListViewSelectionMode.NONE;},selected:function(){var value=this.store().val();return value?value.split(','):[];},count:function(){return this.selected().length;},selectables:function(){return this._element.find('tr.selectable');},_updateSelection:function(rows,state){rows.each(function(){var row=$(this);row.toggleClass('selected',state);row.find('[name="select_one"]').prop("checked",row.is('.selected'));});this._updateStore();rows.each(function(){var row=$(this);row.trigger('row-selection-changed',{selected:row.is('.selected')});});return this;},toggle:function(rows,state){if(!this.isEnabled()){return this;}
if(!this.isMultiple()){if(rows.length>1&&state!==false){throw new Error('Unable to toggle/select more than one row at once');}
this._updateSelection(this.selectables().not(rows),false);}
return this._updateSelection(rows,state);},toggleAll:function(state){if(!this.isEnabled()){return this;}
return this.toggle(this.selectables(),state);}});var ListViewController=creme.component.Component.sub({_init_:function(options){options=$.extend({selectionMode:creme.lv_widget.ListViewSelectionMode.SINGLE,reloadUrl:null,submitOnKey:$.ui.keyCode.ENTER},options||{});this._events=new creme.component.EventHandler();this._actionBuilders=new creme.lv_widget.ListViewActionBuilders(this);this._columnFilterBuilders=new ListViewColumnFilterBuilders(this);this._selections=new ListViewSelectionController(this,{selectionMode:options.selectionMode});this._element=null;this._overlay=new creme.dialog.Overlay();this._loading=false;this.selectionMode(options.selectionMode);this.reloadUrl(options.reloadUrl);this.submitOnKey(options.submitOnKey);},isBound:function(){return Object.isNone(this._element)===false;},isLoading:function(){return this._loading;},element:function(){return this._element;},selectionMode:function(value){if(value===undefined){return this._selections.selectionMode();}
this._selections.selectionMode(value);return this;},selectedRows:function(){return this.isBound()?this._selections.selected():[];},selectedRowsCount:function(){return this.isBound()?this._selections.count():0;},hasSelectedRows:function(){return this.selectedRowsCount()>0;},isSelectionEnabled:function(){return this.isBound()&&this._selections.isEnabled();},isSingleSelectionMode:function(){return this.isBound()&&this._selections.isSingle();},isMultipleSelectionMode:function(){return this.isBound()&&this._selections.isMultiple();},clearSelectedRows:function(){if(this.isBound()){this._selections.toggleAll(false);}},reloadUrl:function(value){return Object.property(this,'_reloadUrl',value);},actionBuilders:function(){return this._actionBuilders;},columnFilterBuilders:function(){return this._columnFilterBuilders;},submitOnKey:function(value){return Object.property(this,'_submitOnKey',value);},on:function(event,listener,decorator){this._events.on(event,listener,decorator);return this;},off:function(event,listener){this._events.off(event,listener);return this;},one:function(event,listener){this._events.one(event,listener);return this;},trigger:function(event,data){if(this.isBound()){this._element.trigger('listview-'+event,(data||[]).concat([this]));}
this._events.trigger(event,data,this);return this;},stateField:function(key){return this._element.find('.lv-state-field[name="'+key+'"]');},state:function(){var fields=this._element.find('.lv-state-field:not(.invalid)');var names=Array.from(arguments);if(names.length>0){fields=fields.filter(function(){return names.indexOf($(this).attr('name'))!==-1;});}
return creme.ajax.serializeFormAsDict(fields);},nextStateUrl:function(data){var link=_.toRelativeURL(this.reloadUrl());var urlData=_.omit(data||{},['search']);return link.updateSearchData(urlData).href();},toggleSort:function(column){var prevState=this.state('sort_key','sort_order');var order='ASC';if(column===prevState.sort_key[0]){order=prevState.sort_order[0]==='ASC'?'DESC':'ASC';}
return this.submitState({'sort_key':[column],'sort_order':[order]});},_updateLoadingState:function(state){if(state!==this.isLoading()){this._loading=state;this._element.toggleClass('is-loading',state);this._overlay.update(state,'',state?100:0);}},_updateLoadingProgress:function(percent){var element=this._element;$('.list-header-container',element).attr('data-loading-progress',percent);this.trigger('submit-state-progress',[percent]);},reload:function(listeners){this.submitState({},listeners);},resetSearchState:function(listeners){var state={};var searchKeys=this._element.find('.lv-search-header .lv-state-field').map(function(){return $(this).attr('name');}).get();searchKeys.forEach(function(key){state[key]=[''];});state['search']='clear';return this.submitState(state,listeners);},submitState:function(data,listeners){var self=this;var reloadUrl=this.reloadUrl();var state=$.extend(this.state(),data||{});var nextStateUrl=this.nextStateUrl(state);var element=this._element;if(this.isLoading()){return new creme.component.Action(function(){this.cancel();}).on(listeners||{}).start();}
var queryData=$.extend({},state,{content:1});var queryOptions={action:'POST',progress:function(evt){var percent=_.clamp(evt.loadedPercent||100,20,100);self._updateLoadingProgress(percent);}};creme.ajax.query(reloadUrl,queryOptions,queryData).onStart(function(){self._updateLoadingState(true);self.clearSelectedRows();self.trigger('submit-state-start',[nextStateUrl]);}).onComplete(function(event,data){self._updateLoadingState(false);self.trigger('submit-state-complete',[nextStateUrl,data]);}).onDone(function(event,data){var content=$(data.trim());creme.widget.destroy(element);element.replaceWith(content);creme.widget.create(content);self.trigger('submit-state-done',[nextStateUrl,data]);}).on(listeners||{}).start();return this;},unbind:function(){if(!this.isBound()){throw new Error('Listview component is not bound');}
var element=this._element;this._unbindColumnFilters(element);this._overlay.unbind(element);this._element=null;return this;},bind:function(element){if(this.isBound()){throw new Error('Listview component is already bound');}
this._element=element;this._selections.bind(element);this._overlay.addClass('lv-loading').content($('<h2><img src="${src}"><span>${label}</span></h2>'.template({src:creme_media_url('images/wait.gif'),label:gettext('Loading')}))).bind(element);this._bindActions(element);this._bindColumnSort(element);this._bindColumnFilters(element);this.trigger('bind-complete');return this;},_bindColumnSort:function(element){var self=this;element.on('click','.lv-columns-header .lv-column.sortable button:not(:disabled)',function(e){e.preventDefault();e.stopPropagation();var column=$(this).parent('.lv-column').first();self.toggleSort(column.attr('data-column-key'));});},_bindColumnFilters:function(element){var self=this;this.trigger('setup-column-filters',[this._columnFilterBuilders]);element.find('.lv-column [data-lv-search-widget]').each(function(){self._columnFilterBuilders.create($(this),self);});},_unbindColumnFilters:function(element){element.find('.lv-column [data-lv-search-widget]').trigger('lvsearch:destroy');},_bindActions:function(element){var self=this;this.trigger('setup-actions',[this._actionBuilders]);element.find('a[data-action]').each(function(){var link=new creme.lv_widget.ListViewActionLink(self);link.bind($(this));});element.find('.row-actions-trigger').map(function(){return new ListViewActionMenu($(this),{classes:'row-actions-popover listview-actions-popover',listview:self});});element.find('.header-actions-trigger').map(function(){return new ListViewActionMenu($(this),{classes:'header-actions-popover listview-actions-popover',anchor:$(this).find('span'),listview:self});});this.trigger('bind-actions-complete',[this._actionBuilders]);}});creme.utils.newJQueryPlugin({name:'list_view',create:function(options){return new ListViewController(options).bind($(this));},destroy:function(controller){controller.unbind();},methods:['selectedRowsCount','selectedRows','hasSelectedRows','state','submitState','reload','actionBuilders','columnFilterBuilders'],properties:['selectionMode','reloadUrl','submitOnKey','isLoading']});})(jQuery);(function($){"use strict";creme.lv_widget={};creme.lv_widget.ListViewSelectionMode={NONE:'none',MULTIPLE:'multiple',SINGLE:'single'};creme.lv_widget.checkSelectionMode=function(mode){if(Object.values(creme.lv_widget.ListViewSelectionMode).indexOf(mode)===-1){throw Error('invalid listview selection mode '+mode);}else{return mode;}};creme.lv_widget.ExportAction=creme.component.Action.sub({_init_:function(list,options){this._super_(creme.component.Action,'_init_',this._run,options);this._list=list;},_run:function(options){options=$.extend({},this.options(),options||{});var self=this;var formats=options.formats||[['','No backend found']];creme.dialogs.choice(gettext("Select the export format"),{title:gettext("Export"),choices:formats.map(function(item){return{value:item[0],label:item[1]};}),required:true}).onOk(function(event,data){creme.utils.goTo(options.url,{type:data});self.done();}).onClose(function(){self.cancel();}).open();}});creme.lv_widget.DeleteSelectedAction=creme.component.Action.sub({_init_:function(list,options){this._super_(creme.component.Action,'_init_',this._run,options);this._list=list;},_onDeleteFail:function(event,error,data){var self=this;var list=this._list;var message=Object.isType(error,'string')?error:(error.message||gettext("Error"));var header=creme.ajax.localizedErrorMessage(data);if(!Object.isEmpty(message)&&_.isJSON(message)){var results=JSON.parse(message);var removed_count=results.count-results.errors.length;header='';if(removed_count>0){header=ngettext('%d entity has been deleted.','%d entities have been deleted.',removed_count).format(removed_count);}
if(results.errors){header+=ngettext(' %d entity cannot be deleted.',' %d entities cannot be deleted.',results.errors.length).format(results.errors.length);}
message='<ul>'+results.errors.map(function(item){return'<li>'+item+'</li>';}).join('')+'</ul>';}
creme.dialogs.warning(message,{header:header}).onClose(function(){list.reload();self.fail();}).open();},_run:function(options){options=$.extend({},this.options(),options||{});var self=this;var list=this._list;var selection=list.selectedRows();if(selection.length<1){creme.dialogs.warning(gettext("Please select at least one entity.")).onClose(function(){self.cancel();}).open();}else{var query=creme.utils.ajaxQuery(options.url,{action:'POST',confirm:true,warnOnFail:false,dataType:'json'},{ids:selection.join(',')});query.onFail(this._onDeleteFail.bind(this)).onCancel(function(event,data){self.cancel();}).onDone(function(event,data){list.reload();self.done();}).start();}}});creme.lv_widget.AddToSelectedAction=creme.component.Action.sub({_init_:function(list,options){this._super_(creme.component.Action,'_init_',this._run,options);this._list=list;},_run:function(options){options=$.extend({},this.options(),options||{});var self=this;var list=this._list;var selection=list.selectedRows();if(selection.length<1){creme.dialogs.warning(gettext("Please select at least one entity.")).onClose(function(){self.cancel();}).open();}else{var dialog=creme.dialogs.form(options.url,{submitData:{ids:selection}},{ids:selection});dialog.onFormSuccess(function(event,data){list.reload();self.done();}).onClose(function(){self.cancel();}).open({width:800});}}});creme.lv_widget.EditSelectedAction=creme.component.Action.sub({_init_:function(list,options){this._super_(creme.component.Action,'_init_',this._run,options);this._list=list;this._isEditionDone=false;},_run:function(options){options=$.extend({},this.options(),options||{});var self=this;var list=this._list;var isEditionDone=false;var selection=list.selectedRows();if(selection.length<1){creme.dialogs.warning(gettext("Please select at least one entity.")).onClose(function(){self.cancel();}).open();}else{var dialog=new creme.dialog.FormDialog({url:options.url,data:{entities:selection.join('.')},submitData:{entities:selection},closeOnFormSuccess:false});dialog.onFormSuccess(function(event,data){isEditionDone=true;}).onClose(function(){if(isEditionDone){list.reload();self.done();}else{self.cancel();}}).on('frame-update',function(event,frame){frame.delegate().on('change','[name="_bulk_fieldname"]',function(){var next=$(this).val();if(!Object.isNone(next)&&next!==dialog.frame().lastFetchUrl()){dialog.fetch(next);}});});dialog.open({width:800});}}});creme.lv_widget.MergeSelectedAction=creme.component.Action.sub({_init_:function(list,options){this._super_(creme.component.Action,'_init_',this._run,options);this._list=list;},_run:function(options){options=$.extend({},this.options(),options||{});var self=this;var list=this._list;var selection=list.selectedRows();if(selection.length!==2){creme.dialogs.warning(gettext("Please select 2 entities.")).onClose(function(){self.cancel();}).open();}else{try{creme.utils.goTo(options.url,{id1:selection[0],id2:selection[1]});}catch(e){this.fail(e);}}}});creme.lv_widget.ListViewDialog=creme.dialog.Dialog.sub({_init_:function(options){options=$.extend({title:'',useListTitle:true,selectionMode:'single',selectionValidator:this._defaultValidator,width:'80%'},options||{});this._super_(creme.dialog.Dialog,'_init_',options);this.selectionValidator(options.selectionValidator);this.selectionMode(options.selectionMode);this._bindListView();},_bindListView:function(){var self=this;this.on('frame-update',function(){self.content().on('listview-bind-complete','.ui-creme-listview',function(){self._updateDialogTitle();});});},_onFrameFail:function(event,data,error){var buttons={};this._appendButton(buttons,'close',gettext('Close'),function(button,e,options){this.close();});this.replaceButtons(buttons);this._super_(creme.dialog.Dialog,'_onFrameFail',event,data,error);},_updateDialogTitle:function(){var container=this.content().find('.list-title');container.toggleClass('hidden',this.options.useListTitle);if(this.options.useListTitle){var title=this.options.title;var subtitle=container.find('.list-sub-title').text();var stats=container.find('.list-title-stats').text();if(Object.isEmpty(title)){title=container.find('.list-main-title').text();}
this.title("${title}${subtitle} ${stats}".template({title:title,subtitle:Object.isEmpty(subtitle)?'':['  ',subtitle].join(''),stats:stats}));}},selectionMode:function(mode){if(mode===undefined){return this._selectionMode;}
this._selectionMode=creme.lv_widget.checkSelectionMode(mode);var controller=this.controller();if(Object.isNone(controller)===false){controller.submitState({selection:mode});}
return this;},isSelectable:function(){return this.selectionMode()!==creme.lv_widget.ListViewSelectionMode.NONE;},isMultiple:function(){return this.selectionMode()===creme.lv_widget.ListViewSelectionMode.MULTIPLE;},isSingle:function(){return this.selectionMode()===creme.lv_widget.ListViewSelectionMode.SINGLE;},_frameFetchData:function(options,data){var fetchData=this._super_(creme.dialog.Dialog,'_frameFetchData',options,data);return $.extend({},fetchData,{selection:this.selectionMode()});},_defaultValidator:function(rows){if(!this.isSelectable()){return true;}
if(Object.isEmpty(rows)){creme.dialogs.warning(gettext('Please select at least one entity.'),{'title':gettext("Error")}).open();return false;}
if(!this.isMultiple()&&rows.length>1){creme.dialogs.warning(gettext('Please select only one entity.'),{'title':gettext("Error")}).open();return false;}
return true;},selectionValidator:function(validator){return Object.property(this,'_validator',validator);},controller:function(){return this.content().find('.ui-creme-listview').list_view('instance');},selected:function(){var controller=this.controller();return Object.isNone(controller)?[]:controller.selectedRows();},validate:function(){var validator=this._validator;var selected=this.selected();if(Object.isFunc(validator)&&validator.apply(this,[selected])===false){return this;}
this._destroyDialog();this._events.trigger('validate',[selected],this);return this;},_defaultButtons:function(buttons,options){if(this.isSelectable()){this._appendButton(buttons,'validate',gettext('Validate the selection'),function(button,e,options){this.validate();});this._appendButton(buttons,'close',gettext('Cancel'),function(button,e,options){this.close();});}else{this._appendButton(buttons,'close',gettext('Close'),function(button,e,options){this.close();});}
return buttons;},onValidate:function(cb){this._events.on('validate',cb);return this;}});creme.lv_widget.ListViewDialogAction=creme.component.Action.sub({_init_:function(options,listeners){this._super_(creme.component.Action,'_init_',this._openPopup,options);this._listeners=listeners||{};},_onValidate:function(event,selected){this.done(selected);},_buildPopup:function(options){var self=this;options=$.extend(this.options(),options||{});var dialog=new creme.lv_widget.ListViewDialog(options).onValidate(this._onValidate.bind(this)).onClose(function(){self.cancel();}).on(this._listeners);return dialog;},_openPopup:function(options){this._buildPopup(options).open();}});creme.lv_widget.ListViewActionLink=creme.action.ActionLink.sub({_init_:function(list,options){this._super_(creme.action.ActionLink,'_init_',options);this._list=list;this.on('action-link-start',function(event,url,options,data,e){$(e.target).parents('.popover').first().trigger('modal-close');});this.builders(list.actionBuilders());}});creme.lv_widget.ListViewActionBuilders=creme.action.DefaultActionBuilderRegistry.sub({_init_:function(list){this._list=list;this._super_(creme.action.DefaultActionBuilderRegistry,'_init_');},_defaultDialogOptions:function(url,title){var width=$(window).innerWidth();return{resizable:true,draggable:true,width:width*0.8,maxWidth:width,url:url,title:title};},_build_popover:function(url,options,data,e){var link=$(e.target).closest('[data-action]');return creme.dialog.PopoverAction.fromTarget(link,options);},_build_update:function(url,options,data,e){var list=this._list;return this._postQueryAction(url,options,data).onDone(function(){list.reload();});},_build_delete:function(url,options,data,e){return this._build_update(url,$.extend({},options,{confirm:gettext('Are you sure?')}),data,e);},_build_form:function(url,options,data,e){var list=this._list;options=$.extend(this._defaultDialogOptions(url),options||{});return new creme.dialog.FormDialogAction(options,{'form-success':function(){list.reload();}});},_build_clone:function(url,options,data,e){options=$.extend({confirm:gettext('Do you really want to clone this entity?')},options||{});var action=this._postQueryAction(url,options,data);action.onDone(function(event,data,xhr){creme.utils.goTo(data);});return action;},_build_edit_selection:function(url,options,data,e){return new creme.lv_widget.EditSelectedAction(this._list,{url:url});},_build_delete_selection:function(url,options,data,e){return new creme.lv_widget.DeleteSelectedAction(this._list,{url:url});},_build_addto_selection:function(url,options,data,e){return new creme.lv_widget.AddToSelectedAction(this._list,{url:url});},_build_merge_selection:function(url,options,data,e){return new creme.lv_widget.MergeSelectedAction(this._list,{url:url});},_build_submit_lv_state:function(url,options,data,e){var listview=this._list;return new creme.component.Action(function(){listview.submitState(data,{done:function(){this.done();},fail:function(){this.fail();},cancel:function(){this.cancel();}});});},_build_reset_lv_search:function(url,options,data,e){var listview=this._list;return new creme.component.Action(function(){listview.resetSearchState({done:function(){this.done();},fail:function(){this.fail();},cancel:function(){this.cancel();}});});},_build_export_as:function(url,options,data,e){return new creme.lv_widget.ExportAction(this._list,Object.assign({url:url},options));},_build_redirect:function(url,options,data){return this._redirectAction(url,options,data);}});creme.lv_widget.ListViewHeader=creme.component.Component.sub({_init_:function(options){options=$.extend({standalone:false,headTop:0},options||{});this._isStandalone=options.standalone;this._headTop=options.headTop;this._rowListeners={mouseenter:this._onEnterSelectableRow.bind(this),mouseleave:this._onLeaveSelectableRow.bind(this),selection:this._onRowSelectionChange.bind(this)};this._floatListeners={floatHead:this._onHeadFloatEnabled.bind(this)};this._documentListeners={scroll:this._onDocumentScroll.bind(this)};},isBound:function(){return this._list!==undefined;},_onEnterSelectableRow:function(e){this._list.addClass('first-row-hovered');if(this._isStandalone){$('.listview.floatThead-table').addClass('first-row-hovered');}},_onLeaveSelectableRow:function(e){this._list.removeClass('first-row-hovered');if(this._isStandalone){$('.listview.floatThead-table').removeClass('first-row-hovered');}},_onRowSelectionChange:function(e,data){this._list.toggleClass('first-row-selected',data.selected);if(this._isStandalone){$('.listview.floatThead-table').toggleClass('first-row-selected',data.selected);}},_onHeadFloatEnabled:function(e,isFloated,container){if(isFloated){container.addClass('floated');this._list.addClass('floated');$('.header-actions-popover').trigger('modal-close');}else{container.removeClass('floated');this._list.removeClass('floated');}},_onDocumentScroll:function(e){this.updateAnchorPosition();},bind:function(list){if(this.isBound()){throw new Error('ListViewHeader is already bound');}
var isStandalone=this._isStandalone;var headTop=this._headTop;this._list=list;this._list.on('mouseenter','tr.selectable:first-child',this._rowListeners.mouseenter);this._list.on('mouseleave','tr.selectable:first-child',this._rowListeners.mouseleave);this._list.on('row-selection-changed','tbody tr:first-child',this._rowListeners.selection);if(isStandalone){list.floatThead({top:headTop,zIndex:97,scrollContainer:function(table){return table.closest('.sub_content');}});var floatContainer=$('.floatThead-container');var isFloating=$(document).scrollTop()>list.offset().top;if(isFloating){floatContainer.addClass('floated');list.addClass('floated');}
list.on('floatThead',this._floatListeners.floatHead);var anchor=this._floatAnchor=$('<div class="floated-header-anchor">');anchor.insertAfter(floatContainer).css({'position':'fixed'});this.updateAnchorPosition();$(document).on('scroll',this._documentListeners.scroll);}
return this;},unbind:function(){if(this.isBound()===false){throw new Error('ListViewHeader is not bound');}
this._list.off('mouseenter','tr.selectable:first-child',this._rowListeners.mouseenter);this._list.off('mouseleave','tr.selectable:first-child',this._rowListeners.mouseleave);this._list.off('row-selection-changed','tbody tr:first-child',this._rowListeners.selection);if(this._isStandalone){this._floatAnchor.detach();this._list.off('floatThead',this._floatListeners.floatHead);$(document).on('scroll',this._documentListeners.scroll);}
this._floatAnchor=undefined;this._list=undefined;return this;},updateAnchorPosition:function(){if(this._isStandalone){var scrollLeft=$(document).scrollLeft();var viewportWidth=$(window).width();var listAnchorStickingStart=this._list.offset().left;var listAnchorStickingEnd=listAnchorStickingStart+this._list.width();var overShooting=scrollLeft+viewportWidth>=listAnchorStickingEnd;var overshoot=Math.abs(Math.ceil(listAnchorStickingEnd-viewportWidth-scrollLeft));var floatContainer=$('.floatThead-container');var headerHeight=$(floatContainer.children().get(0)).height();var anchorHeight=this._floatAnchor.height();this._floatAnchor.css({'left':Math.max(0,listAnchorStickingStart-scrollLeft),'right':overShooting?overshoot:0,'top':this._headTop+headerHeight-anchorHeight});}}});creme.lv_widget.ListViewLauncher=creme.widget.declare('ui-creme-listview',{options:{'selection-mode':'single','reload-url':''},_destroy:function(element){$(document).off('scroll',this._scrollListener);element.list_view('destroy');element.removeClass('widget-ready');},_create:function(element,options,cb,sync,args){var selectionMode=options.selectionMode||element.attr('selection-mode');var list=this._list=element.find('.listview');this._isStandalone=list.hasClass('listview-standalone');this._pager=new creme.list.Pager();this._header=new creme.lv_widget.ListViewHeader({standalone:this._isStandalone,headTop:$('.header-menu').height()});this._rowCount=parseInt(list.attr('data-total-count'));this._rowCount=isNaN(this._rowCount)?0:this._rowCount;this._scrollListener=this._onDocumentScroll.bind(this);if(this._isStandalone){element.addClass('ui-creme-listview-standalone');$(document).on('scroll',this._scrollListener);this._handleHorizontalStickiness();}else{element.addClass('ui-creme-listview-popup');}
var controller=this._initController(element,{selectionMode:selectionMode,reloadurl:options['reload-url']});if(this._rowCount>0){if(!this._isStandalone){var popup=element.parents('.ui-dialog').first();list.find('.list-footer-container').css('max-width',popup.width());}else{this._handleHorizontalStickiness();}
this._header.bind(list);this._pager.on('refresh',function(event,page){controller.submitState({page:page});}).bind(list.find('.listview-pagination'));}
element.on('change','.list-control-group.list-views select',function(){controller.submitState({hfilter:$(this).val()});});element.on('change','.list-control-group.list-filters select',function(){controller.submitState({filter:$(this).val()});});list.on('change','select.list-pagesize-selector',function(){controller.submitState({rows:$(this).val()});});},_initController:function(element,options){var listview=this.controller(element);if(!listview){var inPopup=element.parents('.ui-dialog-content').first().length>0;var reloadUrl=options.reloadurl||window.location.href;listview=element.list_view({selectionMode:options.selectionMode,reloadUrl:reloadUrl});if(inPopup===false){listview.on('submit-state-complete',function(event,url,data){creme.history.push(url);});}}
return listview;},_onDocumentScroll:function(e){this._handleHorizontalStickiness();this._handleActionPopoverConstraints();},_handleHorizontalStickiness:function(){var scrollLeft=$(document).scrollLeft();$('.sticky-container-standalone .sticks-horizontally, .listview-standalone .sticks-horizontally, .footer, .page-decoration').css('transform','translateX('+scrollLeft+'px)');},_handleActionPopoverConstraints:function(){$('.listview-actions-popover').each(function(){var popover=$(this);var offset=popover.offset();var floatContainer=$('.floatThead-container');var floatingOffset=floatContainer.offset();if(offset.top<floatingOffset.top+floatContainer.innerHeight()+5){var isRowPopover=popover.hasClass('row-actions-popover');var isHeaderPopover=popover.hasClass('header-actions-popover');var containerIsFloating=floatContainer.hasClass('floated');var popoverNeedsClosing=isRowPopover||(isHeaderPopover&&containerIsFloating);if(popoverNeedsClosing){popover.trigger('modal-close');}}});},isStandalone:function(element){return this._isStandalone;},count:function(element){return this._rowCount;},header:function(element){return this._header;},pager:function(element){return this._pager;},controller:function(element){return element.list_view('instance');}});}(jQuery));(function($){"use strict";var detailViewActions={'creme_core-detailview-merge':function(url,options,data){var action=new creme.lv_widget.ListViewDialogAction({url:data.selection_url,selectionMode:'single',data:{id1:data.id}});action.onDone(function(event,selections){creme.utils.goTo(url,{id1:data.id,id2:selections[0]});});return action;},'creme_core-detailview-clone':function(url,options,data){return this._build_update_redirect(url,options,data);},'creme_core-detailview-delete':function(url,options,data){return this._build_update_redirect(url,options,data);},'creme_core-detailview-restore':function(url,options,data){return this._build_update_redirect(url,options,data);}};$(document).on('brick-setup-actions','.brick.brick-hat',function(e,brick,actions){actions.registerAll(detailViewActions);});creme.views=creme.views||{};var menuBarActions={'creme_core-hatmenubar-view':function(url,options,data){options=$.extend(creme.bricks.defaultDialogOptions(url,data.title),options||{});return new creme.bricks.DialogAction(options);},'creme_core-hatmenubar-form':function(url,options,data){options=$.extend(creme.bricks.defaultDialogOptions(url,data.title),options||{});return new creme.bricks.FormDialogAction(options);},'creme_core-hatmenubar-update':function(url,options,data){return this._postQueryAction(url,options,data);},'creme_core-hatmenubar-update-redirect':function(url,options,data){return this._postQueryAction(url,options).onDone(function(){creme.utils.goTo(data.redirect);});}};creme.views.HatMenuBar=creme.widget.declare('ui-creme-hatmenubar',{_create:function(element,options,cb,sync,args){var builder=this._builder=new creme.action.DefaultActionBuilderRegistry();var buttons=$('[data-action]',element);builder.registerAll(menuBarActions);$(element).trigger('hatmenubar-setup-actions',[builder]);this._actionlinks=buttons.map(function(){return new creme.action.ActionLink().builders(builder).bind($(this));}).get();element.addClass('widget-ready');creme.object.invoke(cb,element);},_destroy:function(element){this._actionlinks.forEach(function(link){link.unbind();});}});}(jQuery));(function($){"use strict";creme.entity_cell=creme.entity_cell||{};creme.entity_cell.EntityCellsWidget=creme.component.Component.sub({_init_:function(options){options=$.extend({samples:[]},options||{});this.column_titles={};this.columns=[];this.underlays={};this.samples=Array.from(options.samples);},isBound:function(){return Object.isNone(this.div)===false;},bind:function(element){if(this.isBound()){throw new Error('EntityCellsWidget is already bound');}
this.div=$(element);this.store=this.div.find('input.inner_value');this._initSelectorCheck();this._initSelectorFilters();this._initSelectorUnderlays();this._initPreviewTable();return this;},updateStore:function(){this.store.attr('value',this.columns);},updatePreview:function(){var div=this.div;var length=this.columns.length;var preview_title;if(length===0){preview_title=gettext('Preview');}else if(length===1){preview_title=gettext('Preview of the column');}else{preview_title=gettext('Preview and order of the %s columns').format(length);}
div.find('.preview_title').text(preview_title);div.find('.help_instructions').text(length>0?gettext('Drag and drop the columns to order them.'):gettext('The preview is empty. Select some fields and relationships to add some columns.'));},findUnderlayInfo:function(column){var underlay_info;var sep_index=column.indexOf('__');if(sep_index!==-1){var selector;var fk_fieldname=column.slice(0,sep_index);var underlay=this.underlays[fk_fieldname];if(!underlay){selector=this.div.find('.selector_list .selector[data-column='+fk_fieldname+']');underlay=selector.find('.underlay-container');}else{selector=underlay.data('underlay_selector');}
if(underlay.length!==0){underlay_info={'selector':selector,'content':underlay.find('.underlay-content')};}}
return underlay_info;},onColumnChanged:function(checkbox){var self=this;var div=this.div;var columns=this.columns;var column=checkbox.parentNode.getAttribute('data-column');if(checkbox.checked){var column_titles=this.column_titles;columns.push(column);this.header_labels.append($('<th>').attr('data-column',column).append($('<input type="checkbox" checked class="preview_column_toggle" />').on('change',function(event){var underlay_info=self.findUnderlayInfo(column);var selectors=underlay_info?underlay_info.content.find('.underlay_selector_list'):div.find('.selector_list');selectors.find('.selector[data-column='+column+'] input[type=checkbox]:checked').prop('checked',false).trigger('change');}).attr('title',gettext("Remove the column '%s'").format(column_titles[column]))).append($('<span>').addClass('dragtable-drag-handle').text(column_titles[column])));var lists=div.find('.preview_table .preview_row');var samples=this.samples;for(var i=0;i<samples.length;++i){var text=samples[i][column];if(text===''){text='';}else if(text===undefined){text='[]';}
$('<td>').attr('data-column',column).html(text).appendTo(lists[i]);}}else{div.find('.preview_table [data-column='+column+']').remove();var index=columns.indexOf(column);columns.splice(index,1);}
this.updatePreview();var underlay_info=this.findUnderlayInfo(column);if(underlay_info){var checkboxes=underlay_info.content.find('input[type=checkbox]');var selected_checkboxes=checkboxes.filter(':checked');underlay_info.selector.find('.selected_count').remove();if(selected_checkboxes.length){$('<span>').addClass('selected_count').text(' ('+selected_checkboxes.length+' / '+checkboxes.length+')').appendTo(underlay_info.selector);}}
this.updateStore();},onDragChange:function(e){this.columns=$.map(this.div.find('.preview_table_header th'),function(e,i){return $(e).attr('data-column');});this.updateStore();},findLastItemOfLine:function(selector){var selectorY=selector.position().top;var firstItemOfNextLine=false;selector.nextAll('.selector').each(function(i,e){if(firstItemOfNextLine){return;}
var elem=$(e);if(elem.position().top!==selectorY){firstItemOfNextLine=elem;}});if(firstItemOfNextLine){return firstItemOfNextLine.prevAll('.selector').first();}else{return selector.parent('.selector_list').find('> .selector').last();}},placeUnderlay:function(underlay,lastItemOfLine){underlay.insertAfter(lastItemOfLine);if(!underlay.__underlay_height){underlay.__underlay_height=underlay.height();}
underlay.css('max-height',underlay.__underlay_height);},_initSelectorCheck:function(){var self=this;var div=this.div;var column_titles=this.column_titles;this.header_labels=div.find('.preview_table_header .sortable_header');div.find('.selector_list .selector[data-column]').each(function(i,e){var el=$(e);var links=el.find('.sub_selector_toggle');var textSource=links.length?links:el;var text=textSource.text();if(el.parent().is('.underlay_selector_list')){text=column_titles[el.parents('.selector').attr('data-column')]+'  '+text;}
column_titles[el.attr('data-column')]=text.trim();var input=el.find('> input[type=checkbox]');el.find('> label').on('click',function(e){e.preventDefault();e.stopPropagation();input.prop('checked',!input.prop('checked')).trigger('change');});});div.find('.selector_list input[type=checkbox]').on('change',function(event){self.onColumnChanged(event.target);});var value=this.store.attr('value');if(value){var to_check=value.split(',');this.store.attr('value','');to_check.forEach(function(column){var checkbox=div.find('.selector_list [data-column="'+column+'"] > input[type=checkbox]');$(checkbox).prop('checked',true).trigger('change');});}else{this.updatePreview();}},_initPreviewTable:function(){var div=this.div;var underlays=this.underlays;div.find('.remove_all_columns').on('click',function(e){e.preventDefault();div.find('.selector input[type=checkbox]:checked').prop('checked',false).trigger('change');for(var column in underlays){underlays[column].find('.selector input[type=checkbox]:checked').prop('checked',false).trigger('change');}});var self=this;var parent=this.div.parents('.ui-dialog-content').first();if(parent.length===0){parent=$(document.body);}
div.find('.preview_table').dragtable({dataHeader:'data-column',appendTarget:parent,change:function(event){self.onDragChange(event);}});},_initSelectorFilters:function(){var div=this.div;div.find('.field_selector_filter').each(function(){var elem=$(this);elem.data('oldVal',elem.val());var type=elem.attr('data-type');elem.on('propertychange keyup input paste',function(){var val=elem.val();if(elem.data('oldVal')===val){return;}
elem.data('oldVal',val);var term=val.removeDiacritics().toLowerCase();if(type==='relationships'){if(term===''){div.find('.relationship_selectors .selector_list .selector').css('display','inline-block');div.find('.relationship_selectors .filter_result').text('');}else{var total_count=0;var matches_count=0;div.find('.relationship_selectors .selector_list .selector').each(function(i,element){var item=$(element);var text=item.text().removeDiacritics().toLowerCase();if(text.indexOf(term)===-1){item.css('display','none');}else{item.css('display','inline-block');matches_count+=1;}
total_count+=1;});div.find('.relationship_selectors .filter_result').text(gettext('%s result(s) on %s').format(matches_count,total_count));}}else{div.find('.field_selectors .selector_list .selector').each(function(i,element){var item=$(element);var text=item.text().removeDiacritics().toLowerCase();item.css('opacity',text.indexOf(term)===-1?0.4:1);});}});});},_toggleSelectorUnderlay:function(target){var self=this;var underlays=this.underlays;var selector=target.parent('.selector');var column=selector.attr('data-column');var underlay=underlays[column];if(!underlay){underlays[column]=underlay=$('<div>').attr('data-column',column).addClass('underlay').data('underlay_selector',selector).append(selector.find('.underlay-container'));}
var lastItemOfLine=this.findLastItemOfLine(selector);var container=selector.parents('.selector_list').find('.underlay');if(container.length===0){this.placeUnderlay(underlay,lastItemOfLine);underlay.children().css('opacity',1);underlay.find('.underlay-content').css('opacity',0);underlay.css('max-height',0).css('opacity',1);var targetHeight=underlay.__underlay_height;underlay.find('.underlay-content').animate({opacity:1},400);underlay.children().delay(100).animate({opacity:1},400);underlay.animate({'max-height':targetHeight},300,function(){});}else if(container.attr('data-column')===column){container.find('.underlay-content').animate({opacity:0},150);container.children().delay(130).animate({opacity:0},150);container.animate({'max-height':0},300,function(e){container.detach();});}else{container.animate({opacity:0},100,function(e){container.detach();underlay.css('opacity',0);self.placeUnderlay(underlay,lastItemOfLine);underlay.animate({opacity:1},150);underlay.find('.underlay-content').animate({opacity:1},150);underlay.children().animate({opacity:1},150);});}
var arrow=underlay.find('.arrow');var arrowWidth=17;var toggleOffset=target.offset().left-target.parents('.field_selectors').offset().left;var arrowOffset=toggleOffset+(target.width()-arrowWidth)/2;arrow.css('left',arrowOffset+'px');},_initSelectorUnderlays:function(){var self=this;var div=this.div;$(document).on('click','.underlay .selector_close',function(e){e.preventDefault();var column=$(this).parents('.underlay').first().attr('data-column');var target=div.find('.selector[data-column="'+column+'"] .sub_selector_toggle');self._toggleSelectorUnderlay(target);});div.find('.sub_selector_toggle').on('click',function(e){e.preventDefault();self._toggleSelectorUnderlay($(this));});}});}(jQuery));(function($){"use strict";function getFieldValue(input){if(input.is('input[type="checkbox"]')){return input.prop('checked');}else if(input.is('input, select, textarea')){return input.val();}else if(input.is('.ui-creme-widget')){return input.creme().widget().val();}};function setFieldValue(input,value){if(input.is('input[type="checkbox"]')){input.prop('checked',value);}else if(input.is('input, select, textarea')){input.val(value).trigger('change');}else if(input.is('.ui-creme-widget')){input.creme().widget().val(value);}};creme.initializeMergeForm=function(element){function createButton(options){return $(('<li class="merge-field-button">'+'<button type="button" data-from="${from}" data-to="${to}">'+'<div class="merge-${direction}-arrow"></div>'+'</button>'+'</li>').template(options));}
element.on('click','.merge-field-button button',function(e){e.preventDefault();var source=element.find('#'+$(this).data('from'));var target=element.find('#'+$(this).data('to'));setFieldValue(target,getFieldValue(source));});element.find('.merge-field[id]').each(function(){var resultField=$(this).find('.merge-field-result');var id=$(this).attr('id');resultField.before(createButton({direction:'right',from:id+'_1',to:id+'_merged'}));resultField.after(createButton({direction:'left',from:id+'_2',to:id+'_merged'}));});};creme.merge=creme.merge||{};creme.merge.initializeMergeForm=creme.initializeMergeForm;}(jQuery));(function($){"use strict";creme.relations=creme.relations||{};creme.relations.AddRelationToAction=creme.component.Action.sub({_init_:function(options){options=$.extend({multiple:false},options||{});if(Object.isEmpty(options.addto_url)){options.addto_url=$('body').attr('data-save-relations-url');}
if(Object.isEmpty(options.selector_url)){options.selector_url=$('body').attr('data-select-relations-objects-url');}
this._super_(creme.component.Action,'_init_',this._addRelationTo,options);},_updateQuery:function(selection,options){var self=this;var query=creme.ajax.query(options.addto_url||'');if(options.reloadOnSuccess){query.onDone(function(){creme.utils.reload();self.done();}).onCancel(function(){self.cancel();}).onFail(function(e,data){self.fail(data);});}else{var deps=new creme.bricks.BricksReloader().dependencies(['creme_core.relation','creme_core.relation.'+options.rtype_id]).action();deps.after(query).on('cancel done',function(){self.done();}).onFail(function(){self.fail();});}
return query;},_addRelationTo:function(options){options=$.extend(this.options(),options||{});var self=this;if(Object.isEmpty(options.addto_url)||Object.isEmpty(options.selector_url)){console.log('missing urls in options of AddRelationTo action',options);this.fail();return;}
var lv_data={subject_id:options.subject_id,rtype_id:options.rtype_id,objects_ct_id:options.ctype_id};if(options.q_filter){lv_data['q_filter']=options.q_filter;}
var selector=new creme.lv_widget.ListViewDialog({url:options.selector_url||'',selectionMode:options.multiple?'multiple':'single',data:lv_data,title:options.list_title});selector.onValidate(function(event,selection){self._updateQuery(selection,options).post({entities:selection,subject_id:options.subject_id,predicate_id:options.rtype_id});}).onClose(function(){self.cancel();}).open();}});}(jQuery));(function($){"use strict";creme.jobs={};var __JOB_STATUS={WAIT:1,ERROR:10,OK:20};creme.jobs.BaseJobsMonitor=creme.component.Component.sub({_init_:function(options){options=$.extend({fetchDelay:5000},options||{});this._url=options.url;this._fetchDelay=options.fetchDelay;this._events=new creme.component.EventHandler();},on:function(event,listener,decorator){this._events.on(event,listener,decorator);return this;},off:function(event,listener){this._events.off(event,listener);return this;},one:function(event,listener){this._events.one(event,listener);return this;},trigger:function(event,data){this._events.trigger(event,data,this);return this;},_updateErrorState:function(errorMessage){var label=this.element().find('.global-error');label.toggleClass('hidden',Object.isEmpty(errorMessage)).text(errorMessage);},_updateJobState:function(jobId,jobState){jobState=jobState||{};var needReload=false;var jobs=this.jobItems(jobId);var progress=jobState.progress||{};if(jobState.ack_errors){needReload=true;jobs.each(function(){var item=$(this);if(item.find('.ack-errors').length===0){item.append('<span class="ack-errors">${message}</span>'.template({message:gettext('Communication error with the job manager (last changes have not been taken into consideration)')}));}});}else{jobs.find('.ack-errors').remove();}
jobs.attr('data-job-status',jobState.status);jobs.data('job-status',jobState.status);switch(jobState.status){case __JOB_STATUS.WAIT:needReload=true;if(progress){jobs.each(function(){var item=$(this);item.find('.job-progress-bar-label').text(progress.label||'');item.find('.job-progress-percentage-value').text(progress.percentage||'');item.find('progress.job-progress-bar').prop('value',progress.percentage||0);});}
break;case __JOB_STATUS.ERROR:jobs.text(gettext('Error'));break;case __JOB_STATUS.OK:jobs.text(gettext('Completed successfully'));break;}
return needReload;},element:function(){throw Error('Not implemented !');},jobItems:function(jobId){return this.element().find('[data-job-id="'+jobId+'"]');},url:function(url){return Object.property(this,'_url',url);},fetchDelay:function(state){return Object.property(this,'_fetchDelay',state);},_retry:function(){this._cancelDeferFetch();this._deferred=setTimeout(this.fetch.bind(this),Math.max(100,this.fetchDelay()));},_cancelDeferFetch:function(){if(Object.isNone(this._deferred)===false){clearTimeout(this._deferred);this._deferred=null;}},fetch:function(){var self=this;var element=this.element();var jobIds=[];this._cancelDeferFetch();element.find('[data-job-id]').each(function(){var jobId=$(this).data('job-id');var needReload=self._updateJobState(jobId,{status:$(this).data('job-status'),ack_errors:$(this).data('job-ack-errors')});if(needReload){jobIds.push(jobId);}});self.trigger('fetch',jobIds);var query=creme.ajax.query(self.url(),{backend:{dataType:'json'}},{id:jobIds});query.onFail(function(){self._updateErrorState(gettext('HTTP server error'));}).onDone(function(event,data){var isOk=Object.isEmpty(data.error);var needReload=!isOk;self._updateErrorState(data.error);if(isOk){jobIds.forEach(function(jobId,index,array){var jobState=data[jobId];if(Object.isString(jobState)){console.log('Server returned an error for job <${job}>  ${state}'.template({job:jobId,state:jobState}));}else if(Object.isNone(jobState)){console.log('Invalid state for job <${job}>'.template({job:jobId}));}else{needReload|=self._updateJobState(jobId,jobState);}});}
if(needReload){self._retry();}else{self.trigger('finished');}}).get();}});creme.jobs.JobsMonitor=creme.jobs.BaseJobsMonitor.sub({_init_:function(element,options){this._super_(creme.jobs.BaseJobsMonitor,'_init_',options);this._element=element;},element:function(){return this._element;}});creme.jobs.BrickJobsMonitor=creme.jobs.BaseJobsMonitor.sub({_init_:function(brick,options){options=options||{};this._super_(creme.jobs.BaseJobsMonitor,'_init_',options);this._brickId=brick.id();},element:function(){return $('#'+this._brickId);}});creme.jobs.PopupJobWaitingController=creme.widget.declare('job-waiting-ctrl',{_create:function(element,options,cb,sync,args){var dialog=element.parents('.ui-dialog').first();var buttons=dialog.find('.ui-dialog-buttonset');var cancel=buttons.find('.ui-button[name="cancel"]');var terminate=buttons.find('.ui-button[name="send"]');cancel.text(gettext('Close (process in background)'));terminate.hide();element.addClass('widget-ready');var jobs=new creme.jobs.JobsMonitor(element,{url:element.attr('data-jobs-info-url')});jobs.on('finished',function(){cancel.hide();terminate.show();}).fetch();},_destroy:function(element){}});}(jQuery));(function($){"use strict";creme.widget.ImportField=creme.widget.declare('ui-import-field',{_create:function(element,options,cb,sync){this._element=element;var isNotSelected=element.find('.import-field-select select').val()==='0';element.find('.import-field-details').toggleClass('hidden',isNotSelected);element.on('change','.import-field-select select',this._onColumnSelect.bind(this));element.addClass('widget-ready');},_onColumnSelect:function(e){var isNotSelected=$(e.target).val()==='0';this._element.find('.import-field-details').toggleClass('hidden',isNotSelected);}});}(jQuery));(function($){"use strict";creme.FormGroupsController=creme.component.Component.sub({_init_:function(options){options=options||{};Assert.not(Object.isEmpty(options.expandUrl),'FormGroupsController expandUrl is not set');this.expandUrl(options.expandUrl);},expandUrl:function(url){return Object.property(this,'_expandUrl',url);},_saveState:function(state){var query=new creme.ajax.Query();query.url(this.expandUrl()).post(state);},_toggleCType:function(element,state){if(state===undefined){state=!element.is('.customform-config-collapsed');}
this.ctypes().addClass('customform-config-collapsed');element.toggleClass('customform-config-collapsed',!state);if(state){creme.utils.scrollTo(element,200);}else{element.find('.customform-config-item').addClass('customform-config-collapsed');}},ctypes:function(){Assert.that(this.isBound(),'FormGroupsController is not bound');return this._brick.element().find('.customform-config-ctype');},ctype:function(id){Assert.that(this.isBound(),'FormGroupsController is not bound');return this._brick.element().find('.customform-config-show-details[data-ct-id="${id}"]'.template({id:id})).first().parents('.customform-config-ctype').first();},bind:function(brick){Assert.not(this.isBound(),'FormGroupsController is already bound');this._brick=brick;var toggleCType=this._toggleCType.bind(this);var saveState=this._saveState.bind(this);var element=brick.element();element.find('.customform-config-blocks').sortable({update:function(e,ui){var url=ui.item.data('reorderable-form-group-url');var query=new creme.ajax.Query();query.url(url).onFail(function(){brick.refresh();}).onDone(function(){brick.refresh();}).post({target:ui.item.index()});}});element.on('click','.customform-config-show-details',function(e){e.preventDefault();toggleCType($(this).parents('.customform-config-ctype').first(),true);saveState({action:'show',ct_id:$(this).data('ct-id')});});element.on('click','.customform-config-hide-details',function(e){e.preventDefault();toggleCType($(this).parents('.customform-config-ctype').first(),false);saveState({action:'hide',ct_id:$(this).data('ct-id')});});element.on('click','.toggle-icon-container',function(e){e.stopPropagation();var icon=$(this);var expand=icon.is('.toggle-icon-expand');icon.parents('.customform-config-item').first().toggleClass('customform-config-collapsed',!expand);saveState({action:(expand?'show':'hide'),item_id:$(this).data('item-id')});});return this;},isBound:function(){return Object.isNone(this._brick)===false;}});}(jQuery));(function($){"use strict";function __buildButtonChoice(choice){return $('<span>').attr('class','menu_button').attr('title',choice.description).text(choice.label).append($('<input>').attr('type','hidden').attr('name',choice.name).val(choice.value).prop('disabled',!choice.selected));}
function __buildWidget(widget,choices){choices.forEach(function(choice){if(choice.selected){widget.find(".widget-selected .widget-container").append(__buildButtonChoice(choice));}else{widget.find(".widget-available .widget-container").append(__buildButtonChoice(choice));}});}
creme.ButtonMenuEditor=creme.component.Component.sub({_init_:function(element,options){options=options||{};if(options.optionsId){__buildWidget(element,JSON.parse($('#${optionsId}'.template(options)).text()||'[]'));}
function onSortEventHandler(event){element.find(".widget-available input").prop("disabled",true);element.find(".widget-selected input").prop("disabled",false);};var groupName=element.attr("id");this._availableList=new Sortable(element.find(".widget-available .widget-container").get(0),{group:groupName,animation:150,sort:false,onSort:onSortEventHandler});this._selectedList=new Sortable(element.find(".widget-selected .widget-container").get(0),{group:groupName,animation:150,onSort:onSortEventHandler});}});}(jQuery));(function($){"use strict";creme.MenuContainersController=creme.component.Component.sub({_init_:function(brick){this._brick=brick;var brickID=brick.element().attr('id');var _onSort=this._onSort.bind(this);this._containers=$.map(brick.element().find('.menu-config-container'),function(element,index){return new Sortable(element,{group:brickID+'-'+index,animation:150,onSort:_onSort});});return this;},_onSort:function(event){var url=$(event.item).data('reorderable-menu-container-url');var brick=this._brick;brick.action('update',url,{},{target:event.newIndex+1}).on('fail',function(){console.log('MenuContainersController: error when trying to re-order.');brick.refresh();}).start();}});}(jQuery));(function($){"use strict";creme.MenuEditor=creme.component.Component.sub({_init_:function(element,options){options=options||{};var self=this;var name=options.name||'MISSING';this._element=element;this._input=$('<input type="hidden" name="${name}">'.template({name:name}));element.append(this._input);Assert.not(Object.isEmpty(options.initialSelector),'MenuEditor missing options.initialSelector');this._appendEntries(JSON.parse(_.readJSONScriptText(element.find(options.initialSelector).get(0))));this._sortable=new Sortable(element.find('.menu-edit-entries').get(0),{group:element.attr('id'),animation:150,onSort:this._onSort.bind(this)});var regularChoices=[];if(Object.isNotEmpty(options.regularChoicesSelector)){regularChoices=JSON.parse(_.readJSONScriptText(element.find(options.regularChoicesSelector).get(0)));}
if(Object.isNotEmpty(regularChoices)){element.on('click','.new-regular-entries',function(event){self._regularEntriesDialog(regularChoices).open();});}else{element.find('.new-regular-entries').remove();}
element.on('click','.new-extra-entry',function(event){self._specialEntriesDialog($(this)).open();});element.on('click','.menu-edit-entry button',function(e){e.preventDefault();$(this).parent('.menu-edit-entry:first').remove();self._onSort();});},_appendEntries:function(entries){var divs=this._element.find('.menu-edit-entries');var html=entries.map(function(entry){var res=('<div class="menu-edit-entry menu-edit-entry-${id}" data-value="${value}">'+'<span>${label}</span>'+'<button type="button">${delete_label}</button>'+'</div>').template({id:entry.value.id,value:JSON.stringify(entry.value).escapeHTML(),label:entry.label.escapeHTML(),delete_label:gettext('Delete')});return res;}).join('');divs.append(html);this._onSort();},_onSort:function(event){this._input.val(JSON.stringify(this.entries()));},value:function(){return JSON.parse(this._input.val());},entries:function(){return this._element.find('.menu-edit-entry').map(function(){return $(this).data('value');}).get();},_regularEntriesDialog:function(choices){var self=this;var excluded=this.entries().map(function(e){return e.id;});var options=choices.filter(function(c){return excluded.indexOf(c[0])===-1;}).map(function(c){return'<option value="${0}">${1}</option>'.template(c);});if(options.length===0){return new creme.dialog.ConfirmDialog(gettext('All menu entries are already used.'));}else{var html=('<form class="menu-edit-regular-entries">'+'<div class="help-text">${help}</div>'+'<select name="entry_type" multiple>${choices}</select>'+'<button class="ui-creme-dialog-action" type="submit">${label}</button>'+'</form>').template({label:gettext('Add entries'),help:gettext('Hold down Control, or Command on a Mac, to select more than one.'),choices:options.join('')});var formDialog=new creme.dialog.FormDialog({title:gettext('New entries'),fitFrame:false,height:400,width:500,noValidate:true,html:$(html)});formDialog.on('frame-activated',function(){this.button('send').on('click',function(){var newEntries=[];formDialog.form().find('[name="entry_type"] option:selected').each(function(){var option=$(this);newEntries.push({label:option.text(),value:{id:option.val()}});});self._appendEntries(newEntries);formDialog.close();});});return formDialog;}},_specialEntriesDialog:function(button){var self=this;return new creme.dialog.FormDialog({url:button.data('url')}).onFormSuccess(function(event,data){if(data.isJSONOrObject()){self._appendEntries(data.data());}else{console.log('_specialEntriesDialog expects JSON ; data received:',data);}});}});}(jQuery));(function($){"use strict";creme.BricksConfigEditor=creme.component.Component.sub({_init_:function(element,options){options=this.options=options||{};this.element=element;this.groups={available:element.find('.widget-choices.widget-available-choices'),top:element.find('.widget-choices.widget-enabled-top-choices'),right:element.find('.widget-choices.widget-enabled-right-choices'),left:element.find('.widget-choices.widget-enabled-left-choices'),bottom:element.find('.widget-choices.widget-enabled-bottom-choices')};if(options.choices){this._populateChoices(JSON.parse($(options.choices).text()||'[]'));}
this._initializeWidget({group:element.attr('id'),dataIdAttr:"data-choice-id",onSort:this._onSort.bind(this)});},_onSort:function(event){if(this.options.targetInput){this.options.targetInput.val(this._serializeWidget());}},_buildButtonChoice:function(choice){return $(('<div class="widget-choice" data-choice-id="${value}" title="${description}">'+'${name}'+'</div>').template($.extend({description:''},choice)));},_populateChoices:function(choices){choices.forEach(function(choice){var choiceGroup=this.groups[choice.orientation?choice.orientation:"available"];choiceGroup.append(this._buildButtonChoice(choice));}.bind(this));},_serializeWidget:function(){return JSON.stringify({top:this.widgets.top.toArray(),right:this.widgets.right.toArray(),left:this.widgets.left.toArray(),bottom:this.widgets.bottom.toArray()});},_initializeWidget:function(options){this.widgets={available:new Sortable(this.groups.available[0],$.extend({sort:false},options)),top:new Sortable(this.groups.top[0],options),right:new Sortable(this.groups.right[0],options),left:new Sortable(this.groups.left[0],options),bottom:new Sortable(this.groups.bottom[0],options)};}});}(jQuery));(function($){"use strict";creme.UserSettingController=creme.component.Component.sub({_init_:function(element){element.on('change','.user-setting-toggle',function(){var item=$(this);var data={};data[item.attr('name')]=item.val();creme.ajax.query(item.data('url')).onDone(function(){creme.utils.reload();}).post(data);});}});}(jQuery));(function(d3){"use strict";var epsilon=1e-6;function identity(x){return x;}
function number(scale){return function(d){return+scale(d);};}
function translate(x,y){return"translate("+x+","+y+")";}
function center(scale,offset){offset=Math.max(0,scale.bandwidth()-offset*2)/2;if(scale.round()){offset=Math.round(offset);}
return function(d){return scale(d)+offset;};}
function entering(){return!this.__axis;}
function polar2cart(angle,r){return[Math.sin(angle)*r,-Math.cos(angle)*r];}
function angularTranslate(angle,radius){return translate.apply(translate,polar2cart(angle,radius));}
function radialAxis(scale,radius,outer){var tickArguments=[],tickValues=null,tickFormat=null,tickSizeInner=6,tickSizeOuter=6,tickPadding=12,offset=typeof window!=="undefined"&&window.devicePixelRatio>1?0:0.5;outer=outer||false;radius=radius||1;function axis(context){var values=tickValues==null?(scale.ticks?scale.ticks.apply(scale,tickArguments):scale.domain()):tickValues,format=tickFormat==null?(scale.tickFormat?scale.tickFormat.apply(scale,tickArguments):identity):tickFormat,spacing=Math.max(tickSizeInner,0)+tickPadding,angleRange=scale.range(),anglePos=(scale.bandwidth?center:number)(scale.copy(),offset),selection=context.selection?context.selection():context,path=selection.selectAll(".domain").data([null]),tick=selection.selectAll(".tick").data(values,scale).order(),tickExit=tick.exit(),tickEnter=tick.enter().append("g").attr("class","tick"),line=tick.select("line"),text=tick.select("text");var isFullCircle=Math.abs(angleRange[1]-angleRange[0])>=2*Math.PI;path=path.merge(path.enter().insert("path",".tick").attr("class","domain").attr("stroke","currentColor"));tick=tick.merge(tickEnter);line=line.merge(tickEnter.append("line").attr("stroke","currentColor"));text=text.merge(tickEnter.append("text").attr("fill","currentColor").attr("dy",".35em").attr("text-anchor","middle"));if(context!==selection){path=path.transition(context);tick=tick.transition(context);line=line.transition(context);text=text.transition(context);tickExit=tickExit.transition(context).attr("opacity",epsilon).attr("transform",function(d){var pos=anglePos(d);return isFinite(pos)?angularTranslate(pos+offset,radius):this.getAttribute("transform");});tickEnter.attr("opacity",epsilon).attr("transform",function(d){var p=this.parentNode.__axis;var pos=p?p(d):NaN;pos=isFinite(pos)?pos:anglePos(d);return angularTranslate(pos+offset,radius);});}
tickExit.remove();function getTickPath(angle,r){return('M'+polar2cart(angle,r+tickSizeOuter*(outer?1:-1)).join(',')+'L'+polar2cart(angle,r).join(','));}
function getArcPath(startAngle,endAngle,r){var isLargeArc=Math.abs(endAngle-startAngle)%(2*Math.PI)>Math.PI;var isClockWise=endAngle>startAngle;return('M'+polar2cart(startAngle,r).join(',')+
(isFullCircle?('A'+[r,r,0,1,1].concat(polar2cart(startAngle+Math.PI,r)).join(',')+'A'+[r,r,0,1,1].concat(polar2cart(startAngle,r)).join(',')):('A'+[r,r,0,isLargeArc?1:0,isClockWise?1:0].concat(polar2cart(endAngle,r)).join(','))));}
path.attr('d',getArcPath(angleRange[0],angleRange[1],radius)+getTickPath(angleRange[0],radius));tick.attr("opacity",1).attr("transform",function(d){return angularTranslate(anglePos(d),radius);});line.attr('x1',0).attr('y1',0).attr('x2',function(d){return polar2cart(anglePos(d),tickSizeInner)[0]*(outer?1:-1);}).attr('y2',function(d){return polar2cart(anglePos(d),tickSizeInner)[1]*(outer?1:-1);});text.attr('x',function(d){return polar2cart(anglePos(d),spacing)[0]*(outer?1:-1);}).attr('y',function(d){return polar2cart(anglePos(d),spacing)[1]*(outer?1:-1);}).text(format);selection.filter(entering).attr("fill","none").attr("font-size",10).attr("font-family","sans-serif");selection.each(function(){this.__axis=anglePos;});}
axis.scale=function(_){return arguments.length?(scale=_,axis):scale;};axis.radius=function(_){return arguments.length?(radius=+_,axis):radius;};axis.ticks=function(_){tickArguments=Array.from(arguments);return axis;};axis.tickArguments=function(_){if(arguments.length){tickArguments=_==null?[]:Array.from(_);return axis;}else{return tickArguments&&tickArguments.slice();}};axis.tickValues=function(_){if(arguments.length){tickValues=_==null?[]:Array.from(_);return axis;}else{return tickValues&&tickValues.slice();}};axis.tickFormat=function(_){if(arguments.length){tickFormat=_;return axis;}else{return tickFormat;}};axis.tickSize=function(_){if(arguments.length){tickSizeInner=tickSizeOuter=+_;return axis;}else{return outer?tickSizeOuter:tickSizeInner;}};axis.tickSizeInner=function(_){if(arguments.length){tickSizeInner=+_;return axis;}else{return tickSizeInner;}};axis.tickSizeOuter=function(_){if(arguments.length){tickSizeOuter=+_;return axis;}else{return tickSizeOuter;}};axis.tickPadding=function(_){if(arguments.length){tickPadding=+_;return axis;}else{return tickPadding;}};axis.offset=function(_){if(arguments.length){offset=+_;return axis;}else{return offset;}};axis.outer=function(_){if(arguments.length){outer=_||false;return axis;}else{return outer;}};return axis;}
d3.axisRadialInner=function(scale,radius){return radialAxis(scale,radius,false);};d3.axisRadialOuter=function(scale,radius){return radialAxis(scale,radius,true);};}(d3));(function(){"use strict";function Transform(){this._ops=[];}
function toNumber(value){return+value||0;}
Transform.prototype={translate:function(){this._ops.push({op:'translate',args:Array.from(arguments).map(toNumber)});return this;},rotate:function(){this._ops.push({op:'rotate',args:Array.from(arguments).map(toNumber)});return this;},scale:function(x,y){this._ops.push({op:'scale',args:Array.from(arguments).map(toNumber)});return this;},toString:function(){return this._ops.map(function(o){return o.op+'('+o.args.join(',')+')';}).join(' ');}};creme.svgTransform=function(){return new Transform();};creme.svgRulesAsCSS=function(rules){return Object.entries(rules).map(function(rule){var selector=rule[0];var props=rule[1]||{};Assert.not(Object.isEmpty(selector),'CSS selector must be a non empty string');if(Object.isString(props)){return selector+' { '+props+'; }';}else{return selector+' { '+Object.entries(props).map(function(prop){return''+prop[0]+': '+prop[1];}).join('; ')+'; }';}}).join('\n');};creme.svgBounds=function(bounds){bounds=bounds||{};var margin={top:0,left:0,right:0,bottom:0};if(arguments.length>1){for(var i=1;i<arguments.length;++i){var m=arguments[i];if(Object.isNumber(m)||Object.isString(m)){m=+m;margin.top+=m;margin.left+=m;margin.right+=m;margin.bottom+=m;}else{margin.top+=+(m.top)||0;margin.left+=+(m.left)||0;margin.right+=+(m.right)||0;margin.bottom+=+(m.bottom)||0;}}}
return{top:Math.max(0,margin.top)+(bounds.top||0),left:Math.max(0,margin.left)+(bounds.left||0),width:Math.max(0,(bounds.width||0)-margin.right-margin.left),height:Math.max(0,(bounds.height||0)-margin.top-margin.bottom)};};creme.svgBoundsRadius=function(bounds){return Math.min(bounds.width||0,bounds.height||0)/2;};creme.svgAsXml=function(svg,options){options=options||{};Assert.that(svg instanceof window.HTMLElement||svg instanceof window.SVGElement,'Not an HTML or SVG element : ${e}',{e:svg});return['<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="${width}" height="${height}">',svg.innerHTML,'</svg>'].join('\n').template({width:options.width||(svg.getAttribute('width')||'auto'),height:options.height||(svg.getAttribute('height')||'auto')});};creme.svgAsDataURI=function(svg,options){function _encodeURIEntity(match,val){var char=String.fromCharCode(parseInt(val,16));return char==='%'?'%25':char;}
function _reEncodeURI(uri){return decodeURIComponent(encodeURIComponent(uri).replace(/%([0-9A-F]{2})/g,_encodeURIEntity));}
return'data:image/svg+xml;base64,'+window.btoa(_reEncodeURI(creme.svgAsXml(svg,options)));};creme.svgAsBlob=function(done,svg,options){options=Object.assign({encoderType:'image/svg+xml',encoderQuality:0.8},options||{});Assert.that(Object.isFunc(done),'A callback is required to get the SVG blob');if(options.encoderType==='image/svg+xml'){done(new Blob(['<?xml version="1.0" standalone="no"?>',creme.svgAsXml(svg,options)],{type:"image/svg+xml;charset=utf-8"}));}else{creme.svgAsCanvas(function(canvas){if(Object.isFunc(canvas.msToBlob)){canvas.msToBlob(done,options.encoderType,options.encoderQuality);}else{canvas.toBlob(done,options.encoderType,options.encoderQuality);}},svg,options);}};creme.svgAsCanvas=function(done,svg,options){options=options||{};var canvas=document.createElement('canvas');var context=canvas.getContext('2d');var pixelRatio=window.devicePixelRatio||1;var width=+options.width||(svg.getAttribute('width')||100);var height=+options.height||(svg.getAttribute('height')||100);canvas.width=width*pixelRatio;canvas.height=height*pixelRatio;canvas.style.width=''+canvas.width+'px';canvas.style.height=''+canvas.height+'px';context.setTransform(pixelRatio,0,0,pixelRatio,0,0);Assert.that(Object.isFunc(done),'A callback is required to get the SVG canvas');if(Object.isNone(window.canvg)===false){window.canvg(canvas,creme.svgAsXml(svg,options));done(canvas);}else{creme.svgAsImage(function(image){if(image){try{context.drawImage(image,0,0);}catch(e){console.error('There was an error drawing the SVG within the canvas',e);done(null);}
done(canvas);}else{done(null);}},svg,options);}
return canvas;};creme.svgAsImage=function(done,svg,options){Assert.that(Object.isFunc(done),'A callback is required to get the SVG image');var image=document.createElement('img');var uri=creme.svgAsDataURI(svg,options);image.onload=function(){done(image);};image.onerror=function(){console.error('There was an error loading the data URI as an image',uri);done(null);};image.src=uri;return image;};creme.svgScreenCTMatrix=function(node){while(node.getScreenCTM==null&&node.parentNode!=null){node=node.parentNode;}
return node.getScreenCTM();};creme.d3FontSize=function(select){if(select.size()>1){return creme.d3Map(select,function(d){return parseFloat(window.getComputedStyle(this).fontSize)||0;});}else if(select.size()>0){return parseFloat(window.getComputedStyle(select.node()).fontSize)||0;}else{return 0;}};creme.d3NumericDataInfo=function(data,getter){data=data||[];getter=getter||function(d){return d;};if(data.length===0){return{integer:true,min:0,max:0,gap:0,average:0};}
var min=0,max=0,onlyInt=true,sum=0;data.forEach(function(d){var value=parseFloat(getter(d));onlyInt=onlyInt&&Number.isInteger(value);min=isNaN(value)?min:Math.min(min,value);max=isNaN(value)?max:Math.max(max,value);sum+=isNaN(value)?0:value;});return{min:min,max:max,gap:Math.abs(max-min),average:sum/data.length,integer:onlyInt};};creme.d3NumericFormat=function(info){if(info.integer){if(info.gap<10000){return d3.format('~s');}else{return d3.format('.3s');}}else{if(info.gap<100){return d3.formatPrefix('.2',1);}else if(info.gap<5000){return d3.format('~s');}else if(info.gap<10000){return d3.format('.2s');}else{return d3.format('.3s');}}};creme.d3NumericAxisFormat=function(info){if(info.integer){if(info.gap<1000){return d3.format('~s');}else{return d3.format('.2s');}}else{if(info.gap<100){return d3.formatPrefix('.2',1);}else{return d3.format('.2s');}}};creme.d3Map=function(select,func){var res=[];select.each(function(datum,i,nodes){res.push(func.apply(this,[datum,i,nodes]));});return res;};creme.d3PreventResizeObserverLoop=function(callback){return function(entries,observer){var previousSizes=entries.map(function(entry){return entry.target.getBoundingClientRect();});try{callback(entries,observer);}finally{var resizedElements=entries.filter(function(entry,i){var size=entry.target.getBoundingClientRect();var previousSize=previousSizes[i];return(size.width!==previousSize.width||size.height!==previousSize.height);}).map(function(event){return event.target;});resizedElements.forEach(function(element){observer.unobserve(element);});window.requestAnimationFrame(function(){resizedElements.forEach(function(element){observer.observe(element);});});}};};}());(function(){"use strict";creme.d3ColorRange=function(colors,options){if(Array.isArray(colors)){return colors;}else if(Object.isFunc(colors)){return colors(options);}else{return[colors];}};creme.d3SpectralColors=function(options){options=Object.assign({start:0,step:1.0,size:2},options||{});return d3.quantize(function(t){return d3.interpolateSpectral(t*options.step+options.start);},Math.max(options.size,2));};creme.d3Colorize=function(){var props={scale:function(d){return'black';},accessor:function(d){return d.x;}};function colorize(data){return data.map(function(d,i){var color=props.color?props.color(d):d.color;var textColor=props.textColor?props.textColor(d):d.textColor;var value=props.accessor?props.accessor(d,i):d;d.color=color||props.scale(value);var rgbColor=new RGBColor(d.color);d.isDarkColor=rgbColor.isDark();if(textColor){d.textColor=textColor;}else{d.textColor=d.isDarkColor?'white':'black';}
return d;});}
colorize.scale=function(scale){props.scale=scale;return colorize;};colorize.color=function(color){props.color=color;return colorize;};colorize.textColor=function(color){props.textColor=color;return colorize;};colorize.accessor=function(accessor){props.accessor=accessor;return colorize;};return colorize;};}());(function(){"use strict";function bboxAnchorPoint(target,node,direction){var point;var bbox=target.getBBox();switch(direction){case'n':point=new DOMPoint(bbox.x+bbox.height/2,bbox.y);point.x-=node.offsetWidth/2;point.y-=node.offsetHeight;break;case's':point=new DOMPoint(bbox.x+bbox.height/2,bbox.y+bbox.height);point.x-=node.offsetWidth/2;break;case'e':point=new DOMPoint(bbox.x+bbox.width,bbox.y+bbox.height/2);point.y-=node.offsetHeight/2;break;case'w':point=new DOMPoint(bbox.x,bbox.y+bbox.height/2);point.x-=node.offsetWidth;point.y-=node.offsetHeight/2;break;case'nw':point=new DOMPoint(bbox.x,bbox.y);point.x-=node.offsetWidth;point.y-=node.offsetHeight;break;case'ne':point=new DOMPoint(bbox.x+bbox.width,bbox.y);point.y-=node.offsetHeight;break;case'se':point=new DOMPoint(bbox.x+bbox.width,bbox.y+bbox.height);break;case'sw':point=new DOMPoint(bbox.x,bbox.y+bbox.height);point.x-=node.offsetWidth;break;default:point=new DOMPoint(bbox.x+bbox.width/2,bbox.y+bbox.height/2);point.x-=node.offsetWidth/2;point.y-=node.offsetHeight/2;}
return point;}
function TooltipEvent(type,options){Object.defineProperties(this,{type:{value:type,enumerable:true,configurable:true},target:{value:options.target,enumerable:true,configurable:true},tooltip:{value:options.tooltip,enumerable:true,configurable:true},container:{value:options.container,enumerable:true,configurable:true},_:{value:options.dispatch}});}
creme.d3Tooltip=function(root){var container=null;var listeners=d3.dispatch("show","hide");var props={root:root||document.body,transition:true};function prop(name,value){if(value===undefined){return props[name];}else{props[name]=value;return tooltip;}}
function getContainer(root){if(container===null){container=d3.select(document.createElement('div')).attr('class','d3-sketch-tooltip').style('top',0).style('left',0);root.node().appendChild(container.node());}
return container;}
function emit(node,type,container){var d=d3.select(node).datum();var event=new TooltipEvent(type,{target:node,tooltip:tooltip,container:container,dispatch:listeners});listeners.call(type,node,event,d);}
function tooltip(node){};tooltip.show=function(){var args=Array.from(arguments);var root=d3.select(Object.isFunc(props.root)?props.root.apply(this,args):props.root);var content=Object.isFunc(props.html)?props.html.apply(this,args):props.html;var direction=(Object.isFunc(props.direction)?props.direction.apply(this,args):props.direction)||'s';var offset=(Object.isFunc(props.offset)?props.offset.apply(this,args):props.offset)||[0,0];var scroll={top:document.documentElement.scrollTop||props.root.scrollTop,left:document.documentElement.scrollLeft||props.root.scrollLeft};offset=Array.isArray(offset)?new DOMPoint(offset[0],offset[1]):offset;var container=getContainer(root);emit(this,'show',container);container.html(content);var coords=bboxAnchorPoint(this,container.node(),direction).matrixTransform(creme.svgScreenCTMatrix(this));container.style('pointer-events','all').style('top',coords.y+offset.y+scroll.top+'px').style('left',coords.x+offset.x+scroll.left+'px').attr('class','d3-sketch-tooltip tip-'+direction);container=props.transition?container.transition():container;container.style('opacity',1);return tooltip;};tooltip.hide=function(){var args=Array.from(arguments);var root=d3.select(Object.isFunc(props.root)?props.root.apply(this,args):props.root);var container=getContainer(root);emit(this,'hide',container);container.style('pointer-events','none').attr('class','d3-sketch-tooltip');container=props.transition?container.transition():container;container.style('opacity',0);};tooltip.offset=function(offset){return prop('offset',offset);};tooltip.direction=function(direction){return prop('direction',direction);};tooltip.root=function(root){return prop('root',root);};tooltip.html=function(html){return prop('html',html);};tooltip.transition=function(transition){return prop('transition',transition);};tooltip.on=function(){var value=listeners.on.apply(listeners,arguments);return value===listeners?tooltip:value;};return tooltip;};}());(function(){"use strict";creme.d3BisectScale=function(getter){var bisect=d3.bisector(getter).center;var props={scale:null};function invertLinear(data,pos){return bisect(data,props.scale.invert(pos),0);}
function invertOrdinal(data,pos){var scale=d3.scaleLinear([0,data.length],props.scale.range());var index=Math.max(0,Math.min(Math.floor(scale.invert(pos)),data.length-1));return getter(data[index]);}
function invert(data,pos){return props.scale.invert?invertLinear(data,pos):invertOrdinal(data,pos);}
invert.scale=function(scale){if(scale===undefined){return props.scale;}else{props.scale=scale;return invert;}};return invert;};}());(function(){"use strict";creme.D3Sketch=creme.component.Component.sub({_init_:function(options){options=Object.assign({ignoreResize:false},options||{});this._ignoreResize=!!options.ignoreResize;this._events=new creme.component.EventHandler();this._elementListeners={resize:this._onContainerResize.bind(this)};},isBound:function(){return Object.isNone(this._element)===false;},ignoreResize:function(){return this._ignoreResize;},bind:function(element){Assert.not(this.isBound(),'D3Sketch is already bound');Assert.that(element.length===1,'Unable to bind D3Sketch to multiple nor empty selection');this._element=element.addClass('d3-sketch');this._element.empty();var domElement=element.get(0);var svg=this._svg=d3.select(domElement).append("svg");element.data('sketchId',_.uniqueId('d3sketch'));svg.attr('width','100%').attr('height',this.containerSize().height);if(!this.ignoreResize()){this._resizeObserver=new ResizeObserver(creme.d3PreventResizeObserverLoop(this._onContainerResize.bind(this)));this._resizeObserver.observe(domElement);}
element.on(this._elementListeners);return this;},unbind:function(){Assert.that(this.isBound(),'D3Sketch is not bound');if(this._resizeObserver){this._resizeObserver.disconnect();this._resizeObserver=undefined;}
this._element.off(this._elementListeners);this._element.removeClass('d3-sketch');this._element.data('sketchId',null);this._element=undefined;this._svg.remove();this._svg=undefined;return this;},on:function(event,listeners,decorator){this._events.on(event,listeners,decorator);return this;},off:function(event,listeners){this._events.off(event,listeners);return this;},clear:function(){Assert.that(this.isBound(),'D3Sketch is not bound');this._svg.interrupt().selectAll('*').interrupt().remove();},element:function(){return this._element;},svg:function(){return this._svg;},containerSize:function(){if(this.isBound()){return{width:this._element.innerWidth(),height:this._element.innerHeight()};}else{return{width:0,height:0};}},size:function(){if(this.isBound()){var style=window.getComputedStyle(this._svg.node());var preferred=this.containerSize();return{width:parseInt(style.width)||preferred.width,height:parseInt(style.height)||preferred.height};}else{return{width:0,height:0};}},_onContainerResize:function(){var preferred=this.containerSize();this._svg.attr('height',preferred.height);var svgSize=this.size();this._element.trigger(jQuery.Event("sketch-resize"),svgSize);this._events.trigger('resize',[svgSize]);},width:function(){return this.isBound()?this.size().width:0;},height:function(){return this.isBound()?this.size().height:0;},saveAs:function(done,filename,options){options=Object.assign(this.size(),options);Assert.that(this.isBound(),'D3Sketch is not bound');Assert.that(Object.isFunc(done),'A callback is required to convert and save the SVG.');var saveAs=FileSaver.saveAs;creme.svgAsBlob(function(blob){filename=filename||'output.svg';if(blob){saveAs(blob,filename);}
done(blob,filename);},this._svg.node(),options);},asImage:function(done,options){options=Object.assign(this.size(),options);Assert.that(this.isBound(),'D3Sketch is not bound');Assert.that(Object.isFunc(done),'A callback is required to convert the SVG as image.');return creme.svgAsImage(done,this.svg().node(),options);}});}());(function($){"use strict";creme.D3Chart=creme.component.Component.sub({defaultProps:{},_init_:function(options){options=options||{};this._props=Object.assign({drawOnResize:true},this.defaultProps);this._events=new creme.component.EventHandler();this._selection=new creme.model.SelectionController();this._modelListeners={update:this._onModelUpdate.bind(this),add:this._onModelAdd.bind(this),remove:this._onModelRemove.bind(this),reset:this._onModelReset.bind(this)};this._sketchListeners={resize:_.debounce(this._onSketchResize.bind(this),200)};this.props(options);},props:function(props){if(props===undefined){return Object.assign({},this._props);}
this._props=Object.assign(this._props||{},props);return this;},prop:function(name,value){if(value===undefined){return this._props[name];}else{this._props[name]=value;return this;}},selection:function(selection){return this._selection;},on:function(event,listeners,decorator){this._events.on(event,listeners,decorator);return this;},off:function(event,listeners){this._events.off(event,listeners);return this;},hasCanvas:function(){return!Object.isNone(this._sketch);},sketch:function(sketch){if(sketch===undefined){return this._sketch;}
Assert.is(sketch,creme.D3Sketch,'${sketch} is not a creme.D3Sketch',{sketch:sketch});if(this._sketch){this._sketch.off(this._sketchListeners);}
this._sketch=sketch;this._sketch.on(this._sketchListeners);return this;},model:function(model){if(model===undefined){return this._model;}
if(Array.isArray(model)){model=new creme.model.Array(model);}else{Assert.is(model,creme.model.Collection,'${model} is not a valid data model',{model:model});}
var previous=this._model;if(previous!==undefined){previous.unbind(this._modelListeners);}
if(!Object.isNone(model)){model.bind(this._modelListeners);}
this._selection.model(model);this._model=model;return this;},draw:function(){var sketch=this.sketch();Assert.not(Object.isNone(sketch),'D3Chart must have a target sketch to draw on');Assert.that(sketch.isBound(),'D3Chart sketch is not bound');var data=this.model()?this.model().all():[];this._draw(sketch,data,this.props());return this;},saveAs:function(done,filename,options){var data=this.model()?this.model().all():[];var props=Object.assign(this.props(),this.exportProps());options=Object.assign(options||{},this.exportOptions(data,options,props));this._withShadowSketch(options,function(sketch){this._export(sketch,data,props);sketch.saveAs(done,filename,options);});return this;},asImage:function(done,options){var data=this.model()?this.model().all():[];var props=Object.assign(this.props(),this.exportProps());options=Object.assign(options||{},this.exportOptions(data,options,props));return this._withShadowSketch(options,function(sketch){this._export(sketch,data,props);return sketch.asImage(done);});},exportOptions:function(data,options,props){return{};},exportStyle:function(props){return creme.svgRulesAsCSS({"g":{font:"10px sans-serif"}});},exportProps:function(){return{};},_withShadowSketch:function(options,callable){Assert.that(this.hasCanvas(),'D3Chart must have a target sketch to draw on');options=Object.assign(this.sketch().size(),options||{});var id=_.uniqueId('shadow-d3sketch');var element=$('<div>').css({width:options.width,height:options.height,display:'absolute',left:-10000,top:-10000}).attr('id',id);var canvas=new creme.D3Sketch({ignoreResize:true}).bind(element);try{element.appendTo('body');return callable.bind(this)(canvas);}finally{try{canvas.unbind();}finally{element.remove();}}},_export:function(sketch,data,props){var style=this.exportStyle(props);sketch.svg().append('style').text(Object.isString(style)?style:creme.svgRulesAsCSS(style));this._draw(sketch,data,props);},_draw:function(sketch,data,props){throw new Error('Not implemented');},_onSketchResize:function(){if(this.prop('drawOnResize')){this.draw();}},_onModelUpdate:function(event,data,start,end,previous,action){if(action!=='reset'){this.draw();}},_onModelAdd:function(event,data,start,end,action){if(action!=='reset'){this.draw();}},_onModelRemove:function(event,data,start,end,action){if(action!=='reset'){this.draw();}},_onModelReset:function(event,data){this.draw();}});}(jQuery));(function($){"use strict";creme.D3ChartBrickController=creme.component.Component.sub({_init_:function(options){options=options||{};var chart=options.chart;Assert.not(Object.isNone(chart),'D3ChartBrickController must have a creme.D3Chart');Assert.is(chart,creme.D3Chart,'${chart} is not a creme.D3Chart',options);this._chart=chart;this._sketch=new creme.D3Sketch();this._model=new creme.model.Array([]);},isBound:function(){return Object.isNone(this._brick)===false;},bind:function(brick){Assert.not(this.isBound(),'D3ChartBrickController is already bound');var model=this._model;var element=brick.element();var container=element.find('.brick-d3-content');this._brick=brick;if(container.length>0){this._sketch.bind(container);}
this._chart.props(this.initialProps()).sketch(this._sketch).model(model);model.reset(this.initialData());},initialData:function(){var script=$('script[type$="/json"].sketch-chart-data:first',this._brick.element());var data=_.readJSONScriptText(script.get(0));return Object.isEmpty(data)?[]:JSON.parse(data);},initialProps:function(){var script=$('script[type$="/json"].sketch-chart-props:first',this._brick.element());var data=_.readJSONScriptText(script.get(0));return Object.isEmpty(data)?{}:JSON.parse(data);},sketch:function(){return this._sketch;},chart:function(){return this._chart;},model:function(){return this._model;},registerActions:function(brick){var self=this;Assert.is(brick,creme.bricks.Brick,'${brick} is not a creme.bricks.Brick',{brick:brick});brick.getActionBuilders().registerAll({'sketch-download':function(url,options,data,e){options=Object.assign({filename:url,width:$(window).innerWidth(),height:$(window).innerHeight()},options||{});return new creme.D3ChartBrickDownloadAction(this._brick,self.chart(),options);},'sketch-popover':function(url,options,data,e){options=Object.assign({width:$(window).innerWidth()*0.8,height:$(window).innerHeight()*0.8},options||{});return new creme.D3ChartBrickPopoverAction(this._brick,self.chart(),options);}});}});creme.D3ChartBrickDownloadAction=creme.component.Action.sub({_init_:function(brick,chart,options){options=options||{};this._brick=brick;this._chart=chart;this._super_(creme.component.Action,'_init_',this._run,options);},_run:function(options){options=Object.assign({},this.options(),options||{});var self=this;this._chart.saveAs(function(){self.done();},options.filename,options);}});creme.D3ChartBrickPopoverAction=creme.component.Action.sub({_init_:function(brick,chart,options){options=options||{};this._brick=brick;this._chart=chart;this._super_(creme.component.Action,'_init_',this._run,options);},_run:function(options){options=Object.assign({},this.options(),options||{});var self=this;this._chart.asImage(function(image){if(image){var dialog=creme.dialogs.image(image,{title:self._brick.title()});dialog.on('closed',function(){self.done();}).open();}else{self.done();}},options);}});creme.setupD3ChartBrick=function(element,options){var controller=new creme.D3ChartBrickController(options);$(element).on('brick-ready',function(e,brick){controller.bind(brick);}).on('brick-setup-actions',function(e,brick,actions){controller.registerActions(brick);});return controller;};}(jQuery));(function($){"use strict";creme.D3Drawable=creme.component.Component.sub({defaultProps:{},_init_:function(options){this.props(Object.assign({},this.defaultProps,options||{}));},drawAll:function(selection){var self=this;creme.d3Map(selection,function(datum,i,nodes){self.draw(this,datum,i,nodes);});},draw:function(d,i){throw new Error('Not implemented');},props:function(props){if(props===undefined){return Object.assign({},this._props);}
this._props=Object.assign(this._props||{},props);return this;},prop:function(name,value){if(value===undefined){return this._props[name];}else{this._props[name]=value;return this;}}});creme.d3Drawable=function(options){options=options||{};var props=new Set(options.props||[]);var methods=new Set(options.methods||[]);var instance=options.instance;Assert.is(instance,creme.D3Drawable,'Must be a creme.D3Drawable');function renderer(selection){return instance.drawAll(selection);}
renderer.prop=function(name,value){var res=instance.prop(name,value);return value===undefined?res:this;};renderer.props=function(props){var res=instance.props(props);return props===undefined?res:this;};props.forEach(function(name){renderer[name]=function(value){var res=instance.prop(name,value);return value===undefined?res:this;};});methods.forEach(function(name){Assert.that(renderer[name]===undefined,'A property "${name}" already exists for this renderer.'.template({name:name}));renderer[name]=function(selection){return creme.d3Map(selection,function(datum,i,nodes){instance[name].apply(instance,[this,datum,i,nodes]);});};});return renderer;};}(jQuery));(function($){"use strict";creme.D3LegendRow=creme.D3Drawable.sub({defaultProps:{swatchSize:{width:20,height:20},swatchColor:d3.scaleOrdinal().range(["#98abc5","#8a89a6","#7b6888","#6b486b","#a05d56","#d0743c","#ff8c00"]),spacing:0,data:[],text:function(d,i){return d;},help:null,textWrap:{breakAll:true,lineHeight:'1.1em'}},draw:function(node,datum,i){var props=this.props();var interval=Math.max((props.swatchSize.width||0)+props.spacing,props.interval||0);var position=function(d,i){return creme.svgTransform().translate((interval/2)+i*interval,0);};var textWrapper=Object.isFunc(props.textWrapper)?props.textWrapper:creme.d3TextWrap().maxWidth(interval).props(props.textWrap);var legend=d3.select(node);var items=legend.selectAll('.legend-item').data(props.data||[]);var newItem=items.enter().append('g').attr('class','legend-item').attr("transform",position);newItem.append("rect").attr("width",props.swatchSize.width).attr("height",props.swatchSize.height).attr('title',props.help||props.text).attr("fill",props.swatchColor);newItem.append("text").attr("y",props.swatchSize.height*1.5).attr("dx",props.swatchSize.width/2).attr("dy","0.35em").attr('text-anchor','middle').text(props.text).call(textWrapper);items.attr("transform",position);items.select('text').text(props.text).call(textWrapper);items.select("rect").attr('title',props.help||props.text).attr("fill",props.swatchColor);items.exit().remove();}});creme.d3LegendRow=function(options){return creme.d3Drawable({instance:new creme.D3LegendRow(options),props:['swatchSize','swatchColor','spacing','data','text','interval','helpText','textWrap']});};creme.D3LegendColumn=creme.D3Drawable.sub({defaultProps:{swatchSize:{width:20,height:20},swatchColor:d3.scaleOrdinal().range(["#98abc5","#8a89a6","#7b6888","#6b486b","#a05d56","#d0743c","#ff8c00"]),spacing:0,data:[],text:function(d,i){return d;}},draw:function(node,datum,i){var props=this.props();var position=function(d,i){return creme.svgTransform().translate(0,i*(props.swatchSize.height+props.spacing));};var items=d3.select(node).selectAll('.legend-item').data(props.data||[]);var newItem=items.enter().append('g').attr('class','legend-item').attr("transform",position);newItem.append("rect").attr("width",props.swatchSize.width).attr("height",props.swatchSize.height).attr('title',props.help||props.text).attr("fill",props.swatchColor);newItem.append("text").attr("x",props.swatchSize.width).attr('text-anchor','start').attr('alignment-baseline','middle').attr("y",props.swatchSize.height*0.5).attr("dx","0.31em").text(props.text);items.attr("transform",position);items.select("rect").attr('title',props.help||props.text).attr("fill",props.swatchColor);items.select("text").text(props.text);items.exit().remove();}});creme.d3LegendColumn=function(options){return creme.d3Drawable({instance:new creme.D3LegendColumn(options),props:['swatchSize','swatchColor','spacing','data','text']});};}(jQuery));(function($){"use strict";creme.D3LimitStack=creme.D3Drawable.sub({defaultProps:{zIndex:1,data:[],bounds:{top:0,left:0,width:0,height:0},label:function(d,i){return d;},help:function(d,i){return d;},scale:function(d,i){return d;},color:'#000'},draw:function(node,datum,i){var props=this.props();function position(d,i){return creme.svgTransform().translate(0,props.scale(d));}
var limits=d3.select(node).selectAll('.limit').data(props.data||[]);limits.enter().append('line').attr('class','limit').attr('z-index',props.zIndex).attr('x2',props.bounds.width).attr('transform',position).attr('title',props.help).attr('fill',props.color);limits.attr('transform',position).attr('title',props.help).attr('fill',props.color);limits.exit().remove();}});creme.d3LimitStack=function(options){return creme.d3Drawable({instance:new creme.D3LimitStack(options),props:['label','help','zIndex','bounds','data','scale','color']});};}(jQuery));(function($){"use strict";creme.D3BottomAxis=creme.D3Drawable.sub({defaultProps:{label:function(d,i){return d;},help:function(d,i){return d;},scale:function(d,i){return d;},minHeight:20,tickWrapWidth:30,tickFormat:null,ticks:10},draw:function(node,datum,i){var props=this.props();var axis=d3.select(node);var ticks=axis.select('.axis-ticks');if(ticks.size()===0){ticks=axis.append('g').attr('class','axis-ticks');}
ticks.call(d3.axisBottom(props.scale).tickFormat(props.tickFormat).tickSizeOuter(0).ticks(props.ticks)).selectAll('.tick text').call(creme.d3TextWrap().maxWidth(props.tickWrapWidth).breakAll(true).lineHeight('1.1em'));var title=axis.select('.axis-title');if(title.size()===0){title=axis.append('text').attr('class','axis-title').attr('text-anchor','end').attr('fill','currentColor');title.append('tspan').attr('class','axis-title-label');title.append('tspan').attr('class','axis-title-arrow').attr('dx','0.5em').text('');}
title.select('.axis-title-label').text(props.label);var titleHeight=title.node().getBBox().height;var ticksBBox=ticks.node().getBBox();title.attr('transform',creme.svgTransform().translate(ticksBBox.width,Math.max(props.minHeight,ticksBBox.height)+(titleHeight/2)*1.1));}});creme.d3BottomAxis=function(options){return creme.d3Drawable({instance:new creme.D3BottomAxis(options),props:['label','help','scale','minHeight','tickFormat','tickWrapWidth','ticks','isNumeric']});};creme.D3LeftAxis=creme.D3Drawable.sub({defaultProps:{label:function(d,i){return d;},help:function(d,i){return d;},scale:function(d,i){return d;},minWidth:20,fill:'rgba(0,0,0,0)',tickFormat:d3.format('~s'),ticks:10},draw:function(node,datum,i){var props=this.props();var axis=d3.select(node);var ticks=axis.select('.axis-ticks');if(ticks.size()===0){axis.append('rect').attr('class','axis-bg');ticks=axis.append('g').attr('class','axis-ticks');}
ticks.call(d3.axisLeft(props.scale).tickFormat(props.tickFormat).tickSizeOuter(0).ticks(props.ticks));var title=axis.select('.axis-title');if(title.size()===0){title=axis.append('text').attr('class','axis-title').attr('text-anchor','start').attr('fill','currentColor').attr('dy','-1em');title.append('tspan').attr('class','axis-title-arrow').text('');title.append('tspan').attr('class','axis-title-label').attr('dy','0.1em').attr('dx','0.5em');}
title.select('.axis-title-label').text(props.label);title.attr('transform',creme.svgTransform().translate(-ticks.node().getBBox().width,0));var axisBBox=axis.node().getBBox();axis.select('.axis-bg').attr('width',axisBBox.width).attr('height',axisBBox.height).attr('fill',props.fill).attr('transform',creme.svgTransform().translate(-axisBBox.width,0));}});creme.d3LeftAxis=function(options){return creme.d3Drawable({instance:new creme.D3LeftAxis(options),props:['label','help','scale','tickFormat','fill','ticks']});};}(jQuery));(function($){"use strict";creme.D3TextWrap=creme.D3Drawable.sub({defaultProps:{lineHeight:'1.2em',maxWidth:0,wordBreakSeparator:'-',breakAll:false},breakWord:function(text,props){var node=text.node();var computedWidth=node.getComputedTextLength();var avgCharSize=(computedWidth/text.text().length);var words=text.text().split(/\s+/);var lines=[];var line=words.shift();words.forEach(function(word){var next=line+' '+word;if(next.length*avgCharSize>props.maxWidth){lines.push(line);line=word;}else{line=next;}});lines.push(line);return lines;},breakAll:function(text,props){var node=text.node();var computedWidth=node.getComputedTextLength();var avgCharSize=(computedWidth/text.text().length);var maxWordLength=Math.ceil(props.maxWidth/avgCharSize)-props.wordBreakSeparator.length;var lines=[];var words=text.text().split(/\s+/);var line='';words.forEach(function(word){if(word.length>maxWordLength){if(line){lines.push(line);}
line=word;while(line.length>maxWordLength){lines.push(line.substring(0,maxWordLength)+props.wordBreakSeparator);line=line.substring(maxWordLength);}}else if(line){var next=line+' '+word;if(next.length*avgCharSize>props.maxWidth){lines.push(line);line=word;}else{line=next;}}else{line=word;}});lines.push(line);return lines;},draw:function(node,datum,i){var props=this.props();var text=d3.select(node);var lines=props.breakAll?this.breakAll(text,props):this.breakWord(text,props);if(lines.length>1){text.text("").selectAll("tspan").data(lines).join("tspan").text(function(d){return d;}).attr("x",0).attr("dy",function(d,i){return i===0?null:props.lineHeight;});}}});creme.d3TextWrap=function(options){return creme.d3Drawable({instance:new creme.D3TextWrap(options),props:['lineHeight','maxWidth','wordBreakSeparator','breakAll']});};}(jQuery));(function($){"use strict";creme.D3Scroll=creme.D3Drawable.sub({defaultProps:{target:null,bounds:{top:0,left:0,width:0,height:0},innerSize:{width:0,height:0},wheelScale:0.1,disabled:false,wheelScrollDelta:function(e,props){return{x:-e.deltaY*props.wheelScale,y:0};}},setup:function(node,datum,i){var self=this;var zoom=this.zoom=d3.zoom();var props=this.props();var container=d3.select(node);var target=(Object.isString(props.target)?container.select(props.target):props.target)||container;zoom.on("zoom.wheel",null).on("zoom",function(e){if(!self.prop('disabled')){target.attr("transform",creme.svgTransform().translate(e.transform.x,e.transform.y));}});target.on('wheel',function(e){var wheelScrollDelta=self.prop('wheelScrollDelta');if(!self.prop('disabled')&&wheelScrollDelta){e.preventDefault();e.stopPropagation();var delta=wheelScrollDelta(e,props);container.call(zoom.translateBy,delta.x,delta.y);}});container.call(zoom);},draw:function(node,datum,i){var props=this.props();var container=d3.select(node);var bounds=props.bounds;var zoom=this.zoom;var target=(Object.isString(props.target)?container.select(props.target):props.target)||container;if(!this.zoom){this.setup(node,datum,i);zoom=this.zoom;}
zoom.extent([[0,0],[bounds.width+bounds.left,bounds.height+bounds.top]]).scaleExtent([1,1]).translateExtent([[0,0],[props.innerSize.width+bounds.left,props.innerSize.height+bounds.top]]);container.call(zoom.transform,d3.zoomIdentity);target.attr("transform",creme.svgTransform().translate(0,0));}});creme.d3Scroll=function(options){return creme.d3Drawable({instance:new creme.D3Scroll(options),props:['target','bounds','innerSize','wheelScale','wheelScrollDelta','disabled'],methods:['setup']});};}(jQuery));(function($){"use strict";creme.D3AreaChart=creme.D3Chart.sub({defaultProps:{xaxisSize:30,yaxisSize:20,margin:0,visible:true},_init_:function(options){this._super_(creme.D3Chart,'_init_',options);},_draw:function(sketch,data,props){var svg=sketch.svg();var chart=svg.select(".area-chart");if(chart.size()===0){chart=svg.append("g").attr('class','area-chart d3-chart');chart.append("path").attr("class","area");chart.append('g').attr('class','x axis');chart.append("g").attr("class","y axis");}
chart.classed('not-visible',!props.visible);this._updateChart(sketch,chart,data,props);return this;},_updateChart:function(sketch,chart,data,props){var bounds=creme.svgBounds(sketch.size(),{left:props.xaxisSize,bottom:props.yaxisSize},props.margin);var ymax=d3.max(data,function(d){return d.y;})||1;var xscale=d3.scaleBand().domain(data.map(function(d){return d.x;})).rangeRound([0,bounds.width],0.1);var yscale=d3.scaleLinear().domain([0,ymax]).range([bounds.height,0]);var area=d3.area().x(function(d){return xscale(d.x);}).y0(bounds.height).y1(function(d){return yscale(d.y);});chart.attr('transform',creme.svgTransform().translate(bounds.left,bounds.top));chart.selectAll('.x.axis').attr('transform',creme.svgTransform().translate(0,bounds.height)).call(d3.axisBottom(xscale).tickSizeOuter(0));chart.selectAll('.y.axis').call(d3.axisLeft(yscale).tickSizeOuter(0));chart.selectAll(".area").datum(data).attr("d",area);}});}(jQuery));(function($){"use strict";creme.D3BarChart=creme.D3Chart.sub({defaultProps:{xAxisSize:25,xAxisTitle:'',yAxisSize:30,yAxisTitle:'',yAxisTickFormat:null,barMinWidth:60,colors:"#4682b4",barTextFormat:null,limits:[],margin:0,transition:true,visible:true,xScroll:null,overflow:false},_init_:function(options){this._super_(creme.D3Chart,'_init_',options);},exportStyle:function(props){return creme.svgRulesAsCSS({".bar-chart":{font:"10px sans-serif"},".bar-chart .bar rect":{"shape-rendering":"crispedges"},".bar-chart .bar.selected rect":{"opacity":"0.8"},".bar-chart .bar text":{"text-anchor":"middle"},".bar-chart .bar text.inner.dark-bg":{"font-weight":600},".bar-chart .bar text.outer":{"fill":"black"},".bar-chart .limit":{stroke:"#f6c2d4","z-index":1}});},exportOptions:function(data,options,props){if(props.overflow){var margin=props.margin?props.margin.left+props.margin.right:0;var width=(data.length*props.barMinWidth)+props.yAxisSize+margin;return{width:Math.max(width,options.width||0)};}
return{};},exportProps:function(){return{transition:false,drawOnResize:false,xScroll:false,overflow:true};},_draw:function(sketch,data,props){var svg=sketch.svg();var chart=svg.select(".bar-chart");if(chart.size()===0){chart=svg.append('g').attr('class','bar-chart d3-chart');this._setupChart(sketch,chart,props);}
chart.classed('not-visible',!props.visible);this._updateChart(sketch,chart,data,props);},chartData:function(data){return data.map(function(d,i){return{index:i,x:d.x,y:d.y,color:d.color,data:d};});},_setupChart:function(sketch,chart,props){var body=chart.append('g').attr('class','x-scroll-body');body.append('g').attr('class','x axis');body.append('g').attr('class','bars');chart.append('g').attr('class','limits');chart.append("g").attr("class","y axis");this.scroll=creme.d3Scroll().target(body);},_updateChart:function(sketch,chart,data,props){var bounds=creme.svgBounds(sketch.size(),props.margin);var xScroll=props.xScroll;var overflow=props.overflow;data=this.chartData(data);var yDataInfo=creme.d3NumericDataInfo(data,function(d){return d.y;});var ymax=yDataInfo.max||1;var yAxisFontSize=creme.d3FontSize(chart.select('.y.axis'));var barTextFormat=props.barTextFormat||creme.d3NumericFormat(yDataInfo);var yAxisTickFormat=props.yAxisTickFormat||creme.d3NumericAxisFormat(yDataInfo);var yAxisTitleHeight=yAxisFontSize*2;var yAxisSize=Math.max(props.yAxisSize,6+(yAxisFontSize*3));var colorize=creme.d3Colorize().scale(d3.scaleOrdinal().domain([0,data.length]).range(creme.d3ColorRange(props.colors,{size:data.length})));data=colorize(data);chart.attr('transform',creme.svgTransform().translate(bounds.left,bounds.top));bounds=creme.svgBounds(bounds,{left:yAxisSize});if(xScroll===null){xScroll=Boolean(props.barMinWidth*data.length>bounds.width);overflow=xScroll;}
var xAxisWidth=overflow?Math.max(props.barMinWidth*data.length,bounds.width):bounds.width;chart.classed('x-scroll',xScroll);var xscale=d3.scaleBand().domain(data.map(function(d){return d.x;})).range([0,xAxisWidth],0.1).padding(0.1);chart.select('.x.axis').call(creme.d3BottomAxis().scale(xscale).minHeight(props.xAxisSize).tickWrapWidth(xscale.bandwidth()).label(props.xAxisTitle)).attr('transform',function(){return creme.svgTransform().translate(yAxisSize,bounds.height-Math.floor(this.getBBox().height));});var xAxisHeight=Math.floor(chart.select('.x.axis').node().getBBox().height);bounds=creme.svgBounds(bounds,{bottom:xAxisHeight,top:yAxisTitleHeight});var yscale=d3.scaleLinear();yscale.domain([0,ymax]).range([bounds.height,0]);chart.selectAll('.y.axis').attr('transform',creme.svgTransform().translate(yAxisSize,yAxisTitleHeight)).call(creme.d3LeftAxis().fill('#fff').scale(yscale).tickFormat(yAxisTickFormat).ticks(yDataInfo.integer?Math.min(yDataInfo.gap,8):8).label(props.yAxisTitle));var items=chart.select('.bars').attr('transform',creme.svgTransform().translate(yAxisSize,yAxisTitleHeight)).selectAll('.bar').data(data);var context={bounds:bounds,xscale:xscale,yscale:yscale,textformat:barTextFormat};this._enterBar(items.enter(),context);this._updateBar(props.transition?items.transition():items,context);items.exit().remove();if(props.limits){var limits=creme.d3LimitStack().bounds(bounds).scale(yscale).data(props.limits);chart.select('.limits').call(limits);}
this.scroll.bounds(bounds).disabled(!xScroll).innerSize({width:xAxisWidth});sketch.svg().call(this.scroll);return chart;},_enterBar:function(enter,context){var selection=this.selection();var xscale=context.xscale;var yscale=context.yscale;var textformat=context.textformat;var bounds=context.bounds;function isInnerText(d){return(bounds.height-yscale(d.y))>15;}
var bar=enter.append('g').attr('class','bar').classed('selected',function(d){return d.data.selected;}).attr('transform',function(d){return creme.svgTransform().translate(xscale(d.x),yscale(d.y));});bar.append('rect').attr('x',1).attr('width',xscale.bandwidth()).attr('height',function(d){return bounds.height-yscale(d.y);}).attr("fill",function(d){return d.color;}).on('click',function(e,d){selection.select(d.index);});bar.append('text').classed('dark-bg',function(d){return d.isDarkColor;}).attr('dy','.75em').attr('class',function(d){return isInnerText(d)?(d.isDarkColor?'inner dark-bg':'inner'):'outer';}).attr('fill',function(d){return d.textColor;}).attr('y',function(d){return isInnerText(d)?6:-12;}).attr('x',Math.ceil(xscale.bandwidth()/2)).text(function(d){return textformat(d.y);});},_updateBar:function(update,context){var xscale=context.xscale;var yscale=context.yscale;var textformat=context.textformat;var bounds=context.bounds;function isInnerText(d){return(bounds.height-yscale(d.y))>15;}
update.selection().classed('selected',function(d){return d.data.selected;});update.attr('transform',function(d){return creme.svgTransform().translate(xscale(d.x),yscale(d.y));});update.select('rect').attr("fill",function(d){return d.color;}).attr('width',xscale.bandwidth()).attr('height',function(d){return bounds.height-yscale(d.y);});update.select('text').attr('class',function(d){return isInnerText(d)?(d.isDarkColor?'inner dark-bg':'inner'):'outer';}).attr('fill',function(d){return d.textColor;}).attr('y',function(d){return isInnerText(d)?6:-12;}).attr('x',Math.ceil(xscale.bandwidth()/2)).text(function(d){return textformat(d.y);});}});}(jQuery));(function($){"use strict";creme.D3DonutChart=creme.D3Chart.sub({defaultProps:{band:60,margin:0,colors:creme.d3SpectralColors,textRadius:0.8,textFormat:null,textVisibleMinAngle:Math.PI/12,showLegend:true,transition:true,visible:true,scrollLegend:null,legendItemHeight:25},_init_:function(options){this._super_(creme.D3Chart,'_init_',options);},_draw:function(sketch,data,props){var svg=sketch.svg();var chart=svg.select(".donut-chart");if(chart.size()===0){chart=svg.append("g").attr('class','donut-chart d3-chart');this._setupChart(sketch,chart,props);}
chart.classed('not-visible',!props.visible);this._updateChart(sketch,chart,data,props);return this;},exportProps:function(){return{transition:false,drawOnResize:false,scrollLegend:false};},exportStyle:function(props){return creme.svgRulesAsCSS({".donut-chart":{font:"10px sans-serif"},".donut-chart .arc path":{stroke:"#fff"},".donut-chart .slice .hidden-label":{visibility:"visible"},".donut-chart .slice text.dark-bg":{"font-weight":600}});},chartData:function(data){return data.map(function(d,i){return{index:i,x:d.x,y:d.y,selected:d.selected,color:d.color,data:d};});},_setupChart:function(sketch,chart,props){chart.append('g').attr('class','slices');chart.append('g').attr('class','legend');this.scroll=creme.d3Scroll();},_updateChart:function(sketch,chart,data,props){var scrollLegend=props.scrollLegend;var bounds=creme.svgBounds(sketch.size(),props.margin);var colors=creme.d3ColorRange(props.colors,{size:data.length});var textFormat=props.textFormat||creme.d3NumericFormat(creme.d3NumericDataInfo(data,function(d){return d.y;}));data=this.chartData(data);var colorScale=d3.scaleOrdinal().domain([0,data.length]).range(creme.d3ColorRange(colors));var colorize=creme.d3Colorize().scale(colorScale);var pielayout=d3.pie().sort(null).value(function(d){return d.y;});if(props.showLegend){var legends=creme.d3LegendColumn().swatchColor(function(d){return d.color;}).swatchSize({width:20,height:props.legendItemHeight}).spacing(0).text(function(d){return d.x;}).data(data);chart.select('.legend').attr("transform",creme.svgTransform().translate(bounds.left,bounds.top)).call(legends);bounds=creme.svgBounds(bounds,{left:chart.select('.legend').node().getBBox().width});if(scrollLegend===null){scrollLegend=Boolean(props.legendItemHeight*data.length>bounds.height);}
chart.select('.legend').classed('legend-scroll',scrollLegend);}
var radius=creme.svgBoundsRadius(bounds);var arcpath=d3.arc().innerRadius(props.band>0?Math.max(0,radius-props.band):0).outerRadius(radius);var textArc=d3.arc().innerRadius(radius*props.textRadius).outerRadius(radius*props.textRadius);chart.select('.slices').attr("transform",creme.svgTransform().translate(bounds.left+(bounds.width/2),bounds.top+(bounds.height/2)));data=colorize(data);data=pielayout(data.filter(function(d){return d.y>0;}));var items=chart.select('.slices').selectAll('.slice').data(data);var context={arcpath:arcpath,textArc:textArc,textVisibleMinAngle:props.textVisibleMinAngle,formatValue:textFormat,transition:props.transition};this._enterItem(items.enter(),context);this._updateItem(props.transition?items.transition():items,context);items.exit().remove();if(props.showLegend&&scrollLegend){var legend=chart.select('.legend');var legendHeight=legend.node().getBBox().height;this.scroll.bounds(bounds).disabled(false).innerSize({height:legendHeight}).wheelScrollDelta(function(e,props){return{x:0,y:-e.deltaY*props.wheelScale};});legend.call(this.scroll);}else{this.scroll.disabled(true);}
return chart;},itemClasses:function(d,context){var classes=[];if(Math.abs(d.startAngle-d.endAngle)<context.textVisibleMinAngle){classes.push('hidden-label');}
if(d.data.isDarkColor){classes.push('dark-bg');}
return classes.join(' ');},_enterItem:function(item,context){var self=this;var selection=this.selection();var arcpath=context.arcpath;var formatValue=context.formatValue;var textArc=context.textArc;var arc=item.append('g').attr('class','slice').classed('selected',function(d){return d.data.selected;});arc.append("path").attr('d',arcpath).attr("fill",function(d){return d.data.color;}).on('click',function(e,d){selection.select(d.data.index);});arc.append("text").attr("dy",".35em").style("text-anchor","middle").text(function(d){return formatValue(d.data.y);}).attr("transform",function(d){var pos=textArc.centroid(d);return creme.svgTransform().translate(pos[0],pos[1]);}).attr('class',function(d){return self.itemClasses(d,context);}).attr('fill',function(d){return d.data.textColor;}).classed('dark-bg',function(d){return d.data.isDarkColor;});},_updateItem:function(item,context){var self=this;var arcpath=context.arcpath;var formatValue=context.formatValue;var textArc=context.textArc;function arcTween(d){this._current=this._current||d;var interpolate=d3.interpolate(this._current,d);this._current=interpolate(0);return function(t){return arcpath(interpolate(t));};};item.selection().classed('selected',function(d){return d.data.selected;});if(context.transition){item.select('path').attrTween("d",arcTween);}else{item.select('path').attr("d",arcpath);}
item.select('path').attr("fill",function(d){return d.data.color;});item.select("text").text(function(d){return formatValue(d.data.y);}).attr("transform",function(d){var pos=textArc.centroid(d);return creme.svgTransform().translate(pos[0],pos[1]);}).attr('fill',function(d){return d.data.textColor;}).attr('class',function(d){return self.itemClasses(d,context);});}});}(jQuery));(function($){"use strict";creme.D3LineChart=creme.D3Chart.sub({defaultProps:{xAxisSize:25,xAxisTitle:'',yAxisSize:30,yAxisTitle:'',yAxisTickFormat:null,minDotInterval:40,colors:"#4682b4",lineColors:"#4682b4",lineStroke:2,limits:[],margin:0,transition:true,visible:true,xScroll:null,overflow:false,showTooltip:true,tooltipDirection:'n',tooltipHtml:function(e,d){return d.y;},showDots:true,dotVisibility:'unit',dotRadius:5},_init_:function(options){this._super_(creme.D3Chart,'_init_',options);},exportStyle:function(props){return creme.svgRulesAsCSS({".line-chart":{font:"10px sans-serif"},".line-chart .dot":{"fill":"currentColor","stroke-width":0},".line-chart .line path":{"fill":"none","stroke-width":1.5},".line-chart .limit":{stroke:"#f6c2d4","z-index":1}});},exportProps:function(){return{transition:false,drawOnResize:false,xScroll:false,overflow:true,showTooltip:false,dotVisibility:'always',isExport:true};},_draw:function(sketch,data,props){var svg=sketch.svg();var chart=svg.select(".line-chart");if(chart.size()===0){chart=svg.append('g').attr('class','line-chart d3-chart');this._setupChart(sketch,chart,props);}
chart.classed('not-visible',!props.visible);this._updateChart(sketch,chart,data,props);},chartData:function(data){return data.map(function(d,i){return{index:i,x:d.x,y:d.y,color:d.color,data:d};});},_setupChart:function(sketch,chart,props){var body=chart.append('g').attr('class','x-scroll-body');body.append('g').attr('class','x axis');body.append('g').attr('class','lines');chart.append('g').attr('class','limits');chart.append("g").attr("class","y axis");this.scroll=creme.d3Scroll().target(body);},_updateChart:function(sketch,chart,data,props){var bounds=creme.svgBounds(sketch.size(),props.margin);var xScroll=props.xScroll;var overflow=props.overflow;data=this.chartData(data);var yDataInfo=creme.d3NumericDataInfo(data,function(d){return d.y;});var ymax=yDataInfo.max||1;var yAxisFontSize=creme.d3FontSize(chart.select('.y.axis'));var yAxisTickFormat=props.yAxisTickFormat||creme.d3NumericAxisFormat(yDataInfo);var yAxisTitleHeight=yAxisFontSize*2;var yAxisSize=Math.max(props.yAxisSize,6+(yAxisFontSize*3));var colorize=creme.d3Colorize().scale(d3.scaleOrdinal().domain([0,data.length]).range(creme.d3ColorRange(props.colors,{size:data.length})));var lineColors=d3.scaleOrdinal().domain([0,data.length]).range(creme.d3ColorRange(props.lineColors,{size:data.length}));data=colorize(data);chart.attr('transform',creme.svgTransform().translate(bounds.left,bounds.top));bounds=creme.svgBounds(bounds,{left:yAxisSize});if(xScroll===null){xScroll=Boolean(props.minDotInterval*data.length>bounds.width);overflow=xScroll;}
var xAxisWidth=overflow?Math.max(props.minDotInterval*data.length,bounds.width):bounds.width;chart.classed('x-scroll',xScroll);var xscale=d3.scalePoint().domain(data.map(function(d){return d.x;})).range([0,xAxisWidth-(props.minDotInterval*0.6)-3]).round(true).padding(0.1).align(0.5);chart.select('.x.axis').call(creme.d3BottomAxis().scale(xscale).minHeight(props.xAxisSize).tickWrapWidth(xscale.step()).label(props.xAxisTitle)).attr('transform',function(){return creme.svgTransform().translate(yAxisSize-1,bounds.height-Math.floor(this.getBBox().height));});var xAxisHeight=Math.floor(chart.select('.x.axis').node().getBBox().height);bounds=creme.svgBounds(bounds,{bottom:xAxisHeight,top:yAxisTitleHeight});var yscale=d3.scaleLinear();yscale.domain([0,ymax]).range([bounds.height,0]);chart.selectAll('.y.axis').attr('transform',creme.svgTransform().translate(yAxisSize,yAxisTitleHeight)).call(creme.d3LeftAxis().fill(overflow?'#fff':'none').scale(yscale).tickFormat(yAxisTickFormat).ticks(yDataInfo.integer?Math.min(yDataInfo.gap,8):8).label(props.yAxisTitle));var linepath;if(data.length===1){linepath=function(data){var posy=yscale(data[0].y);var posx=xscale(data[0].x);return'M0,0C'+[0,posy,posx,posy,xAxisWidth-(props.minDotInterval*0.6)-3,posy].join(',');};}else{linepath=d3.line().curve(d3.curveMonotoneX).x(function(d){return xscale(d.x);}).y(function(d){return yscale(d.y);});}
var context={props:props,bounds:bounds,xscale:xscale,yscale:yscale,linepath:linepath,lineColors:lineColors};if(props.showTooltip){context.tooltip=creme.d3Tooltip().direction(props.tooltipDirection).on('show',function(e,d){e.container.style('background',d.color).style('color',d.textColor);}).html(props.tooltipHtml);}
var lines=chart.select('.lines').attr('transform',creme.svgTransform().translate(yAxisSize,yAxisTitleHeight)).selectAll('.line').data([data]);this._enterLine(lines.enter(),context);this._updateLine(props.transition?lines.transition():lines,context);lines.exit().remove();if(props.showDots){if(props.dotVisibility==='unit'){var scale=xscale.invert?xscale:d3.scaleLinear([0,data.length],xscale.range());var node=chart.select('.lines').node();chart.select('.lines').attr('pointer-events','bounding-box').on('mousemove',function(e){var rect=node.getBoundingClientRect();var pos=Math.floor(scale.invert(e.clientX-rect.left-node.clientLeft));chart.selectAll('.dot').each(function(d,index){d3.select(this).classed('dot-unit-hilight',index===pos);});}).on('mouseleave',function(e){chart.selectAll('.dot').classed('dot-unit-hilight',false);});}
var dots=lines.selectAll('.dot').data(function(d){return d;});this._enterDot(dots.enter(),context);this._updateDot(props.transition?dots.transition():dots,context);dots.exit().remove();}
if(props.limits){var limits=creme.d3LimitStack().bounds(bounds).scale(yscale).data(props.limits);chart.select('.limits').call(limits);}
this.scroll.bounds(bounds).disabled(!xScroll).innerSize({width:xAxisWidth});sketch.svg().call(this.scroll);return chart;},_enterLine:function(enter,context){var props=context.props;var line=enter.append('g').attr('class','line');line.append('path').datum(function(d){return d;}).attr("fill","none").attr("stroke",function(d,i){return context.lineColors(i);}).attr("stroke-width",props.lineStroke).attr("d",context.linepath);if(props.showDots){var dots=line.selectAll('.dot').data(function(d){return d;});this._enterDot(dots.enter(),context);}
return enter;},_updateLine:function(update,context){update.select('path').attr("d",context.linepath);},_enterDot:function(enter,context){var selection=this.selection();var props=context.props;var dot=enter.append('circle').attr('color',function(d){return d.color;}).attr('cx',function(d){return context.xscale(d.x);}).attr('cy',function(d){return context.yscale(d.y);}).attr('class',['dot','dot-'+props.dotVisibility].join(' ')).attr('r',props.dotRadius).attr('stroke',function(d){return d3.select(this.parentNode.querySelector('path')).attr('stroke');});dot.on('click',function(e,d){selection.select(d.index);});if(context.tooltip){dot.on('mouseenter',context.tooltip.show).on('mouseleave',context.tooltip.hide);};},_updateDot:function(update,context){var props=context.props;update.attr('fill',function(d){return d.color;}).attr('cx',function(d){return context.xscale(d.x);}).attr('cy',function(d){return context.yscale(d.y);}).attr('class',['dot','dot-'+props.dotVisibility].join(' ')).attr('r',props.dotRadius);}});}(jQuery));(function($){"use strict";creme.D3GroupBarChart=creme.D3Chart.sub({defaultProps:{xaxisSize:30,yaxisSize:20,showLegend:true,legendSize:40,limits:[],limitColor:'#000',barTextColor:'#fff',barTextFormat:function(d){return d3.format(",.0f")(d.y);},margin:0,colors:["#98abc5","#8a89a6","#7b6888","#6b486b","#a05d56","#d0743c","#ff8c00"],transition:true,groupId:function(d){return d.group;},visible:true},_init_:function(options){this._super_(creme.D3Chart,'_init_',options);},exportStyle:function(props){return creme.svgRulesAsCSS({".legend":{font:"10px sans-serif","text-anchor":"end"},".legend-item text":{"text-anchor":"middle"},".group-bar-chart":{font:"10px sans-serif"},".group-bar-chart .bar text":{"text-anchor":"middle"},".group-bar-chart .bar text.inner":{fill:props.barTextColor}});},_draw:function(sketch,data,props){var svg=sketch.svg();var chart=svg.select(".group-bar-chart");if(chart.size()===0){chart=svg.append("g").attr('class','group-bar-chart d3-chart');chart.append('g').attr('class','x axis');chart.append("g").attr("class","y axis");chart.append('g').attr('class','groups');chart.append('g').attr('class','limits');svg.append('g').attr('class','legend');}
chart.classed('not-visible',!props.visible);this._updateChart(sketch,chart,data,props);},_updateChart:function(sketch,chart,data,props){var bounds=creme.svgBounds(sketch.size(),{left:props.xaxisSize,bottom:props.yaxisSize,top:props.showLegend?props.legendSize:0},props.margin);var ymax=d3.max(data,function(d){return d.y;})||1;var groupdata=this.hierarchy(data,props);var xkeys=Array.from(new Set(data.map(function(d){return d.x;})));var groupscale=d3.scaleBand().domain(groupdata.map(function(d){return d.group;})).rangeRound([0,bounds.width]).paddingInner(0.1);var yscale=d3.scaleLinear().domain([0,ymax]).range([bounds.height,0]);var xscale=d3.scaleBand().domain(data.map(function(d){return d.x;})).rangeRound([0,groupscale.bandwidth()]).padding(0.05);chart.attr('transform',creme.svgTransform().translate(bounds.left,bounds.top));chart.selectAll('.x.axis').attr('transform',creme.svgTransform().translate(0,bounds.height)).call(d3.axisBottom(groupscale).tickSizeOuter(0)).call(function(g){g.select(".domain").remove();});chart.selectAll('.y.axis').call(d3.axisLeft(yscale).tickSizeOuter(0));var context={xscale:xscale,yscale:yscale,groupscale:groupscale,text:props.barTextFormat,bounds:bounds,color:d3.scaleOrdinal().range(props.colors),transition:props.transition};var groups=chart.select('.groups').selectAll('.group').data(groupdata);this._enterGroup(groups.enter(),context);this._updateGroup(groups,context);groups.exit().remove();if(props.showLegend){var legends=creme.d3LegendRow().swatchColor(context.color).swatchSize({width:36,height:19}).data(xkeys.sort());sketch.svg().select('.legend').call(legends);}
if(props.limits){var limits=creme.d3LimitStack().bounds(bounds).color(props.limitColor).scale(yscale).data(props.limits);chart.select('.limits').call(limits);}
return chart;},hierarchy:function(data,props){var groupId=props.groupId;var stack={};data.forEach(function(d,i){var group=groupId(d);stack[group]=(stack[group]||[]);stack[group].push({x:d.x,y:d.y,index:i,data:d});});return Object.entries(stack).map(function(entry){return{group:entry[0],items:entry[1]};});},_enterGroup:function(groups,context){var bars=groups.append('g').attr('class','group').attr('transform',function(d){return creme.svgTransform().translate(context.groupscale(d.group)||0,0);}).selectAll('.bar').data(function(d){return d.items;});this._enterBar(bars.enter(),context);},_updateGroup:function(groups,context){groups.attr('transform',function(d){return creme.svgTransform().translate(context.groupscale(d.group)||0,0);});var bars=groups.selectAll('.bar').data(function(d){return d.items;});this._enterBar(bars.enter(),context);this._updateBar(context.transition?bars.transition():bars,context);bars.exit().remove();},_enterBar:function(bars,context){var selection=this.selection();var xscale=context.xscale;var yscale=context.yscale;var bounds=context.bounds;var colorscale=context.color;var bar=bars.append('g').attr('class','bar').classed('selected',function(d){return d.data.selected;}).attr('transform',function(d){return creme.svgTransform().translate(xscale(d.x)||0,yscale(d.y));});bar.append('rect').attr('x',1).attr('width',xscale.bandwidth()).attr('height',function(d){return bounds.height-yscale(d.y);}).attr("fill",function(d){return colorscale(d.x);}).on('click',function(e,d){selection.select(d.index);});bar.append('text').attr('dy','0.75em').attr('class',function(d){return(bounds.height-yscale(d.y))>15?'inner':'outer';}).attr('y',function(d){return(bounds.height-yscale(d.y))>15?6:-12;}).attr('x',Math.ceil(xscale.bandwidth()/2)).text(context.text);return bar;},_updateBar:function(bar,context){var xscale=context.xscale;var yscale=context.yscale;var bounds=context.bounds;var color=context.color;bar.selection().classed('selected',function(d){return d.data.selected;});bar.attr('transform',function(d){return creme.svgTransform().translate(xscale(d.x)||0,yscale(d.y));});bar.select('rect').attr('width',xscale.bandwidth()).attr('height',function(d){return bounds.height-yscale(d.y);}).attr("fill",function(d){return color(d.x);});bar.select('text').attr('class',function(d){return(bounds.height-yscale(d.y))>15?'inner':'outer';}).attr('y',function(d){return(bounds.height-yscale(d.y))>15?6:-12;}).attr('x',Math.ceil(xscale.bandwidth()/2)).text(context.text);}});}(jQuery));(function($){"use strict";creme.D3StackBarChart=creme.D3Chart.sub({defaultProps:{xaxisSize:30,yaxisSize:20,showLegend:true,legendSize:40,limits:[],limitColor:'#000',barTextColor:'#fff',barTextFormat:function(d){return d3.format(",.0f")(d.y);},margin:0,colors:["#98abc5","#8a89a6","#7b6888","#6b486b","#a05d56","#d0743c","#ff8c00"],transition:true,groupId:function(d){return d.group;},visible:true},_init_:function(options){this._super_(creme.D3Chart,'_init_',options);},exportStyle:function(props){return creme.svgRulesAsCSS({".legend":{font:"10px sans-serif","text-anchor":"end"},".legend-item text":{"text-anchor":"middle"},".stack-bar-chart":{font:"10px sans-serif"},".stack-bar-chart .bar text":{"text-anchor":"middle"},".stack-bar-chart .bar text.inner":{fill:props.barTextColor},".stack-bar-chart .bar text.outer":{display:"none"}});},_draw:function(sketch,data,props){var svg=sketch.svg();var chart=svg.select(".stack-bar-chart");if(chart.size()===0){chart=svg.append("g").attr('class','stack-bar-chart d3-chart');chart.append('g').attr('class','x axis');chart.append("g").attr("class","y axis");chart.append('g').attr('class','stacks');chart.append('g').attr('class','limits');svg.append('g').attr('class','legend');}
chart.classed('not-visible',!props.visible);this._updateChart(sketch,chart,data,props);},_updateChart:function(sketch,chart,data,props){var bounds=creme.svgBounds(sketch.size(),{left:props.xaxisSize,bottom:props.yaxisSize,top:props.showLegend?props.legendSize:0},props.margin);var xkeys=Array.from(new Set(data.map(function(d){return d.x;})));var stackdata=this.hierarchy(data,props);var ymax=d3.max(stackdata,function(d){return d.items.reduce(function(a,d){return a+d.y;},0);})||1;var stackscale=d3.scaleBand().domain(stackdata.map(function(d){return d.group;})).rangeRound([0,bounds.width]).paddingInner(0.1);var yscale=d3.scaleLinear().domain([0,ymax]).range([bounds.height,0]).nice();var color=d3.scaleOrdinal().range(props.colors);chart.attr('transform',creme.svgTransform().translate(bounds.left,bounds.top));chart.selectAll('.x.axis').attr('transform',creme.svgTransform().translate(0,bounds.height)).call(d3.axisBottom(stackscale).tickSizeOuter(0));chart.selectAll('.y.axis').call(d3.axisLeft(yscale).tickSizeOuter(0));var context={yscale:yscale,stackscale:stackscale,xkeys:xkeys,color:color,text:props.barTextFormat,transition:props.transition};var stacks=chart.select('.stacks').selectAll('.stack').data(stackdata);this._enterStack(stacks.enter(),context);this._updateStack(stacks,context);stacks.exit().remove();if(props.showLegend){var legends=creme.d3LegendRow().swatchColor(context.color).swatchSize({width:36,height:19}).data(xkeys.sort());sketch.svg().select('.legend').call(legends);}
if(props.limits){var limits=creme.d3LimitStack().bounds(bounds).color(props.limitColor).scale(yscale).data(props.limits);chart.select('.limits').call(limits);}
return chart;},hierarchy:function(data,props){var groupId=props.groupId;var stack={};data.forEach(function(d,i){var group=groupId(d);stack[group]=(stack[group]||[]);stack[group].push({x:d.x,y:d.y,index:i,data:d});});for(var group in stack){var acc=0;stack[group].forEach(function(d,i,items){var prevY=i>0?items[i-1].y:0;acc+=prevY;d.startY=acc;d.endY=acc+d.y;});}
return Object.entries(stack).map(function(entry){return{group:entry[0],items:entry[1]};});},_enterStack:function(stacks,context){var bars=stacks.append('g').attr('class','stack').attr('transform',function(d){return creme.svgTransform().translate(context.stackscale(d.group)||0,0);}).selectAll('.bar').data(function(d){return d.items;});this._enterBar(bars.enter(),context);},_updateStack:function(stacks,context){stacks.attr('transform',function(d){return creme.svgTransform().translate(context.stackscale(d.group)||0,0);});var bars=stacks.selectAll('.bar').data(function(d){return d.items;});this._enterBar(bars.enter(),context);this._updateBar(context.transition?bars.transition():bars,context);bars.exit().remove();},_enterBar:function(bars,context){var selection=this.selection();var yscale=context.yscale;var color=context.color;var bar=bars.append('g').attr('class','bar').classed('selected',function(d){return d.data.selected;}).attr('transform',function(d){return creme.svgTransform().translate(0,yscale(d.endY));});bar.append('rect').attr('x',1).attr('title',context.text).attr('width',context.stackscale.bandwidth()).attr('height',function(d){return yscale(d.startY)-yscale(d.endY);}).attr("fill",function(d){return color(d.x);}).on('click',function(e,d){selection.select(d.index);});bar.append('text').attr('dy','0.75em').attr('class',function(d){return(yscale(d.startY)-yscale(d.endY))>16?'inner':'outer';}).attr('y',6).attr('x',Math.ceil(context.stackscale.bandwidth()/2)).text(context.text);return bar;},_updateBar:function(bar,context){var yscale=context.yscale;var color=context.color;bar.selection().classed('selected',function(d){return d.data.selected;});bar.attr('transform',function(d){return creme.svgTransform().translate(0,yscale(d.endY));});bar.select('rect').attr('title',context.text).attr('width',context.stackscale.bandwidth()).attr('height',function(d){return yscale(d.startY)-yscale(d.endY);}).attr("fill",function(d){return color(d.x);});bar.select('text').attr('class',function(d){return(yscale(d.startY)-yscale(d.endY))>16?'inner':'outer';}).attr('y',6).attr('x',Math.ceil(context.stackscale.bandwidth()/2)).text(context.text);}});}(jQuery));(function($){"use strict";creme.persons=creme.persons||{};creme.persons.copyAddressInputs=function(source_prefix,target_prefix,source_root,target_root){if(target_root===undefined){target_root=source_root;}
source_root.find('input, textarea, select').filter('[name|='+source_prefix+']').each(function(){target_root.find('input, textarea, select').filter('[name='+$(this).attr('name').replace(source_prefix,target_prefix)+']').val($(this).val());});};creme.persons.BecomeAction=creme.component.Action.sub({_init_:function(options){this._super_(creme.component.Action,'_init_',this._run,options);},_saveRelationship:function(options,selected){var self=this;var url=options.url;if(Object.isEmpty(url)){url=$('body').attr('data-save-relations-url');}
creme.utils.ajaxQuery(url,{action:'post',warnOnFail:true},{subject_id:options.subject,predicate_id:options.rtype,entities:selected}).onFail(function(event,message){self.fail(message);}).onDone(function(){self.done();}).start();},_run:function(options){options=$.extend({},this._options,options||{});var self=this;var organisations=options.organisations||[];if(Object.isEmpty(organisations)){this.cancel();return;}
if(organisations.length>1){creme.dialogs.choice(gettext('Select the concerned organisation.'),{required:true,choices:organisations,title:gettext('Organisation')}).onOk(function(event,selected){self._saveRelationship(options,selected);}).onClose(function(event,data){self.cancel();}).open();}else{this._saveRelationship(options,organisations[0].value);}}});var hatmenubarActions={'persons-hatmenubar-become':function(url,options,data,e){var action=new creme.persons.BecomeAction({url:url,subject:data.subject_id,rtype:data.rtype_id,organisations:data.organisations});return action.onDone(this._refreshBrick.bind(this));}};$(document).on('brick-setup-actions','.creme_core-buttons-brick',function(e,brick,actions){actions.registerAll(hatmenubarActions);});}(jQuery));(function($){"use strict";creme.activities=creme.activities||{};creme.activities.ExportAsICalAction=creme.component.Action.sub({_init_:function(list,options){this._super_(creme.component.Action,'_init_',this._run,options);this._list=list;},_run:function(options){options=$.extend({},this.options(),options||{});var self=this;var selection=this._list.selectedRows();if(selection.length<1){creme.dialogs.warning(gettext('Please select at least a line in order to export.')).onClose(function(){self.cancel();}).open();}else{self.done();creme.utils.goTo(options.url,{id:selection});}}});$(document).on('listview-setup-actions','.ui-creme-listview',function(e,actions){actions.register('activities-export-ical',function(url,options,data,e){return new creme.activities.ExportAsICalAction(this._list,{url:url});});});}(jQuery));(function($){"use strict";function isStartOfDay(value){return value.toArray().slice(3,6).join('')==='000';}
function eventMomentFormatter(options){options=options||{};var timeFormat=options.time||'H[h]mm';var dayFormat=options.datetime||timeFormat;var dateFormat=options.date||'D/MM';return function(info){var locale=info.localeCodes[0];var start=convertToMoment(info.start,info.timeZone,locale);var end=info.end?convertToMoment(info.end,info.timeZone,locale):null;var output;if(end===null){output=isStartOfDay(start)?start.format(dateFormat):start.format(timeFormat);}else if(start.isSame(end,'day')){output=[start.format(timeFormat),end.format(timeFormat)].join(info.defaultSeparator);}else if(isStartOfDay(start)&&isStartOfDay(end)){var days=end?end.diff(start,'days'):0;if(days>1){output=[start.format(dateFormat),end.clone().add(-1,'day').format(dateFormat)].join(info.defaultSeparator);}else{output=start.format(dateFormat);}}else{output=[start.format(dayFormat),end.format(dayFormat)].join(info.defaultSeparator);}
return output;};}
function slotMomentFormatter(format){return function(info){var locale=info.localeCodes[0];var start=convertToMoment(info.start,info.timeZone,locale);return start.format(format);};}
var FULLCALENDAR_SETTINGS={locales:[{code:"fr",buttonText:{today:gettext("Today"),year:gettext("Year"),month:gettext("Month"),week:gettext("Week"),day:gettext("Day"),list:gettext("Calendar")},weekText:gettext("Week"),allDayContent:gettext("All day"),moreLinkContent:gettext("More"),noEventsContent:gettext("No event to display")}],locale:'fr',eventTimeFormat:eventMomentFormatter({time:'H[h]mm',datetime:'D/MM H[h]mm',date:'D/MM'}),headerToolbar:{left:'title',center:'today,prev,next',right:'week,month'},initialView:'month',views:{month:{type:'dayGridMonth',titleFormat:{year:'numeric',month:'long'},dayHeaderFormat:{weekday:'long'}},week:{type:'timeGridWeek',titleFormat:{year:'numeric',month:'long',day:'numeric'},titleRangeSeparator:'  ',dayHeaderFormat:{weekday:'long',day:'numeric',month:'long'},weekNumbers:false},day:{type:'timeGridDay',titleFormat:{weekday:'long',year:'numeric',month:'long',day:'numeric'},dayHeaderFormat:{weekday:'long',day:'numeric',month:'long'}}},timeZone:'UTC',slotMinTime:'00:00:00',slotMaxTime:'24:00:00',scrollTime:'08:00:00',defaultTimedEventDuration:'01:00:00',businessHours:{daysOfWeek:[1,2,3,4,5,6],startTime:'08:00:00',endTime:'18:00:00'},allDaySlot:true,allDayContent:gettext("All day"),slotLabelFormat:slotMomentFormatter("H[h]mm"),slotLabelInterval:'01:00:00',slotDuration:'00:15:00',defaultRangeSeparator:'  ',weekends:true,firstDay:1,fixedWeekCount:true,themeSystem:'standard',aspectRatio:2,expandRows:true,editable:true,selectable:true,dayMaxEventRows:4,dayMaxEvents:true,stickyHeaderDates:true,selectMirror:true,droppable:true,dropAccept:'.floating-event',nowIndicator:true};function convertToMoment(input,timeZone,locale){if(input===null||moment.isMoment(input)){return input;}else{return moment.utc(input);}}
function toISO8601(value,allDay){return allDay?value.format('YYYY-MM-DD'):value.utc().toISOString(true);}
creme.availableFullCalendarViewNames=function(options){options=options||{};var views=Object.assign(FULLCALENDAR_SETTINGS,(options.fullCalendarOptions||options)).views||{};return _.keys(views);};creme.CalendarEventRange=creme.component.Component.sub({_init_:function(options){options=Object.assign({start:moment(),duration:'01:00:00',allDay:false},options||{});this.start=options.start;this.end=options.end;this.allDay=options.allDay;if(Object.isNone(this.end)){this.end=this.start.clone();if(this.allDay){this.end.set({hours:23,minutes:59,seconds:0});}else{this.end.add(moment.duration(options.duration));}}else if(this.allDay){this.end.set({hours:0,minutes:0,seconds:0}).subtract(1,'minutes');}},isSmall:function(){return!this.allDay&&(this.end.diff(this.start)<moment.duration('00:31:00').asMilliseconds());},toString:function(){return'${start}  ${end}${allday}'.template({start:this.start,end:this.end,allday:this.allDay?'[ALLDAY]':''});}});creme.ActivityCalendar=creme.component.Component.sub({_init_:function(element,options){options=Object.assign({allowEventCreate:true,allowEventMove:true,allowEventOverlaps:true,defaultView:'month',externalEventData:_.noop,eventUpdateUrl:'',eventCreateUrl:'',eventFetchUrl:'',fullCalendarOptions:{},headlessMode:false,owner:'',selectedSourceIds:[],showWeekNumber:true,showTimezoneInfo:false,timezoneOffset:0,rendererDelay:100},options||{});this._element=element;this._events=new creme.component.EventHandler();this.selectedSourceIds(options.selectedSourceIds||[]);this.props(_.omit(options,'selectedSourceIds'));Assert.not(element.is('.fc-creme'),'creme.ActivityCalendar is already bound');this._setupCalendarUi(element,options);this._setupCalendarExternalEvents(element);},props:function(props){if(props===undefined){return Object.assign({},this._props);}
this._props=Object.assign(this._props||{},props);return this;},prop:function(name,value){if(value===undefined){return this._props[name];}else{this._props[name]=value;return this;}},trigger:function(event){var data=Array.from(arguments).slice(1);if(!Object.isNone(this._element)){this._element.trigger('cal-'+event,[this].concat(data||[]));}
this._events.trigger(event,data,this);return this;},one:function(event,listener,decorator){this._events.one(event,listener,decorator);return this;},on:function(event,listener,decorator){this._events.on(event,listener,decorator);return this;},off:function(event,listener){this._events.off(event,listener);return this;},allowEventCreate:function(state){return this.prop('allowEventCreate',state);},allowEventMove:function(state){return this.prop('allowEventMove',state);},allowEventOverlaps:function(state){return this.prop('allowEventOverlaps',state);},defaultView:function(view){return this.prop('defaultView',view);},element:function(){return this._element;},eventUpdateUrl:function(url){return this.prop('eventUpdateUrl',url);},eventCreateUrl:function(url){return this.prop('eventCreateUrl',url);},eventFetchUrl:function(url){return this.prop('eventFetchUrl',url);},fullCalendar:function(){return this._calendar;},fullCalendarEvents:function(){return this._calendar.getEvents();},fullCalendarOptions:function(options){return this.prop('fullCalendarOptions',options);},fullCalendarView:function(view,options){if(view===undefined){return this._calendar.view;}
var calendar=this._calendar;calendar.batchRendering(function(){calendar.changeView(view,options);});},goToDate:function(date){this._calendar.gotoDate(date);},headlessMode:function(flag){return this.prop('headlessMode',flag);},owner:function(owner){return this.prop('owner',owner);},showWeekNumber:function(state){return this.prop('showWeekNumber',state);},showTimezoneInfo:function(state){return this.prop('showTimezoneInfo',state);},timezoneOffset:function(offset){return this.prop('timezoneOffset',offset);},selectedSourceIds:function(ids){if(ids===undefined){return Array.from(this._selectedSourceIds||[]);}
var next=new Set(ids||[]);var prev=new Set(this._selectedSourceIds||[]);var added=_.reject(Array.from(next),function(id){return prev.has(id);});var removed=_.reject(Array.from(prev),function(id){return next.has(id);});var calendar=this._calendar;this._selectedSourceIds=ids;if(!added.length&&removed.length>0){if(calendar){var removedEvents=calendar.getEvents().filter(function(event){return!next.has(String(event.extendedProps.calendar));});calendar.batchRendering(function(){removedEvents.forEach(function(event){event.remove();});});}}else if(next.size){this.refetchEvents();}
return this;},redraw:function(){if(this._calendar){this._calendar.render();}
return this;},refetchEvents:function(){if(this._calendar){this._calendar.refetchEvents();}
return this;},_queryErrorMessage:function(data,error){if(error.status===403){return gettext("You do not have permission, the change will not be saved.");}else if(error.status===409){return unescape(data);}else{return gettext("Error, please reload the page.");}},_query:function(options,data){var self=this;var query=creme.ajax.query(options.url,options,data).onComplete(function(event){self.trigger('query-complete',{activityCalendar:self,options:options,data:data,ok:event==='done'});});if(options.warnOnFail){return new creme.component.Action(function(){var action=this;query.onFail(function(event,data,error){var message=self._queryErrorMessage(data,error);var dialog=creme.dialogs.warning(message);dialog.onClose(function(){action.fail(data,error);}).open();}).onDone(function(event,data){action.done(data);}).start();});}else{return query;}},_toMoment:function(input){var dateEnv=this.fullCalendar().getCurrentData().dateEnv;var timeZone=dateEnv.timeZone;var locale=dateEnv.locale.codes[0];return convertToMoment(input,timeZone,locale);},_setupCalendarExternalEvents:function(element){var self=this;var props=this._props;var container=$(props.externalEventContainer);if(container.length>0){this._draggable=new FullCalendar.Draggable(container.get(0),{itemSelector:props.externalEventItemSelector,eventData:function(el){return self._props.externalEventData($(el),this);}});}},_onCalendarExternalEventUpdate:function(calendar,info){var self=this;var item=$(info.draggedEl);var range=new creme.CalendarEventRange({start:this._toMoment(info.date),duration:calendar.getOption('defaultTimedEventDuration'),allDay:info.allDay});var nextEvent=Object.assign({},this._props.externalEventData(item,this),{start:range.start.toDate(),end:range.end.toDate(),allDay:range.allDay});this._query({url:this.eventUpdateUrl(),action:'POST',warnOnFail:true},{id:nextEvent.id,start:toISO8601(range.start,range.allDay),end:toISO8601(range.end,range.allDay),allDay:range.allDay}).onDone(function(){calendar.addEvent(nextEvent);self.trigger('event-new',{activityCalendar:self,activityRange:range,calEvent:nextEvent,item:item,external:true});}).onFail(function(){info.revert();}).start();},_onCalendarEventUpdate:function(calendar,info){var self=this;var range=new creme.CalendarEventRange({start:this._toMoment(info.event.start),end:this._toMoment(info.event.end),duration:calendar.getOption('defaultTimedEventDuration'),allDay:info.event.allDay});if(!info.event.allDay&&info.event.end===null){info.event.setEnd(range.end.toDate());}
this._query({url:this.eventUpdateUrl(),action:'POST',warnOnFail:true},{id:info.event.id,start:toISO8601(range.start,range.allDay),end:toISO8601(range.end,range.allDay),allDay:range.allDay}).onFail(function(){info.revert();}).onDone(function(){self.trigger('event-update',{activityCalendar:self,activityRange:range});}).start();},_onCalendarEventFetch:function(calendar,info,successCb,failureCb){var self=this;var range=new creme.CalendarEventRange({start:this._toMoment(info.start),end:this._toMoment(info.end)});var isEditable=this.allowEventMove();this._query({url:this.eventFetchUrl(),backend:{dataType:'json'}},{calendar_id:this.selectedSourceIds(),start:range.start.format('YYYY-MM-DD'),end:range.end.format('YYYY-MM-DD')}).onDone(function(event,data){var items=data.map(function(item){item.textColor=new RGBColor(item.color).foreground().toString();item.editable=item.editable&&isEditable;return item;});self.trigger('event-fetch',{activityCalendar:self,activityRange:range,items:items,ok:true});successCb(items);}).onFail(function(event,err){self.trigger('event-fetch',{activityCalendar:self,activityRange:range,items:[],error:err,ok:false});failureCb(err);}).start();},_onCalendarEventCreate:function(calendar,info){var self=this;var range=new creme.CalendarEventRange({start:this._toMoment(info.start),end:this._toMoment(info.end),duration:calendar.getOption('defaultTimedEventDuration'),allDay:info.allDay});var data={start:toISO8601(range.start,range.allDay),end:toISO8601(range.end,range.allDay),allDay:range.allDay?1:0};creme.dialogs.form(this.eventCreateUrl(),{},data).onFormSuccess(function(event,response){self.trigger('event-new',{activityCalendar:self,activityRange:range,calEvent:info,external:false,redirectUrl:response.content});}).open({width:'80%'});},_onCalendarEventShow:function(calendar,info){var self=this;creme.dialogs.url(info.event.url).onClose(function(){self.refetchEvents();self.trigger('event-shown',{activityCalendar:self,calEvent:info});}).open({width:'80%'});},_formatEventTime:function(info,formatter){var view=info.view;var event=info.event;if(info.event.end!==null){return view.dateEnv.formatRange(event.start,event.end,formatter);}else{return view.dateEnv.format(event.start,formatter);}},_eventTimeSlotCount:function(event,calendar){if(event.end){var start=this._toMoment(event.start);var end=this._toMoment(event.end);var eventDuration=start?end.diff(start):0;var slotDuration=moment.duration(calendar.getOption('slotDuration')).asMilliseconds();return Math.round(eventDuration/slotDuration);}},_renderWeekEventContent:function(calendar,info,createElement){var event=info.event;var view=info.view;var text=info.timeText;var formatter=FullCalendar.Internal.createFormatter(calendar.getOption('eventTimeFormat'));var slotCount=this._eventTimeSlotCount(event,calendar);var typeTag=event.extendedProps.type||'';if(event.allDay){return createElement('div',{className:'fc-event-main-frame'},createElement('div',{className:'fc-event-title'},event.title),typeTag&&(createElement('div',{className:'fc-event-type'},typeTag)));}else if(slotCount<2){text=view.dateEnv.format(event.start,formatter);return createElement('div',{className:'fc-event-main-frame fc-smaller'},text&&(createElement("div",{className:"fc-event-time"},text)),createElement('div',{className:'fc-event-title'},event.title),typeTag&&(createElement('div',{className:'fc-event-type'},typeTag)));}else if(slotCount<3){text=view.dateEnv.format(event.start,formatter);return createElement('div',{className:'fc-event-main-frame fc-small'},text&&(createElement("div",{className:"fc-event-time"},text)),typeTag&&(createElement('div',{className:'fc-event-type'},typeTag)),createElement('div',{className:'fc-event-title'},event.title));}else{text=event.end?this._formatEventTime(info,formatter):text;return createElement('div',{className:'fc-event-main-frame'},typeTag&&(createElement('div',{className:'fc-event-type fc-sticky'},typeTag)),createElement('div',{className:'fc-event-header'},text&&(createElement("div",{className:"fc-event-time"},text))),createElement('div',{className:'fc-event-title-container'},createElement('div',{className:'fc-event-title fc-sticky'},event.title)));}},_renderMonthEventContent:function(calendar,info,createElement){var event=info.event;var view=info.view;var typeTag=event.extendedProps.type||'';var dotColor=info.borderColor||info.backgroundColor;var text=info.timeText;var start=this._toMoment(event.start);var end=this._toMoment(event.end);var isMultiDay=end&&start.format('MMD')!==end.format('MMD');var formatter=FullCalendar.Internal.createFormatter(calendar.getOption('eventTimeFormat'));if(event.allDay||isMultiDay){return createElement('div',{className:'fc-event-main-frame'},createElement('div',{className:'fc-event-title'},event.title),typeTag&&(createElement('div',{className:'fc-event-type'},typeTag)));}else{text=view.dateEnv.format(event.start,formatter);return createElement('div',{className:'fc-event-empty-frame'},createElement('div',{className:'fc-daygrid-event-dot',style:{borderColor:dotColor}}),text&&(createElement("div",{className:"fc-event-time"},text)),createElement('div',{className:'fc-event-title'},event.title),typeTag&&(createElement('div',{className:'fc-event-type'},typeTag)));}},_renderCalendarEventContent:function(calendar,info,createElement){if(info.view.type==='week'){return this._renderWeekEventContent(calendar,info,createElement);}else{return this._renderMonthEventContent(calendar,info,createElement);}},_postRenderCalendarEvent:function(calendar,info){var formatter=FullCalendar.Internal.createFormatter(calendar.getOption('eventTimeFormat'));var title="${range}\n${tag}${title}".template({range:this._formatEventTime(info,formatter),tag:info.event.extendedProps.type?info.event.extendedProps.type+'\n':'',title:info.event.title});info.el.setAttribute('alt',title);info.el.setAttribute('title',title);if(info.event.extendedProps.busy){info.el.classList.add('fc-busy');}},_postRenderCalendarView:function(calendar,info){var view=info.view;if(this.showWeekNumber()){var title=this._element.find('.fc-header-toolbar .fc-toolbar-title');var start=this._toMoment(view.activeStart);var week=title.find('.fc-header-week');var isWeekView=(view.type==='week');if(isWeekView){if(week.length===0){week=$('<span class="fc-header-week">').appendTo(title);}
week.text('${label} ${num}'.template({label:gettext("Week"),num:start.format('W')}));}
week.toggleClass('hidden',!isWeekView);}},_renderWeekNumber:function(calendar,info){return this._toMoment(info.date).format('[S] W');},_onCalendarEventOverlap:function(calendar,still,moving){var overlaps=this._props.allowEventOverlaps;if(Object.isFunc(overlaps)){var stillRange=new creme.CalendarEventRange({start:this._toMoment(still.start),end:this._toMoment(still.end),duration:calendar.getOption('defaultTimedEventDuration'),allDay:still.allDay});var movingRange=new creme.CalendarEventRange({start:this._toMoment(moving.start),end:this._toMoment(moving.end),duration:calendar.getOption('defaultTimedEventDuration'),allDay:moving.allDay});return overlaps({still:still,stillRange:stillRange,moving:moving,movingRange:movingRange,activityCalendar:this});}else{return overlaps||false;}},_setupCalendarHandlers:function(calendar){var self=this;calendar.on('select',function(info){if(self.allowEventCreate()){self._onCalendarEventCreate(calendar,info);}});calendar.on('eventClick',function(info){info.jsEvent.preventDefault();self._onCalendarEventShow(calendar,info);return false;});calendar.on('eventResize',function(info){self._onCalendarEventUpdate(calendar,info);self._postRenderCalendarEvent(calendar,info);});calendar.on('datesSet',function(info){self._postRenderCalendarView(calendar,info);self.trigger('range-select',{activityCalendar:self,view:info.view.type,start:self._toMoment(info.view.activeStart),end:self._toMoment(info.view.activeEnd),calEvent:info});});calendar.on('drop',function(info){self._onCalendarExternalEventUpdate(calendar,info);});calendar.on('eventDrop',function(info){self._onCalendarEventUpdate(calendar,info);self._postRenderCalendarEvent(calendar,info);});},_setupCalendarUi:function(element,options){var self=this;var initialDate=options.initialDate?moment(options.initialDate):moment();var initialView=options.initialView||this.defaultView();var fullCalendarSettings=this._fullCalendarSettings=Object.assign({},FULLCALENDAR_SETTINGS,options.fullCalendarOptions||{},{initialDate:initialDate.format('YYYY-MM-DD'),initialView:initialView,weekNumbers:options.showWeekNumber});if(options.rendererDelay>0){fullCalendarSettings.rerenderDelay=options.rendererDelay;}
if(options.headlessMode){fullCalendarSettings.header=false;}
element.addClass('fc-creme');var calendar=this._calendar=new FullCalendar.Calendar(element.get(0),Object.assign({},fullCalendarSettings,{weekNumberContent:function(info){return self._renderWeekNumber(calendar,info);},eventContent:function(info,createElement){return self._renderCalendarEventContent(calendar,info,createElement);},eventDidMount:function(info){return self._postRenderCalendarEvent(calendar,info);},eventOverlap:function(still,moving){return self._onCalendarEventOverlap(calendar,still,moving);},nowIndicatorContent:function(info,createElement){if(self.showTimezoneInfo()){var text=moment.utc().utcOffset(self.timezoneOffset()).format('Z');return createElement('div',{className:'fc-timegrid-now-timezone'},'UTC'+text);}
return true;},now:function(){var now=moment().milliseconds(0);var offset=self.timezoneOffset();offset=isNaN(offset)?now.utcOffset():offset;now=now.utc().add(offset,'m');return now.toISOString(true);}}));element.data('fc-creme',calendar);calendar.addEventSource(function(info,successCb,failureCb){self._onCalendarEventFetch(calendar,info,successCb,failureCb);});this._setupCalendarHandlers(calendar);calendar.render();}});}(jQuery));(function($){"use strict";creme.ActivityCalendarController=creme.component.Component.sub({_init_:function(element,options){this._props=options=Object.assign({allowEventMove:true,allowEventOverlaps:true,debounceDelay:200,defaultView:'month',fullCalendarOptions:{},keepState:false,showWeekNumber:true,showTimezoneInfo:false,timezoneOffset:0,sourceSelectUrl:''},options||{});this._element=element;this._fullCalendarViewNames=creme.availableFullCalendarViewNames(options);Assert.not(element.is('.is-active'),'creme.ActivityCalendarController is already bound');this._bindFilterInputs(element,'.floating-event-filter input',this._filterCalendarEvents.bind(this));this._bindFilterInputs(element,'.calendar-menu-filter input',this._filterCalendars.bind(this));this._setupCalendarUi(element,options);this._setupCalendarToggle(element);},props:function(props){if(props===undefined){return Object.assign({},this._props);}
this._props=Object.assign(this._props||{},props);return this;},prop:function(name,value){if(value===undefined){return this._props[name];}else{this._props[name]=value;return this;}},fullCalendarViewNames:function(){return this._fullCalendarViewNames;},debounceDelay:function(delay){return this.prop('debounceDelay',delay);},calendar:function(){return this._calendar;},element:function(){return this._element;},keepState:function(keep){return this.prop('keepState',keep);},sourceSelectUrl:function(url){return this.prop('sourceSelectUrl',url);},selectedSourceIds:function(){return this._calendar.selectedSourceIds();},selectSource:function(ids){var next=new Set(ids||[]);if(this.sourceSelectUrl()){var prev=new Set(this.selectedSourceIds());var added=_.reject(Array.from(next),function(id){return prev.has(id);});var removed=_.reject(Array.from(prev),function(id){return next.has(id);});var data={};if(added.length>0){data.add=added;}
if(removed.length>0){data.remove=removed;}
if(added.length>0||removed.length>0){creme.ajax.query(this.sourceSelectUrl(),{action:'POST'},data).start();}}
this._calendar.selectedSourceIds(next);return this;},fullCalendar:function(){return this._calendar.fullCalendar();},fullCalendarView:function(view,options){return this._calendar.fullCalendarView(view,options);},fullCalendarEvents:function(){return this._calendar.fullCalendarEvents();},setViewState:function(state){this._calendar.fullCalendarView(state.view,state.date?state.date.format('YYYY-MM-DD'):undefined);return this;},goToDate:function(date){this.calendar().goToDate(date);},_onCalendarEventCreate:function(event,info){if(info.external){var group=info.item.parents('.menu-group').first();info.item.detach();group.toggleClass('is-empty-group',group.find('.floating-event').length===0);}else{if(info.redirectUrl){creme.utils.goTo(info.redirectUrl);}else{info.activityCalendar.refetchEvents();}}},_currentUrl:function(){return window.location.href;},_loadStateFromUrl:function(url){var hash=_.urlAsDict(url||this._currentUrl()).hash||'';var data=_.decodeURLSearchData(hash.slice(1));var view=data.view&&(this.fullCalendarViewNames().indexOf(data.view)!==-1?data.view:this.prop('defaultView'));var date=data.date?moment(data.date):undefined;date=date&&date.isValid()?date:undefined;return{view:view,date:date};},_storeStateInUrl:function(state){creme.history.push('#'+_.encodeURLSearch({view:state.view,date:state.date.format('YYYY-MM-DD')}));},_onCalendarStateUpdate:function(event,info){if(!this.keepState()){return;}
var previous=(this._loadStateFromUrl()||{});var prevDate=previous.date?previous.date.format('YYYY-MM-DD'):null;var nextDate=info.start.format('YYYY-MM-DD');if(info.view===previous.view&&nextDate===prevDate){return;}
if(info.view==='month'&&previous.date&&previous.date.isBetween(info.start,info.end)){return;}
this._storeStateInUrl({view:info.view,date:info.start});},_debounce:function(handler){var delay=this.debounceDelay();if(delay>0){return _.debounce(handler,delay);}else{return handler;}},_filterCalendars:function(element,search){element.find('.other-calendars .calendar-menu-usergroup').each(function(){var username=$(this).attr('data-user');var calendars=$(this).find('.calendar-menu-item');var title=$(this).find('.calendar-menu-usergroup-label');var isOwnerMatches=(username.toUpperCase().indexOf(search)!==-1||title.text().toUpperCase().indexOf(search)!==-1);if(isOwnerMatches){title.removeClass('hidden');calendars.removeClass('hidden');}else{var anyCalendarMatch=false;calendars.each(function(){var match=$(this).find('label').text().toUpperCase().indexOf(search)!==-1;$(this).toggleClass('hidden',!match);anyCalendarMatch|=match;});title.toggleClass('hidden',!anyCalendarMatch);}});},_filterCalendarEvents:function(element,search){element.find('.floating-event').each(function(){$(this).toggleClass('hidden',$(this).text().toUpperCase().indexOf(search)===-1);});},_bindFilterInputs:function(element,query,callback){element.on('propertychange keyup input paste',query,this._debounce(function(e){callback(element,$(this).val().toUpperCase());}));},_setupCalendarToggle:function(element){var self=this;element.on('change','.calendar-menu-item input[type="checkbox"]',this._debounce(function(e){self.selectSource(self.checkedSourceIds());}));},_externalEventData:function(item){var color=item.data('color');return{id:item.data('id'),title:(item.text()||'').trim(),extendedProps:{type:item.data('type'),user:this.calendar().owner(),calendar:item.data('calendar'),busy:Boolean(item.data('busy'))},className:[],url:item.data('popup_url'),editable:true,create:false,backgroundColor:color,textColor:new RGBColor(color).foreground().toString()};},checkedSourceIds:function(element){return this._element.find('input[type="checkbox"][name="calendar_id"]:checked').map(function(){return $(this).val();}).get();},_setupCalendarUi:function(element,options){var self=this;var state=self._loadStateFromUrl();var initialState={date:options.initialDate?moment(options.initialDate):moment(),view:options.initialView};state={date:state.date?state.date:initialState.date,view:state.view?state.view:initialState.view};options=Object.assign({},options,{initialDate:state.date,initialView:state.view,externalEventData:this._externalEventData.bind(this),externalEventContainer:element.find('.floating-activities'),externalEventItemSelector:'.floating-event',selectedSourceIds:this.checkedSourceIds()});var calendarElement=this._element.find('.calendar');var calendar=this._calendar=new creme.ActivityCalendar(calendarElement,options);element.addClass('is-active');calendar.on('event-new',this._onCalendarEventCreate.bind(this));calendar.on('range-select',this._onCalendarStateUpdate.bind(this));$(window).on('hashchange',function(){if(self.keepState()){var state=self._loadStateFromUrl();if(state.view){calendar.fullCalendarView(state.view,state.date?state.date.format('YYYY-MM-DD'):undefined);}}});}});creme.userActivityCalendar=function(element,options){return new creme.ActivityCalendarController(element,options);};}(jQuery));(function($){"use strict";creme.ActivityCalendarBrickController=creme.component.Component.sub({_init_:function(props){this._props=Object.assign({fullCalendarOptions:{}},props||{});},props:function(props){if(props===undefined){return Object.assign({},this._props);}
this._props=Object.assign(this._props||{},props);return this;},prop:function(name,value){if(value===undefined){return this._props[name];}else{this._props[name]=value;return this;}},brick:function(){return this._brick;},calendar:function(){return this._calendar;},isBound:function(){return!Object.isNone(this._brick);},_calendarSettings:function(element){var script=$('script[type$="/json"].brick-calendar-settings:first',element);var data=_.readJSONScriptText(script.get(0));return Object.isEmpty(data)?{}:JSON.parse(data);},_calendarSources:function(element){var script=$('script[type$="/json"].brick-calendar-sources:first',element);var data=_.readJSONScriptText(script.get(0));return Object.isEmpty(data)?[]:JSON.parse(data);},bind:function(brick){Assert.that(Object.isNone(this._brick),'ActivityCalendarBrickController is already bound');Assert.is(brick,creme.bricks.Brick,'${brick} is not a creme.bricks.Brick',{brick:brick});this._brick=brick;var props=this.props();var element=brick.element();var container=element.find('.brick-calendar');var settings=this._calendarSettings(element);var extra=settings.extra_data||{};var sources=this._calendarSources(element);if(Array.isArray(extra)||_.isString(extra)||_.isNumber(extra)){console.warn('Ignore the extra_data field that must be a plain object :',extra);extra={};}
props=Object.assign({selectedSourceIds:sources,keepState:Boolean(settings.allow_keep_state),defaultView:settings.view||'month',timezoneOffset:settings.utc_offset||0,allowEventMove:Boolean(settings.allow_event_move),allowEventCreate:Boolean(settings.allow_event_create),headlessMode:Boolean(settings.headless_mode),showWeekNumber:!(settings.show_week_number===false),showTimezoneInfo:Boolean(settings.show_timezone_info),fullCalendarOptions:Object.assign(extra,{slotDuration:settings.slot_duration,businessHours:{daysOfWeek:settings.week_days,startTime:settings.day_start,endTime:settings.day_end},firstDay:settings.week_start})},props);this._calendar=new creme.ActivityCalendar(container,props);return this;},registerActions:function(brick){Assert.is(brick,creme.bricks.Brick,'${brick} is not a creme.bricks.Brick',{brick:brick});brick.getActionBuilders().registerAll({});return this;}});creme.setupActivityCalendarBrick=function(element,options){var controller=new creme.ActivityCalendarBrickController(options);$(element).on('brick-ready',function(e,brick){controller.bind(brick);}).on('brick-setup-actions',function(e,brick,actions){controller.registerActions(brick);});return controller;};}(jQuery));(function($){"use strict";creme.billing=creme.billing||{};creme.billing.checkPositiveDecimal=function(element){return element.val().match(/^[0-9]+(\.[0-9]{1,2}){0,1}$/)!==null;};creme.billing.checkPositiveInteger=function(element){return element.val().match(/^[0-9]+$/)!==null;};creme.billing.checkDecimal=function(element){return element.val().match(/^[\-]{0,1}[0-9]+(\.[0-9]{1,2}){0,1}$/)!==null;};creme.billing.checkPercent=function(element){return element.val().match(/^(100(\.[0]{1,2}){0,1}|[0-9]{1,2}(\.[0-9]{1,2}){0,1})$/)!==null;};creme.billing.checkValue=function(element){return Boolean(element.val());};creme.billing.checkDiscount=function(element){var parent_tr=element.closest('tr');var discount_unit=parseInt($('select[name*=discount_unit]',parent_tr).val());var discount_value=parseFloat($('input[name*=discount]',parent_tr).val());var unit_price=parseFloat($('input[name*=unit_price]',parent_tr).val());var quantity=parseInt($('input[name*=quantity]',parent_tr).val());switch(discount_unit){case 1:return creme.billing.checkPercent(element);case 2:return discount_value<=unit_price*quantity;case 3:return discount_value<=unit_price;default:console.log("checkDiscount(): Bad discount value ?!",discount_unit);}
return false;};creme.billing.markDelete=function(prefix,lineId){var name=prefix+'-DELETE';var checkbox=$('#id_'+name);var line=$('#line_content_'+lineId);var toDelete=!checkbox.is(':checked');checkbox.prop('checked',toDelete);line.toggleClass('bline-deletion-mark',toDelete);};creme.billing.inputs=function(element){return $('input, select, textarea',element);};creme.billing.forms=function(element){return $('.bline-form',element);};creme.billing.modifiedBLineForms=function(){return $('.bline-form').filter(function(){return Boolean(($('> :not(.hidden-form) .bline-input-modified, .bline-deletion-mark',$(this)).first().length));});};creme.billing.formsHaveErrors=function(){return Boolean($('.bline-form > :not(.hidden-form) .bline-input-error').first().length);};creme.billing.serializeInput=function(input){var key=input.attr('name');var value=input.attr('type')==='checkbox'?(input.prop('checked')?input.val():undefined):input.val();if(key!==undefined&&value!==undefined){return{key:key,value:value};}};creme.billing.validateInput=function(input){var validator=input.attr('validator')?creme.billing['check'+input.attr('validator')]:undefined;var isvalid=input.attr('isvalid')||false;if(Object.isFunc(validator)){isvalid=validator(input);}else{isvalid=true;}
input.attr('isvalid',isvalid);input.toggleClass('bline-input-error',!isvalid);return isvalid;};creme.billing.initializeForm=function(element){creme.billing.inputs(element).each(function(){var input=$(this);var item=creme.billing.serializeInput(input);input.attr('initial',item!==undefined?item.value:undefined);creme.billing.validateInput(input);});creme.billing.inputs(element).on('propertychange input change paste',function(){var input=$(this);var item=creme.billing.serializeInput(input);var changed=(item!==undefined&&(''+item.value!==input.attr('initial')));if(input.attr('type')==='checkbox'&&item===undefined&&input.attr('initial')){changed=true;}
creme.billing.validateInput(input);input.toggleClass('bline-input-modified',changed);var lineContainer=input.closest('.bline-container');lineContainer.toggleClass('bline-container-modified',lineContainer.has('.bline-input-modified')[0]!==undefined);});};creme.billing.initializeForms=function(element){creme.billing.forms(element).each(function(){creme.billing.initializeForm($(this));});};creme.billing.hideEmptyForm=function(ct_id,formset_prefix,line_count){$('.empty_form_'+ct_id).toggleClass('hidden-form',true);var form_count_hidden_input=$('#id_'+formset_prefix+'-TOTAL_FORMS');form_count_hidden_input.val(parseInt(form_count_hidden_input.val())-1);$('.add_on_the_fly_'+ct_id).removeClass('forbidden');if(line_count===0){$('.empty_msg_'+ct_id).attr('style','display:table-row');}};creme.billing.showEmptyForm=function(btn,ct_id,prefix,line_count){if(btn.hasClass('forbidden')){return;}
btn.addClass('forbidden');var form_count_hidden_input=$('#id_'+prefix+'-TOTAL_FORMS');var td_inputs=$('.empty_form_inputs_'+ct_id);var formCount=parseInt(form_count_hidden_input.val());$('input,select,textarea',td_inputs).each(function(index){var input=$(this);input.removeClass('bline-input-error');var input_id=input.attr('id');if(input_id){input.attr('id',input_id.replace('__prefix__',formCount));}
var input_name=input.attr('name');if(input_name){input.attr('name',input_name.replace('__prefix__',formCount));}
creme.billing.restoreValue(input);});form_count_hidden_input.val(formCount+1);$('.empty_form_'+ct_id).toggleClass('hidden-form',false);if(line_count===0){$('.space_line_'+ct_id).attr('style','display:none');$('.empty_msg_'+ct_id).attr('style','display:none');}};creme.billing.restoreValue=function(input){var initial_value=input.attr('initial');if(input.attr('type')==='checkbox'){input.prop('checked',!Object.isNone(initial_value));}else{input.val(initial_value);}
input.trigger('change');};creme.billing.restoreInitialValues=function(line_id,form_prefix){creme.dialogs.confirm(gettext('Do you really want to restore initial values of this line?')).onOk(function(){$('input,select,textarea',$('.restorable_'+line_id)).each(function(){creme.billing.restoreValue($(this));});var delete_checkbox=$('#id_'+form_prefix+'-DELETE');var line_td=$('#line_content_'+line_id);var to_delete=delete_checkbox.prop('checked');if(to_delete){delete_checkbox.prop('checked',false);line_td.removeClass('bline-deletion-mark');line_td.removeClass('bline-input-error');line_td.addClass('block_header_line_dark');}}).open();};creme.billing.initBoundedFields=function(element,currency,global_discount){var discounted=$('[name="discounted"]',element);var inclusive_of_tax=$('[name="inclusive_of_tax"]',element);var exclusive_of_tax=$('[name="exclusive_of_tax"]',element);var container=element.parents('.bline-container:first');element.on('change','.bound',function(){if(container.is('.hidden-form')){return;}
var quantity=$('[name*="quantity"]',element);var unit_price=$('td input[name*="unit_price"]',element);var discount=$('input[name*="discount"]',element);var vat_value_widget=$('select[name*="vat_value"]',element);var vat_value=$("option[value='"+vat_value_widget.val()+"']",vat_value_widget).text();var discount_unit=$('[name*="discount_unit"]',element).val();var discounted_value;switch(discount_unit){case'1':discounted_value=quantity.val()*(unit_price.val()-(unit_price.val()*discount.val()/100));break;case'2':discounted_value=quantity.val()*unit_price.val()-discount.val();break;case'3':discounted_value=quantity.val()*(unit_price.val()-discount.val());break;default:console.log("Bad discount value ?!",discount_unit);}
discounted_value=discounted_value-(discounted_value*global_discount/100);var exclusive_of_tax_discounted=Math.round(discounted_value*100)/100;var is_discount_invalid=!creme.billing.checkDiscount(discount);discount.toggleClass('bline-input-error',is_discount_invalid);if(isNaN(exclusive_of_tax_discounted)||is_discount_invalid||!creme.billing.checkPositiveDecimal(quantity)){discounted.text('###');inclusive_of_tax.text('###');exclusive_of_tax.text('###');}else{var eot_value=Math.round(quantity.val()*unit_price.val()*100)/100;var iot_value=Math.round((parseFloat(exclusive_of_tax_discounted)+parseFloat(exclusive_of_tax_discounted)*vat_value/100)*100)/100;exclusive_of_tax.text(eot_value.toFixed(2).replace(".",",")+" "+currency);discounted.text(exclusive_of_tax_discounted.toFixed(2).replace(".",",")+" "+currency);inclusive_of_tax.text(iot_value.toFixed(2).replace(".",",")+" "+currency);discounted.attr('data-value',exclusive_of_tax_discounted);inclusive_of_tax.attr('data-value',iot_value);creme.billing.updateBrickTotals(currency);}
if(!vat_value_widget.val()){inclusive_of_tax.text('###');}});};creme.billing.checkModifiedOnUnload=function(){if(creme.billing.modifiedBLineForms().first().length){return gettext("You modified your lines.");}};creme.billing.initLinesBrick=function(brick){var brick_element=brick._element;var currency=brick_element.attr('data-type-currency');var global_discount=parseFloat(brick_element.attr('data-type-global-discount'));creme.billing.initializeForms(brick_element);$('.linetable',brick_element).each(function(index){creme.billing.initBoundedFields($(this),currency,global_discount);});$('select[name*="vat_value"]',brick_element).each(function(index){$(this).addClass('bound line-vat');});setupLineSort(brick);};creme.billing.serializeForm=function(form){var data={};creme.billing.inputs($(form)).each(function(){var item=creme.billing.serializeInput($(this));if(item!==undefined){data[item.key]=item.value;}});return data;};creme.billing.updateBrickTotals=function(currency){var total_no_vat_element=$('h1[name=total_no_vat]');var total_vat_element=$('h1[name=total_vat]');var total_no_vat=0;var total_vat=0;$('td[name=discounted]').each(function(){total_no_vat+=parseFloat($(this).attr('data-value'));});$('td[name=inclusive_of_tax]').each(function(){total_vat+=parseFloat($(this).attr('data-value'));});total_no_vat_element.text(total_no_vat.toFixed(2).replace('.',',')+' '+currency);total_vat_element.text(total_vat.toFixed(2).replace('.',',')+' '+currency);};function setupLineSort(brick){var lines=brick.element().find('.bline-form');lines.sortable({items:'.bline-sortable',placeholder:'bline-ghost',handle:'.bline-reorder-anchor',opacity:0.8,revert:200,delay:200,stop:function(event,ui){var item=ui.item;var next=item.index('.bline-sortable')+1;var prev=parseInt(item.data('bline-order'));var url=item.data('bline-reorder-url');if(next!==prev){brick.action('update',url,{},{target:next}).on('fail',function(){brick.refresh();}).start();}}});}}(jQuery));(function($){"use strict";creme.billing=creme.billing||{};creme.billing.AddDocumentAction=creme.component.Action.sub({_init_:function(options){this._super_(creme.component.Action,'_init_',this._run,options);},_run:function(options){options=$.extend(this.options(),options||{});var self=this;var width=$(window).innerWidth();var dialog=new creme.dialog.FormDialogAction({width:width*0.8,maxWidth:width,url:options.url});dialog.onDone(function(event,data){var redirectionURL=data['content'];if(redirectionURL){creme.utils.redirect(redirectionURL);}else{var deps=options.deps||['creme_core.relation'];var reload=new creme.bricks.BricksReloader().dependencies(deps).action();reload.on({fail:function(event,error){self.fail(error);},'done cancel':function(){self.done();}}).start();}}).onFail(function(event,error){self.fail(error);}).onCancel(function(event){self.cancel();}).start();}});var hatmenubarActions={'billing-hatmenubar-add-document':function(url,options,data,e){return new creme.billing.AddDocumentAction({url:url,deps:['creme_core.relation','creme_core.relation.'+data.rtype_id,data.model_id]});}};$(document).on('brick-setup-actions','.creme_core-buttons-brick',function(e,brick,actions){actions.registerAll(hatmenubarActions);});creme.billing.BulkExportAction=creme.component.Action.sub({_init_:function(list,options){this._super_(creme.component.Action,'_init_',this._run,options);this._list=list;},_run:function(options){options=$.extend({},this.options(),options||{});var self=this;var selection=this._list.selectedRows();if(selection.length<1){creme.dialogs.warning(gettext('Please select at least a line in order to export.')).onClose(function(){self.cancel();}).open();}else{self.done();creme.utils.goTo(options.url,{id:selection});}}});$(document).on('listview-setup-actions','.ui-creme-listview',function(e,actions){actions.register('billing-number',function(url,options,data,e){var list=this._list;var action=creme.utils.ajaxQuery(url,$.extend({action:'post',warnOnFail:true},options||{}));action.onDone(function(){list.reload();});return action;});actions.register('billing-bulk-export',function(url,options,data,e){return new creme.billing.BulkExportAction(this._list,{url:url});});});var billingLinesActions={'billing-line-addonfly':function(url,options,data,e){return new creme.component.Action(function(){var count=data.count?parseInt(data.count):0;creme.billing.showEmptyForm($(e.currentTarget),data.ctype_id,data.prefix,count);this.done();});},'billing-line-saveall':function(url,options,data,e){var brick=this._brick;return new creme.component.Action(function(){var self=this;if(creme.billing.formsHaveErrors()){creme.dialogs.alert('<p>'+gettext('There are some errors in your lines.')+'</p>').onClose(function(){self.cancel();}).open();}else{var formsData={};var modifiedLines=creme.billing.modifiedBLineForms();if(modifiedLines.length===0){console.log('Forms not modified !');return this.cancel();}
modifiedLines.each(function(){var container=$(this);formsData[container.attr('ct_id')]=JSON.stringify(creme.billing.serializeForm(container));});creme.utils.ajaxQuery(url,{action:'post',warnOnFail:true,warnOnFailTitle:gettext('Errors report')},formsData).onDone(function(){self.done();brick.refresh();}).onFail(function(event,message){self.fail(message);}).start();}});},'billing-line-clearonfly':function(url,action,data,e){var brick=this._brick;return new creme.component.Action(function(){creme.billing.hideEmptyForm(data.ctype_id,data.prefix,data.count);$('[data-action="billing-line-addonfly"]',brick._element).removeClass('forbidden');this.done();});}};$(document).on('brick-setup-actions','.brick.billing-lines-brick',function(e,brick,actions){actions.registerAll(billingLinesActions);}).on('brick-ready',function(e,brick,options){creme.billing.initLinesBrick(brick);});}(jQuery));(function($){"use strict";creme.opportunities=creme.opportunities||{};creme.opportunities.QuoteController=creme.component.Component.sub({_init_:function(options){this._options=options||{};},bind:function(brick){if(this.isBound()){throw new Error('QuoteController is already bound');}
brick.element().on('click','input.opportunities-current-quote[data-url]:not(.is-loading):not([disabled])',function(e){e.preventDefault();e.stopPropagation();var url=$(this).attr('data-url');if(Object.isEmpty(url)===false){$(this).addClass('is-loading');creme.utils.ajaxQuery(url,{action:'post',warnOnFail:true}).onDone(function(){brick.refresh();}).start();}});this._brick=brick;return this;},isBound:function(){return Object.isNone(this._brick)===false;}});}(jQuery));(function($){"use strict";creme.commercial=creme.commercial||{};creme.commercial.setScore=function(input,url,scoredModelId,segmentId,orgaId){input=$(input);var brick=input.parents('.brick').creme().widget().brick();var data={score:input.val(),model_id:scoredModelId,segment_desc_id:segmentId,orga_id:orgaId};creme.utils.ajaxQuery(url,{action:'post',warnOnFail:true},data).onDone(function(){brick.refresh();}).start();};}(jQuery));(function($){"use strict";creme.projects=creme.projects||{};$(document).on('listview-setup-actions','.ui-creme-listview',function(e,actions){actions.register('projects-close',function(url,options,data,e){var list=this._list;options=$.extend({action:'post',confirm:gettext('Do you really want to close this project?'),warnOnFail:true},options||{});var action=creme.utils.ajaxQuery(url,options,data);action.onDone(function(){list.reload();});return action;});});}(jQuery));(function($){"use strict";creme.reports=creme.reports||{};creme.reports.PreviewController=creme.component.Component.sub({_init_:function(options){options=options||{};this._redirectUrl=options.previewUrl||'';this._downloadUrl=options.downloadUrl||'';this._listeners={update:this._updateHeader.bind(this),redirect:this.redirect.bind(this),download:this.download.bind(this)};},isBound:function(){return this._header!==undefined;},bind:function(element){Assert.not(this.isBound(),'creme.reports.PreviewController is already bound.');var listeners=this._listeners;var header=this._header=$('.report-preview-header',element);$('select[name="date_field"]',header).on('change',listeners.update);$('button[name="generate"]',header).on('click',listeners.redirect);$('button[name="download"]',header).on('click',listeners.download);this._updateHeader();return this;},unbind:function(){Assert.that(this.isBound(),'creme.reports.PreviewController is not bound.');var listeners=this._listeners;var header=this._header;if(header!==undefined){$('select[name="date_field"]',header).unbind('change',listeners.update);$('button[name="generate"]',header).unbind('click',listeners.redirect);$('button[name="download"]',header).unbind('click',listeners.download);}
this._header=undefined;return this;},_updateHeader:function(){var header=this._header;var range=$('.ui-creme-daterange',header);var needsRange=!Object.isEmpty($('[name="date_field"]',header).val());$('.date-filter',header).toggle(needsRange);if(needsRange&&range.length>0){range.creme().widget().reset();}},redirect:function(){creme.utils.goTo(this._redirectUrl,$('form',this._header).serialize());},download:function(){creme.utils.goTo(this._downloadUrl,$('form',this._header).serialize());}});}(jQuery));(function($){"use strict";creme.reports=creme.reports||{};creme.reports.ExportReportAction=creme.component.Action.sub({_init_:function(options){this._super_(creme.component.Action,'_init_',this._run,options);},_run:function(options){options=$.extend({},this.options(),options||{});var self=this;creme.dialogs.form(options.filterUrl).on('frame-activated',function(event,frame){new creme.reports.PreviewController(options).bind(frame.delegate());}).onFormSuccess(function(event,response,dataType){self.done(response.content);creme.utils.goTo(response.content);}).onClose(function(){self.cancel();}).open({width:1024});}});$(document).on('brick-setup-actions','.brick.brick-hat-bar',function(e,brick,actions){actions.register('reports-export',function(url,options,data,e){return new creme.reports.ExportReportAction({filterUrl:url});});});$(document).on('listview-setup-actions','.ui-creme-listview',function(e,actions){actions.register('reports-export',function(url,options,data,e){return new creme.reports.ExportReportAction({filterUrl:url});});});}(jQuery));(function($){"use strict";creme.ReportD3ChartSwapper=creme.component.Component.sub({_init_:function(element,options){var self=this;options=$.extend({debounceDelay:100},options||{});this._charts={};this._element=element;this._backend=options.backend||creme.ajax.defaultCacheBackend();this._model=new creme.model.AjaxArray(this._backend);this._model.url(options.fetchUrl);this.debounceDelay(options.debounceDelay);this._selectionListeners={change:function(event){return self._onSelectionChange(event);}};this._sketch=new creme.D3Sketch().bind(element.find('.brick-d3-content'));this._sortState=element.find('.chart-controls-sort .chart-control-value').dropdown();this._plotState=element.find('.chart-controls-plot .chart-control-value').dropdown();element.on('change','.chart-controls-plot .chart-control-value',function(e){this.swapChart($(e.target).val()).draw();this._updateFetchSettings();}.bind(this));element.on('change','.chart-controls-sort .chart-control-value',function(e){this.model().reverse();this._updateFetchSettings();}.bind(this));this._model.reset(this.initialData());this.charts(options.charts);this.swapChart(this._plotState.val());},charts:function(charts){if(charts===undefined){return this._charts;}
Assert.not(Object.isEmpty(charts),'ReportD3ChartBrickController must have a dict of creme.D3Chart');for(var key in charts){var chart=charts[key];Assert.is(chart,creme.D3Chart,'${key} : ${chart} is not a creme.D3Chart',{key:key,chart:chart});}
this._charts=charts;},chart:function(){return this._chart;},selected:function(){var chart=this.chart();return chart?chart.selection().selected():[];},model:function(){return this._model;},sketch:function(){return this._sketch;},draw:function(){Object.values(this._charts).forEach(function(chart){if(chart.hasCanvas()){chart.draw();}});return this;},debounceDelay:function(delay){return Object.property(this,'_debounceDelay',delay);},state:function(){var plot=this._element.find('.chart-controls-plot .chart-control-value').val();var sort=this._element.find('.chart-controls-sort .chart-control-value').val();return{plot:plot,sort:sort};},swapChart:function(name){var chart=this._charts[name];if(Object.isNone(chart)){console.warn('ReportD3ChartSwapper : unable to swap to the unknown chart "${name}"'.template({name:name}));return;}
if(this._chart){this._chart.props({visible:false});this._chart.selection().off(this._selectionListeners);}
chart.props(this.initialProps()[name]||{}).props({visible:true}).sketch(this._sketch).model(this._model);chart.selection().on(this._selectionListeners);this._chart=chart;return this;},_updateFetchSettings:function(){var url=this._element.find('.chart-controls').data('fetchSettingsUrl');_.debounce(function(){creme.ajax.query(url,{action:'post',dataType:'json'},this.state()).start();}.bind(this),this.debounceDelay()||0)();},_onSelectionChange:function(event){var data=this.selected();if(data.length>0&&data[0].url){creme.utils.redirect(data[0].url);}},initialData:function(){var script=$('script[type$="/json"].sketch-chart-data:first',this._element);var data=_.readJSONScriptText(script.get(0));return Object.isEmpty(data)?[]:JSON.parse(data);},initialProps:function(){var script=$('script[type$="/json"].sketch-chart-props:first',this._element);var data=_.readJSONScriptText(script.get(0));return Object.isEmpty(data)?{}:JSON.parse(data);}});creme.setupReportD3ChartBrick=function(element,options){var controller=new creme.ReportD3ChartBrickController(options);$(element).on('brick-ready',function(e,brick){controller.bind(brick);}).on('brick-setup-actions',function(e,brick,actions){controller.registerActions(brick);});return controller;};creme.ReportD3ChartBrickController=creme.component.Component.sub({_init_:function(options){this.props(options||{});},props:function(props){return Object.property(this,'_props',props);},isBound:function(){return Object.isNone(this._brick)===false;},bind:function(brick){Assert.not(this.isBound(),'ReportD3ChartBrickController is already bound');this._brick=brick;if(brick.element().find('.brick-d3-content').length>0){this._swapper=new creme.ReportD3ChartSwapper(brick.element(),{charts:this.props().charts});this._swapper.draw();}},swapper:function(){return this._swapper;},registerActions:function(brick){var self=this;Assert.is(brick,creme.bricks.Brick,'${brick} is not a creme.bricks.Brick',{brick:brick});brick.getActionBuilders().registerAll({'sketch-download':function(url,options,data,e){options=$.extend({filename:url,width:$(window).innerWidth(),height:$(window).innerHeight()},options||{});return new creme.D3ChartBrickDownloadAction(this._brick,self.swapper().chart(),options);},'sketch-popover':function(url,options,data,e){options=$.extend({width:$(window).innerWidth()*0.8,height:$(window).innerHeight()*0.8},options||{});return new creme.D3ChartBrickPopoverAction(this._brick,self.swapper().chart(),options);}});}});creme.ReportD3ChartListBrickController=creme.component.Component.sub({_init_:function(options){this.props(options);},props:function(props){return Object.property(this,'_props',props);},isBound:function(){return Object.isNone(this._brick)===false;},bind:function(brick){Assert.not(this.isBound(),'ReportD3ChartListBrickController is already bound');this._brick=brick;var props=this.props();var swappers=this._swappers={};brick.element().find('.chart-row:not(.is-empty)').each(function(){swappers[$(this).data('chartId')]=new creme.ReportD3ChartSwapper($(this),{charts:props.charts()});});brick.element().on('click','.chart-accordion-title',function(e){var chartId=$(this).data('chartId');brick.element().find('.chart-row').filter(function(){return $(this).data('chartId')===chartId;}).toggleClass('chart-row-collapsed');$(this).toggleClass('chart-accordion-expanded');if($(this).is('.chart-accordion-expanded')){swappers[chartId].draw();}});},swappers:function(){return this._swappers;}});creme.setupReportD3ChartListBrick=function(element,options){var controller=new creme.ReportD3ChartListBrickController(options);$(element).on('brick-ready',function(e,brick){controller.bind(brick);});return controller;};}(jQuery));(function($){"use strict";creme.D3TubeChart=creme.D3Chart.sub({defaultProps:{xAxisSize:20,xAxisTitle:'',xAxisTickFormat:null,barTextFormat:null,barTextAlignmentRatio:0.5,barTextVisibleMinSize:30,colors:["#98abc5","#8a89a6","#7b6888","#6b486b","#a05d56","#d0743c","#ff8c00"],margin:5,showLegend:true,transition:true,visible:true,scrollLegend:null,legendItemMinWidth:60},exportStyle:function(props){return creme.svgRulesAsCSS({".tube-chart":{font:"10px sans-serif"},".tube-chart .bar rect":{"shape-rendering":"crispedges"},".tube-chart .bar text":{"text-anchor":"middle"},".tube-chart .bar .dark-bg":{"font-weight":"bold"}});},exportProps:function(){return{transition:false,drawOnResize:false,scrollLegend:false};},_draw:function(sketch,data,props){var svg=sketch.svg();var chart=svg.select(".tube-chart");if(chart.size()===0){chart=svg.append('g').attr('class','tube-chart d3-chart');this._setupChart(sketch,chart,props);}
chart.classed('not-visible',!props.visible);this._updateChart(sketch,chart,data,props);},_setupChart:function(sketch,chart,props){chart.append('g').attr('class','x axis');chart.append('g').attr('class','bars');var legend=chart.append('g').attr('class','legend');this.scroll=creme.d3Scroll().target(legend);},_updateChart:function(sketch,chart,data,props){var scrollLegend=props.scrollLegend;var bounds=creme.svgBounds(sketch.size(),props.margin,{left:5,right:5});var colors=creme.d3ColorRange(props.colors,{size:data.length});var colorScale=d3.scaleOrdinal().domain([0,data.length]).range(colors);var xscale=d3.scaleLinear();var colorize=creme.d3Colorize().scale(colorScale);data=this.hierarchy(data);data=colorize(data);var yDataInfo=creme.d3NumericDataInfo(data,function(d){return d.endX;});var barTextFormat=props.barTextFormat||creme.d3NumericFormat(yDataInfo);var xAxisTickFormat=props.xAxisTickFormat||creme.d3NumericAxisFormat(yDataInfo);var ymax=yDataInfo.max||1;var legendHeight=0;chart.attr('transform',creme.svgTransform().translate(bounds.left,bounds.top));if(scrollLegend===null){scrollLegend=Boolean(props.legendItemMinWidth*data.length>bounds.width);}
var legendWidth=scrollLegend?Math.max(props.legendItemMinWidth*data.length,bounds.width):bounds.width;if(props.showLegend){var legend=chart.select('.legend');var itemMaxWidth=Math.ceil(legendWidth/data.length);var legendRow=creme.d3LegendRow().swatchColor(function(d){return d.color;}).swatchSize({width:16,height:16}).text(function(d){return d.x;}).interval(itemMaxWidth).data(data);legend.call(legendRow);legendHeight=Math.ceil(legend.node().getBBox().height);legend.classed('legend-scroll',scrollLegend);}
xscale.domain([0,ymax]).range([0,bounds.width]);var xAxisTicks=yDataInfo.integer?Math.min(yDataInfo.gap,8):8;chart.select('.x.axis').call(creme.d3BottomAxis().scale(xscale).tickFormat(xAxisTickFormat).minHeight(props.xAxisSize).tickWrapWidth(bounds.width/xAxisTicks).ticks(xAxisTicks).label(props.xAxisTitle)).attr('transform',function(){return creme.svgTransform().translate(0,bounds.height-Math.floor(this.getBBox().height));});var xAxisHeight=Math.floor(chart.select('.x.axis').node().getBBox().height);bounds=creme.svgBounds(bounds,{top:legendHeight,bottom:xAxisHeight});var nonzero_data=data.filter(function(d){return d.y>0;});var items=chart.select('.bars').attr('transform',creme.svgTransform().translate(0,legendHeight)).selectAll('.bar').data(nonzero_data);var context={bounds:bounds,xscale:xscale,textformat:barTextFormat,textAlignRatio:props.barTextAlignmentRatio,textMinVisibleSize:props.barTextVisibleMinSize,transition:props.transition};this._enterStack(items.enter(),context);this._updateStack(props.transition?items.transition():items,context);items.exit().remove();if(props.showLegend&&scrollLegend){this.scroll.bounds(bounds).disabled(false).innerSize({width:legendWidth});legend.call(this.scroll);}else{this.scroll.disabled(true);}
return chart;},hierarchy:function(data){var acc=0;return data.map(function(d,i){var entry={y:d.y,x:d.x,index:i,startX:acc,endX:acc+d.y,color:d.color,data:d};acc+=d.y;return entry;});},itemClasses:function(d,context){var classes=[];if(Math.abs(context.xscale(d.y))<context.textMinVisibleSize){classes.push('hidden-label');}
if(d.isDarkColor){classes.push('dark-bg');}
return classes.join(' ');},_enterStack:function(enter,context){var self=this;var selection=this.selection();var xscale=context.xscale;var textformat=context.textformat;var textAlignRatio=context.textAlignRatio;var bounds=context.bounds;var bar=enter.append('g').attr('class','bar').classed('selected',function(d){return d.data.selected;}).attr('transform',function(d){return creme.svgTransform().translate(xscale(d.startX)||0,0);});bar.append('rect').attr('x',1).attr('width',function(d){return xscale(d.y);}).attr('height',bounds.height).attr("fill",function(d){return d.color;}).on('click',function(e,d){selection.select(d.index);});bar.append('text').attr('dy','.75em').attr('y',Math.ceil(bounds.height/2)).attr('x',function(d){return xscale(d.y)*textAlignRatio;}).attr('class',function(d){return self.itemClasses(d,context);}).attr('fill',function(d){return d.textColor;}).text(function(d){return textformat(d.y);});},_updateStack:function(update,context){var self=this;var xscale=context.xscale;var textformat=context.textformat;var textAlignRatio=context.textAlignRatio;var bounds=context.bounds;update.selection().classed('selected',function(d){return d.data.selected;});update.attr('transform',function(d){return creme.svgTransform().translate(xscale(d.startX)||0,0);});update.select('rect').attr('width',function(d){return xscale(d.y);}).attr('height',bounds.height).attr("fill",function(d){return d.color;});update.select('text').attr('y',Math.ceil(bounds.height/2)).attr('x',function(d){return xscale(d.y)*textAlignRatio;}).attr('class',function(d){return self.itemClasses(d,context);}).attr('fill',function(d){return d.textColor;}).text(function(d){return textformat(d.y);});}});}(jQuery));(function($){"use strict";creme.D3GraphRelationChart=creme.D3Chart.sub({defaultProps:{margin:0,nodeFillColor:"white",nodeStrokeColor:"#ccc",nodeStrokeSize:2,nodeEdgeCountStep:4,nodeSize:10,nodeTextColor:"black",edgeColors:d3.schemeCategory10,maxIteration:100,transition:true,showLegend:true,drawOnResize:false},_init_:function(options){this._super_(creme.D3Chart,'_init_',options);},hierarchy:function(data){var relations={};var nodes={};var edge_counts={};var edges=data.filter(function(d){return d.relation;}).map(function(d){relations[d.relation.id]=d.relation;edge_counts[d.id]=(edge_counts[d.id]||0)+1;if(d.parent){edge_counts[d.parent]=(edge_counts[d.parent]||0)+1;}
return{target:d.id,source:d.parent,data:d};});data.forEach(function(d){nodes[d.id]={id:d.id,edgeCount:edge_counts[d.id]||0,data:{url:d.url,label:d.label}};});return{nodes:Object.values(nodes),types:Object.values(relations),edges:edges};},exportProps:function(){return{transition:false};},_nodeRadius:function(props){return function(d){return props.nodeSize+((d.edgeCount||0)*props.nodeEdgeCountStep);};},_draw:function(sketch,data,props){var svg=sketch.svg();var chart=svg.select(".graphs-relation-chart");if(chart.size()===0){chart=svg.append("g").attr('class','graphs-relation-chart d3-chart');svg.append('g').attr('class','legend');}
this._updateChart(sketch,chart,data,props);return this;},_updateChart:function(sketch,chart,data,props){var svg=sketch.svg();var bounds=creme.svgBounds(sketch.size(),{left:props.xaxisSize,bottom:props.yaxisSize},props.margin);var graphData=this.hierarchy(data);var typeColorScale=d3.scaleOrdinal(graphData.types.map(function(d){return d.id;}),d3.schemeCategory10);var typeColor=function(d){return typeColorScale(d.id);};var alphaDecay=1.0-Math.pow(0.001,(1.0/props.maxIteration));var simulation=d3.forceSimulation().stop().nodes(graphData.nodes).alphaDecay(alphaDecay);simulation.force('link',d3.forceLink(graphData.edges).id(function(node){return node.id;})).force('charge',d3.forceManyBody().strength(-400)).force('center',d3.forceCenter(bounds.width/2,bounds.height/2)).force('collide',d3.forceCollide().radius(70).iterations(2));svg.append("defs").selectAll('marker').data(graphData.types).join('marker').attr("id",function(d){return"graphs-relation-arrow-"+d.id;}).attr("viewBox","0 -5 10 10").attr("refX",4).attr("refY",0).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("path").attr("fill",typeColor).attr("d","M0,-5L10,0L0,5");if(props.showLegend){var legends=creme.d3LegendColumn().swatchColor(typeColor).swatchSize({width:20,height:25}).spacing(0).text(function(d){return d.label;}).data(graphData.types);sketch.svg().select('.legend').call(legends);}
var link=chart.append("g").attr('class','graph-edges').attr("fill","none").attr("stroke-width",1.5).selectAll("path").data(graphData.edges).join('path').attr('class','graph-edge').attr("stroke",function(d){return typeColorScale(d.data.relation.id);}).attr("marker-end",function(d){return'url(#graphs-relation-arrow-'+d.data.relation.id+')';});var node=chart.append("g").attr('class','graph-nodes').attr("fill","currentColor").attr("stroke-linecap","round").attr("stroke-linejoin","round").selectAll("g").data(graphData.nodes).join('g').attr('class','graph-node');node.append("circle").attr("fill",props.nodeFillColor).attr("stroke",props.nodeStrokeColor).attr("stroke-width",props.nodeStrokeSize).attr("r",this._nodeRadius(props));node.append("a").attr("x",8).attr("y","0.31em").attr("xlink:href",function(d){return d.data.url;}).attr("target",function(d){return!d.data.url?'_blank':undefined;}).append("text").attr("y","0.31em").attr('text-anchor','middle').text(function(d){return d.data.label;}).attr("fill",props.nodeTextColor).clone(true).lower().attr("fill","none").attr("stroke","#fff").attr("stroke-width",2);var zoom=d3.zoom();zoom.extent([[0,0],[bounds.width,bounds.height]]);zoom.on("zoom",function(e){chart.attr("transform",e.transform);});var applyState=this._applySimulationState.bind(this);if(props.transition){simulation.on("tick",function(){applyState(link,node,props);});simulation.restart();}else{simulation.tick(props.maxIteration);applyState(link,node,props);}
svg.call(zoom).call(zoom.transform,d3.zoomIdentity);return chart;},_applySimulationState:function(link,node,props){var radius=this._nodeRadius(props);link.attr("d",function(d){var xdiff=d.target.x-d.source.x;var ydiff=d.target.y-d.source.y;var targetRadius=radius(d.target)+5+(props.nodeStrokeSize/2);var r=Math.hypot(xdiff,ydiff);var distance=Math.sqrt((xdiff*xdiff)+(ydiff*ydiff));var ratio=(distance-targetRadius)/distance;var xoffset=xdiff*ratio;var yoffset=ydiff*ratio;return'M${source_x},${source_y}\nA${r},${r} 0 0,1 ${target_x},${target_y}'.template({source_x:d.source.x,source_y:d.source.y,target_x:d.source.x+xoffset,target_y:d.source.y+yoffset,r:r});});node.attr("transform",function(d){return creme.svgTransform().translate(d.x,d.y);});}});}(jQuery));(function($){"use strict";creme.crudity={};var waitingSyncActions={'crudity-validate':function(url,options,data,e){var values=this._selectedRowValues().filter(Object.isNotEmpty);if(values.length===0){return this._warningAction(gettext('Nothing is selected.'));}
return this._build_update(url,{messageOnSuccess:gettext('Process done')},{ids:values},e);},'crudity-validate-row':function(url,options,data,e){return this._build_update(url,{messageOnSuccess:gettext('Process done')},{ids:[data.id]},e);},'crudity-delete':function(url,options,data,e){var values=this._selectedRowValues().filter(Object.isNotEmpty);if(values.length===0){return this._warningAction(gettext('Nothing is selected.'));}
return this._build_update(url,{messageOnSuccess:gettext('Process done')},{ids:values},e);}};$(document).on('brick-setup-actions','.brick.crudity-actions-brick',function(e,brick,actions){actions.registerAll(waitingSyncActions);});creme.crudity.RefreshSyncStatusAction=creme.component.Action.sub({_init_:function(options){this._super_(creme.component.Action,'_init_',this._run,options);},_reloadCrudityDeps:function(backends){var self=this;var dependencies=new creme.bricks.Dependencies([]);$('.brick').each(function(){var brick=$(this);if(backends.indexOf(brick.attr('data-crudity-backend'))!==-1){dependencies.add(brick.creme().widget().brick().dependencies());}});var reload=new creme.bricks.BricksReloader().dependencies(dependencies).action();reload.on({fail:function(event,error){self.fail(error);},'done cancel':function(){self.done(backends);}});return reload.start();},_run:function(options){options=$.extend({},this.options(),options||{});var self=this;var query=creme.ajax.query(options.url||'',{action:'post'});query.onFail(function(event,error){if(options.warnOnFail){creme.dialogs.warning(error).onClose(function(){self.fail(error);}).open();}else{self.fail(error);}}).onDone(function(event,data){data=_.cleanJSON(data)||[];if(Array.isArray(data)&&!Object.isEmpty(data)){return self._reloadCrudityDeps(data);}else{self.done(data);}}).start();}});var CrudityActionBuilderRegistry=creme.component.FactoryRegistry.sub({_build_crudity_hatbar_refresh:function(url,options,data,e){return new creme.crudity.RefreshSyncStatusAction({url:url,warnOnFail:true});}});creme.crudity.CrudityHatController=creme.component.Component.sub({_init_:function(){this._builders=new CrudityActionBuilderRegistry();},isBound:function(){return Object.isNone(this._element)===false;},bind:function(element){if(this.isBound()){throw new Error('CrudityHatController is already bound');}
this._element=element;var builders=this._builders;element.find('a[data-action]').each(function(){new creme.action.ActionLink().builders(builders).bind($(this));});return this;},refresh:function(delay){if(this.isBound()===false){return this;}
var self=this;if(this._timeout){clearTimeout(this._timeout);}
this._timeout=setTimeout(function(){self._timeout=undefined;self._element.find('a[data-action="crudity-hatbar-refresh"]').trigger('click');},delay||0);return this;}});}(jQuery));(function($){"use strict";creme.emails={};creme.emails.LinkEMailToAction=creme.component.Action.sub({_init_:function(options){this._super_(creme.component.Action,'_init_',this._run,options);},_run:function(options){options=$.extend({},this._options,options||{});var self=this;var formData={ids:options.ids,rtype:options.rtypes};var dialog=creme.dialogs.form(options.url,{submitData:formData},formData);dialog.onFormSuccess(function(event,data){var deps=['creme_core.relation'].concat(options.rtypes.map(function(rtype){return'creme_core.relation.'+rtype;}));new creme.bricks.BricksReloader().dependencies(deps).action().start();self.done();}).onClose(function(){self.cancel();}).open({width:1024});}});$(document).on('brick-setup-actions','.creme_core-buttons-brick',function(e,brick,actions){actions.register('emails-hatmenubar-linkto',function(url,options,data,e){return new creme.emails.LinkEMailToAction({url:url,rtypes:data.rtypes,ids:data.ids});});});var _emailSyncSelection=function(registry,data){if(Object.isEmpty(data.id)){return registry._selectedRowValues().filter(Object.isNotEmpty);}else{return[data.id];}};creme.emails.MultiSelectedAction=creme.component.Action.sub({_init_:function(brick,ids,options){options=$.extend({successMessageBuilder:function(count){return'%d email(s) have been processed.'.format(count);},failMessageBuilder:function(count){return'%d email(s) cannot be processed.'.format(count);}},options||{});this._super_(creme.component.Action,'_init_',this._run,options);this._brick=brick;this._ids=ids;Assert.not(Object.isEmpty(options.url),"'url' option is required");this._url=options.url;this._successMessageBuilder=options.successMessageBuilder;this._failMessageBuilder=options.failMessageBuilder;},_onMultiFail:function(event,data,response){var message=gettext('Some errors occurred.');var header=creme.ajax.localizedErrorMessage(response.status);if(!Object.isEmpty(data)&&_.isJSON(data)){var results=JSON.parse(data);var removedCount=results.count-results.errors.length;if(removedCount>0){header=this._successMessageBuilder(removedCount);}
if(results.errors){header+=' - '+this._failMessageBuilder(results.errors.length);}
message='<ul>'+
results.errors.map(function(item){return'<li>'+item+'</li>';}).join('')+'</ul>';}
var brick=this._brick;creme.dialogs.warning(message,{header:header}).onClose(function(){brick.refresh();}).open();},_run:function(options){var self=this;var query=creme.utils.ajaxQuery(self._url,{action:'POST',confirm:true,warnOnFail:false},{ids:self._ids.join(',')});query.onDone(function(){self._brick.refresh();}).onFail(this._onMultiFail.bind(this)).start();}});var emailSyncActions={'emailsync-accept':function(url,options,data,e){var id=data.ids;if(!id){return this._warningAction(gettext('No email is selected.'));}
return new creme.emails.MultiSelectedAction(this._brick,[id],{url:url,successMessageBuilder:function(count){return ngettext('%d email has been synchronised','%d emails have been synchronised',count).format(count);},failMessageBuilder:function(count){return ngettext('%d email cannot be synchronised.','%d emails cannot be synchronised.',count).format(count);}});},'emailsync-accept-multi':function(url,options,data,e){var ids=_emailSyncSelection(this,data);if(Object.isEmpty(ids)){return this._warningAction(gettext('No email is selected.'));}
return new creme.emails.MultiSelectedAction(this._brick,ids,{url:url,successMessageBuilder:function(count){return ngettext('%d email has been synchronised','%d emails have been synchronised',count).format(count);},failMessageBuilder:function(count){return ngettext('%d email cannot be synchronised.','%d emails cannot be synchronised.',count).format(count);}});},'emailsync-delete':function(url,options,data,e){var id=data.ids;if(!id){return this._warningAction(gettext('No email is selected.'));}
return new creme.emails.MultiSelectedAction(this._brick,[id],{url:url,successMessageBuilder:function(count){return ngettext('%d email has been deleted','%d emails have been deleted',count).format(count);},failMessageBuilder:function(count){return ngettext('%d email cannot be deleted.','%d emails cannot be deleted.',count).format(count);}});},'emailsync-delete-multi':function(url,options,data,e){var ids=_emailSyncSelection(this,data);if(Object.isEmpty(ids)){return this._warningAction(gettext('No email is selected.'));}
return new creme.emails.MultiSelectedAction(this._brick,ids,{url:url,successMessageBuilder:function(count){return ngettext('%d email has been deleted','%d emails have been deleted',count).format(count);},failMessageBuilder:function(count){return ngettext('%d email cannot be deleted.','%d emails cannot be deleted.',count).format(count);}});}};$(document).on('brick-setup-actions','.brick.emails-emails_to_sync-brick',function(e,brick,actions){actions.registerAll(emailSyncActions);});var emailActions={'email-toggle-images':function(url,options,data,e){var iframe=this._brick.element().find('iframe[data-html-field]');var link=document.createElement('a');link.href=iframe.attr('src');var visible=link.search.indexOf('external_img=on')!==-1;var nexturl=link.pathname+(visible?'':'?external_img=on');var title=$(e.target).find('.brick-action-title');if(title.length){title.text(visible?data.inlabel:data.outlabel);}else{$(e.target).text(visible?data.inlabel:data.outlabel);}
iframe.attr('src',nexturl);}};$(document).on('brick-setup-actions','.brick.emails-email-brick',function(e,brick,actions){actions.registerAll(emailActions);});creme.emails.ResendEMailsAction=creme.component.Action.sub({_init_:function(list,options){this._super_(creme.component.Action,'_init_',this._run,options);this._list=list;},_onResendFail:function(event,error,data){var self=this;var list=this._list;var message=Object.isType(error,'string')?error:(error.message||gettext("Error"));var header=creme.ajax.localizedErrorMessage(data);creme.dialogs.warning(message,{header:header}).onClose(function(){list.reload();self.fail();}).open();},_run:function(options){options=$.extend({},this.options(),options||{});var self=this;var list=this._list;var selection=list.selectedRows();if(Array.isArray(options.selection)){selection=_.unique(selection.concat(options.selection));}
if(selection.length<1){creme.dialogs.warning(gettext("Please select at least one email.")).onClose(function(){self.cancel();}).open();}else{var query=creme.utils.ajaxQuery(options.url,{action:'POST',confirm:true,warnOnFail:false},{ids:selection.join(',')});query.onFail(this._onResendFail.bind(this)).onCancel(function(event,data){self.cancel();}).onDone(function(event,data){list.reload();self.done();}).start();}}});$(document).on('listview-setup-actions','.ui-creme-listview',function(e,actions){actions.register('email-resend-selection',function(url,options,data,e){return new creme.emails.ResendEMailsAction(this._list,{url:url});});actions.register('email-resend',function(url,options,data,e){return new creme.emails.ResendEMailsAction(this._list,{url:url,selection:options.selection});});});}(jQuery));(function($){"use strict";creme.events=creme.events||{};creme.events.saveContactStatus=function(url,select){creme.utils.ajaxQuery(url,{action:'post',warnOnFail:true,reloadOnFail:true},{status:$(select).val()}).start();};}(jQuery));(function($){"use strict";creme.geolocation=creme.geolocation||{};creme.geolocation.LocationStatus={UNDEFINED:0,MANUAL:1,PARTIAL:2,COMPLETE:3};creme.geolocation.locationStatusLabel=function(status){switch(status){case creme.geolocation.LocationStatus.UNDEFINED:return gettext("Not localized");case creme.geolocation.LocationStatus.MANUAL:return gettext("Manual location");case creme.geolocation.LocationStatus.PARTIAL:return gettext("Partially matching location");default:return'';}};creme.geolocation.Location=creme.component.Component.sub({_init_:function(options){options=options||{};if(options instanceof creme.geolocation.Location){return this._init_(options.props());}
this.id(options.id);this.content(options.content||'');this.title(options.title||'');this.owner(options.owner);this.icon(options.icon);this.iconShadow(options.iconShadow);this.extraData(options.extraData);if(options.latitude){this.position({lat:options.latitude,lng:options.longitude});}else{this.position(options.position||null);}
this.visible(options.visible||false);this.status(options.status||creme.geolocation.LocationStatus.UNDEFINED);this.url(options.url);},props:function(){return{id:this.id(),content:this.content(),title:this.title(),owner:this.owner(),position:this.position(),visible:this.visible(),status:this.status(),url:this.url(),icon:this.icon(),iconShadow:this.iconShadow(),extraData:this.extraData()};},extraData:function(extra){return Object.property(this,'_extraData',extra);},icon:function(icon){return Object.property(this,'_icon',icon);},iconShadow:function(icon){return Object.property(this,'_iconShadow',icon);},id:function(id){return Object.property(this,'_id',id);},content:function(content){return Object.property(this,'_content',content);},title:function(title){return Object.property(this,'_title',title);},owner:function(owner){return Object.property(this,'_owner',owner);},position:function(position){return Object.property(this,'_position',position);},visible:function(visible){return Object.property(this,'_visible',visible);},status:function(status){return Object.property(this,'_status',status);},url:function(url){return Object.property(this,'_url',url);},isComplete:function(){return this.status()===creme.geolocation.LocationStatus.COMPLETE;},isPartial:function(){return this.status()===creme.geolocation.LocationStatus.PARTIAL;},isManual:function(){return this.status()===creme.geolocation.LocationStatus.MANUAL;},hasPosition:function(){return Object.isEmpty(this._position)===false;},statusLabel:function(){return creme.geolocation.locationStatusLabel(this._status);},positionLabel:function(){return this.hasPosition()?'%3.6f, %3.6f'.format(this._position.lat,this._position.lng):'';},markerLabel:function(){var title=this.title();if(Object.isNotEmpty(title)){title="("+title+")";}
return[this.owner()||'',this.content(),title].filter(Object.isNotEmpty).join('\n');}});creme.geolocation.GeoMapController=creme.component.Component.sub({_init_:function(options){options=$.extend({allowGeocoder:true},options||{});this._events=new creme.component.EventHandler();this._enabled=false;this._allowGeocoder=options.allowGeocoder;},on:function(event,listener,decorator){this._events.on(event,listener,decorator);return this;},off:function(event,listener){this._events.off(event,listener);return this;},one:function(event,listener){this._events.one(event,listener);return this;},trigger:function(event,data){if(this.isBound()){this._element.trigger('geomap-'+event,[this].concat(data||[]));}
this._events.trigger(event,data,this);return this;},bind:function(element){if(this.isBound()){throw new Error('GeoMapController is already bound');}
this._element=element;this._bindMap(element);return this;},unbind:function(){if(!this.isBound()){throw new Error('GeoMapController is not bound');}
this._unbindMap(this._element);this._element=undefined;},element:function(){return this._element;},isBound:function(){return Object.isNone(this._element)===false;},isGeocoderAllowed:function(allowed){return Object.property(this,'_allowGeocoder',allowed);},isMapEnabled:function(){return false;},isGeocoderEnabled:function(){return false;},_bindMap:function(element){throw new Error('Not implemented');},_unbindMap:function(element){throw new Error('Not implemented');},markLocation:function(options,listeners){options=options||{};var self=this;var location=new creme.geolocation.Location(options.location);var query;if(location.hasPosition()&&!options.force){query=new creme.component.Action(function(){this.done(location.position(),location.status(),{});});}else{query=this._searchLocationQuery(location.content());}
query.onDone(function(event,position,status,data){self._updateLocationMarker({id:location.id(),title:location.markerLabel(),location:location,position:position,status:status,icon:location.icon(),iconShadow:location.iconShadow(),draggable:options.draggable||false,searchData:data,extraData:options.extraData||{}});}).on(listeners||{});return query.start();},_updateLocationMarker:function(options){options=options||{};var marker=this.updateOrAddMarker(options.id,options);this.trigger('marker-move',[marker,Object.assign(this.getMarkerProperties(options.id),{status:options.status,searchData:options.searchData,location:options.location})]);},_searchLocationQuery:function(content){return new creme.component.Action(function(){this.cancel();});},isEnabled:function(enabled){if(enabled===undefined){return this._enabled||false;}
this._enabled=enabled;this.trigger('status',enabled);this.trigger('status-${state}'.template({state:enabled?'enabled':'disabled'}));},updateOrAddMarker:function(id,options){if(this.hasMarker(id)){this.updateMarker(id,options);return this.getMarker(id);}else{return this.addMarker(id,options);}},replaceMarkers:function(data){data=(data||[]).filter(function(d){return Object.isNotEmpty(d.id);});var dataIds=data.map(function(d){return d.id;});var markerIds=this.markerIds();data.map(function(data){return this.updateOrAddMarker(data.id,data);}.bind(this));var removed=markerIds.filter(function(id){return dataIds.indexOf(id)===-1;});removed.forEach(this.removeMarker.bind(this));return this.markers();},addMarker:function(id,options){throw new Error('Not implemented');},removeMarker:function(id){return this;},removeAllMarkers:function(){this.markerIds().forEach(this.removeMarker.bind(this));return this;},updateMarker:function(id,options){return this;},getMarker:function(id){throw new Error('Not implemented');},getMarkerProperties:function(id){throw new Error('Not implemented');},hasMarker:function(id){return false;},markers:function(query){return[];},markerIds:function(query){return[];},toggleMarker:function(id,state){return this;},toggleAllMarkers:function(state){return this;},addShape:function(id,options){throw new Error('Not implemented');},getShape:function(id){throw new Error('Not implemented');},hasShape:function(id){return false;},updateOrAddShape:function(id,options){if(this.hasShape(id)){this.updateShape(id,options);return this.getShape(id);}else{return this.addShape(id,options);}},updateShape:function(id,options){return this;},removeShape:function(id){return this;},removeAllShapes:function(){this.shapeIds().forEach(this.removeShape.bind(this));return this;},shapes:function(query){return[];},shapeIds:function(query){return[];},autoResize:function(){return this;},adjustMap:function(){throw new Error('Not implemented');},adjustMapToShape:function(id){throw new Error('Not implemented');}});}(jQuery));(function($){"use strict";creme.geolocation=creme.geolocation||{};var __googleAPIStatus={NONE:0,LOADING:1,READY:2,UNAVAILABLE:-1};var __googleAPI={apiStatus:__googleAPIStatus.NONE};var __googleAPIEvents=new creme.component.EventHandler();window.__googleAPILoaderCb=function(){__googleAPI.apiStatus=__googleAPIStatus.READY;__googleAPIEvents.trigger('google-api-ready',[$({},__googleAPI)]);};window.gm_authFailure=function(){__googleAPI.apiStatus=__googleAPIStatus.UNAVAILABLE;__googleAPIEvents.trigger('google-api-error',[$({},__googleAPI)]);};var googleAPIState=function(){return $.extend({},__googleAPI);};creme.geolocation.isGoogleAPIReady=function(){return __googleAPI.apiStatus===__googleAPIStatus.READY;};var GoogleAPILoader=creme.component.Action.sub({_init_:function(options){this._super_(creme.component.Action,'_init_',this._loadAPI,options);},_loadAPI:function(options){options=$.extend({language:LANGUAGE_CODE||'en'},this.options(),options);var self=this;if(__googleAPI.apiStatus===__googleAPIStatus.READY){return self.done(googleAPIState());}
__googleAPIEvents.on('google-api-ready',function(event,status){self.done(status);});if(__googleAPI.status!==__googleAPIStatus.LOADING){__googleAPI.status=__googleAPIStatus.LOADING;if(!options.apiKey){console.warn('creme.geolocation.googleAPILoader(): empty "apiKey" is deprecated ; configure it in settings.');}
var script=document.createElement('script');var parameters={v:options.apiVersion||'3.exp',callback:'__googleAPILoaderCb',language:options.language,key:options.apiKey||''};script.type='text/javascript';script.src=_.toRelativeURL('https://maps.googleapis.com/maps/api/js').searchData(parameters).toString();document.head.appendChild(script);}}});var GoogleMapShapeRegistry=creme.component.Component.sub({_init_:function(controller){this._controller=controller;this._shapes={};},all:function(query){query=query||{};var shapes=Object.values(this._shapes);if(query.visible!==undefined){shapes=shapes.filter(function(item){return item.getVisible()===query.visible;});}
return shapes;},register:function(id,shape){Assert.not(Object.isEmpty(id),'Shape id cannot be empty');Assert.not(id in this._shapes,'Shape "${id}" is already registered',{id:id});this._shapes[id]=shape;shape.__extra=(shape.__extra||{});shape.__extra.id=id;shape.setMap(this._controller.map());return shape;},unregister:function(id){Assert.not(Object.isEmpty(id),'Shape id cannot be empty');Assert.that(id in this._shapes,'Shape "${id}" is not registered',{id:id});var shape=this._shapes[id];delete shape.__extra.id;delete this._shapes[id];shape.setMap(null);return shape;},get:function(id){return this._shapes[id];},update:function(id,options){options=options||{};Assert.not(Object.isEmpty(id),'Shape id cannot be empty');Assert.that(id in this._shapes,'Shape "${id}" is not registered',{id:id});if(options.position){var position=options.position;options.center=new google.maps.LatLng(position.lat,position.lng);}
var shape=this.get(id);shape.setOptions(options);if(options.extraData){$.extend(shape.__extra.extraData,options.extraData||{});}},Circle:function(options){options=options||{};var position=options.position||{lat:0,lng:0};var shape=new google.maps.Circle({strokeColor:'#dea29b',strokeOpacity:0.9,strokeWeight:2,fillColor:'#dea29b',fillOpacity:0.40,map:this._controller.map(),center:new google.maps.LatLng(position.lat,position.lng),radius:options.radius});shape.__extra={extraData:$.extend({},options.extraData)};return shape;}});var __googleMarkerIcons={"circle":function(){return{path:google.maps.SymbolPath.CIRCLE,scale:5};},"target":function(){return{path:google.maps.SymbolPath.CIRCLE,scale:5};},"default":null};var __getGoogleMarkerIcon=function(path){var icon=__googleMarkerIcons[path||'default'];if(icon===undefined){return{url:path,size:new google.maps.Size(25,41),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(12,41)};}else if(Object.isFunc(icon)){return icon(path);}else{return null;}};var GoogleMapMarkerManager=creme.component.Component.sub({_init_:function(controller){this._controller=controller;this._markers={};},all:function(query){query=query||{};var markers=Object.values(this._markers);if(query.visible!==undefined){markers=markers.filter(function(item){return item.getVisible()===query.visible;});}
return markers;},register:function(id,marker){Assert.not(Object.isEmpty(id),'Marker id cannot be empty');Assert.not(id in this._markers,'Marker "${id}" is already registered',{id:id});this._markers[id]=marker;marker.__extra=(marker.__extra||{});marker.__extra.id=id;marker.setMap(this._controller.map());return marker;},unregister:function(id){Assert.not(Object.isEmpty(id),'Marker id cannot be empty');Assert.that(id in this._markers,'Marker "${id}" is not registered',{id:id});var marker=this._markers[id];delete marker.__extra.id;delete this._markers[id];marker.setMap(null);return marker;},Marker:function(options){options=options||{};options=$.extend({draggable:false},options);if(options.icon!==undefined){options.icon=__getGoogleMarkerIcon(options.icon);}
var marker=new google.maps.Marker(options);marker.__extra={extraData:$.extend({},options.extraData)};var controller=this._controller;google.maps.event.addListener(marker,'click',function(){controller.trigger('marker-click',[marker.__extra,marker,this]);});if(options.draggable){google.maps.event.addListener(marker,'dragstart',function(){this.__dropData=$.extend({},marker.__extra,{dragStartPosition:{lat:this.getPosition().lat(),lng:this.getPosition().lng()}});controller.trigger('marker-dragstart',[this.__dropData,marker,this]);});google.maps.event.addListener(marker,'dragend',function(){var dropData=$.extend({},this.__dropData||{},{dragStopPosition:{lat:this.getPosition().lat(),lng:this.getPosition().lng()}});controller.trigger('marker-dragstop',[dropData||{},marker,this]);});}
return marker;},update:function(id,options){options=options||{};Assert.not(Object.isEmpty(id),'Marker id cannot be empty');Assert.that(id in this._markers,'Marker "${id}" is not registered',{id:id});var marker=this.get(id);if(options.icon!==undefined){options.icon=__getGoogleMarkerIcon(options.icon);}
marker.setOptions(options);if(options.extraData){$.extend(marker.__extra.extraData,options.extraData||{});}},get:function(id){return this._markers[id];},getProperties:function(id){var marker=this.get(id);if(marker){return{id:id,title:marker.getTitle(),draggable:marker.getDraggable(),visible:marker.getVisible(),position:{lat:marker.getPosition().lat(),lng:marker.getPosition().lng()},extraData:(marker.__extra||{}).extraData||{}};}},toggle:function(id,state){var marker=this.get(id);if(marker){marker.setVisible(state===undefined?!marker.getVisible():state);}},toggleAll:function(state){for(var key in this._markers){this.toggle(key,state);}},getBoundBox:function(){var boundbox=new google.maps.LatLngBounds();this.all({visible:true}).forEach(function(marker){boundbox.extend(marker.getPosition());});return boundbox;}});creme.geolocation.GoogleMapController=creme.geolocation.GeoMapController.sub({MAPSTYLES:[{id:'creme',label:gettext('Map'),style:[{stylers:[{hue:'#94c6db'},{weight:2}]},{featureType:'road',elementType:'geometry',stylers:[{visibility:'simplified'}]}]}],_init_:function(options){options=$.extend({defaultZoomValue:12,defaultLat:48,defaultLn:2,defaultLargeZoom:4,styles:this.MAPSTYLES.slice(),apiVersion:'3.exp'},options||{});this._super_(creme.geolocation.GeoMapController,'_init_',options);this._options=options;this._markers=new GoogleMapMarkerManager(this);this._shapes=new GoogleMapShapeRegistry(this);},_unbindMap:function(element){this.disableMap();},_bindMap:function(){var self=this;var _APILoadedCb=function(){self.enableGeocoder();if(self.isBound()){self.enableMap();}};if(this.isAPIReady()){setTimeout(_APILoadedCb,0);return this;}
new GoogleAPILoader({apiKey:this.apiKey}).on('done',function(){setTimeout(_APILoadedCb,0);self.trigger('google-api-ready');}).on('fail',function(){console.warn('creme.geolocation.GoogleMapController(): google map API is now disabled');self.isEnabled(false);self.trigger('google-api-error');}).start();return this;},options:function(){return $.extend({},this._options);},enableMap:function(){Assert.not(this.isMapEnabled(),'Map canvas is already enabled');Assert.that(this.isBound(),'Cannot enable map of an unbound controller');this._assertAPIAvailable();var styles=this.options().styles||this.MAPSTYLES.slice();var container=this.element().get(0);var styleIds=styles.map(function(style){return style.id;}).concat(google.maps.MapTypeId.SATELLITE);var map=this._map=new google.maps.Map(container,{zoom:this.defaultZoomValue,mapTypeControlOptions:{mapTypeIds:styleIds}});styles.forEach(function(style){map.mapTypes.set(style.id,new google.maps.StyledMapType(style.style,{name:style.label}));});map.setMapTypeId(styleIds[0]);this.autoResize();this.adjustMap();this.isEnabled(true);return this;},disableMap:function(){this._assertMapEnabled();delete this._map;this.element().empty();this.isEnabled(false);return this;},enableGeocoder:function(){try{if(this.isGeocoderAllowed()&&!this.isGeocoderEnabled()){this._geocoder=new google.maps.Geocoder();}}catch(e){console.warn('creme.geolocation.GoogleMapController(): unable to build google.maps.Geocoder instance',e);}},_assertMapEnabled:function(){Assert.that(this.isMapEnabled(),'Map canvas is disabled');},_assertAPIAvailable:function(){Assert.that(this.isAPIReady(),'The google API is not available');},isMapEnabled:function(){return Object.isNone(this._map)===false;},isAPIReady:function(){return __googleAPI.apiStatus===__googleAPIStatus.READY;},isGeocoderEnabled:function(){return Object.isNone(this._geocoder)===false;},adjustMap:function(){if(!this.isMapEnabled()){return this;}
var markerCount=this._markers.all(true).length;var options=this.options();if(markerCount===0){this._map.setCenter(new google.maps.LatLng(options.defaultLat,options.defaultLn));this._map.setZoom(options.defaultLargeZoom);}else{var boundbox=this._markers.getBoundBox();this._map.setCenter(boundbox.getCenter());if(markerCount===1){this._map.setZoom(options.defaultZoomValue);}else{this._map.fitBounds(boundbox);}}
return this;},adjustMapToShape:function(id){if(!this.isMapEnabled()){return this;}
var options=this.options();var shape=this._shapes.get(id);if(shape){this._map.setCenter(shape.getCenter());this._map.fitBounds(shape.getBounds());}else{this._map.setCenter(new google.maps.LatLng(options.defaultLat,options.defaultLn));this._map.setZoom(options.defaultLargeZoom);}
return this;},_searchLocationQuery:function(search){var geocoder=this.geocoder();var isPartialMatch=function(results){if(results.length>1){return true;}
var match=results[0];if(match.partial_match===false){return false;}
return match.address_components.length<7;};return new creme.component.Action(function(){var action=this;if(Object.isNone(geocoder)){return this.cancel();}
try{geocoder.geocode({address:search},function(results,status){if(status!==google.maps.GeocoderStatus.OK){action.fail(gettext("No matching location"));return;}
var result=results[0];var position=result.geometry.location;var isPartial=isPartialMatch(results);var locationStatus=creme.geolocation.LocationStatus.COMPLETE;if(isPartial){locationStatus=creme.geolocation.LocationStatus.PARTIAL;}
action.done(position,locationStatus,result);});}catch(e){console.error(e);this.fail(gettext("No matching location"),e);}});},addMarker:function(id,options){this._assertMapEnabled();var marker=this._markers.Marker(options);this._markers.register(id,marker);return marker;},removeMarker:function(id){this._assertMapEnabled();this._markers.unregister(id);return this;},updateMarker:function(id,options){this._assertMapEnabled();this._markers.update(id,options);return this;},hasMarker:function(id){return this.isMapEnabled()&&Object.isNone(this._markers.get(id))===false;},getMarker:function(id){return this.isMapEnabled()?this._markers.get(id):undefined;},getMarkerProperties:function(id){return this.isMapEnabled()?this._markers.getProperties(id):undefined;},markers:function(query){return this.isMapEnabled()?this._markers.all(query):[];},markerIds:function(query){return this.markers(query).map(function(m){return m.__extra.id;});},toggleMarker:function(id,state){this._assertMapEnabled();this._markers.toggle(id,state);this.adjustMap();return this;},toggleAllMarkers:function(state){this._assertMapEnabled();this._markers.toggleAll(state);this.adjustMap();return this;},addShape:function(id,options){this._assertMapEnabled();var shape;var shapeType=options.shape||'';switch(shapeType.toLowerCase()){case'circle':shape=this._shapes.Circle(options);break;default:throw Error('Shape has unknown type "${shape}"'.template({shape:shapeType}));}
return this._shapes.register(id,shape);},getShape:function(id){return this.isMapEnabled()?this._shapes.get(id):undefined;},hasShape:function(id){return this.isMapEnabled()&&Object.isNone(this._shapes.get(id))===false;},updateShape:function(id,options){this._assertMapEnabled();this._shapes.update(id,options);return this;},removeShape:function(id){this._assertMapEnabled();this._shapes.unregister(id);return this;},shapes:function(query){return this.isMapEnabled()?this._shapes.all(query):[];},shapeIds:function(query){return this.shapes(query).map(function(s){return s.__extra.id;});},geocoder:function(){return this._geocoder;},map:function(){return this._map;},autoResize:function(){if(this.isMapEnabled()){google.maps.event.trigger(this._map,'resize');}
return this;}});}(jQuery));(function($,leaflet){"use strict";creme.geolocation=creme.geolocation||{};function __iconMark(options){return leaflet.icon(Object.assign({className:'geolocation-leaflet-marker',iconUrl:options.iconUrl,iconRetinaUrl:options.iconRetinaUrl,iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[-7,-57],shadowUrl:options.shadowUrl,shadowSize:[41,41],shadowAnchor:[12,41]},options||{}));}
function __iconDefault(){return __iconMark({iconUrl:creme_media_url('geolocation/images/marker-icon.png'),iconRetinaUrl:creme_media_url('geolocation/images/marker-icon-2x.png'),shadowUrl:creme_media_url('geolocation/images/marker-shadow.png')});}
var __ICONS={"circle":function(){return leaflet.divIcon('');},"default":function(){return __iconDefault();},"target":function(){return __iconMark({iconUrl:creme_media_url('geolocation/images/marker-icon-red.png'),iconRetinaUrl:creme_media_url('geolocation/images/marker-icon-red-2x.png'),shadowUrl:creme_media_url('geolocation/images/marker-shadow.png')});}};function __markerDraggable(marker,state){if(state===undefined){return marker.dragging&&marker.dragging.enabled();}else if(marker.dragging){if(state){marker.dragging.enable();}else{marker.dragging.disable();}}
return marker;}
function __iconMediaURL(path){if(String(path||'').includes('/'+window.THEME_NAME+'/')){return path;}else{return creme_media_url(path);}}
function __getIcon(path,shadowPath){var icon=__ICONS[path||'default'];if(Object.isFunc(icon)){icon=icon(path,shadowPath);}else if(path){icon=__iconMark({iconUrl:__iconMediaURL(path),iconRetinaUrl:__iconMediaURL(path),shadowUrl:shadowPath?__iconMediaURL(shadowPath):''});}
return icon||__iconDefault();}
function __markerIcon(marker,path,shadowPath){if(path===undefined){return marker.getIcon();}else{marker.setIcon(__getIcon(path,shadowPath));return marker;}}
function __circleShape(options){options=$.extend({color:'#dea29b',opacity:0.9,weight:2,fillColor:'#dea29b',fillOpacity:0.40,radius:1.0},options||{});return leaflet.circle([options.position.lat,options.position.lng],options);}
creme.geolocation.NominatimGeocoder=creme.component.Component.sub({_init_:function(options){options=$.extend({url:'https://nominatim.openstreetmap.org/search'},options||{});this._url=options.url;},search:function(content){function isPartialMatch(results){return results.length>1;}
var url=this._url;return new creme.component.Action(function(){var action=this;creme.ajax.query(url,{},{q:content,format:'json',addressdetails:1}).converter(JSON.parse).onDone(function(event,data){if(Object.isEmpty(data)){action.fail(gettext("No matching location"));return;}
var result=data[0];var position={lat:parseFloat(result.lat),lng:parseFloat(result.lon)};var locationStatus=creme.geolocation.LocationStatus.COMPLETE;if(isPartialMatch(data)){locationStatus=creme.geolocation.LocationStatus.PARTIAL;}
action.done(position,locationStatus,data);}).onFail(function(event,data){action.fail(gettext("No matching location"));}).start();});}});creme.geolocation.LeafletMapController=creme.geolocation.GeoMapController.sub({_init_:function(options){options=$.extend({defaultZoomValue:12,defaultLat:48,defaultLn:2,defaultLargeZoom:4,maxZoom:18,minZoom:1,tileMapUrl:'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',tileMapAttribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',nominatimUrl:'https://nominatim.openstreetmap.org/search'},options||{});this._super_(creme.geolocation.GeoMapController,'_init_',options);this._options=options;this._markers={};this._shapes={};},_bindMap:function(element){Assert.not(this.isMapEnabled(),'Map canvas is already enabled');var options=this.options();var map=this._map=leaflet.map(this.element().get(0),{maxZoom:options.maxZoom,minZoom:options.minZoom});map.setView([options.defaultLn,options.defaultLat],options.defaultZoomValue);leaflet.tileLayer(options.tileMapUrl,{attribution:options.tileMapAttribution}).addTo(map);this.enableGeocoder();this.autoResize();this.adjustMap();this.isEnabled(true);},_unbindMap:function(element){Assert.that(this.isMapEnabled(),'Map canvas is disabled');delete this._map;this.element().empty();this.isEnabled(false);},defaultLatLng:function(){var options=this.options();return leaflet.latLng([options.defaultLat,options.defaultLn]);},options:function(){return $.extend({},this._options);},geocoder:function(){return this._geocoder;},map:function(){return this._map;},isMapEnabled:function(){return Object.isNone(this._map)===false;},isGeocoderEnabled:function(){return Object.isNone(this._geocoder)===false;},enableGeocoder:function(){if(this.isGeocoderAllowed()&&!this.isGeocoderEnabled()){this._geocoder=new creme.geolocation.NominatimGeocoder({url:this.options().nominatimUrl});}
return this;},adjustMap:function(){if(!this.isMapEnabled()){return this;}
var markers=this.markers({visible:true});var options=this.options();if(markers.length===0){this._map.setView([options.defaultLat,options.defaultLn],options.defaultLargeZoom);}else if(markers.length===1){this._map.setView(markers[0].getLatLng(),options.defaultZoomValue);}else{var bounds=markers.map(function(marker){return marker.getLatLng();});this._map.fitBounds(bounds);}
return this;},adjustMapToShape:function(id){if(!this.isMapEnabled()){return this;}
var options=this.options();var shape=this.getShape(id);if(shape){this._map.fitBounds(shape.getBounds());}else{this._map.setView([options.defaultLat,options.defaultLn],options.defaultLargeZoom);}
return this;},_itemVisibility:function(item,state){var visible=$(item.getElement()).is(':not(.leaflet-hidden)');if(state===undefined){return visible;}else if(visible!==state){$(item.getElement()).toggleClass('leaflet-hidden',!state);if(state){item.addTo(this._map);}else{item.removeFrom(this._map);}}},_itemExtraData:function(item,data){if(data===undefined){return(item.__extra||{}).extraData||{};}
item.__extra=$.extend(true,item.__extra||{},{extraData:data});},_itemExtraId:function(item,id){if(id===undefined){return(item.__extra||{}).id;}
if(id===null&&item.__extra){delete item.__extra.id;}else{item.__extra['id']=id;}
return item;},_itemExtraIds:function(items){return items.map(function(item){return item.__extra.id;});},_filterItems:function(items,query){query=query||{};var visibility=this._itemVisibility.bind(this);if(query.visible!==undefined){items=items.filter(function(item){return visibility(item)===query.visible;});}
return items;},_searchLocationQuery:function(search){if(this.isGeocoderEnabled()){return this._geocoder.search(search);}
return this._super_(creme.geolocation.GeoMapController,'_searchLocationQuery',search);},addMarker:function(id,options){Assert.that(this.isMapEnabled(),'Map canvas is disabled');Assert.not(Object.isEmpty(id),'Marker id cannot be empty');Assert.not(this.hasMarker(id),'Marker "${id}" is already registered',{id:id});options=$.extend({draggable:false,visible:true},options||{});var position=Object.isNone(options.position)?this.defaultLatLng():options.position;var marker=leaflet.marker([position.lat,position.lng],{title:options.title,draggable:true,icon:__getIcon(options.icon,options.iconShadow)});this._itemVisibility(marker,options.visible);this._itemExtraData(marker,options.extraData||{});this._itemExtraId(marker,id);__markerDraggable(marker,options.draggable);var controller=this;marker.on('click',function(){controller.trigger('marker-click',[marker.__extra,marker,this]);});marker.on('dragstart',function(){this.__dropData=$.extend({},this.__extra,{dragStartPosition:{lat:this.getLatLng().lat,lng:this.getLatLng().lng}});controller.trigger('marker-dragstart',[this.__dropData,marker,this]);});marker.on('dragend',function(){var dropData=$.extend({},this.__dropData||{},{dragStopPosition:{lat:this.getLatLng().lat,lng:this.getLatLng().lng}});controller.trigger('marker-dragstop',[dropData||{},marker,this]);});this._markers[id]=marker;return marker;},removeMarker:function(id){Assert.that(this.isMapEnabled(),'Map canvas is disabled');Assert.not(Object.isEmpty(id),'Marker id cannot be empty');Assert.that(this.hasMarker(id),'Marker "${id}" is not registered',{id:id});var marker=this._markers[id];this._itemExtraId(marker,null);delete this._markers[id];marker.remove();return marker;},updateMarker:function(id,options){Assert.that(this.isMapEnabled(),'Map canvas is disabled');Assert.not(Object.isEmpty(id),'Marker id cannot be empty');Assert.that(this.hasMarker(id),'Marker "${id}" is not registered',{id:id});options=options||{};var marker=this._markers[id];__markerDraggable(marker,options.draggable);__markerIcon(marker,options.icon,options.iconShadow);this._itemVisibility(marker,options.visible);this._itemExtraData(marker,options.extraData);if(options.position){marker.setLatLng([options.position.lat,options.position.lng]);}
return this;},getMarker:function(id){return this.isMapEnabled()?this._markers[id]:undefined;},getMarkerProperties:function(id){var marker=this.getMarker(id);if(marker){return{id:id,title:marker.options.title,icon:marker.getIcon(),draggable:__markerDraggable(marker),visible:this._itemVisibility(marker),position:{lat:marker.getLatLng().lat,lng:marker.getLatLng().lng},extraData:(marker.__extra||{}).extraData||{}};}},hasMarker:function(id){return id in this._markers;},markers:function(query){return this._filterItems(Object.values(this._markers),query);},markerIds:function(query){return this._itemExtraIds(this.markers(query));},toggleMarker:function(id,state){var marker=this.getMarker(id);if(marker){this._itemVisibility(marker,state);}
return this;},toggleAllMarkers:function(state){for(var key in this._markers){this.toggleMarker(key,state);}
return this;},getShape:function(id){return this.isMapEnabled()?this._shapes[id]:undefined;},hasShape:function(id){return id in this._shapes;},addShape:function(id,options){Assert.that(this.isMapEnabled(),'Map canvas is disabled');Assert.not(Object.isEmpty(id),'Shape id cannot be empty');Assert.not(this.hasShape(id),'Shape "${id}" is already registered',{id:id});options=$.extend({position:{lat:0,lng:0},visible:true},options||{});var shapeType=options.shape||'';var shape;switch(shapeType.toLowerCase()){case'circle':shape=__circleShape(options);break;default:throw new Error('Shape has unknown type "${shape}"'.template({shape:shapeType}));}
this._itemVisibility(shape,options.visible);this._itemExtraData(shape,options.extraData||{});this._itemExtraId(shape,id);this._shapes[id]=shape;return shape;},removeShape:function(id){Assert.that(this.isMapEnabled(),'Map canvas is disabled');Assert.not(Object.isEmpty(id),'Shape id cannot be empty');Assert.that(this.hasShape(id),'Shape "${id}" is not registered',{id:id});var shape=this._shapes[id];this._itemExtraId(shape,null);delete this._shapes[id];shape.remove();return shape;},updateShape:function(id,options){Assert.that(this.isMapEnabled(),'Map canvas is disabled');Assert.not(Object.isEmpty(id),'Shape id cannot be empty');Assert.that(this.hasShape(id),'Shape "${id}" is not registered',{id:id});options=options||{};var shape=this._shapes[id];this._itemVisibility(shape,options.visible);this._itemExtraData(shape,options.extraData);if(options.position){shape.setLatLng([options.position.lat,options.position.lng]);}
if(options.radius){shape.setRadius(options.radius);}
return this;},shapes:function(query){return this._filterItems(Object.values(this._shapes),query);},shapeIds:function(query){return this._itemExtraIds(this.shapes(query));},autoResize:function(){if(this.isMapEnabled()){this._map.invalidateSize();}
return this;}});}(jQuery,L));(function($){"use strict";creme.geolocation=creme.geolocation||{};creme.geolocation.PersonsBrick=creme.component.Component.sub({_init_:function(brick,options){options=$.extend({addresses:'script[type$="/json"].geoaddress-data:first'},options||{});this._brick=brick;this.addresses(options.addresses);this.locationUrl(options.locationUrl);Assert.is(options.mapController,creme.geolocation.GeoMapController,'${value} is not a GeoMapController');this._controller=options.mapController;this._controller.on('marker-dragstop',this._onDropLocation.bind(this)).on('status',this._onCanvasStatus.bind(this)).on('status-enabled',this._onCanvasEnabled.bind(this));brick.on('state-update',this._onBrickStateUpdate.bind(this));this.addresses().forEach(function(location){this.addressItem(location.id()).find('input[type="checkbox"]').prop('checked',location.visible());}.bind(this));brick.element().on('change','.brick-geoaddress-item input[type="checkbox"]',this._onToggleLocation.bind(this));brick.element().on('click','.brick-geoaddress-item.is-mark-visible .brick-geoaddress-reset',this._onResetLocation.bind(this));this._controller.bind(this.canvas());},_onBrickStateUpdate:function(event,state){if(!state.collapsed){this._controller.autoResize();this._controller.adjustMap();}},_onCanvasStatus:function(event,status){this._brick.element().toggleClass('is-geolocation-disabled',!status);},_onCanvasEnabled:function(){this.addresses().filter(function(location){return location.visible();}).forEach(function(location){this._markLocation({location:location,draggable:true});}.bind(this));},_onDropLocation:function(event,data,marker,mousevent){var self=this;this.saveLocation({id:data.id,position:data.dragStopPosition,status:creme.geolocation.LocationStatus.MANUAL},{'cancel fail':function(){self._controller.updateMarker(data.id,{position:data.dragStartPosition});},done:function(){var location=self.address(data.id);location.position(data.dragStopPosition);location.status(creme.geolocation.LocationStatus.MANUAL);self._renderLocationStatus(location);}});},_markLocation:function(options){options=options||{};var self=this;var location=options.location;return this._controller.markLocation(options,{done:function(event,position,status,data){var hasImproved=status>location.status();location.position(position);location.status(status);location.visible(true);if(hasImproved){self.saveLocation(location);}
self._renderLocationStatus(location);self._controller.adjustMap();},fail:function(){location.status(creme.geolocation.LocationStatus.UNDEFINED);self._renderLocationStatus(location);self._controller.adjustMap();}});},locationUrl:function(url){return Object.property(this,'_locationUrl',url);},address:function(addressId){return this._addresses[addressId];},addresses:function(addresses){if(addresses===undefined){return Object.values(this._addresses);}
if(_.isString(addresses)){var script=_.readJSONScriptText($(addresses,this._brick.element()).get(0));addresses=Object.isEmpty(script)?[]:JSON.parse(script);}
var data=this._addresses={};for(var index in addresses){var address=addresses[index];if(Object.isEmpty(address.id)){throw new Error('PersonsBrick : empty address id');}else if(data[address.id]!==undefined){throw new Error('PersonsBrick : address "${id}" already exists'.template(address));}
data[address.id]=new creme.geolocation.Location($.extend({visible:address.selected||address.is_billing},address));}
return this;},addressItem:function(address_id){return $('.brick-geoaddress-item[data-addressid="'+address_id+'"]',this._brick.element());},addressItems:function(){return $('.brick-geoaddress-item',this._brick.element());},canvas:function(){return $('.brick-geoaddress-canvas',this._brick.element());},mapController:function(){return this._controller;},saveLocation:function(location,listeners){var self=this;location=new creme.geolocation.Location(location);if(Object.isEmpty(this.locationUrl())){new creme.component.Action(function(){this.cancel();}).on(listeners||{}).start();return this;}
creme.ajax.query(this.locationUrl(),{},{id:location.id(),latitude:location.position().lat,longitude:location.position().lng,geocoded:true,status:location.status()}).onDone(function(){self._brick.trigger('geoaddress-location-save',[location]);}).on(listeners||{}).post();return this;},_renderLocationStatus:function(location){var item=this.addressItem(location.id());item.find('.brick-geoaddress-status').text(location.statusLabel());item.find('.brick-geoaddress-action').toggleClass('brick-geoaddress-iscomplete',location.isComplete());item.find('.brick-geoaddress-position').text(location.positionLabel());item.find('input[type="checkbox"]').prop('checked',location.visible());item.toggleClass('is-mark-visible',location.visible());},_toggleLocation:function(location,visible){if(this._controller.hasMarker(location.id())){this._controller.toggleMarker(location.id(),visible);this._controller.adjustMap();location.visible(visible);this._renderLocationStatus(location);}else if(visible){this._markLocation({location:location,draggable:true});}},_onResetLocation:function(event){var id=$(event.target).attr('data-addressid');var location=this.address(id);this._markLocation({location:location,draggable:true,force:true});},_onToggleLocation:function(event){var location=this.address($(event.target).val());this._toggleLocation(location,$(event.target).is(':checked'));}});creme.geolocation.AddressesBrick=creme.component.Component.sub({_init_:function(brick,options){options=options||{};this._brick=brick;this._addresses=[];this.addressesUrl(options.addressesUrl);Assert.is(options.mapController,creme.geolocation.GeoMapController,'${value} is not a GeoMapController');this._controller=options.mapController;this._controller.on('status',this._onCanvasStatus.bind(this)).on('status-enabled',this._onCanvasEnabled.bind(this)).on('marker-click',this._onMarkerClick.bind(this));brick.on('state-update',this._onBrickStateUpdate.bind(this));brick.element().on('change','.brick-geoaddress-filter',this._onFilterChange.bind(this));this._controller.bind(this.canvas());},canvas:function(){return $('.brick-geoaddress-canvas',this._brick.element());},filterSelector:function(){return $('.brick-geoaddress-filter',this._brick.element());},counterItem:function(){return $('.brick-geoaddress-counter',this._brick.element());},addressesUrl:function(url){return Object.property(this,'_addressesUrl',url);},addresses:function(){return this._addresses;},address:function(id){var res=this._addresses.filter(function(n){return n.id()===id;});return res.length>0?res[0]:undefined;},mapController:function(){return this._controller;},_onBrickStateUpdate:function(event,state){if(!state.collapsed){this._controller.autoResize();this._controller.adjustMap();}},_onCanvasStatus:function(event,status){this._brick.element().toggleClass('is-geolocation-disabled',!status);},_onCanvasEnabled:function(event){this._queryAddresses(this._brick.element().find('.brick-geoaddress-filter').val());},_queryAddresses:function(filter,listeners){var self=this;var query;if(Object.isEmpty(filter)){query=new creme.component.Action(function(){this.fail();});}else{query=creme.ajax.query(this.addressesUrl(),{},{id:filter}).converter(JSON.parse);}
query.onDone(function(event,data){self._onUpdateAddresses(data.addresses);}).onFail(function(){self._onUpdateAddresses([]);}).on(listeners||{});return query.start();},_onUpdateAddresses:function(addresses){addresses=addresses||[];var controller=this._controller;controller.toggleAllMarkers(false);this._addresses=addresses.map(function(address){var location=new creme.geolocation.Location(Object.assign({position:address.latitude?{lat:address.latitude,lng:address.longitude}:null},address||{}));if(location.hasPosition()){controller.updateOrAddMarker(location.id(),{title:location.markerLabel(),position:location.position(),visible:true,draggable:false,icon:location.icon(),iconShadow:location.iconShadow(),extraData:location.extraData()||{}});}
return location;});controller.adjustMap();this._renderCount(controller.markers({visible:true}).length);},_onMarkerClick:function(event,data){var location=this.address(data.id);if(location&&!Object.isEmpty(location.url())){creme.utils.goTo(location.url());}},_onFilterChange:function(event){var filter=$(event.target);this._queryAddresses(filter.val(),{fail:function(){filter.val('');}});},_renderCount:function(count){var content=count>0?ngettext('%0$d address from','%0$d addresses from',count).format(count):gettext('No address from');$('.brick-geoaddress-counter',this._brick.element()).html(content);}});creme.geolocation.PersonsNeighborhoodBrick=creme.component.Component.sub({_init_:function(brick,options){options=options||{};this._brick=brick;this._origin=null;this._neighbours=[];this.radius(options.radius||1);this.neighboursUrl(options.neighboursUrl);Assert.is(options.mapController,creme.geolocation.GeoMapController,'${value} is not a GeoMapController');this._controller=options.mapController;this._controller.on('status',this._onCanvasStatus.bind(this)).on('status-enabled',this._onUpdateNeighbours.bind(this)).on('marker-click',this._onMarkerClick.bind(this));brick.on('state-update',this._onBrickStateUpdate.bind(this));this._brick.element().on('change','.brick-geoaddress-origin',this._onUpdateNeighbours.bind(this));this._brick.element().on('change','.brick-geoaddress-filter',this._onUpdateNeighbours.bind(this));$(document).on('brick-geoaddress-location-save','.geolocation-detail-brick',this._onMoveLocation.bind(this));this._controller.bind(this.canvas());},neighboursUrl:function(url){return Object.property(this,'_neighboursUrl',url);},radius:function(radius){return Object.property(this,'_radius',radius);},mapController:function(){return this._controller;},_onBrickStateUpdate:function(event,state){if(!state.collapsed){this._controller.autoResize();this._controller.adjustMapToShape('NeighbourhoodCircle');}},_onCanvasStatus:function(event,status){this._brick.element().toggleClass('is-geolocation-disabled',!status);},_onUpdateNeighbours:function(){this._queryNeighboursOf({originId:this.originSelector().val(),filterId:this.filterSelector().val()});},_queryNeighboursOf:function(options,listeners){options=options||{};var markNeighbours=this.markNeighbours.bind(this);var query;if(Object.isEmpty(options.originId)){query=new creme.component.Action(function(){this.fail();});}else{query=creme.ajax.query(this.neighboursUrl(),{},{address_id:options.originId,filter_id:options.filterId}).converter(JSON.parse);}
query.onDone(function(event,data){markNeighbours({originId:options.originId,origin:new creme.geolocation.Location(data.source_address),neighbours:data.addresses.map(function(address){return new creme.geolocation.Location(address);})});}).onFail(function(){markNeighbours({originId:options.originId,origin:null,neighbours:[]});}).on(listeners||[]);return query.start();},markNeighbours:function(options){options=options||{};var controller=this._controller;var origin=this._origin=options.origin||null;var neighbours=this._neighbours=options.neighbours||[];controller.toggleAllMarkers(false);if(Object.isNone(origin)){controller.removeAllMarkers();controller.removeAllShapes();}else{controller.updateOrAddShape('NeighbourhoodCircle',{position:origin.position(),radius:this.radius(),shape:'circle'});controller.replaceMarkers(neighbours.map(function(location){return{id:location.id(),title:location.markerLabel(),position:location.position(),draggable:false,visible:true,icon:location.icon(),iconShadow:location.iconShadow(),extraData:location.extraData()};}));controller.updateOrAddMarker(origin.id(),{title:origin.markerLabel(),position:origin.position(),draggable:false,icon:origin.icon()||'target',iconShadow:origin.iconShadow(),extraData:origin.extraData()||{}});controller.adjustMapToShape('NeighbourhoodCircle');}
this._renderCount(neighbours.length);},_onMoveLocation:function(event,brick,location){this._onUpdateNeighbours();},_onMarkerClick:function(event,data){var location=this.neighbour(data.id);if(location&&!Object.isEmpty(location.url())){creme.utils.goTo(location.url());}},canvas:function(){return $('.brick-geoaddress-canvas',this._brick.element());},originSelector:function(){return $('.brick-geoaddress-origin',this._brick.element());},filterSelector:function(){return $('.brick-geoaddress-filter',this._brick.element());},neighbours:function(){return this._neighbours;},neighbour:function(id){var res=this._neighbours.filter(function(n){return n.id()===id;});return res.length>0?res[0]:undefined;},origin:function(){return this._origin;},counterItem:function(){return $('.brick-geoaddress-counter',this._brick.element());},_renderCount:function(count){var content=count>0?ngettext('%0$d of','%0$d of',count).format(count):gettext('None of');this.counterItem().text(content);}});}(jQuery));